var WebApp,__awaiter=this&&this.__awaiter||function(t,e,a,i){return new(a||(a=Promise))((function(s,r){function o(t){try{l(i.next(t))}catch(t){r(t)}}function n(t){try{l(i.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(o,n)}l((i=i.apply(t,e||[])).next())}))};function capitalizeFirst(t){return t.substr(0,1).toUpperCase()+t.substr(1)}function expandCollapse(t){let e=t.parentElement,a=e.querySelector(".section-content");e.classList.contains("closed")?(a.style.removeProperty("display"),e.classList.remove("closed")):(e.classList.add("closed"),setTimeout(()=>a.style.display="none",300))}!function(t){!function(e){let a;!function(e){e.saveState=function(e,a){return __awaiter(this,void 0,void 0,(function*(){let i=yield t.Http.postJsonAsync("~/SaveState/"+e,a);if(!i.isSuccess)throw i.error;return i.data}))},e.loadState=function(e){return __awaiter(this,void 0,void 0,(function*(){let a=yield t.Http.getJsonAsync("~/LoadState/"+e);if(!a.isSuccess)throw a.error;return a.data}))},e.loadStudioData=function(){return __awaiter(this,void 0,void 0,(function*(){return yield t.Http.getJsonAsync("~/StudioData")}))}}(a=e.Api||(e.Api={}))}(t.GeoPlot||(t.GeoPlot={}))}(WebApp||(WebApp={})),function(t){let e;!function(e){e.GeoPlotApplication=class{constructor(){}initServices(){t.Services.httpClient=new t.XHRHttpClient}}}(e=t.GeoPlot||(t.GeoPlot={})),t.app=new e.GeoPlotApplication}(WebApp||(WebApp={})),HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,a){let i=this;setTimeout(()=>{const s=atob(i.toDataURL(e,a).split(",")[1]),r=s.length,o=new Uint8Array(r);for(let t=0;t<r;t++)o[t]=s.charCodeAt(t);t(new Blob([o],{type:e||"image/png"}))})}}),window.Chart&&Chart.plugins.register({beforeDraw:function(t){var e=t.ctx;e.fillStyle="white",e.fillRect(0,0,t.width,t.height)}}),function(t){!function(e){e.ConstIndicatorFunction=class{constructor(t){this._value=t}value(t,e,a,i,s){let r=this._value(t,s);if(a)for(var o in a)r-=this.value(a[o],i[o],null,null,s);return r}};e.SimpleIndicatorFunction=class{constructor(t){this._value=t}value(t,e,a,i,s){var r=this._value(t,s);if(e&&(r-=this._value(e,s)),a)for(var o in a)r-=this.value(a[o],i[o],null,null,s);return r}};e.CombineIndicatorFunction=class{constructor(t,e){this._value=e,this._indicators=t}value(t,e,a,i,s){const r={};for(var o in this._indicators)r[o]=this._indicators[o].value(t,e,a,i,s);return this._value(r)}};e.SimpleFactorFunction=class{constructor(t){this._value=t}value(t,e,a,i,s,r){let o=0;for(var n in t)o+=r.value(t[n],e[n],a[n],i[n],s);return this._value(o,t[0],s)}};e.DoubleFactorFunction=class{constructor(t,e){this._value=t,this._factor=e}value(t,e,a,i,s,r){let o=0,n=0;for(var l in t)o+=r.value(t[l],e[l],a[l],i[l],s),n+=this._factor.value(t[l],e[l],a[l],i[l],s);return this._value(o,n)}};e.IndicatorCalculator=class{constructor(t,e,a){this._data=t,this._dataSet=e,this._geo=a}getFactorValue(e){const a=("string"==typeof e.areaOrId?e.areaOrId:e.areaOrId.id).toLowerCase(),i=(t,e)=>t<0?void 0:this._data.days[t].values[e];let s;s=Array.isArray(e.dayNumberOrGroup)?e.dayNumberOrGroup:[e.dayNumberOrGroup];let r=[],o=[],n=[],l=[];for(var h of s)if(r.push(i(h,a)),e.isDayDelta&&o.push(i(h-1,a)),e.execludedAreas){var c=[],d=[];for(var u of e.execludedAreas)c.push(i(h,u.toLowerCase())),e.isDayDelta&&d.push(i(h-1,u.toLowerCase()));n.push(c),l.push(d)}const p=t.linq(this._dataSet.factors).first(t=>t.id==e.factorId),m=t.linq(this._dataSet.indicators).first(t=>t.id==e.indicatorId);return p.compute.value(r,o,n,l,this._geo.areas[a],m.compute)}getIndicatorValue(e){const a=("string"==typeof e.areaOrId?e.areaOrId:e.areaOrId.id).toLowerCase(),i=t.linq(this._dataSet.indicators).first(t=>t.id==e.indicatorId),s=(t,e)=>t<0?void 0:this._data.days[t].values[e];let r,o,n,l=s(e.dayNumber,a);if(e.isDayDelta&&(r=s(e.dayNumber-1,a)),e.execludedAreas)for(var h of(o=[],n=[],e.execludedAreas))o.push(s(e.dayNumber,h.toLowerCase())),e.isDayDelta&&n.push(s(e.dayNumber-1,h.toLowerCase()));return i.compute.value(l,r,o,n,this._geo.areas[a])}getSerie(t){const e=[];if(t.groupSize>1){let a=t.groupSize,i=[];for(let s=0+t.startDay;s<this._data.days.length;s++)if(i.push(s),a--,0==a){const r={x:"date"==t.xAxis?new Date(this._data.days[s].date):s,y:this.getFactorValue({dayNumberOrGroup:t.isDelta?i:s,areaOrId:t.areaId,factorId:t.factorId,indicatorId:t.indicatorId,execludedAreas:t.exeludedAreaIds,isDayDelta:t.isDelta})};e.push(r),a=t.groupSize,i=[]}}else for(let a=0+t.startDay;a<this._data.days.length;a++){const i={x:"date"==t.xAxis?new Date(this._data.days[a].date):a,y:this.getFactorValue({dayNumberOrGroup:a,areaOrId:t.areaId,factorId:t.factorId,indicatorId:t.indicatorId,execludedAreas:t.exeludedAreaIds,isDayDelta:t.isDelta})};e.push(i)}return e}}}(t.GeoPlot||(t.GeoPlot={}))}(WebApp||(WebApp={})),function(t){!function(t){let e,a;!function(t){t[t.SUm=0]="SUm",t[t.Avg=1]="Avg"}(e=t.AggregationFunc||(t.AggregationFunc={})),function(t){t[t.Country=0]="Country",t[t.State=1]="State",t[t.Region=2]="Region",t[t.District=3]="District"}(a=t.GeoAreaType||(t.GeoAreaType={}))}(t.GeoPlot||(t.GeoPlot={}))}(WebApp||(WebApp={})),function(t){!function(e){class a{constructor(t,e,a=0){this._value=t,this._separator=e,this._startIndex=a}get current(){return this._current||(this._current=this._value.substring(this._currentStartIndex,this._curIndex)),this._current}moveNext(){if(this._curIndex==this._value.length)return!1;this._currentStartIndex=this._curIndex;var t=this._value.indexOf(this._separator,this._curIndex);return this._curIndex=-1==t?this._value.length:t+this._separator.length,this._current=null,!0}reset(){this._curIndex=this._startIndex,this._currentStartIndex=this._curIndex,this._current=null}}class i{constructor(t){}}e.TextTableDataAdapter=class extends i{constructor(t){super(t),this._options=t}createIdentifier(t){let e=0,a="";for(let i=0;i<t.length;i++){const s=t[i];switch(e){case 0:a+=s.toLowerCase(),e=1;break;case 1:" "==s||"-"==s||"_"==s?e=2:a+=s;break;case 2:a+=s.toUpperCase(),e=1}}return a}extractHeader(e){const i=t.linq(new a(e,this._options.rowSeparator)).first().split(this._options.columnSeparator);let s;if(!1!==this._options.hasHeader){const e=[];this.analyzeRow(i,e);const a=t.linq(e).sum(t=>t.stringCount),r=t.linq(e).sum(t=>t.emptyCount);a>0&&a+r==i.length&&(this._options.hasHeader=!0,s=t.linq(i).select((t,e)=>""==t?"col"+e:this.createIdentifier(t)).toArray())}s||(this._options.hasHeader=!1,s=t.linq(i).select((t,e)=>"col"+e).toArray()),this._options.columnsIds||(this._options.columnsIds=s)}extractRowSeparator(t){if(this._options.rowSeparator)return;const e=["\r\n","\n"];for(var a of e)if(-1!=t.indexOf(a))return void(this._options.rowSeparator=a)}extractColumnSeparator(e){if(this._options.columnSeparator)return;const i=["\t",";",","," "],s={},r=t.linq(new a(e,this._options.rowSeparator)).take(10);for(let e of r)for(let r of i){if(!1===s[r])continue;const i=t.linq(new a(e,r)).count();i>1&&!(r in s)?s[r]=i:s[r]!=i&&(s[r]=!1)}for(var o in s)if(!1!==s[o])return void(this._options.columnSeparator=o)}analyzeRow(t,e){if(0==e.length)for(let a=0;a<t.length;a++)e.push({values:{},booleanCount:0,dateCount:0,emptyCount:0,numberCount:0,stringCount:0});for(let a=0;a<t.length;a++)this.analyzeColumn(t[a],e[a])}analyzeColumn(t,e){t in e.values?e.values[t]++:e.values[t]=1,""==t?e.emptyCount++:isNaN(t)?Date.parse(t)?e.dateCount++:"true"==t||"false"==t?e.booleanCount++:e.stringCount++:e.numberCount++}createParser(t){return t.numberCount>0&&0==t.stringCount?t=>t?parseFloat(t):null:t.booleanCount>0&&0==t.stringCount?t=>"true"==t:t.dateCount>0&&0==t.stringCount?t=>t?new Date(t):null:t.stringCount>0?t=>t?t.startsWith('"')&&t.endsWith('"')?t.substr(1,t.length-2):t:"":t=>null}analyze(e){this.extractRowSeparator(e),this.extractColumnSeparator(e),this.extractHeader(e);let i=t.linq(new a(e,this._options.rowSeparator));this._options.hasHeader&&(i=i.skip(1));const s=[];return i.foreach(t=>this.analyzeRow(t.split(this._options.columnSeparator),s)),this._options.columnsParser||(this._options.columnsParser={},s.forEach((t,e)=>this._options.columnsParser[this._options.columnsIds[e]]=this.createParser(t))),this._options.xColumn||(this._options.xColumn=this._options.columnsIds[0]),this._options.serieColumns||(this._options.serieColumns=[],s.forEach((t,e)=>{t.numberCount>0&&0==t.stringCount&&this._options.serieColumns.push(this._options.columnsIds[e])})),this._options.groupColumns||(this._options.groupColumns=[],s.forEach((e,a)=>{if(e.stringCount>0){var i=t.linq(e.values);i.count()>1&&i.any(t=>t.value>1)&&this._options.groupColumns.push(this._options.columnsIds[a])}})),s}parse(e){this.analyze(e);var i=[],s=t.linq(new a(e,this._options.rowSeparator));for(var r of(this._options.hasHeader&&(s=s.skip(1)),s)){var o=r.split(this._options.columnSeparator),n={};for(let t=0;t<o.length;t++)n[this._options.columnsIds[t]]=this._options.columnsParser[this._options.columnsIds[t]](o[t]);i.push(n)}return i}};e.DataImportControl=class{constructor(){}}}(t.GeoPlot||(t.GeoPlot={}))}(WebApp||(WebApp={})),function(t){!function(e){e.InfectionDataSet={name:"COVID-19",indicators:[{id:"totalPositive",name:$string("$(total-positive)"),colorLight:"#f44336",colorDark:"#b71c1c",compute:new e.SimpleIndicatorFunction(t=>t.totalPositive)},{id:"currentPositive",name:$string("$(current-positive)"),validFor:["region","country"],colorLight:"#e91e63",colorDark:"#880e4f",compute:new e.SimpleIndicatorFunction(t=>t.currentPositive)},{id:"totalDeath",name:$string("$(death)"),validFor:["region","country"],colorLight:"#9c27b0",colorDark:"#4a148c",compute:new e.SimpleIndicatorFunction(t=>t.totalDeath)},{id:"totalSevere",name:$string("$(severe)"),validFor:["region","country"],colorLight:"#ff9800",colorDark:"#e65100",compute:new e.SimpleIndicatorFunction(t=>t.totalSevere)},{id:"totalHospedalized",name:$string("$(hospedalized)"),validFor:["region","country"],colorLight:"#fdd835",colorDark:"#fbc02d",compute:new e.SimpleIndicatorFunction(t=>t.totalHospedalized)},{id:"totalHealed",name:$string("$(healed)"),validFor:["region","country"],colorLight:"#4caf50",colorDark:"#1b5e20",compute:new e.SimpleIndicatorFunction(t=>t.totalHealed)},{id:"toatlTests",name:$string("$(tested)"),validFor:["region","country"],colorLight:"#03a9f4",colorDark:"#01579b",compute:new e.SimpleIndicatorFunction(t=>t.toatlTests)},{id:"surface",name:$string("$(surface) ($(geo))"),validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new e.ConstIndicatorFunction((e,a)=>t.MathUtils.round(a.surface,0))},{id:"density",name:$string("$(density) ($(geo))"),validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new e.ConstIndicatorFunction((e,a)=>t.MathUtils.round(a.demography.total/a.surface,0))},{id:"population",name:$string("$(population) ($(geo))"),validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new e.ConstIndicatorFunction((t,e)=>e.demography.total)},{id:"populationOld",name:$string("$(population) +65 ($(geo))"),validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new e.ConstIndicatorFunction((t,e)=>e.demography.over65)}],factors:[{id:"none",name:$string("$(none)"),compute:new e.SimpleFactorFunction((t,e,a)=>t),format:t=>formatNumber(t),reference:(t,e)=>"N/A",description:$string("[indicator]")},{id:"population",name:$string("$(population)"),compute:new e.SimpleFactorFunction((t,e,a)=>t/a.demography.total*1e5),format:t=>formatNumber(t),reference:(t,e)=>formatNumber(e.demography.total),description:$string("[indicator] $(every-100k)")},{id:"population",name:$string("$(population) +65"),compute:new e.SimpleFactorFunction((t,e,a)=>t/a.demography.over65*1e5),format:e=>formatNumber(t.MathUtils.round(e,1)),reference:(t,e)=>formatNumber(e.demography.over65),description:$string("[indicator] $(every-100k) +65")},{id:"density",name:$string("$(density)"),compute:new e.SimpleFactorFunction((t,e,a)=>t/(a.demography.total/a.surface)*1e5),format:e=>formatNumber(t.MathUtils.round(e,1)),reference:(e,a)=>formatNumber(t.MathUtils.round(a.demography.total/a.surface,1)),description:$string("[indicator] $(over-density)")},{id:"totalPositive",name:$string("$(total-positive)"),validFor:["region","country"],compute:new e.DoubleFactorFunction((t,e)=>t?t/e*100:0,new e.SimpleIndicatorFunction(t=>t.totalPositive)),format:e=>t.MathUtils.round(e,1)+"%",reference:(t,e)=>t.totalPositive?formatNumber(t.totalPositive):"N/A",description:$string("% [indicator] $(over-total-positive)")},{id:"severe",name:$string("$(severe)"),validFor:["region","country"],compute:new e.DoubleFactorFunction((t,e)=>t?t/e*100:0,new e.SimpleIndicatorFunction(t=>t.totalSevere)),format:e=>t.MathUtils.round(e,1)+"%",reference:(t,e)=>t.totalSevere?formatNumber(t.totalSevere):"N/A",description:$string("% [indicator] $(over-severe)")},{id:"test",name:$string("$(tested)"),validFor:["region","country"],compute:new e.DoubleFactorFunction((t,e)=>t?t/e*100:0,new e.SimpleIndicatorFunction(t=>t.toatlTests)),format:e=>t.MathUtils.round(e,1)+"%",reference:(t,e)=>t.toatlTests?formatNumber(t.toatlTests):"N/A",description:$string("% [indicator] $(over-tested)")}]}}(t.GeoPlot||(t.GeoPlot={}))}(WebApp||(WebApp={})),function(t){!function(t){t.ViewModes={district:{label:{singular:$string("$(district)"),plural:$string("$(districts)")},mapGroup:"group_district",tab:"districtTab",areaType:t.GeoAreaType.District,validateId:t=>"d"==t[0].toLowerCase()},region:{label:{singular:$string("$(region)"),plural:$string("$(regions)")},mapGroup:"group_region",tab:"regionTab",areaType:t.GeoAreaType.Region,validateId:t=>"r"==t[0].toLowerCase()},country:{label:{singular:$string("$(italian)"),plural:$string("$(italians)")},mapGroup:"group_country",tab:"italyTab",areaType:t.GeoAreaType.Country,validateId:t=>"it"==t.toLowerCase()}}}(t.GeoPlot||(t.GeoPlot={}))}(WebApp||(WebApp={})),window.ko&&(ko.bindingHandlers.attach={init:(t,e,a,i)=>{let s=ko.unwrap(e());if(!0!==s&&null!=s||(s=i.attachNode),"function"!=typeof s)throw"Supplied argument is not a function";setTimeout(()=>s.call(i,t))}}),function(t){!function(t){class e{static project(t){var a={x:0,y:0};return a.x=t.lng*e.OriginShift/180,a.y=Math.log(Math.tan((90+t.lat)*Math.PI/360))/(Math.PI/180),a.y=-a.y*e.OriginShift/180,a.x-=e.OFFSET_X,a.y-=e.OFFSET_Y,a}}e.EarthRadius=6378137,e.OriginShift=2*Math.PI*e.EarthRadius/2,e.OFFSET_X=1263355,e.OFFSET_Y=5543162,t.Geo=e}(t.GeoPlot||(t.GeoPlot={}))}(WebApp||(WebApp={})),function(t){t.LinearGradient=class{constructor(...a){a.length>0?"string"==typeof a[0]?this.colors=t.linq(a).select(t=>new e(t)).toArray():this.colors=a:this.colors=[]}valueAt(t){if(t<0)return this.colors[0];t>1&&this.colors[this.colors.length-1];const a=1/(this.colors.length-1),i=Math.floor(t/a),s=Math.ceil(t/a),r=(t-i*a)/a,o=this.colors[i],n=this.colors[s],l=new e;return l.r=o.r+(n.r-o.r)*r,l.g=o.g+(n.g-o.g)*r,l.b=o.b+(n.b-o.b)*r,l}};class e{constructor(t){this.r=0,this.g=0,this.b=0,t&&this.fromHex(t)}fromHex(t){4==t.length?(this.r=parseInt("0x"+t[1]+t[1])/255,this.g=parseInt("0x"+t[2]+t[2])/255,this.b=parseInt("0x"+t[3]+t[3])/255):(this.r=parseInt("0x"+t[1]+t[2])/255,this.g=parseInt("0x"+t[3]+t[4])/255,this.b=parseInt("0x"+t[5]+t[6])/255)}toString(){function t(t){let e=Math.round(255*t).toString(16);return 1==e.length?"0"+e:e}return"#"+t(this.r)+t(this.g)+t(this.b)}}t.RgbColor=e;t.Graphics=class{constructor(t){this._svg=t}setViewPort(t,e,a,i){this._svg.viewBox.baseVal.x=t,this._svg.viewBox.baseVal.y=e,this._svg.viewBox.baseVal.width=a-t,this._svg.viewBox.baseVal.height=i-e}drawPoly(t){var e=document.createElementNS("http://www.w3.org/2000/svg","polygon");e.style.fill=t.fillColor,e.style.stroke=t.strokeColor,e.style.strokeWidth=t.strokeSize+"%",e.id=t.id;for(let a=0;a<t.geometry.points.length;a++){let i=this._svg.createSVGPoint();i.x=t.geometry.points[a].x,i.y=t.geometry.points[a].y,e.points.appendItem(i)}this._svg.appendChild(e)}}}(WebApp||(WebApp={})),function(t){class e{constructor(t,e){this.isVisible=ko.observable(!1),this.isTransparent=ko.observable(!1),this.value=t,this._closeAfter=e}dontShowAgain(){}onActionExecuted(){}executeAction(){this.value.showAction&&this.value.showAction(),setTimeout(()=>this.startPulse()),this.onActionExecuted()}startPulse(){if(this._element=document.querySelector(this.value.elementSelector),!this._element)return;let e=t.DomUtils.centerElement(this._element);t.DomUtils.addClass(this._element,"pulse");let a=document.querySelector(".tip-container");e<a.clientTop+a.clientHeight&&this.isTransparent(!0)}stopPulse(){this._element&&(t.DomUtils.removeClass(this._element,"pulse"),this.isTransparent(!1))}next(){}understood(){}onClose(){}close(){clearTimeout(this._closeTimeoutId),this.stopPulse(),this.isVisible(!1),this.onClose()}show(){this._closeTimeoutId&&clearTimeout(this._closeTimeoutId),this.isVisible(!0),this._closeAfter&&(this._closeTimeoutId=setTimeout(()=>this.close(),this._closeAfter))}}t.TipViewModel=e;t.TipManager=class{constructor(t,e,a){this.tip=ko.observable(),this._getPreferences=e,this._tips=t,this.savePreferences=a}get preferences(){return this._getPreferences()}savePreferences(){}markAction(e,a){this.preferences.actions[e]++,this.savePreferences(),window.gtag&&t.safeCall(()=>gtag("event",e,{event_category:"GeoPlot",event_label:a,value:this.preferences.actions[e]}))}markTip(e,a){window.gtag&&t.safeCall(()=>gtag("event",a,{event_category:"GeoPlot/Tip",event_label:e}))}engageUser(){if(null!=this.preferences.showTips&&!this.preferences.showTips)return;const e=t.linq(this._tips).where(t=>t.value.showAfter>0&&0==this.preferences.actions[t.key]).first();this.showTip(e.key,{onClose:()=>this.engageUser(),timeout:e.value.showAfter})||this.engageUser()}showTip(a,i){if(null!=this.preferences.showTips&&!this.preferences.showTips)return!1;if((!i||!i.override)&&this.tip()&&this.tip().isVisible())return!1;if((!i||!i.force)&&this.preferences.actions[a])return!1;const s=this._tips[a],r=new e(s);r.onActionExecuted=()=>{this.markTip(a,"how")},r.dontShowAgain=()=>{this.preferences.showTips=!1,this.savePreferences(),r.close(),this.markTip(a,"dontShowAgain")},r.understood=()=>{this.preferences.actions[a]++,this.savePreferences(),r.close(),this.markTip(a,"understood")},r.onClose=()=>{i&&i.onClose&&i.onClose()};let o=t.linq(this._tips).where(t=>t.value.order>s.order&&0==this.preferences.actions[t.key]).first();return r.next=o?()=>{r.close(),this.preferences.actions[a]++,this.showTip(o.key),this.markTip(a,"next")}:null,this.tip(r),setTimeout(()=>r.show(),i&&i.timeout?1e3*i.timeout:0),!0}}}(WebApp||(WebApp={})),function(t){!function(e){class a{constructor(){this.value=ko.observable()}select(){}}class i{constructor(){this.data=ko.observable(),this.factor=ko.observable(),this.indicator=ko.observable(),this.reference=ko.observable(),this.indicators=ko.observable()}select(){}}e.GeoPlotPage=class{constructor(a){this._topAreasVisible=!1,this._execludedArea=new Map,this._dataSet=e.InfectionDataSet,this._keepState=!1,this._debugMode=!1,this._tips={areaSelected:{order:0,featureName:"Zone",html:"Puoi vedere i dati relativi ad una particolare area selezionadoli sulla mappa.",elementSelector:".card-map .center-align",showAfter:3,showAction:()=>{this.viewMode("region"),this.selectedArea=this._geo.areas.r10}},indicatorSelected:{order:1,featureName:"Indicatori",html:"Puoi vedere il grafico associato all'indicatore, facendo click sull'indicatore.",elementSelector:".indicators .summary-field",showAfter:15,showAction:()=>{this.currentArea()||this._tips.areaSelected.showAction(),this.selectedIndicator(t.linq(this._dataSet.indicators).first(t=>"totalDeath"==t.id))}},dayChanged:{order:2,featureName:"Cronologia",html:"Puoi vedere gli indicatori dei giorni precedenti muovendo la slide.",elementSelector:".day input[type=range]",showAfter:20,showAction:()=>{this.dayNumber(5)}},indicatorChanged:{order:3,featureName:"Indicatori",html:"Puoi cambiare l'indicatore scegliendolo dal filtro nell'elenco.",elementSelector:".filter-indicator",showAfter:0},viewChanged:{order:4,featureName:"Zone",html:"Puoi vedere gli indicatori a livello regionale, nazionale o provinciale.",elementSelector:"#areaTabs",showAfter:0,showAction:()=>{this.viewMode("district")}},topAreasOpened:{order:5,featureName:"Zone",html:"Puo vedere le zone più colpite di un qualsiasi indicatore scelto.",elementSelector:"#topCases .card-title",showAfter:20,showAction:()=>{"country"==this.viewMode()&&this.viewMode("region"),M.Collapsible.getInstance(document.getElementById("topCases")).open(0)}},deltaSelected:{order:5.5,featureName:"Indicatori",html:"Puoi vedere l'incremento giornaliero dell'indicatore anzichè il valore totale.",elementSelector:".day-delta",showAfter:20,showAction:()=>{this.currentArea()||this._tips.areaSelected.showAction(),this.isDayDelta(!0)}},factorChanged:{order:6,featureName:"Indicatori",html:"Puoi mettere in relazione qualsiasi indicatore a numerosi parametri (es. % Positivi su Tamponi).",elementSelector:".filter-factor",showAfter:30,showAction:()=>{this.currentArea()||this._tips.areaSelected.showAction(),this.selectedIndicator(t.linq(this._dataSet.indicators).first(t=>"totalPositive"==t.id)),this.selectedFactor(t.linq(this._dataSet.factors).first(t=>"population"==t.id))}},groupChanged:{order:7,featureName:"Grafico",html:"Puo raggruppare i dati del grafico in gruppi da 1 a 7 giorni. Puoi anche scegliere la data d'inizio.",elementSelector:".row-chart-group .select-wrapper",showAfter:30,showAction:()=>{this.currentArea()||this._tips.areaSelected.showAction();var t=document.querySelector(".chart-options");t.classList.contains("closed")&&t.classList.remove("closed"),this.groupSize(2),M.FormSelect.init(document.querySelectorAll(".row-chart-group select"))}},chartActionExecuted:{order:8,featureName:"Grafico",html:"Puoi portare il grafico a schermo interno, copiarlo, o copiare la serie numerico e incollarla in excel.",elementSelector:".chart .actions",showAfter:30},scaleChanged:{order:9,featureName:"Grafico",html:"Puoi cambiare da scala logaritmica a scala lineare.",elementSelector:".log-scale",showAfter:210,showAction:()=>{this.isLogScale(!0)}},maxFactorChanged:{order:10,featureName:"Mappa",html:"Puoi cambiare il riferimento rispetto al quale la mappa viene colorata. Normalmente è in base al valore massimo che si ha avuto globalmente.",elementSelector:".max-factor",showAfter:60,showAction:()=>{this.currentArea()||this._tips.areaSelected.showAction(),this.selectedIndicator(t.linq(this._dataSet.indicators).first(t=>"totalPositive"==t.id)),this.autoMaxFactor(!1),this.maxFactor(1e3)}},regionExcluded:{order:11,featureName:"Mappa",html:"Nella vista nazionale puoi escludere dagli indicatori il valore di una o più regioni cliccando sulla mappa.",elementSelector:".card-map .center-align",showAfter:0,showAction:()=>{"country"!=this.viewMode()&&this.viewMode("country"),this._execludedArea.set("R8",this._geo.areas.r8),this.updateIndicator()}}},this._specialDates={current:{date:void 0,color:"#000",width:.5,label:"Giorno corrente"},dpcm8:{date:new Date(2020,2,7),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 8 Marzo (italia zona rossa)"},dpcm9:{date:new Date(2020,2,9),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 9 Marzo (italia zona rossa)"},dpcm11:{date:new Date(2020,2,11),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 11 Marzo (chiusura attività)"},mds20:{date:new Date(2020,2,20),color:"#070",dash:[5,5],width:1,visible:!1,label:"MDS 20 Marzo (chiura parchi, motoria nelle vicinane)"},dpcm22:{date:new Date(2020,2,21),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 22 Marzo (chiusura ulteriore attività)"},dpcm25:{date:new Date(2020,2,24),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 25 Marzo (maggiori sanzioni)"}},this.dayNumber=ko.observable(0),this.totalDays=ko.observable(0),this.currentData=ko.observable(),this.currentArea=ko.observable(),this.topAreas=ko.observable(),this.viewMode=ko.observable("district"),this.selectedIndicator=ko.observable(),this.selectedFactor=ko.observable(),this.autoMaxFactor=ko.observable(!0),this.maxFactor=ko.observable(),this.isPlaying=ko.observable(!1),this.isLogScale=ko.observable(!1),this.isDayDelta=ko.observable(!1),this.isZoomChart=ko.observable(!1),this.isShowEnvData=ko.observable(!1),this.groupSize=ko.observable(1),this.startDay=ko.observable(0),this.isNoFactorSelected=ko.computed(()=>this.selectedFactor()&&"none"==this.selectedFactor().id),this.groupDays=[1,2,3,4,5,6,7],this.factorDescription=ko.observable(),this._data=a.data,this._geo=a.geo,this._debugMode=a.debugMode,this._calculator=new e.IndicatorCalculator(this._data,this._dataSet,this._geo),this.totalDays(this._data.days.length-1),this.dayNumber.subscribe(t=>{t!=this._data.days.length-1&&this.tipManager.markAction("dayChanged"),this.updateDayData(),this._specialDates.current.date=new Date(this._data.days[t].date),this.updateChart()}),this._mapSvg=document.getElementsByTagName("svg").item(0),this._mapSvg.addEventListener("click",t=>this.onMapClick(t)),this.days=[];for(var i=0;i<this._data.days.length;i++)this.days.push({number:i,value:new Date(this._data.days[i].date),text:t.DateUtils.format(this._data.days[i].date,$string("$(date-format-short)"))});M.Tabs.init(document.getElementById("areaTabs")).options.onShow=t=>{this.setViewMode(t.dataset.viewMode)};const s=M.Collapsible.init(document.getElementById("topCases"));s.options.onOpenStart=()=>{this._daysData||this.updateTopAreas(),this._topAreasVisible=!0,this.tipManager.markAction("topAreasOpened")},s.options.onCloseEnd=()=>{this._topAreasVisible=!1},this.indicators=ko.computed(()=>t.linq(this._dataSet.indicators).where(t=>!t.validFor||-1!=t.validFor.indexOf(this.viewMode())).toArray()),this.factors=ko.computed(()=>t.linq(this._dataSet.factors).where(t=>!t.validFor||-1!=t.validFor.indexOf(this.viewMode())).toArray()),this.selectedIndicator.subscribe(t=>{t&&(this.updateIndicator(),"totalPositive"!=t.id&&this.tipManager.markAction("indicatorChanged",t.id))}),this.selectedFactor.subscribe(t=>{t&&(this.updateIndicator(),"none"!=t.id&&this.tipManager.markAction("factorChanged",t.id),setTimeout(()=>M.FormSelect.init(document.querySelectorAll(".row-chart-group select"))))}),this.autoMaxFactor.subscribe(t=>{t&&(this.updateMaxFactor(),this.updateMap()),this.updateUrl()}),this.maxFactor.subscribe(t=>{this.autoMaxFactor()||(this.updateMap(),this.tipManager.markAction("maxFactorChanged",t.toString())),this.updateUrl()}),this.isDayDelta.subscribe(t=>{this.computeStartDayForGroup(),this.updateIndicator(),t&&this.tipManager.markAction("deltaSelected")}),this.isLogScale.subscribe(t=>{this.updateChart(),this.updateUrl(),t&&this.tipManager.markAction("scaleChanged")}),this.isZoomChart.subscribe(t=>{this.updateChart()}),this.groupSize.subscribe(t=>{this.computeStartDayForGroup(),this.updateChart(),this.updateUrl(),t>1&&this.tipManager.markAction("groupChanged",t.toString())}),this.startDay.subscribe(t=>{this.updateChart(),this.updateUrl()});const r=new URLSearchParams(window.location.search),o=r.get("state");let n;this._keepState="true"==r.get("keepState"),this.loadPreferences(),this.tipManager=new t.TipManager(this._tips,()=>this._preferences,()=>this.savePreferences()),this.tipManager.engageUser(),n=o&&this._keepState?JSON.parse(atob(o)):{},setTimeout(()=>this.loadState(n),0),this._debugMode||window.addEventListener("beforeunload",()=>this.savePreferences())}isDefaultState(t){return!(t.day&&t.day!=this._data.days.length-1||t.view&&"region"!=t.view||t.area||t.indicator&&"totalPositive"!=t.indicator||t.factor&&"none"!=t.factor||t.maxFactor||t.dayDelta||t.logScale||t.showEnvData||t.groupSize&&1!=t.groupSize||null!=t.startDay&&0!=t.startDay||t.excludedArea)}loadState(a){if(a.view||(a.view="region"),M.Tabs.getInstance(document.getElementById("areaTabs")).select(e.ViewModes[a.view].tab),document.body.scrollTop=0,null!=a.logScale&&this.isLogScale(a.logScale),a.groupSize&&this.groupSize(a.groupSize),null!=a.startDay&&this.startDay(a.startDay),null!=a.dayDelta&&this.isDayDelta(a.dayDelta),null!=a.showEnvData&&this.isShowEnvData(a.showEnvData),a.maxFactor&&(this.autoMaxFactor(!1),this.maxFactor(a.maxFactor)),this.dayNumber(null!=a.day?a.day:this._data.days.length-1),a.excludedArea){this._execludedArea.clear();for(let t of a.excludedArea)this._execludedArea.set(t,this._geo.areas[t.toLowerCase()])}a.indicator&&this.selectedIndicator(t.linq(this._dataSet.indicators).first(t=>t.id==a.indicator)),a.factor&&this.selectedFactor(t.linq(this._dataSet.factors).first(t=>t.id==a.factor)),a.area&&(this.selectedArea=this._geo.areas[a.area.toLowerCase()])}saveStata(){return{view:"region"==this.viewMode()?void 0:this.viewMode(),indicator:this.selectedIndicator()?this.selectedIndicator().id:void 0,factor:this.selectedFactor()?this.selectedFactor().id:void 0,dayDelta:!!this.isDayDelta()||void 0,maxFactor:this.autoMaxFactor()?void 0:this.maxFactor(),day:this.dayNumber()==this._data.days.length-1?void 0:this.dayNumber(),area:this.selectedArea?this.selectedArea.id:void 0,groupSize:1==this.groupSize()?void 0:this.groupSize(),startDay:0==this.startDay()?void 0:this.startDay(),logScale:!!this.isLogScale()||void 0,excludedArea:this._execludedArea.size>0?t.linq(this._execludedArea.keys()).toArray():void 0,showEnvData:!!this.isShowEnvData()||void 0}}loadPreferences(){let t=localStorage.getItem("preferences");if(t){try{this._preferences=JSON.parse(t)}catch(t){}this._preferences&&1==this._preferences.version||(this._preferences=this.getDefaultPreferences(),this._preferences.isFirstView=!1,this._preferences.showTips=!1,this.savePreferences())}else this._preferences=this.getDefaultPreferences()}getDefaultPreferences(){return{isFirstView:!0,showTips:!0,version:1,actions:{areaSelected:0,indicatorSelected:0,indicatorChanged:0,dayChanged:0,viewChanged:0,chartActionExecuted:0,factorChanged:0,groupChanged:0,maxFactorChanged:0,scaleChanged:0,topAreasOpened:0,deltaSelected:0,regionExcluded:0}}}savePreferences(){this._preferences.isFirstView=!1,localStorage.setItem("preferences",JSON.stringify(this._preferences))}toggleChartZoom(){this._preferences.actions.chartActionExecuted++,this.isZoomChart(!this.isZoomChart())}copyMap(){return __awaiter(this,void 0,void 0,(function*(){const t=document.querySelector("svg.map"),e=t.outerHTML,a=new Blob([e],{type:"image/svg+xml"});if(navigator.clipboard&&navigator.clipboard.write){const e=document.createElement("img");e.style.width=t.clientWidth+"px",e.style.height=t.clientHeight+"px",e.onload=function(){const a=document.createElement("canvas");a.width=t.clientWidth,a.height=t.clientHeight;const i=a.getContext("2d");i.fillStyle="white",i.fillRect(0,0,a.width,a.height),i.drawImage(e,0,0),a.toBlob(t=>__awaiter(this,void 0,void 0,(function*(){let e=new ClipboardItem({[t.type]:t});yield navigator.clipboard.write([e]),M.toast({html:$string("$(msg-map-copied)")})})))},e.src=window.URL.createObjectURL(a)}else{const t=document.createElement("a");t.href=window.URL.createObjectURL(a),t.target="_blan",t.download="map.svg",t.click(),M.toast({html:$string("$(msg-no-copy)")})}}))}copyChart(){this._chart.canvas.toBlob(t=>__awaiter(this,void 0,void 0,(function*(){if(navigator.clipboard&&navigator.clipboard.write){let e=new ClipboardItem({[t.type]:t});yield navigator.clipboard.write([e]),M.toast({html:$string("$(msg-chart-copied)")})}else{const e=window.URL.createObjectURL(t),a=document.createElement("a");a.href=e,a.target="_blan",a.download=this._chart.options.title.text+".png",a.click(),M.toast({html:$string("$(msg-no-copy)")})}}))),this.tipManager.markAction("chartActionExecuted","copy")}copySerie(){return __awaiter(this,void 0,void 0,(function*(){const e=this._chart.data.datasets[0].data;let a="";for(let i=0;i<e.length;i++)a+=t.DateUtils.format(e[i].x,$string("$(date-format)"))+"\t"+i+"\t"+t.MathUtils.round(e[i].y,1)+"\n";t.DomUtils.copyText(a),M.toast({html:$string("$(msg-serie-copied)")}),this.tipManager.markAction("chartActionExecuted","copySerie")}))}copySerieForStudio(){return __awaiter(this,void 0,void 0,(function*(){let e={type:"serie",version:1,color:this.selectedIndicator().colorLight,serie:{areaId:this.selectedArea.id,indicatorId:this.selectedIndicator().id,xAxis:"dayNumber",startDay:this.startDay(),exeludedAreaIds:t.linq(this._execludedArea.keys()).toArray(),factorId:this.selectedFactor().id,groupSize:this.groupSize(),isDelta:this.isDayDelta()},title:this.factorDescription()};e.values=this._calculator.getSerie(e.serie),t.DomUtils.copyText(JSON.stringify(e)),M.toast({html:$string("$(msg-serie-copied-studio)")}),this.tipManager.markAction("chartActionExecuted","copySerieForStudio")}))}play(){this.dayNumber()==this._data.days.length-1&&this.dayNumber(0),this.isPlaying(!0),this.nextFrame()}pause(){this.isPlaying(!1)}setViewMode(t){"region"!=t&&this.tipManager.markAction("viewChanged",t),this.viewMode(t);const e=document.getElementById("group_district");"district"==t?e.style.removeProperty("display"):e.style.display="none",this.selectedArea=null,this._chart=null,this._execludedArea.clear(),this.clearMap(),this.updateMaxFactor(),this.updateDayData(),"country"==this.viewMode()?(this.selectedArea=this._geo.areas.it,this.tipManager.showTip("regionExcluded",{timeout:5})):this._topAreasVisible?this.updateTopAreas():this._daysData=void 0,setTimeout(()=>M.FormSelect.init(document.querySelectorAll(".row-indicator select")))}get selectedArea(){return this._selectedArea}set selectedArea(t){if(t!=this._selectedArea){if(this._selectedArea){const t=document.getElementById(this._selectedArea.id.toUpperCase());t&&t.classList.remove("selected")}if(this._selectedArea=t,this._selectedArea){const t=document.getElementById(this._selectedArea.id.toUpperCase());if(t){t.classList.add("selected");const e=t.parentElement;t.remove(),e.appendChild(t)}}this.changeArea()}}getFactorValue(e,a){return this._calculator.getFactorValue({dayNumberOrGroup:e,areaOrId:a,factorId:this.selectedFactor().id,indicatorId:this.selectedIndicator().id,isDayDelta:this.isDayDelta(),execludedAreas:t.linq(this._execludedArea.keys()).toArray()})}getIndicatorValue(e,a,i){return this._calculator.getIndicatorValue({dayNumber:e,areaOrId:a,indicatorId:i,isDayDelta:this.isDayDelta(),execludedAreas:t.linq(this._execludedArea.keys()).toArray()})}computeStartDayForGroup(){const t=(this.days.length-this.startDay())%this.groupSize();if(0!=t){const e=this.groupSize()-t;this.startDay()-e>=0?this.startDay(this.startDay()-e):this.startDay()+t<this.days.length-1&&this.startDay(this.startDay()+t),M.FormSelect.init(document.querySelectorAll(".row-chart-group select"))}}onMapClick(t){const e=t.target,a=e.parentElement.id,i=this._geo.areas[a.toLowerCase()];i&&("country"==this.viewMode()?(this._execludedArea.has(a)?this._execludedArea.delete(a):(this._execludedArea.set(a,i),M.toast({html:$string("$(msg-region-ex)").replace("[region]",i.name)})),this.updateIndicator()):e.parentElement.classList.contains(this.viewMode())&&(this.selectedArea=i),this.tipManager.markAction("areaSelected",i.name))}nextFrame(){this.isPlaying()&&(this.dayNumber()>=this._data.days.length-1?this.pause():this.dayNumber(parseInt(this.dayNumber().toString())+1),setTimeout(()=>this.nextFrame(),1e3))}changeArea(){if(null==this._selectedArea)this.currentArea(null);else{var t=!this.currentArea();const e=new i;e.value=this._selectedArea,this.updateArea(e),this.currentArea(e),this.updateFactorDescription(),this.updateAreaIndicators(),this.updateChart(),t&&(M.FormSelect.init(document.querySelectorAll(".row-chart-group select")),M.Tooltip.init(document.querySelectorAll(".row-chart-group .tooltipped")))}this.updateUrl()}updateAreaIndicators(){if(!this.currentArea())return;if(!this.currentArea().indicators()){const t=[];for(let e of this.indicators()){let i=new a;i.indicator=e,i.select=()=>{this.tipManager.markAction("indicatorSelected",i.indicator.id),this.selectedIndicator(e),setTimeout(()=>M.FormSelect.init(document.querySelectorAll(".row-indicator select")))},t.push(i)}this.currentArea().indicators(t)}const t=this.currentArea().value.id.toLowerCase();for(let e of this.currentArea().indicators())e.value(this.getIndicatorValue(this.dayNumber(),t,e.indicator.id))}updateFactorDescription(){let t="";if(this.isDayDelta()&&(t="$(new) "),t+=this.selectedFactor().description.replace("[indicator]",this.selectedIndicator().name),this.currentArea()&&(t+=" - "+this.currentArea().value.name),this._execludedArea.size>0){t+=" - $(except) (";let e=0;for(let a of this._execludedArea.keys())e>0&&(t+=", "),t+=this._execludedArea.get(a).name,e++;t+=")"}this.factorDescription($string(t))}updateIndicator(){this.selectedIndicator()&&this.selectedFactor()&&(this.updateFactorDescription(),this.updateMaxFactor(),this.updateDayData(),this.updateChart(),this.updateUrl(),this._topAreasVisible&&this.updateTopAreas())}updateMaxFactor(){if(!this.selectedFactor()||!this.selectedIndicator()||!this.autoMaxFactor())return;let t=Number.NEGATIVE_INFINITY,a=e.ViewModes[this.viewMode()];for(let e=0;e<this._data.days.length;e++){const i=this._data.days[e];for(let s in i.values){if(!a.validateId(s))continue;const i=this.getFactorValue(e,s);i>t&&i!=Number.POSITIVE_INFINITY&&(t=i)}}this.maxFactor(parseFloat(t.toFixed(1)))}initChart(){const e=document.querySelector("#areaGraph"),a={afterDraw:t=>{const e=t.data.datasets[0].data;if(!e||0==e.length)return;const a=t.scales["x-axis-0"],i=t.ctx;for(let e in this._specialDates){let s=this._specialDates[e];if(!s.date||!1===s.visible)continue;let r=a.getPixelForValue({x:s.date});i.lineWidth=s.width||1,i.beginPath(),i.moveTo(r,t.chartArea.top),i.lineTo(r,t.chartArea.bottom),i.strokeStyle=s.color||"#000",s.dash?i.setLineDash(s.dash):i.setLineDash([]),s.dashOffset&&(i.lineDashOffset=s.dashOffset),i.stroke()}}};this._chart=new Chart(e,{plugins:[a],type:"line",data:{datasets:[{lineTension:0,data:[],borderWidth:1}]},options:{maintainAspectRatio:!1,legend:{display:!0,position:"bottom"},title:{display:!1},tooltips:{callbacks:{label:(e,a)=>e.xLabel+": "+t.MathUtils.round(parseFloat(e.value),1)}},scales:{xAxes:[{type:"time",distribution:"linear",time:{unit:"day",tooltipFormat:"DD/MMM"}}]}}})}updateChart(){if(!this.selectedIndicator()||!this.currentArea()||!this.selectedFactor())return;null==this._chart&&this.initChart();const e=this.currentArea().value;e.id.toLowerCase(),this.selectedIndicator().id;this._chart.data.datasets[0].label=this.factorDescription(),this._chart.options.title.text=this._chart.data.datasets[0].label,this.isLogScale()?this._chart.options.scales.yAxes[0].type="logarithmic":this._chart.options.scales.yAxes[0].type="linear",this._chart.data.datasets[0].borderColor=this.selectedIndicator().colorDark,this._chart.data.datasets[0].backgroundColor=this.selectedIndicator().colorLight,this._chart.data.datasets[0].data=this._calculator.getSerie({areaId:e.id,indicatorId:this.selectedIndicator().id,xAxis:"date",startDay:this.startDay(),exeludedAreaIds:t.linq(this._execludedArea.keys()).toArray(),factorId:this.selectedFactor().id,groupSize:this.groupSize(),isDelta:this.isDayDelta()}),this._chart.update()}updateArea(e,a){if(!e||!this.selectedIndicator()||!this.selectedFactor())return;null==a&&(a=this.dayNumber());const i=e.value.id.toLowerCase(),s=e.value,r=this._data.days[a];r&&r.values[i]?(e.data(r.values[i]),e.indicator(this.getIndicatorValue(a,i,this.selectedIndicator().id)),e.factor(t.MathUtils.round(this.getFactorValue(a,s),1)),e.reference(this.selectedFactor().reference(r.values[i],s))):M.toast({html:$string("$msg-no-data)")})}updateTopAreas(){this._daysData=[];for(let a=0;a<this._data.days.length;a++){const s=this._data.days[a],r={},o=e.ViewModes[this.viewMode()].validateId;r.topAreas=t.linq(s.values).select(t=>({factor:this.getFactorValue(a,t.key),value:t})).orderByDesc(t=>t.factor).where(t=>o(t.value.key)).select(t=>{const e=new i;return e.value=this._geo.areas[t.value.key.toLowerCase()],e.select=()=>this.selectedArea=e.value,this.updateArea(e,a),e}).take(25).toArray(),this._daysData.push(r)}this.topAreas(this._daysData[this.dayNumber()].topAreas)}updateDayData(){const e=this._data.days[this.dayNumber()];this.currentData(t.DateUtils.format(e.date,$string("$(date-format)"))),this.updateMap(),this.updateArea(this.currentArea()),this.updateAreaIndicators(),this._daysData&&this._topAreasVisible&&this.topAreas(this._daysData[this.dayNumber()].topAreas),this.updateUrl()}updateUrl(){if(!this._keepState)return;const e=this.saveStata();let a=t.app.baseUrl+"Overview";this.isDefaultState(e)||(a+="?state="+encodeURIComponent(btoa(JSON.stringify(e)))+"&keepState=true"),history.replaceState(null,null,a)}clearMap(){const t=this._data.days[this.dayNumber()];for(const e in t.values){const t=document.getElementById(e.toUpperCase());t&&t.style.removeProperty("fill")}}updateMap(){if(this.selectedIndicator()&&this.selectedFactor())if("country"!=this.viewMode()){const a=this._data.days[this.dayNumber()],i=new t.LinearGradient("#fff",this.selectedIndicator().colorDark);for(const s in a.values){const a=document.getElementById(s.toUpperCase());if(a){const r=this._geo.areas[s];if(r.type!=e.ViewModes[this.viewMode()].areaType)continue;let o=this.getFactorValue(this.dayNumber(),r);if(o==Number.POSITIVE_INFINITY&&(o=NaN),o=Math.min(1,o/this.maxFactor()),isNaN(o))a.classList.contains("valid")&&a.classList.remove("valid"),a.style.removeProperty("fill");else{a.classList.contains("valid")||a.classList.add("valid");t.MathUtils.discretize(t.MathUtils.exponential(o),20);a.style.fill=i.valueAt(.15+.85*o).toString()}}}}else t.linq(document.querySelectorAll("g.region")).foreach(t=>{this._execludedArea.has(t.id)?t.style.fill="#444":t.style.fill="#FFF"})}}}(t.GeoPlot||(t.GeoPlot={}))}(WebApp||(WebApp={})),function(t){!function(e){function a(t){if(null!=t&&null!=t)return t.toString()}class i{constructor(t){this.min=ko.observable(),this.max=ko.observable(),this.step=ko.observable(),this.isSelected=ko.observable(!0),this.value=t.value,this.name=t.name}}class s{constructor(){this.vars={}}setExpressions(e){const a=this.calculator.getState();for(let i of e){const e=t.linq(a.expressions.list).first(t=>t.id==i.id);if(e)for(let t of Object.getOwnPropertyNames(i))e[t]=i[t];else a.expressions.list.push(i)}const i=t.linq(a.expressions.list).where(t=>"folder"!=t.type).groupBy(t=>t.folderId?t.folderId:"").toDictionary(t=>t.key,t=>t.values.toArray()),s=[];for(let e of t.linq(a.expressions.list).where(t=>"folder"==t.type)){s.push(e);const t=i[e.id];if(t)for(let e of t)s.push(e)}const r=i[""];if(r)for(let t of r)s.push(t);a.expressions.list=s,this.calculator.setState(a)}setColor(t,e){this.calculator.controller.dispatch({type:"set-item-color",id:t,color:e})}updateTable(e,a){const i=t.linq(this.calculator.getExpressions()).where(t=>t.id==e).first();i&&(i.columns[0].values=t.linq(a).select(t=>t.x.toString()).toArray(),i.columns[1].values=t.linq(a).select(t=>t.y.toString()).toArray(),this.calculator.setExpression(i))}updateExpression(e){t.linq(this.calculator.getExpressions()).where(t=>t.id==e.id).first();this.calculator.setExpression(e)}updateVariable(t,e,a){e&&this.updateExpression({id:t,latex:e+"="+a.toString()})}expressionZoomFit(t){this.calculator.controller.dispatch({type:"expression-zoom-fit",id:t})}setItemVisibile(t,e){this.updateExpression({id:t,hidden:!e})}generateVars(t){for(let e in t)t[e]||(t[e]=this.generateVar(e))}generateVar(t="a"){return this.vars[t[0]]||(this.vars[t[0]]=0),this.vars[t[0]]++,t[0]+"_{"+this.vars[t[0]]+"}"}}class r{constructor(){this.canDrag=!1,this.name=ko.observable(),this.time=ko.observable(0),this.color=ko.observable(),this.parameters=ko.observableArray()}createActions(e){e.push(t.apply(new d,t=>{t.text=$string("$(delete)"),t.icon="delete",t.execute=()=>this.remove()}))}canAccept(t){return!1}canReadData(t){return!1}readData(t){}writeData(t){return!1}setState(t){t.name&&this.name(t.name),null!=t.visible&&this.node.isVisible(t.visible),t.color&&this.color(t.color),null!=t.opened&&this.node.isExpanded(t.opened),t.folderId&&(this.folderId=t.folderId),this.setStateWork(t),this.updateGraph(),this.setChildrenStateWork(t)}getState(){return{name:this.name(),visible:this.node.isVisible(),folderId:this.folderId,color:this.color(),opened:this.node.isExpanded()}}getVar(t){return this._varsMap[t]}remove(t=!0){this._graphCtx&&(this._graphCtx.calculator.removeExpression({id:this.getGraphId("private")}),this._graphCtx.calculator.removeExpression({id:this.getGraphId("public")})),this.node.remove(),t&&this.children.foreach(t=>t.remove())}attachNode(t){this.node=t,this.node.isVisible.subscribe(t=>this.updateGraphVisibility()),this.node.isSelected.subscribe(t=>{t&&this.onSelected()});const e=[];this.createActions(e),this.node.actions(e)}attachGraph(t){this._graphCtx=t,this._graphCtx.calculator.observe("expressionAnalysis",()=>this.onGraphChanged()),this.color.subscribe(t=>this.updateColor())}isFullVisible(){let t=this.node;for(;t;){if(!t.isVisible())return!1;t=t.parentNode}return!0}updateGraphVisibility(t=!0){const e=this.isFullVisible();return this._graphCtx.setItemVisibile(this.getGraphId("public"),e),this._graphCtx.setItemVisibile(this.getGraphId("private"),e),t&&this.children.foreach(t=>t.updateGraphVisibility()),e}updateGraph(e=!0){if(!this._graphCtx)return;this.folderId||(this.folderId=t.StringUtils.uuidv4());const a=this.getExpressions();this._graphCtx.setExpressions(a),this.updateGraphWork(),this.updateGraphVisibility(),this.updateParameters(),e&&this.children.foreach(t=>t.updateGraph(e))}onParentChanged(){this.updateGraphVisibility()}get parent(){return this.node.parentNode.value()}get children(){return t.linq(this.node.nodes()).select(t=>t.value())}replaceVars(t){for(let e in this._varsMap){const a=new RegExp("\\$"+e,"g");t=t.replace(a,this._varsMap[e])}return t}getGraphId(t){return this.folderId+"/"+t}addChildrenWork(t,e=!0){const a=new u(t);return this.node.addNode(a),t.attachNode(a),t.attachGraph(this._graphCtx),e&&t.updateGraph(),t.onParentChanged(),t}createParameters(t){return!1}updateParameters(){const t=[];this.createParameters(t)&&(this.parameters.removeAll(),t.forEach(t=>this.parameters.push(t)))}updateGraphWork(){}setChildrenStateWork(t){}onSelected(){}onGraphChanged(){}updateColor(){}}class o{constructor(){this.vars=ko.observable()}select(){}}class n{constructor(){this.curValue=ko.observable(),this.autoCompute=ko.observable(),this.min=ko.observable(),this.max=ko.observable(),this.step=ko.observable()}}class l extends r{constructor(t){super(),this._varsMap={},this.selectedFunction=ko.observable(),this.showIntegration=ko.observable(!0),this.maxDay=ko.observable(),this.endDay=ko.observable(),this._varsMap={fun:null,sum:null,n1:null,n2:null,value:null,time:null,tend:null,xp:null},this.itemType="regression",this.icon="show_chart",this.optionsTemplateName="RegressionOptionsTemplate",this.functions=[],this.addFunction({name:$string("$(log-normal)"),type:"log-normal",value:"$y\\sim $c\\cdot\\frac{ e^ {-\\frac{ \\left(\\ln\\ \\left($x - $a\\right) \\ -$u\\right)^ { 2}} { 2$o^ { 2} }}}{ \\left($x - $a\\right) \\sqrt{ 2\\pi } $o }",vars:[{name:"a",label:$string("$(offset)"),autoCompute:!0,precision:0},{name:"c",label:$string("$(total)"),autoCompute:!0,precision:0},{name:"o",label:$string("$(variance)"),autoCompute:!0,precision:5},{name:"u",label:$string("$(average)"),autoCompute:!0,precision:5}]}),this.addFunction({name:$string("$(normal)"),type:"normal",value:"$y\\sim $c\\cdot\\ \\left(\\frac{1}{\\sqrt{2\\cdot\\pi}\\cdot $o}\\right)\\cdot e^{-\\frac{1}{2}\\cdot\\left(\\frac{\\left($x-$u\\right)}{$o}\\right)^{2}}",vars:[{name:"c",label:$string("$(total)"),autoCompute:!0,precision:0},{name:"o",label:$string("$(variance)"),autoCompute:!0,precision:5},{name:"u",label:$string("$(avg-peak)"),autoCompute:!0,precision:0}]}),this.addFunction({name:$string("$(exponential)"),type:"exponential",value:"$y\\sim $a^{\\left($x-$b\\right)}",vars:[{name:"a",label:$string("$(base)"),autoCompute:!0,precision:5},{name:"b",label:$string("$(offset)"),autoCompute:!0,precision:5}]}),this.addFunction({name:$string("$(linear)"),type:"linear",value:"$y\\sim $a+$m$x",vars:[{name:"a",label:$string("$(offset)"),autoCompute:!0,precision:5},{name:"m",label:$string("$(slope)"),autoCompute:!0,precision:5}]}),this.showIntegration.subscribe(()=>{this._graphCtx.setItemVisibile(this.getGraphId("sum-serie"),this.isFullVisible()&&this.showIntegration()),this._graphCtx.setItemVisibile(this.getGraphId("sum-point"),this.isFullVisible()&&this.showIntegration())}),this.selectedFunction.subscribe(t=>{if(!this.name()&&t)return this.name(t.value.name)}),this.endDay.subscribe(t=>this.updateEndDay()),this.maxDay.subscribe(t=>this.updateEndDay()),this.selectedFunction(this.functions[0]),t&&this.setState(t)}addFunction(t){const e=new o;e.value=t,e.select=()=>{this.selectedFunction(e),this.name(e.value.name),this.updateGraph()};const a=[];for(let e of t.vars){const t=new n;t.value=e,t.curValue(e.value),t.autoCompute(e.autoCompute),t.min(e.minValue),t.max(e.maxValue),t.step(e.step),t.min.subscribe(t=>e.minValue=t),t.max.subscribe(t=>e.maxValue=t),t.step.subscribe(t=>e.step=t),t.curValue.subscribe(t=>e.value=t),t.autoCompute.subscribe(t=>{e.autoCompute=t,this.updateGraph()}),t.curValue.subscribe(a=>{t.autoCompute()||this._graphCtx.updateVariable(this.getGraphId(e.name+"-value"),this.getVar(e.name),a)}),a.push(t)}return e.vars(a),this.functions.push(e),e}onGraphChanged(){this.updateRegressionVars()}updateRegressionVars(){let e=this._graphCtx.calculator.controller.getItemModel(this.getGraphId("main"));if(e&&e.regressionParameters)for(let a of this.selectedFunction().vars()){const i=this.getVar(a.value.name).replace("{","").replace("}","");let s=e.regressionParameters[i];null!=s&&(null!=a.value.precision&&(s=t.MathUtils.round(s,a.value.precision)),a.curValue(s))}}createParameters(e){return e.push(t.apply(new i({value:this.endDay,name:$string("$(reg-days)")}),t=>{t.max=this.maxDay,t.min(0),t.step(1)})),!0}setStateWork(e){if(e.function){const a=t.linq(this.functions).first(t=>t.value.type==e.function.type);if(a){for(let i of e.function.vars){const e=t.linq(a.vars()).first(t=>t.value.name==i.name);e&&(e.autoCompute(i.autoCompute),e.max(i.maxValue),e.min(i.minValue),e.step(i.step),e.curValue(i.value))}this.selectedFunction(a)}}null!=e.showIntegration&&this.showIntegration(e.showIntegration)}getState(){const t=super.getState();t.function=this.selectedFunction().value,t.showIntegration=this.showIntegration();for(let t of this.selectedFunction().vars())t.value.value=t.curValue(),t.value.maxValue=t.max(),t.value.minValue=t.min(),t.value.step=t.step(),t.value.autoCompute=t.autoCompute();return t}onParentChanged(){super.onParentChanged(),this.color(this.parent.color()),this.maxDay(t.linq(this.parent.values).max(t=>t.x)),null==this.endDay()&&this.endDay(this.maxDay())}updateEndDay(){this._varsMap.tend&&this._graphCtx.updateExpression({type:"expression",id:this.getGraphId("end-day"),latex:this._varsMap.tend+"="+this.endDay(),slider:{min:"0",step:"1",max:this.maxDay().toString()}})}updateColor(){this._graphCtx.setColor(this.getGraphId("main-func"),this.color()),this._graphCtx.setColor(this.getGraphId("sum-serie"),this.color()),this._graphCtx.setColor(this.getGraphId("sum-point"),this.color()),this._graphCtx.setColor(this.getGraphId("end-day-line"),this.color())}updateGraphWork(){this.updateRegressionVars()}getExpressions(){const t=[];t.push({type:"folder",id:this.getGraphId("public"),title:this.parent.name()+" - "+this.name(),collapsed:!0}),t.push({type:"folder",id:this.getGraphId("private"),secret:!0,title:this.parent.name()+" - "+this.name(),collapsed:!0});const e=this.selectedFunction().value;this._varsMap.x="",this._varsMap.y=this.parent.getVar("y"),this._varsMap.time=this.parent.parent.getVar("time");for(let t of e.vars)this._varsMap[t.name]||(this._varsMap[t.name]=null);this._graphCtx.generateVars(this._varsMap),this._varsMap.x=this.getVar("xp"),t.push({type:"expression",id:this.getGraphId("main"),folderId:this.getGraphId("private"),latex:this.replaceVars(e.value),hidden:!0}),t.push({type:"expression",id:this.getGraphId("main-func"),folderId:this.getGraphId("private"),latex:this.replaceVars(e.value.replace("$y\\sim ","$fun\\left(x\\right)=").replace(/\$x/g,"x")),color:this.parent.color(),lineStyle:Desmos.Styles.DASHED}),t.push({type:"expression",id:this.getGraphId("sum-func"),folderId:this.getGraphId("private"),latex:this.replaceVars("$sum\\left(x\\right)=\\sum_{$n1=1}^{x}\\operatorname{round}\\left($fun\\left($n1\\right)\\right)"),hidden:!0}),t.push({type:"expression",id:this.getGraphId("sum-x-time"),folderId:this.getGraphId("private"),latex:this.replaceVars("$n2=\\left[1,...,$time\\right]")}),t.push({type:"expression",id:this.getGraphId("sum-serie"),folderId:this.getGraphId("private"),latex:this.replaceVars("\\left($n2,\\ $sum\\left($n2\\right)\\right)"),color:this.parent.color(),lines:!0,hidden:!this.showIntegration(),lineStyle:Desmos.Styles.SOLID,pointStyle:"NONE",points:!1}),t.push({type:"expression",id:this.getGraphId("sum-value"),folderId:this.getGraphId("public"),latex:this.replaceVars("$value=$sum\\left($time\\right)")}),t.push({type:"expression",id:this.getGraphId("sum-point"),folderId:this.getGraphId("private"),hidden:!this.showIntegration(),latex:this.replaceVars("\\left($time,$value\\right)"),color:this.parent.color(),label:this.parent.name(),dragMode:"XY",showLabel:!0}),t.push({type:"expression",id:this.getGraphId("end-day"),latex:this._varsMap.tend+"="+this.endDay(),folderId:this.getGraphId("public"),label:"Giorni Previsione",slider:{min:(0).toString(),max:this.maxDay().toString(),hardMax:!0,hardMin:!0,step:"1"}}),t.push({type:"expression",id:this.getGraphId("end-day-line"),color:this.color(),latex:"x="+this._varsMap.tend,folderId:this.getGraphId("private"),lines:!0}),t.push({type:"expression",id:this.getGraphId("end-day-serie"),latex:this.replaceVars("$xp=[0,...,$tend]+"+this.parent.getVar("ofs")),folderId:this.getGraphId("private"),hidden:!0});for(let e of this.selectedFunction().vars())e.autoCompute()?this._graphCtx.calculator.removeExpression({id:this.getGraphId(e.value.name+"-value")}):t.push({type:"expression",id:this.getGraphId(e.value.name+"-value"),latex:this.getVar(e.value.name)+"="+(e.curValue()?e.curValue().toString():"0"),folderId:this.getGraphId("public"),label:e.value.name,slider:{min:a(e.value.minValue),max:a(e.value.maxValue),hardMax:!0,hardMin:!0,step:a(e.value.step)}});return t}}class h extends r{constructor(t){super(),this.color=ko.observable(),this.offsetX=ko.observable(0),this.canDrag=!0,this.itemType="serie",this.icon="insert_chart",this.optionsTemplateName="StudioOptionsTemplate",this._varsMap={x:null,y:null,ofs:null,xofs:null},t&&this.setState(t)}writeData(t){var e={version:1,type:"serieState",state:this.getState()};return t.setData("application/json+studio",JSON.stringify(e)),t.setData("text/html+id",this.node.element.id),!0}createActions(e){super.createActions(e),e.push(t.apply(new d,t=>{t.text=$string("$(update)"),t.icon="autorenew",t.execute=()=>this.updateSerie()})),e.push(t.apply(new d,t=>{t.text=$string("$(new-regression)"),t.icon="add_box",t.execute=()=>{const t=this.addRegression(null,!1);t.updateGraph(),this.node.isExpanded(!0),t.node.isSelected(!0)}})),e.push(t.apply(new d,t=>{t.text=$string("$(zoom)"),t.icon="zoom_in",t.execute=()=>{this.zoom()}}))}static fromText(t){try{const e=JSON.parse(t);if(e){if("serie"==e.type)return new h({name:e.title,values:e.values,source:e.serie,color:e.color});if("serieState"==e.type)return new h(e.state)}}catch(t){}}getExpressions(){return this.color()||this.color("#0000ff"),this._graphCtx.generateVars(this._varsMap),[{type:"folder",id:this.getGraphId("public"),title:this.parent.name()+" - "+this.name(),collapsed:!0},{type:"folder",id:this.getGraphId("private"),title:this.parent.name()+" - "+this.name(),secret:!0,collapsed:!0},{type:"expression",id:this.getGraphId("offset"),latex:this._varsMap.ofs+"="+this.offsetX(),folderId:this.getGraphId("public"),label:"Scostamento",slider:{min:(-this.values.length).toString(),max:this.values.length.toString(),hardMax:!0,hardMin:!0,step:"1"}},{type:"expression",id:this.getGraphId("offset-x"),latex:this._varsMap.xofs+"="+this._varsMap.x+"+"+this._varsMap.ofs,folderId:this.getGraphId("private")},{type:"expression",id:this.getGraphId("offset-x-serie"),latex:"("+this._varsMap.xofs+","+this._varsMap.y+")",folderId:this.getGraphId("private"),points:!0,lines:!0,color:this.color()},{type:"table",id:this.getGraphId("table"),folderId:this.getGraphId("private"),columns:[{id:this.getGraphId("table/x"),latex:this._varsMap.x},{id:this.getGraphId("table/y"),latex:this._varsMap.y,hidden:!0}]}]}createParameters(e){return e.push(t.apply(new i({value:this.offsetX,name:$string("$(shift)")}),t=>{t.max(this.values.length),t.min(-this.values.length),t.step(1)})),!0}updateGraphWork(){this._graphCtx.updateTable(this.getGraphId("table"),this.values)}onGraphChanged(){}onSelected(){this._graphCtx.expressionZoomFit(this.getGraphId("table"))}updateColor(){this._graphCtx.setColor(this.getGraphId("offset-x-serie"),this.color()),this.children.foreach(t=>t.onParentChanged())}attachGraph(t){super.attachGraph(t),this.offsetX.subscribe(t=>this._graphCtx.updateVariable(this.getGraphId("offset"),this._varsMap.ofs,t))}setChildrenStateWork(t){null!=t.children&&(this.children.foreach(t=>t.remove()),t.children.forEach(t=>{this.addRegression(null,!1).setState(t)}))}setStateWork(t){null!=t.offsetX&&this.offsetX(t.offsetX),t.source&&(this.source=t.source),null!=t.values&&(this.values=t.values)}getState(){const t=super.getState();return t.offsetX=this.offsetX(),t.source=this.source,t.values=this.values,t.children=this.children.select(t=>t.getState()).toArray(),t}addRegression(t,e=!0){return this.addChildrenWork(t instanceof l?t:new l(t),e)}updateSerie(){return __awaiter(this,void 0,void 0,(function*(){if(!this._graphCtx.serieCalculator){M.toast({html:$string("$(msg-downloading-data)")});const t=yield e.Api.loadStudioData();this._graphCtx.serieCalculator=new e.IndicatorCalculator(t.data,e.InfectionDataSet,t.geo)}this.values=this._graphCtx.serieCalculator.getSerie(this.source),this._graphCtx.updateTable(this.getGraphId("table"),this.values),this.children.foreach(t=>t.onParentChanged()),M.toast({html:$string("$(msg-update-complete)")})}))}zoom(){const e=t.linq(this.values).min(t=>t.x),a=t.linq(this.values).min(t=>t.y),i=t.linq(this.values).max(t=>t.x),s=t.linq(this.values).max(t=>t.y);this._graphCtx.calculator.setMathBounds({top:s+.1*(s-a),right:i+.1*(i-e),bottom:a-.1*(s-a),left:e-.1*(i-e)})}}class c extends r{constructor(t){super(),this.time=ko.observable(0),this.itemType="project",this.icon="folder",this.optionsTemplateName="ProjectOptionsTemplate",this._varsMap={time:null},t&&this.setState(t)}canAccept(t){return t instanceof h}canReadData(t){return-1!=t.types.indexOf("application/json+studio")}readData(t){const e=t.getData("application/json+studio");let a=h.fromText(e);a&&(this.addSerie(a),this.node.isExpanded(!0))}getExpressions(){return this._graphCtx.generateVars(this._varsMap),[{type:"folder",id:this.getGraphId("public"),title:this.name(),collapsed:!0},{type:"expression",folderId:this.getGraphId("public"),id:this.getGraphId("time"),latex:this._varsMap.time+"="+this.time(),slider:{hardMin:!0,hardMax:!0,min:"0",max:"100",step:"1"}}]}createParameters(e){return e.push(t.apply(new i({value:this.time,name:$string("$(day)")}),t=>{t.max(100),t.min(0),t.step(1)})),!0}setStateWork(t){null!=t.time&&this.time(t.time)}setChildrenStateWork(t){null!=t.children&&(this.children.foreach(t=>t.remove()),t.children.forEach(t=>{this.addSerie(null,!1).setState(t)}))}getState(){const t=super.getState();return t.time=this.time(),t.children=this.children.select(t=>t.getState()).toArray(),t}onGraphChanged(){}attachGraph(t){super.attachGraph(t),this.time.subscribe(t=>this._graphCtx.updateVariable(this.getGraphId("time"),this._varsMap.time,this.time()))}addSerie(t,e=!0){return this.addChildrenWork(t instanceof h?t:new h(t),e)}}class d{execute(){}}class u{constructor(t){this._dargEnterCount=0,this.nodes=ko.observableArray(),this.value=ko.observable(),this.isSelected=ko.observable(!1),this.isVisible=ko.observable(!0),this.isExpanded=ko.observable(!1),this.actions=ko.observable(),this.value(t),this.isSelected.subscribe(t=>{t&&this._treeView.select(this)})}get element(){return this._element}attachNode(e){this._element=e,this._element.id=t.DomUtils.generateId(),this._element.$model=this;let a=this._element.querySelector("header");a.ondragstart=t=>this.onDrag(t),a.ondragover=t=>this.onDragOver(t),a.ondragenter=t=>this.onDragEnter(t),a.ondragleave=t=>this.onDragLeave(t),a.ondrop=t=>this.onDrop(t)}onDrag(t){if(!this.value().writeData(t.dataTransfer)||!this.value().canDrag)return t.preventDefault(),!1}onDragEnter(t){this._dargEnterCount++}onDragLeave(e){this._dargEnterCount--,0==this._dargEnterCount&&t.DomUtils.removeClass(this._element,"drop")}onDragOver(e){if(e.preventDefault(),1==this._dargEnterCount){let a=!0;this.value().canReadData(e.dataTransfer)||(a=!1),a?(e.ctrlKey?e.dataTransfer.dropEffect="copy":e.dataTransfer.dropEffect="move",t.DomUtils.addClass(this._element,"drop")):e.dataTransfer.dropEffect="move"}}onDrop(e){e.preventDefault(),this._dargEnterCount=0,t.DomUtils.removeClass(this._element,"drop");const a=e.dataTransfer.getData("text/html+id");if(a){const t=document.getElementById(a).$model;if(!this.value().canAccept(t.value()))return;if(!e.ctrlKey){if(t._parentNode==this)return;return t._parentNode.nodes.remove(t),t._parentNode=this,this.nodes.push(t),this.isExpanded(!0),void t.value().onParentChanged()}}else this.value().readData(e.dataTransfer)}remove(){this._parentNode&&this._parentNode.nodes.remove(this),this._treeView.selectedNode()==this&&this._treeView.select(null)}addNode(t){t.attach(this._treeView,this),this.nodes.push(t)}attach(t,e){this._treeView=t,this._parentNode=e;for(let e of this.nodes())e.attach(t)}get parentNode(){return this._parentNode}toggleVisible(){this.isVisible(!this.isVisible())}toggleSelection(){this.isSelected(!this.isSelected())}expandCollapse(){this.isExpanded(!this.isExpanded())}}class p{constructor(){this.root=ko.observable(),this.selectedNode=ko.observable()}select(t){this.selectedNode()!=t&&(this.selectedNode()&&this.selectedNode().isSelected(!1),this.selectedNode(t),this.selectedNode()&&this.selectedNode().isSelected(!0))}setRoot(t){t.attach(this),this.root(t)}}e.TreeViewModel=p;e.StudioPage=class{constructor(e){this.items=new p,this.maxX=ko.observable(),this.maxY=ko.observable(),this._projectId=e,this._graphCtx=new s,this._graphCtx.calculator=Desmos.GraphingCalculator(document.getElementById("calculator"),{pasteGraphLink:!1,pasteTableData:!1,expressionsCollapsed:!0,restrictedFunctions:!0,administerSecretFolders:!0,authorIDE:!0,advancedStyling:!0});const a=[];a.push(t.apply(new d,t=>{t.text=$string("$(new-project)"),t.icon="create_new_folder",t.execute=()=>this.newProject()})),a.push(t.apply(new d,t=>{t.text=$string("$(save)"),t.icon="save",t.execute=()=>this.saveState()})),a.push(t.apply(new d,t=>{t.text=$string("$(options)"),t.icon="settings",t.execute=()=>this.showOptions()})),a.push(t.apply(new d,t=>{t.text=$string("$(share) Studio"),t.icon="share",t.execute=()=>this.share()}));const i=new u;i.actions(a),this.items.setRoot(i),document.body.addEventListener("paste",t=>{this.onPaste(t.clipboardData)&&t.preventDefault()}),document.body.addEventListener("keydown",t=>{this.onKeyDown(t)}),M.Modal.init(document.getElementById("options"),{onCloseEnd:()=>this.updateOptions()}),setTimeout(()=>this.init())}updateOptions(){const t=parseInt(this.maxX()),e=parseInt(this.maxY());this._graphCtx.calculator.setMathBounds({bottom:-e/10,left:-t/10,right:t,top:e})}share(){return __awaiter(this,void 0,void 0,(function*(){const a=t.StringUtils.uuidv4();yield e.Api.saveState(a,this.getState());const i=t.Uri.absolute("~/"+$language.split("-")[0]+"/Studio/"+a);yield t.DomUtils.copyText(i),M.toast({html:$string("$(msg-shared)")})}))}showOptions(){const t=this._graphCtx.calculator.graphpaperBounds;this.maxX(Math.round(t.mathCoordinates.width)),this.maxY(Math.round(t.mathCoordinates.height)),M.Modal.getInstance(document.getElementById("options")).open()}removeSelected(){if(!this.items.selectedNode())return;this.items.selectedNode().value().remove()}getSelectedProject(){if(!this.items.selectedNode())return;const t=this.items.selectedNode().value();return"project"==t.itemType?t:"serie"==t.itemType?t.parent:"regression"==t.itemType?t.parent.parent:void 0}newProject(){const t=this.addProject({name:"Project "+(this.projects.count()+1)});return t.node.isSelected(!0),t}addProject(t,e=!0){const a=new c(t),i=new u(a);return this.items.root().addNode(i),a.attachNode(i),a.attachGraph(this._graphCtx),e&&a.updateGraph(),a}getState(){const t={version:2};return t.graphState=this._graphCtx.calculator.getState(),t.vars=this._graphCtx.vars,t.projects=this.projects.select(t=>t.getState()).toArray(),t}setState(t){t&&(t.graphState&&(t.graphState.expressions.list=[],this._graphCtx.calculator.setState(t.graphState)),null!=t.projects&&(this.projects.toArray().forEach(t=>t.remove()),t.projects.forEach(t=>{this.addProject(null,!1).setState(t)})))}loadState(){return __awaiter(this,void 0,void 0,(function*(){if(this._projectId){let t=yield e.Api.loadState(this._projectId);this.setState(t)}else{const t=localStorage.getItem("studio");t&&this.setState(JSON.parse(t))}}))}saveState(){return __awaiter(this,void 0,void 0,(function*(){this._projectId?(yield e.Api.saveState(this._projectId,this.getState()),M.toast({html:$string("$(msg-saved)")})):(localStorage.setItem("studio",JSON.stringify(this.getState())),M.toast({html:$string("$(msg-saved-device)")}))}))}demo(){const t=this.addProject({name:"Project 1"});this.addProject({name:"Project 2"}),this.addProject({name:"Project 3"}),t.addSerie({name:"Serie 1"})}onKeyDown(t){46==t.keyCode&&"INPUT"!=t.target.tagName&&(t.preventDefault(),this.removeSelected())}onPaste(t){let e=this.getSelectedProject();if(e||this.projects.any()||(e=this.newProject()),e){const a=t.getData("text/plain").toString();if(a){const t=h.fromText(a);if(t){e.addSerie(t),e.node.isExpanded(!0),t.node.isExpanded(!0),t.zoom();const a=t.addRegression(null,!1);return a.updateGraph(),a.node.isSelected(!0),!0}}}else M.toast({html:$string("$(msg-select-project)")})}get projects(){return t.linq(function*(){for(let t of this.items.root().nodes())yield t.value()}.apply(this))}init(){return __awaiter(this,void 0,void 0,(function*(){this.loadState()}))}test(){return __awaiter(this,void 0,void 0,(function*(){var a=new e.TextTableDataAdapter({}),i=yield t.Http.getStringAsync("https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-regioni/dpc-covid19-ita-regioni.csv");a.parse(i)}))}}}(t.GeoPlot||(t.GeoPlot={}))}(WebApp||(WebApp={}));