var WebApp,__awaiter=this&&this.__awaiter||function(e,t,a,i){return new(a||(a=Promise))((function(s,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function n(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};function capitalizeFirst(e){return e.substr(0,1).toUpperCase()+e.substr(1)}function expandCollapse(e){let t=e.parentElement,a=t.querySelector(".section-content");t.classList.contains("closed")?(a.style.removeProperty("display"),t.classList.remove("closed")):(t.classList.add("closed"),setTimeout(()=>a.style.display="none",300))}!function(e){!function(t){let a;!function(t){t.saveState=function(t,a){return __awaiter(this,void 0,void 0,(function*(){let i=yield e.Http.postJsonAsync("~/SaveState/"+t,a);if(!i.isSuccess)throw i.error;return i.data}))},t.loadState=function(t){return __awaiter(this,void 0,void 0,(function*(){let a=yield e.Http.getJsonAsync("~/LoadState/"+t);if(!a.isSuccess)throw a.error;return a.data}))},t.loadStudioData=function(){return __awaiter(this,void 0,void 0,(function*(){return yield e.Http.getJsonAsync("~/StudioData")}))}}(a=t.Api||(t.Api={}))}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),function(e){let t;!function(t){t.GeoPlotApplication=class{constructor(){}initServices(){e.Services.httpClient=new e.XHRHttpClient}}}(t=e.GeoPlot||(e.GeoPlot={})),e.app=new t.GeoPlotApplication}(WebApp||(WebApp={})),HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(e,t,a){let i=this;setTimeout(()=>{const s=atob(i.toDataURL(t,a).split(",")[1]),r=s.length,o=new Uint8Array(r);for(let e=0;e<r;e++)o[e]=s.charCodeAt(e);e(new Blob([o],{type:t||"image/png"}))})}}),window.Chart&&Chart.plugins.register({beforeDraw:function(e){var t=e.ctx;t.fillStyle="white",t.fillRect(0,0,e.width,e.height)}}),function(e){!function(t){t.ConstIndicatorFunction=class{constructor(e){this._value=e}value(e,t,a,i,s){let r=this._value(e,s);if(a)for(var o in a)r-=this.value(a[o],i[o],null,null,s);return r}};t.SimpleIndicatorFunction=class{constructor(e){this._value=e}value(e,t,a,i,s){var r=this._value(e,s);if(t&&(r-=this._value(t,s)),a)for(var o in a)r-=this.value(a[o],i[o],null,null,s);return r}};t.CombineIndicatorFunction=class{constructor(e,t){this._value=t,this._indicators=e}value(e,t,a,i,s){const r={};for(var o in this._indicators)r[o]=this._indicators[o].value(e,t,a,i,s);return this._value(r)}};t.SimpleFactorFunction=class{constructor(e){this._value=e}value(e,t,a,i,s,r){let o=0;for(var n in e)o+=r.value(e[n],t[n],a[n],i[n],s);return this._value(o,e[0],s)}};t.DoubleFactorFunction=class{constructor(e,t){this._value=e,this._factor=t}value(e,t,a,i,s,r){let o=0,n=0;for(var l in e)o+=r.value(e[l],t[l],a[l],i[l],s),n+=this._factor.value(e[l],t[l],a[l],i[l],s);return this._value(o,n)}};t.IndicatorCalculator=class{constructor(e,t,a){this._data=e,this._dataSet=t,this._geo=a}getFactorValue(t){const a=("string"==typeof t.areaOrId?t.areaOrId:t.areaOrId.id).toLowerCase(),i=(e,t)=>e<0?void 0:this._data.days[e].values[t];let s;s=Array.isArray(t.dayNumberOrGroup)?t.dayNumberOrGroup:[t.dayNumberOrGroup];let r=[],o=[],n=[],l=[];for(var h of s)if(r.push(i(h,a)),t.isDayDelta&&o.push(i(h-1,a)),t.execludedAreas){var c=[],d=[];for(var u of t.execludedAreas)c.push(i(h,u.toLowerCase())),t.isDayDelta&&d.push(i(h-1,u.toLowerCase()));n.push(c),l.push(d)}const p=e.linq(this._dataSet.factors).first(e=>e.id==t.factorId),m=e.linq(this._dataSet.indicators).first(e=>e.id==t.indicatorId);return p.compute.value(r,o,n,l,this._geo.areas[a],m.compute)}getIndicatorValue(t){const a=("string"==typeof t.areaOrId?t.areaOrId:t.areaOrId.id).toLowerCase(),i=e.linq(this._dataSet.indicators).first(e=>e.id==t.indicatorId),s=(e,t)=>e<0?void 0:this._data.days[e].values[t];let r,o,n,l=s(t.dayNumber,a);if(t.isDayDelta&&(r=s(t.dayNumber-1,a)),t.execludedAreas)for(var h of(o=[],n=[],t.execludedAreas))o.push(s(t.dayNumber,h.toLowerCase())),t.isDayDelta&&n.push(s(t.dayNumber-1,h.toLowerCase()));return i.compute.value(l,r,o,n,this._geo.areas[a])}getSerie(e){const t=[];if(e.groupSize>1){let a=e.groupSize,i=[];for(let s=0+e.startDay;s<this._data.days.length;s++)if(i.push(s),a--,0==a){const r={x:"date"==e.xAxis?new Date(this._data.days[s].date):s,y:this.getFactorValue({dayNumberOrGroup:e.isDelta?i:s,areaOrId:e.areaId,factorId:e.factorId,indicatorId:e.indicatorId,execludedAreas:e.exeludedAreaIds,isDayDelta:e.isDelta})};t.push(r),a=e.groupSize,i=[]}}else for(let a=0+e.startDay;a<this._data.days.length;a++){const i={x:"date"==e.xAxis?new Date(this._data.days[a].date):a,y:this.getFactorValue({dayNumberOrGroup:a,areaOrId:e.areaId,factorId:e.factorId,indicatorId:e.indicatorId,execludedAreas:e.exeludedAreaIds,isDayDelta:e.isDelta})};t.push(i)}return t}}}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),function(e){!function(e){let t,a;!function(e){e[e.SUm=0]="SUm",e[e.Avg=1]="Avg"}(t=e.AggregationFunc||(e.AggregationFunc={})),function(e){e[e.Country=0]="Country",e[e.State=1]="State",e[e.Region=2]="Region",e[e.District=3]="District"}(a=e.GeoAreaType||(e.GeoAreaType={}))}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),function(e){!function(t){class a{constructor(e,t,a=0){this._value=e,this._separator=t,this._startIndex=a}get current(){return this._current||(this._current=this._value.substring(this._currentStartIndex,this._curIndex-this._separator.length)),this._current}moveNext(){if(this._curIndex>this._value.length)return!1;this._currentStartIndex=this._curIndex;var e=this._value.indexOf(this._separator,this._curIndex);return this._curIndex=-1==e?this._value.length+1:e+this._separator.length,this._current=null,!0}reset(){this._curIndex=this._startIndex,this._currentStartIndex=this._curIndex,this._current=null}}let i;!function(e){e[e.Exclude=0]="Exclude",e[e.XAxis=1]="XAxis",e[e.Serie=2]="Serie",e[e.Group=3]="Group"}(i||(i={}));class s{constructor(){}}class r extends s{constructor(){super()}createIdentifier(e){let t=0,a="";for(let i=0;i<e.length;i++){const s=e[i];switch(t){case 0:a+=s.toLowerCase(),t=1;break;case 1:" "==s||"-"==s||"_"==s?t=2:a+=s;break;case 2:a+=s.toUpperCase(),t=1}}return a}extractHeader(t,s){const r=e.linq(new a(t,s.rowSeparator)).first().split(s.columnSeparator);let o;if(!1!==s.hasHeader){const t=[];this.analyzeRow(r,t);const a=e.linq(t).sum(e=>e.stringCount),i=e.linq(t).sum(e=>e.emptyCount);a>0&&a+i==r.length&&(s.hasHeader=!0,o=e.linq(r).select((e,t)=>""==e?"col"+t:e).toArray())}o||(s.hasHeader=!1,o=e.linq(r).select((e,t)=>"col"+t).toArray()),s.columns||(s.columns=e.linq(o).select(e=>({id:this.createIdentifier(e),name:e,type:i.Exclude})).toArray())}extractRowSeparator(e,t){if(t.rowSeparator)return;const a=["\r\n","\n"];for(var i of a)if(-1!=e.indexOf(i))return void(t.rowSeparator=i)}extractColumnSeparator(t,i){if(i.columnSeparator)return;const s=["\t",";",","," "],r={},o=e.linq(new a(t,i.rowSeparator)).take(10);for(let t of o)for(let i of s){if(!1===r[i])continue;const s=e.linq(new a(t,i)).count();s>1&&!(i in r)?r[i]=s:r[i]!=s&&(r[i]=!1)}for(var n in r)if(!1!==r[n])return void(i.columnSeparator=n)}analyzeRow(e,t){if(0==t.length)for(let a=0;a<e.length;a++)t.push({values:{},booleanCount:0,dateCount:0,emptyCount:0,numberCount:0,stringCount:0});for(let a=0;a<e.length;a++)this.analyzeColumn(e[a],t[a])}analyzeColumn(e,t){e in t.values?t.values[e]++:t.values[e]=1,null==e||0==e.length||0==e.trim().length?t.emptyCount++:isNaN(e)?Date.parse(e)?t.dateCount++:"true"==e||"false"==e?t.booleanCount++:t.stringCount++:t.numberCount++}createParser(e){return e.numberCount>0&&0==e.stringCount?e=>isNaN(e)?null:parseFloat(e):e.booleanCount>0&&0==e.stringCount?e=>"true"==e:e.dateCount>0&&0==e.stringCount?e=>e?new Date(e):null:e.stringCount>0?e=>e?e.startsWith('"')&&e.endsWith('"')?e.substr(1,e.length-2):e:"":e=>null}analyze(t,s){s||(s={}),this.extractRowSeparator(t,s),this.extractColumnSeparator(t,s),this.extractHeader(t,s);let r=e.linq(new a(t,s.rowSeparator));s.hasHeader&&(r=r.skip(1));const o=[];r.foreach(e=>this.analyzeRow(e.split(s.columnSeparator),o));const n=e.linq(s.columns);return o.forEach((e,t)=>{s.columns[t].parser||(s.columns[t].parser=this.createParser(e))}),n.any(e=>e.type==i.XAxis)||(n.first(e=>e.type==i.Exclude).type=i.XAxis),n.any(e=>e.type==i.Serie)||o.forEach((e,t)=>{e.numberCount>0&&0==e.stringCount&&(s.columns[t].type=i.Serie)}),n.any(e=>e.type==i.Group)||o.forEach((t,a)=>{if(t.stringCount>0&&0==t.emptyCount){var r=e.linq(t.values);r.count()>1&&r.any(e=>e.value>1)&&(s.columns[a].type=i.Group)}}),s}loadTable(t,s,r){var o=[],n=e.linq(new a(t,s.rowSeparator));for(var l of(s.hasHeader&&(n=n.skip(1)),n)){var h=l.split(s.columnSeparator),c={};for(let e=0;e<h.length;e++){const t=s.columns[e];t.type!=i.Exclude&&(c[t.id]=t.parser(h[e]))}if(o.push(c),r&&o.length>=r)break}return o}loadGroup(t,s){var r={name:"main"},o=e.linq(new a(t,s.rowSeparator));s.hasHeader&&(o=o.skip(1));const n=e.linq(s.columns).where(e=>e.type==i.XAxis).select((e,t)=>t).first();for(var l of o){const e=l.split(s.columnSeparator),t=s.columns[n].parser(e[n]);let a=r;for(let r=0;r<e.length;r++){const o=s.columns[r];if(o.type==i.Exclude||o.type==i.XAxis)continue;let n=o.parser(e[r]);o.type==i.Group?(a.groups||(a.groups={}),""===n&&(n=$string("<$(empty)>")),n in a.groups||(a.groups[n]={name:n,colId:o.id}),a=a.groups[n]):o.type==i.Serie&&(a.series||(a.series={}),o.id in a.series||(a.series[o.id]={name:o.name,colId:o.id,values:[]}),a.series[o.id].values.push({x:t,y:n}))}}return r}}t.TextTableDataAdapter=r;class o{constructor(e){this.alias=ko.observable(),this.type=ko.observable(),this.types=[{text:$string("$(exclude)"),value:i.Exclude},{text:$string("$(x-axis)"),value:i.XAxis},{text:$string("$(serie)"),value:i.Serie},{text:$string("$(group)"),value:i.Group}],this.value=e,this.type(e.type),this.alias(e.name)}}class n{constructor(){this.name=ko.observable(),this.color=ko.observable(),this.canDrag=!1}canReadData(e){return!1}readData(e){}writeData(e){return!1}attachNode(e){this.node=e}remove(){}onParentChanged(){}canAccept(e){return!1}}class l extends n{constructor(e){super(),this.value=e,this.icon="folder",this.itemType="group",this.color("#ffc107"),this.name(e.name)}}class h extends n{constructor(e){super(),this.value=e,this.icon="insert_chart",this.itemType="serie",this.color("#4caf50"),this.name(e.name)}}t.DataImportControl=class{constructor(){this.hasHeader=ko.observable(),this.columnSeparator=ko.observable(),this.columns=ko.observable(),this.table=ko.observable(),this.treeView=new t.TreeViewModel,this.columnSeparators=[{text:$string("$(tab-key)"),value:"\t"},{text:",",value:","},{text:";",value:";"},{text:$string("$(sapce-key)"),value:" "}];const e=new t.TreeNodeViewModel;this.treeView.setRoot(e),this.treeView.selectedNode.subscribe(e=>this.onNodeSelected(e))}import(e,t){if(this._text=e,this._adapter=new r,this._options=this._adapter.analyze(this._text,t),!this._options.columnSeparator||!this._options.rowSeparator||!this._options.columns||this._options.columns.length<2)return!1;this.hasHeader(this._options.hasHeader),this.columnSeparator(this._options.columnSeparator);const a=[];for(let e of this._options.columns){var i=new o(e);a.push(i)}return this.columns(a),this.updatePreview(),!0}getSelectedData(){return __awaiter(this,void 0,void 0,(function*(){const e=[];return yield this.getSelectedDataWork(this.treeView.root(),[],e),e}))}getSelectedDataWork(e,t,a){return __awaiter(this,void 0,void 0,(function*(){if(e.isVisible())if(e.value()instanceof h){const i=e.value().value,s={type:"data-import",options:this._options,serie:i,groups:t};a.push(s)}else{if(e.isExpanded()||(yield e.loadChildNodes()),e.value()instanceof l){const a=e.value().value;let i=t.slice(0,t.length);i.push({id:a.colId,value:a.name}),t=i}for(let i of e.nodes())yield this.getSelectedDataWork(i,t,a)}}))}executeImport(){return __awaiter(this,void 0,void 0,(function*(){const e=yield this.getSelectedData();this._onGetData&&(this._onGetData(e),this._onGetData=null),this._model.close()}))}applyChanges(){this._options.hasHeader=this.hasHeader(),this._options.columnSeparator=this.columnSeparator(),this._options.columns.forEach((e,t)=>{e.name=this.columns()[t].alias(),e.type=this.columns()[t].type()}),this.updatePreview()}updateGroups(){const e=this._adapter.loadGroup(this._text,this._options);this.updateNode(this.treeView.root(),e)}updateNode(a,i){if(a.clear(),i.groups)for(let s of e.linq(i.groups)){let e=new t.TreeNodeViewModel(new l(s.value));e.loadChildNodes=()=>__awaiter(this,void 0,void 0,(function*(){return this.updateNode(e,s.value)})),a.addNode(e)}if(i.series)for(let s of e.linq(i.series)){let e=new t.TreeNodeViewModel(new h(s.value));a.addNode(e)}}updateTable(){const t=this._adapter.loadTable(this._text,this._options,50),a={header:e.linq(this._options.columns).where(e=>e.type!=i.Exclude).select(e=>e.name).toArray(),rows:e.linq(t).select(t=>e.linq(t).select(e=>this.format(e.value)).toArray()).toArray()};this.table(a)}format(t){return"number"==typeof t?formatNumber(t):"boolean"==typeof t?$string(t?"$(yes)":"$(no)"):t instanceof Date?e.DateUtils.format(t,$string("$(date-format)")):t}updatePreview(){this.updateGroups(),this.updateTable()}onNodeSelected(t){if(t&&t.value()instanceof h){const a=t.value().value,s={header:[e.linq(this._options.columns).where(e=>e.type==i.XAxis).select(e=>e.name).first(),a.name],rows:e.linq(a.values).take(50).select(e=>[this.format(e.x),this.format(e.y)]).toArray()};this.table(s)}else this.table(null)}show(){return this._model||(this._model=M.Modal.init(document.getElementById("dataImport"),{onCloseEnd:e=>{this._onGetData&&this._onGetData([])}})),this._model.open(),new Promise(e=>this._onGetData=e)}}}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),function(e){!function(t){t.ActionViewModel=class{execute(){}};t.TreeNodeViewModel=class{constructor(e){this._dargEnterCount=0,this._childLoaded=!1,this.nodes=ko.observableArray(),this.value=ko.observable(),this.isSelected=ko.observable(!1),this.isVisible=ko.observable(!0),this.isExpanded=ko.observable(!1),this.actions=ko.observable(),this.value(e),this.isExpanded.subscribe(e=>__awaiter(this,void 0,void 0,(function*(){e&&!this._childLoaded&&(yield this.loadChildNodes(),this._childLoaded=!0)}))),this.isSelected.subscribe(e=>{e&&this._treeView.select(this)})}loadChildNodes(){return __awaiter(this,void 0,void 0,(function*(){}))}clear(){this._childLoaded=!1,this.nodes.removeAll()}get element(){return this._element}attachNode(t){this._element=t,this._element.id=e.DomUtils.generateId(),this._element.$model=this,this._element.addEventListener("keydown",e=>this.onKeyDown(e));let a=this._element.querySelector("header");a.ondragstart=e=>this.onDrag(e),a.ondragover=e=>this.onDragOver(e),a.ondragenter=e=>this.onDragEnter(e),a.ondragleave=e=>this.onDragLeave(e),a.ondrop=e=>this.onDrop(e)}onKeyDown(e){46==e.keyCode&&"INPUT"!=e.target.tagName&&(e.preventDefault(),this.isSelected()&&this.value().remove())}onDrag(e){if(!this.value().writeData(e.dataTransfer)||!this.value().canDrag)return e.preventDefault(),!1}onDragEnter(e){this._dargEnterCount++}onDragLeave(t){this._dargEnterCount--,0==this._dargEnterCount&&e.DomUtils.removeClass(this._element,"drop")}onDragOver(t){if(t.preventDefault(),1==this._dargEnterCount){let a=!0;this.value().canReadData(t.dataTransfer)||(a=!1),a?(t.ctrlKey?t.dataTransfer.dropEffect="copy":t.dataTransfer.dropEffect="move",e.DomUtils.addClass(this._element,"drop")):t.dataTransfer.dropEffect="move"}}onDrop(t){t.preventDefault(),this._dargEnterCount=0,e.DomUtils.removeClass(this._element,"drop");const a=t.dataTransfer.getData("text/html+id");if(a){const e=document.getElementById(a).$model;if(!this.value().canAccept(e.value()))return;if(!t.ctrlKey){if(e._parentNode==this)return;return e._parentNode.nodes.remove(e),e._parentNode=this,this.nodes.push(e),this.isExpanded(!0),void e.value().onParentChanged()}}else this.value().readData(t.dataTransfer)}remove(){this._parentNode&&this._parentNode.nodes.remove(this),this._treeView.selectedNode()==this&&this._treeView.select(null)}addNode(e){e.attach(this._treeView,this),this.nodes.push(e)}attach(e,t){this._treeView=e,this._parentNode=t;for(let t of this.nodes())t.attach(e)}get parentNode(){return this._parentNode}toggleVisible(){this.isVisible(!this.isVisible())}select(){this.isSelected(!0),this._element.focus()}expandCollapse(){this.isExpanded(!this.isExpanded())}};t.TreeViewModel=class{constructor(){this.root=ko.observable(),this.selectedNode=ko.observable()}select(e){this.selectedNode()!=e&&(this.selectedNode()&&this.selectedNode().isSelected(!1),this.selectedNode(e),this.selectedNode()&&this.selectedNode().isSelected(!0))}setRoot(e){e.attach(this),this.root(e)}}}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),function(e){!function(t){t.InfectionDataSet={name:"COVID-19",indicators:[{id:"totalPositive",name:$string("$(total-positive)"),colorLight:"#f44336",colorDark:"#b71c1c",compute:new t.SimpleIndicatorFunction(e=>e.totalPositive)},{id:"currentPositive",name:$string("$(current-positive)"),validFor:["region","country"],colorLight:"#e91e63",colorDark:"#880e4f",compute:new t.SimpleIndicatorFunction(e=>e.currentPositive)},{id:"totalDeath",name:$string("$(death)"),validFor:["region","country"],colorLight:"#9c27b0",colorDark:"#4a148c",compute:new t.SimpleIndicatorFunction(e=>e.totalDeath)},{id:"totalSevere",name:$string("$(severe)"),validFor:["region","country"],colorLight:"#ff9800",colorDark:"#e65100",compute:new t.SimpleIndicatorFunction(e=>e.totalSevere)},{id:"totalHospedalized",name:$string("$(hospedalized)"),validFor:["region","country"],colorLight:"#fdd835",colorDark:"#fbc02d",compute:new t.SimpleIndicatorFunction(e=>e.totalHospedalized)},{id:"totalHealed",name:$string("$(healed)"),validFor:["region","country"],colorLight:"#4caf50",colorDark:"#1b5e20",compute:new t.SimpleIndicatorFunction(e=>e.totalHealed)},{id:"toatlTests",name:$string("$(tested)"),validFor:["region","country"],colorLight:"#03a9f4",colorDark:"#01579b",compute:new t.SimpleIndicatorFunction(e=>e.toatlTests)},{id:"surface",name:$string("$(surface) ($(geo))"),validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new t.ConstIndicatorFunction((t,a)=>e.MathUtils.round(a.surface,0))},{id:"density",name:$string("$(density) ($(geo))"),validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new t.ConstIndicatorFunction((t,a)=>e.MathUtils.round(a.demography.total/a.surface,0))},{id:"population",name:$string("$(population) ($(geo))"),validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new t.ConstIndicatorFunction((e,t)=>t.demography.total)},{id:"populationOld",name:$string("$(population) +65 ($(geo))"),validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new t.ConstIndicatorFunction((e,t)=>t.demography.over65)}],factors:[{id:"none",name:$string("$(none)"),compute:new t.SimpleFactorFunction((e,t,a)=>e),format:e=>formatNumber(e),reference:(e,t)=>"N/A",description:$string("[indicator]")},{id:"population",name:$string("$(population)"),compute:new t.SimpleFactorFunction((e,t,a)=>e/a.demography.total*1e5),format:e=>formatNumber(e),reference:(e,t)=>formatNumber(t.demography.total),description:$string("[indicator] $(every-100k)")},{id:"population",name:$string("$(population) +65"),compute:new t.SimpleFactorFunction((e,t,a)=>e/a.demography.over65*1e5),format:t=>formatNumber(e.MathUtils.round(t,1)),reference:(e,t)=>formatNumber(t.demography.over65),description:$string("[indicator] $(every-100k) +65")},{id:"density",name:$string("$(density)"),compute:new t.SimpleFactorFunction((e,t,a)=>e/(a.demography.total/a.surface)*1e5),format:t=>formatNumber(e.MathUtils.round(t,1)),reference:(t,a)=>formatNumber(e.MathUtils.round(a.demography.total/a.surface,1)),description:$string("[indicator] $(over-density)")},{id:"totalPositive",name:$string("$(total-positive)"),validFor:["region","country"],compute:new t.DoubleFactorFunction((e,t)=>e?e/t*100:0,new t.SimpleIndicatorFunction(e=>e.totalPositive)),format:t=>e.MathUtils.round(t,1)+"%",reference:(e,t)=>e.totalPositive?formatNumber(e.totalPositive):"N/A",description:$string("% [indicator] $(over-total-positive)")},{id:"severe",name:$string("$(severe)"),validFor:["region","country"],compute:new t.DoubleFactorFunction((e,t)=>e?e/t*100:0,new t.SimpleIndicatorFunction(e=>e.totalSevere)),format:t=>e.MathUtils.round(t,1)+"%",reference:(e,t)=>e.totalSevere?formatNumber(e.totalSevere):"N/A",description:$string("% [indicator] $(over-severe)")},{id:"test",name:$string("$(tested)"),validFor:["region","country"],compute:new t.DoubleFactorFunction((e,t)=>e?e/t*100:0,new t.SimpleIndicatorFunction(e=>e.toatlTests)),format:t=>e.MathUtils.round(t,1)+"%",reference:(e,t)=>e.toatlTests?formatNumber(e.toatlTests):"N/A",description:$string("% [indicator] $(over-tested)")}]}}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),function(e){!function(e){e.ViewModes={district:{label:{singular:$string("$(district)"),plural:$string("$(districts)")},mapGroup:"group_district",tab:"districtTab",areaType:e.GeoAreaType.District,validateId:e=>"d"==e[0].toLowerCase()},region:{label:{singular:$string("$(region)"),plural:$string("$(regions)")},mapGroup:"group_region",tab:"regionTab",areaType:e.GeoAreaType.Region,validateId:e=>"r"==e[0].toLowerCase()},country:{label:{singular:$string("$(italian)"),plural:$string("$(italians)")},mapGroup:"group_country",tab:"italyTab",areaType:e.GeoAreaType.Country,validateId:e=>"it"==e.toLowerCase()}}}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),window.ko&&(ko.bindingHandlers.attach={init:(e,t,a,i)=>{let s=ko.unwrap(t());if(!0!==s&&null!=s||(s=i.attachNode),"function"!=typeof s)throw"Supplied argument is not a function";setTimeout(()=>s.call(i,e))}}),function(e){!function(e){class t{static project(e){var a={x:0,y:0};return a.x=e.lng*t.OriginShift/180,a.y=Math.log(Math.tan((90+e.lat)*Math.PI/360))/(Math.PI/180),a.y=-a.y*t.OriginShift/180,a.x-=t.OFFSET_X,a.y-=t.OFFSET_Y,a}}t.EarthRadius=6378137,t.OriginShift=2*Math.PI*t.EarthRadius/2,t.OFFSET_X=1263355,t.OFFSET_Y=5543162,e.Geo=t}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),function(e){e.LinearGradient=class{constructor(...a){a.length>0?"string"==typeof a[0]?this.colors=e.linq(a).select(e=>new t(e)).toArray():this.colors=a:this.colors=[]}valueAt(e){if(e<0)return this.colors[0];e>1&&this.colors[this.colors.length-1];const a=1/(this.colors.length-1),i=Math.floor(e/a),s=Math.ceil(e/a),r=(e-i*a)/a,o=this.colors[i],n=this.colors[s],l=new t;return l.r=o.r+(n.r-o.r)*r,l.g=o.g+(n.g-o.g)*r,l.b=o.b+(n.b-o.b)*r,l}};class t{constructor(e){this.r=0,this.g=0,this.b=0,e&&this.fromHex(e)}fromHex(e){4==e.length?(this.r=parseInt("0x"+e[1]+e[1])/255,this.g=parseInt("0x"+e[2]+e[2])/255,this.b=parseInt("0x"+e[3]+e[3])/255):(this.r=parseInt("0x"+e[1]+e[2])/255,this.g=parseInt("0x"+e[3]+e[4])/255,this.b=parseInt("0x"+e[5]+e[6])/255)}toString(){function e(e){let t=Math.round(255*e).toString(16);return 1==t.length?"0"+t:t}return"#"+e(this.r)+e(this.g)+e(this.b)}}e.RgbColor=t;e.Graphics=class{constructor(e){this._svg=e}setViewPort(e,t,a,i){this._svg.viewBox.baseVal.x=e,this._svg.viewBox.baseVal.y=t,this._svg.viewBox.baseVal.width=a-e,this._svg.viewBox.baseVal.height=i-t}drawPoly(e){var t=document.createElementNS("http://www.w3.org/2000/svg","polygon");t.style.fill=e.fillColor,t.style.stroke=e.strokeColor,t.style.strokeWidth=e.strokeSize+"%",t.id=e.id;for(let a=0;a<e.geometry.points.length;a++){let i=this._svg.createSVGPoint();i.x=e.geometry.points[a].x,i.y=e.geometry.points[a].y,t.points.appendItem(i)}this._svg.appendChild(t)}}}(WebApp||(WebApp={})),function(e){class t{constructor(e,t){this.isVisible=ko.observable(!1),this.isTransparent=ko.observable(!1),this.value=e,this._closeAfter=t}dontShowAgain(){}onActionExecuted(){}executeAction(){this.value.showAction&&this.value.showAction(),setTimeout(()=>this.startPulse()),this.onActionExecuted()}startPulse(){if(this._element=document.querySelector(this.value.elementSelector),!this._element)return;let t=e.DomUtils.centerElement(this._element);e.DomUtils.addClass(this._element,"pulse");let a=document.querySelector(".tip-container");t<a.clientTop+a.clientHeight&&this.isTransparent(!0)}stopPulse(){this._element&&(e.DomUtils.removeClass(this._element,"pulse"),this.isTransparent(!1))}next(){}understood(){}onClose(){}close(){clearTimeout(this._closeTimeoutId),this.stopPulse(),this.isVisible(!1),this.onClose()}show(){this._closeTimeoutId&&clearTimeout(this._closeTimeoutId),this.isVisible(!0),this._closeAfter&&(this._closeTimeoutId=setTimeout(()=>this.close(),this._closeAfter))}}e.TipViewModel=t;e.TipManager=class{constructor(e,t,a){this.tip=ko.observable(),this._getPreferences=t,this._tips=e,this.savePreferences=a}get preferences(){return this._getPreferences()}savePreferences(){}markAction(t,a){this.preferences.actions[t]++,this.savePreferences(),window.gtag&&e.safeCall(()=>gtag("event",t,{event_category:"GeoPlot",event_label:a,value:this.preferences.actions[t]}))}markTip(t,a){window.gtag&&e.safeCall(()=>gtag("event",a,{event_category:"GeoPlot/Tip",event_label:t}))}engageUser(){if(null!=this.preferences.showTips&&!this.preferences.showTips)return;const t=e.linq(this._tips).where(e=>e.value.showAfter>0&&0==this.preferences.actions[e.key]).first();this.showTip(t.key,{onClose:()=>this.engageUser(),timeout:t.value.showAfter})||this.engageUser()}showTip(a,i){if(null!=this.preferences.showTips&&!this.preferences.showTips)return!1;if((!i||!i.override)&&this.tip()&&this.tip().isVisible())return!1;if((!i||!i.force)&&this.preferences.actions[a])return!1;const s=this._tips[a],r=new t(s);r.onActionExecuted=()=>{this.markTip(a,"how")},r.dontShowAgain=()=>{this.preferences.showTips=!1,this.savePreferences(),r.close(),this.markTip(a,"dontShowAgain")},r.understood=()=>{this.preferences.actions[a]++,this.savePreferences(),r.close(),this.markTip(a,"understood")},r.onClose=()=>{i&&i.onClose&&i.onClose()};let o=e.linq(this._tips).where(e=>e.value.order>s.order&&0==this.preferences.actions[e.key]).first();return r.next=o?()=>{r.close(),this.preferences.actions[a]++,this.showTip(o.key),this.markTip(a,"next")}:null,this.tip(r),setTimeout(()=>r.show(),i&&i.timeout?1e3*i.timeout:0),!0}}}(WebApp||(WebApp={})),function(e){!function(t){class a{constructor(){this.value=ko.observable()}select(){}}class i{constructor(){this.data=ko.observable(),this.factor=ko.observable(),this.indicator=ko.observable(),this.reference=ko.observable(),this.indicators=ko.observable()}select(){}}t.GeoPlotPage=class{constructor(a){this._topAreasVisible=!1,this._execludedArea=new Map,this._dataSet=t.InfectionDataSet,this._keepState=!1,this._debugMode=!1,this._tips={areaSelected:{order:0,featureName:"Zone",html:"Puoi vedere i dati relativi ad una particolare area selezionadoli sulla mappa.",elementSelector:".card-map .center-align",showAfter:3,showAction:()=>{this.viewMode("region"),this.selectedArea=this._geo.areas.r10}},indicatorSelected:{order:1,featureName:"Indicatori",html:"Puoi vedere il grafico associato all'indicatore, facendo click sull'indicatore.",elementSelector:".indicators .summary-field",showAfter:15,showAction:()=>{this.currentArea()||this._tips.areaSelected.showAction(),this.selectedIndicator(e.linq(this._dataSet.indicators).first(e=>"totalDeath"==e.id))}},dayChanged:{order:2,featureName:"Cronologia",html:"Puoi vedere gli indicatori dei giorni precedenti muovendo la slide.",elementSelector:".day input[type=range]",showAfter:20,showAction:()=>{this.dayNumber(5)}},indicatorChanged:{order:3,featureName:"Indicatori",html:"Puoi cambiare l'indicatore scegliendolo dal filtro nell'elenco.",elementSelector:".filter-indicator",showAfter:0},viewChanged:{order:4,featureName:"Zone",html:"Puoi vedere gli indicatori a livello regionale, nazionale o provinciale.",elementSelector:"#areaTabs",showAfter:0,showAction:()=>{this.viewMode("district")}},topAreasOpened:{order:5,featureName:"Zone",html:"Puo vedere le zone più colpite di un qualsiasi indicatore scelto.",elementSelector:"#topCases .card-title",showAfter:20,showAction:()=>{"country"==this.viewMode()&&this.viewMode("region"),M.Collapsible.getInstance(document.getElementById("topCases")).open(0)}},deltaSelected:{order:5.5,featureName:"Indicatori",html:"Puoi vedere l'incremento giornaliero dell'indicatore anzichè il valore totale.",elementSelector:".day-delta",showAfter:20,showAction:()=>{this.currentArea()||this._tips.areaSelected.showAction(),this.isDayDelta(!0)}},factorChanged:{order:6,featureName:"Indicatori",html:"Puoi mettere in relazione qualsiasi indicatore a numerosi parametri (es. % Positivi su Tamponi).",elementSelector:".filter-factor",showAfter:30,showAction:()=>{this.currentArea()||this._tips.areaSelected.showAction(),this.selectedIndicator(e.linq(this._dataSet.indicators).first(e=>"totalPositive"==e.id)),this.selectedFactor(e.linq(this._dataSet.factors).first(e=>"population"==e.id))}},groupChanged:{order:7,featureName:"Grafico",html:"Puo raggruppare i dati del grafico in gruppi da 1 a 7 giorni. Puoi anche scegliere la data d'inizio.",elementSelector:".row-chart-group .select-wrapper",showAfter:30,showAction:()=>{this.currentArea()||this._tips.areaSelected.showAction();var e=document.querySelector(".chart-options");e.classList.contains("closed")&&e.classList.remove("closed"),this.groupSize(2),M.FormSelect.init(document.querySelectorAll(".row-chart-group select"))}},chartActionExecuted:{order:8,featureName:"Grafico",html:"Puoi portare il grafico a schermo interno, copiarlo, o copiare la serie numerico e incollarla in excel.",elementSelector:".chart .actions",showAfter:30},scaleChanged:{order:9,featureName:"Grafico",html:"Puoi cambiare da scala logaritmica a scala lineare.",elementSelector:".log-scale",showAfter:210,showAction:()=>{this.isLogScale(!0)}},maxFactorChanged:{order:10,featureName:"Mappa",html:"Puoi cambiare il riferimento rispetto al quale la mappa viene colorata. Normalmente è in base al valore massimo che si ha avuto globalmente.",elementSelector:".max-factor",showAfter:60,showAction:()=>{this.currentArea()||this._tips.areaSelected.showAction(),this.selectedIndicator(e.linq(this._dataSet.indicators).first(e=>"totalPositive"==e.id)),this.autoMaxFactor(!1),this.maxFactor(1e3)}},regionExcluded:{order:11,featureName:"Mappa",html:"Nella vista nazionale puoi escludere dagli indicatori il valore di una o più regioni cliccando sulla mappa.",elementSelector:".card-map .center-align",showAfter:0,showAction:()=>{"country"!=this.viewMode()&&this.viewMode("country"),this._execludedArea.set("R8",this._geo.areas.r8),this.updateIndicator()}}},this._specialDates={current:{date:void 0,color:"#000",width:.5,label:"Giorno corrente"},dpcm8:{date:new Date(2020,2,7),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 8 Marzo (italia zona rossa)"},dpcm9:{date:new Date(2020,2,9),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 9 Marzo (italia zona rossa)"},dpcm11:{date:new Date(2020,2,11),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 11 Marzo (chiusura attività)"},mds20:{date:new Date(2020,2,20),color:"#070",dash:[5,5],width:1,visible:!1,label:"MDS 20 Marzo (chiura parchi, motoria nelle vicinane)"},dpcm22:{date:new Date(2020,2,21),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 22 Marzo (chiusura ulteriore attività)"},dpcm25:{date:new Date(2020,2,24),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 25 Marzo (maggiori sanzioni)"}},this.dayNumber=ko.observable(0),this.totalDays=ko.observable(0),this.currentData=ko.observable(),this.currentArea=ko.observable(),this.topAreas=ko.observable(),this.viewMode=ko.observable("district"),this.selectedIndicator=ko.observable(),this.selectedFactor=ko.observable(),this.autoMaxFactor=ko.observable(!0),this.maxFactor=ko.observable(),this.isPlaying=ko.observable(!1),this.isLogScale=ko.observable(!1),this.isDayDelta=ko.observable(!1),this.isZoomChart=ko.observable(!1),this.isShowEnvData=ko.observable(!1),this.groupSize=ko.observable(1),this.startDay=ko.observable(0),this.isNoFactorSelected=ko.computed(()=>this.selectedFactor()&&"none"==this.selectedFactor().id),this.groupDays=[1,2,3,4,5,6,7],this.factorDescription=ko.observable(),this._data=a.data,this._geo=a.geo,this._debugMode=a.debugMode,this._calculator=new t.IndicatorCalculator(this._data,this._dataSet,this._geo),this.totalDays(this._data.days.length-1),this.dayNumber.subscribe(e=>{e!=this._data.days.length-1&&this.tipManager.markAction("dayChanged"),this.updateDayData(),this._specialDates.current.date=new Date(this._data.days[e].date),this.updateChart()}),this._mapSvg=document.getElementsByTagName("svg").item(0),this._mapSvg.addEventListener("click",e=>this.onMapClick(e)),this.days=[];for(var i=0;i<this._data.days.length;i++)this.days.push({number:i,value:new Date(this._data.days[i].date),text:e.DateUtils.format(this._data.days[i].date,$string("$(date-format-short)"))});M.Tabs.init(document.getElementById("areaTabs")).options.onShow=e=>{this.setViewMode(e.dataset.viewMode)};const s=M.Collapsible.init(document.getElementById("topCases"));s.options.onOpenStart=()=>{this._daysData||this.updateTopAreas(),this._topAreasVisible=!0,this.tipManager.markAction("topAreasOpened")},s.options.onCloseEnd=()=>{this._topAreasVisible=!1},this.indicators=ko.computed(()=>e.linq(this._dataSet.indicators).where(e=>!e.validFor||-1!=e.validFor.indexOf(this.viewMode())).toArray()),this.factors=ko.computed(()=>e.linq(this._dataSet.factors).where(e=>!e.validFor||-1!=e.validFor.indexOf(this.viewMode())).toArray()),this.selectedIndicator.subscribe(e=>{e&&(this.updateIndicator(),"totalPositive"!=e.id&&this.tipManager.markAction("indicatorChanged",e.id))}),this.selectedFactor.subscribe(e=>{e&&(this.updateIndicator(),"none"!=e.id&&this.tipManager.markAction("factorChanged",e.id),setTimeout(()=>M.FormSelect.init(document.querySelectorAll(".row-chart-group select"))))}),this.autoMaxFactor.subscribe(e=>{e&&(this.updateMaxFactor(),this.updateMap()),this.updateUrl()}),this.maxFactor.subscribe(e=>{this.autoMaxFactor()||(this.updateMap(),this.tipManager.markAction("maxFactorChanged",e.toString())),this.updateUrl()}),this.isDayDelta.subscribe(e=>{this.computeStartDayForGroup(),this.updateIndicator(),e&&this.tipManager.markAction("deltaSelected")}),this.isLogScale.subscribe(e=>{this.updateChart(),this.updateUrl(),e&&this.tipManager.markAction("scaleChanged")}),this.isZoomChart.subscribe(e=>{this.updateChart()}),this.groupSize.subscribe(e=>{this.computeStartDayForGroup(),this.updateChart(),this.updateUrl(),e>1&&this.tipManager.markAction("groupChanged",e.toString())}),this.startDay.subscribe(e=>{this.updateChart(),this.updateUrl()});const r=new URLSearchParams(window.location.search),o=r.get("state");let n;this._keepState="true"==r.get("keepState"),this.loadPreferences(),this.tipManager=new e.TipManager(this._tips,()=>this._preferences,()=>this.savePreferences()),this.tipManager.engageUser(),n=o&&this._keepState?JSON.parse(atob(o)):{},setTimeout(()=>this.loadState(n),0),this._debugMode||window.addEventListener("beforeunload",()=>this.savePreferences())}isDefaultState(e){return!(e.day&&e.day!=this._data.days.length-1||e.view&&"region"!=e.view||e.area||e.indicator&&"totalPositive"!=e.indicator||e.factor&&"none"!=e.factor||e.maxFactor||e.dayDelta||e.logScale||e.showEnvData||e.groupSize&&1!=e.groupSize||null!=e.startDay&&0!=e.startDay||e.excludedArea)}loadState(a){if(a.view||(a.view="region"),M.Tabs.getInstance(document.getElementById("areaTabs")).select(t.ViewModes[a.view].tab),document.body.scrollTop=0,null!=a.logScale&&this.isLogScale(a.logScale),a.groupSize&&this.groupSize(a.groupSize),null!=a.startDay&&this.startDay(a.startDay),null!=a.dayDelta&&this.isDayDelta(a.dayDelta),null!=a.showEnvData&&this.isShowEnvData(a.showEnvData),a.maxFactor&&(this.autoMaxFactor(!1),this.maxFactor(a.maxFactor)),this.dayNumber(null!=a.day?a.day:this._data.days.length-1),a.excludedArea){this._execludedArea.clear();for(let e of a.excludedArea)this._execludedArea.set(e,this._geo.areas[e.toLowerCase()])}a.indicator&&this.selectedIndicator(e.linq(this._dataSet.indicators).first(e=>e.id==a.indicator)),a.factor&&this.selectedFactor(e.linq(this._dataSet.factors).first(e=>e.id==a.factor)),a.area&&(this.selectedArea=this._geo.areas[a.area.toLowerCase()])}saveStata(){return{view:"region"==this.viewMode()?void 0:this.viewMode(),indicator:this.selectedIndicator()?this.selectedIndicator().id:void 0,factor:this.selectedFactor()?this.selectedFactor().id:void 0,dayDelta:!!this.isDayDelta()||void 0,maxFactor:this.autoMaxFactor()?void 0:this.maxFactor(),day:this.dayNumber()==this._data.days.length-1?void 0:this.dayNumber(),area:this.selectedArea?this.selectedArea.id:void 0,groupSize:1==this.groupSize()?void 0:this.groupSize(),startDay:0==this.startDay()?void 0:this.startDay(),logScale:!!this.isLogScale()||void 0,excludedArea:this._execludedArea.size>0?e.linq(this._execludedArea.keys()).toArray():void 0,showEnvData:!!this.isShowEnvData()||void 0}}loadPreferences(){let e=localStorage.getItem("preferences");if(e){try{this._preferences=JSON.parse(e)}catch(e){}this._preferences&&1==this._preferences.version||(this._preferences=this.getDefaultPreferences(),this._preferences.isFirstView=!1,this._preferences.showTips=!1,this.savePreferences())}else this._preferences=this.getDefaultPreferences()}getDefaultPreferences(){return{isFirstView:!0,showTips:!0,version:1,actions:{areaSelected:0,indicatorSelected:0,indicatorChanged:0,dayChanged:0,viewChanged:0,chartActionExecuted:0,factorChanged:0,groupChanged:0,maxFactorChanged:0,scaleChanged:0,topAreasOpened:0,deltaSelected:0,regionExcluded:0}}}savePreferences(){this._preferences.isFirstView=!1,localStorage.setItem("preferences",JSON.stringify(this._preferences))}toggleChartZoom(){this._preferences.actions.chartActionExecuted++,this.isZoomChart(!this.isZoomChart())}copyMap(){return __awaiter(this,void 0,void 0,(function*(){const e=document.querySelector("svg.map"),t=e.outerHTML,a=new Blob([t],{type:"image/svg+xml"});if(navigator.clipboard&&navigator.clipboard.write){const t=document.createElement("img");t.style.width=e.clientWidth+"px",t.style.height=e.clientHeight+"px",t.onload=function(){const a=document.createElement("canvas");a.width=e.clientWidth,a.height=e.clientHeight;const i=a.getContext("2d");i.fillStyle="white",i.fillRect(0,0,a.width,a.height),i.drawImage(t,0,0),a.toBlob(e=>__awaiter(this,void 0,void 0,(function*(){let t=new ClipboardItem({[e.type]:e});yield navigator.clipboard.write([t]),M.toast({html:$string("$(msg-map-copied)")})})))},t.src=window.URL.createObjectURL(a)}else{const e=document.createElement("a");e.href=window.URL.createObjectURL(a),e.target="_blan",e.download="map.svg",e.click(),M.toast({html:$string("$(msg-no-copy)")})}}))}copyChart(){this._chart.canvas.toBlob(e=>__awaiter(this,void 0,void 0,(function*(){if(navigator.clipboard&&navigator.clipboard.write){let t=new ClipboardItem({[e.type]:e});yield navigator.clipboard.write([t]),M.toast({html:$string("$(msg-chart-copied)")})}else{const t=window.URL.createObjectURL(e),a=document.createElement("a");a.href=t,a.target="_blan",a.download=this._chart.options.title.text+".png",a.click(),M.toast({html:$string("$(msg-no-copy)")})}}))),this.tipManager.markAction("chartActionExecuted","copy")}copySerie(){return __awaiter(this,void 0,void 0,(function*(){const t=this._chart.data.datasets[0].data;let a="";for(let i=0;i<t.length;i++)a+=e.DateUtils.format(t[i].x,$string("$(date-format)"))+"\t"+i+"\t"+e.MathUtils.round(t[i].y,1)+"\n";e.DomUtils.copyText(a),M.toast({html:$string("$(msg-serie-copied)")}),this.tipManager.markAction("chartActionExecuted","copySerie")}))}copySerieForStudio(){return __awaiter(this,void 0,void 0,(function*(){let t={type:"serie",version:1,color:this.selectedIndicator().colorLight,serie:{areaId:this.selectedArea.id,indicatorId:this.selectedIndicator().id,xAxis:"dayNumber",startDay:this.startDay(),exeludedAreaIds:e.linq(this._execludedArea.keys()).toArray(),factorId:this.selectedFactor().id,groupSize:this.groupSize(),isDelta:this.isDayDelta()},title:this.factorDescription()};t.values=this._calculator.getSerie(t.serie),e.DomUtils.copyText(JSON.stringify(t)),M.toast({html:$string("$(msg-serie-copied-studio)")}),this.tipManager.markAction("chartActionExecuted","copySerieForStudio")}))}play(){this.dayNumber()==this._data.days.length-1&&this.dayNumber(0),this.isPlaying(!0),this.nextFrame()}pause(){this.isPlaying(!1)}setViewMode(e){"region"!=e&&this.tipManager.markAction("viewChanged",e),this.viewMode(e);const t=document.getElementById("group_district");"district"==e?t.style.removeProperty("display"):t.style.display="none",this.selectedArea=null,this._chart=null,this._execludedArea.clear(),this.clearMap(),this.updateMaxFactor(),this.updateDayData(),"country"==this.viewMode()?(this.selectedArea=this._geo.areas.it,this.tipManager.showTip("regionExcluded",{timeout:5})):this._topAreasVisible?this.updateTopAreas():this._daysData=void 0,setTimeout(()=>M.FormSelect.init(document.querySelectorAll(".row-indicator select")))}get selectedArea(){return this._selectedArea}set selectedArea(e){if(e!=this._selectedArea){if(this._selectedArea){const e=document.getElementById(this._selectedArea.id.toUpperCase());e&&e.classList.remove("selected")}if(this._selectedArea=e,this._selectedArea){const e=document.getElementById(this._selectedArea.id.toUpperCase());if(e){e.classList.add("selected");const t=e.parentElement;e.remove(),t.appendChild(e)}}this.changeArea()}}getFactorValue(t,a){return this._calculator.getFactorValue({dayNumberOrGroup:t,areaOrId:a,factorId:this.selectedFactor().id,indicatorId:this.selectedIndicator().id,isDayDelta:this.isDayDelta(),execludedAreas:e.linq(this._execludedArea.keys()).toArray()})}getIndicatorValue(t,a,i){return this._calculator.getIndicatorValue({dayNumber:t,areaOrId:a,indicatorId:i,isDayDelta:this.isDayDelta(),execludedAreas:e.linq(this._execludedArea.keys()).toArray()})}computeStartDayForGroup(){const e=(this.days.length-this.startDay())%this.groupSize();if(0!=e){const t=this.groupSize()-e;this.startDay()-t>=0?this.startDay(this.startDay()-t):this.startDay()+e<this.days.length-1&&this.startDay(this.startDay()+e),M.FormSelect.init(document.querySelectorAll(".row-chart-group select"))}}onMapClick(e){const t=e.target,a=t.parentElement.id,i=this._geo.areas[a.toLowerCase()];i&&("country"==this.viewMode()?(this._execludedArea.has(a)?this._execludedArea.delete(a):(this._execludedArea.set(a,i),M.toast({html:$string("$(msg-region-ex)").replace("[region]",i.name)})),this.updateIndicator()):t.parentElement.classList.contains(this.viewMode())&&(this.selectedArea=i),this.tipManager.markAction("areaSelected",i.name))}nextFrame(){this.isPlaying()&&(this.dayNumber()>=this._data.days.length-1?this.pause():this.dayNumber(parseInt(this.dayNumber().toString())+1),setTimeout(()=>this.nextFrame(),1e3))}changeArea(){if(null==this._selectedArea)this.currentArea(null);else{var e=!this.currentArea();const t=new i;t.value=this._selectedArea,this.updateArea(t),this.currentArea(t),this.updateFactorDescription(),this.updateAreaIndicators(),this.updateChart(),e&&(M.FormSelect.init(document.querySelectorAll(".row-chart-group select")),M.Tooltip.init(document.querySelectorAll(".row-chart-group .tooltipped")))}this.updateUrl()}updateAreaIndicators(){if(!this.currentArea())return;if(!this.currentArea().indicators()){const e=[];for(let t of this.indicators()){let i=new a;i.indicator=t,i.select=()=>{this.tipManager.markAction("indicatorSelected",i.indicator.id),this.selectedIndicator(t),setTimeout(()=>M.FormSelect.init(document.querySelectorAll(".row-indicator select")))},e.push(i)}this.currentArea().indicators(e)}const e=this.currentArea().value.id.toLowerCase();for(let t of this.currentArea().indicators())t.value(this.getIndicatorValue(this.dayNumber(),e,t.indicator.id))}updateFactorDescription(){let e="";if(this.isDayDelta()&&(e="$(new) "),e+=this.selectedFactor().description.replace("[indicator]",this.selectedIndicator().name),this.currentArea()&&(e+=" - "+this.currentArea().value.name),this._execludedArea.size>0){e+=" - $(except) (";let t=0;for(let a of this._execludedArea.keys())t>0&&(e+=", "),e+=this._execludedArea.get(a).name,t++;e+=")"}this.factorDescription($string(e))}updateIndicator(){this.selectedIndicator()&&this.selectedFactor()&&(this.updateFactorDescription(),this.updateMaxFactor(),this.updateDayData(),this.updateChart(),this.updateUrl(),this._topAreasVisible&&this.updateTopAreas())}updateMaxFactor(){if(!this.selectedFactor()||!this.selectedIndicator()||!this.autoMaxFactor())return;let e=Number.NEGATIVE_INFINITY,a=t.ViewModes[this.viewMode()];for(let t=0;t<this._data.days.length;t++){const i=this._data.days[t];for(let s in i.values){if(!a.validateId(s))continue;const i=this.getFactorValue(t,s);i>e&&i!=Number.POSITIVE_INFINITY&&(e=i)}}this.maxFactor(parseFloat(e.toFixed(1)))}initChart(){const t=document.querySelector("#areaGraph"),a={afterDraw:e=>{const t=e.data.datasets[0].data;if(!t||0==t.length)return;const a=e.scales["x-axis-0"],i=e.ctx;for(let t in this._specialDates){let s=this._specialDates[t];if(!s.date||!1===s.visible)continue;let r=a.getPixelForValue({x:s.date});i.lineWidth=s.width||1,i.beginPath(),i.moveTo(r,e.chartArea.top),i.lineTo(r,e.chartArea.bottom),i.strokeStyle=s.color||"#000",s.dash?i.setLineDash(s.dash):i.setLineDash([]),s.dashOffset&&(i.lineDashOffset=s.dashOffset),i.stroke()}}};this._chart=new Chart(t,{plugins:[a],type:"line",data:{datasets:[{lineTension:0,data:[],borderWidth:1}]},options:{maintainAspectRatio:!1,legend:{display:!0,position:"bottom"},title:{display:!1},tooltips:{callbacks:{label:(t,a)=>t.xLabel+": "+e.MathUtils.round(parseFloat(t.value),1)}},scales:{xAxes:[{type:"time",distribution:"linear",time:{unit:"day",tooltipFormat:"DD/MMM"}}]}}})}updateChart(){if(!this.selectedIndicator()||!this.currentArea()||!this.selectedFactor())return;null==this._chart&&this.initChart();const t=this.currentArea().value;t.id.toLowerCase(),this.selectedIndicator().id;this._chart.data.datasets[0].label=this.factorDescription(),this._chart.options.title.text=this._chart.data.datasets[0].label,this.isLogScale()?this._chart.options.scales.yAxes[0].type="logarithmic":this._chart.options.scales.yAxes[0].type="linear",this._chart.data.datasets[0].borderColor=this.selectedIndicator().colorDark,this._chart.data.datasets[0].backgroundColor=this.selectedIndicator().colorLight,this._chart.data.datasets[0].data=this._calculator.getSerie({areaId:t.id,indicatorId:this.selectedIndicator().id,xAxis:"date",startDay:this.startDay(),exeludedAreaIds:e.linq(this._execludedArea.keys()).toArray(),factorId:this.selectedFactor().id,groupSize:this.groupSize(),isDelta:this.isDayDelta()}),this._chart.update()}updateArea(t,a){if(!t||!this.selectedIndicator()||!this.selectedFactor())return;null==a&&(a=this.dayNumber());const i=t.value.id.toLowerCase(),s=t.value,r=this._data.days[a];r&&r.values[i]?(t.data(r.values[i]),t.indicator(this.getIndicatorValue(a,i,this.selectedIndicator().id)),t.factor(e.MathUtils.round(this.getFactorValue(a,s),1)),t.reference(this.selectedFactor().reference(r.values[i],s))):M.toast({html:$string("$msg-no-data)")})}updateTopAreas(){this._daysData=[];for(let a=0;a<this._data.days.length;a++){const s=this._data.days[a],r={},o=t.ViewModes[this.viewMode()].validateId;r.topAreas=e.linq(s.values).select(e=>({factor:this.getFactorValue(a,e.key),value:e})).orderByDesc(e=>e.factor).where(e=>o(e.value.key)).select(e=>{const t=new i;return t.value=this._geo.areas[e.value.key.toLowerCase()],t.select=()=>this.selectedArea=t.value,this.updateArea(t,a),t}).take(25).toArray(),this._daysData.push(r)}this.topAreas(this._daysData[this.dayNumber()].topAreas)}updateDayData(){const t=this._data.days[this.dayNumber()];this.currentData(e.DateUtils.format(t.date,$string("$(date-format)"))),this.updateMap(),this.updateArea(this.currentArea()),this.updateAreaIndicators(),this._daysData&&this._topAreasVisible&&this.topAreas(this._daysData[this.dayNumber()].topAreas),this.updateUrl()}updateUrl(){if(!this._keepState)return;const t=this.saveStata();let a=e.app.baseUrl+"Overview";this.isDefaultState(t)||(a+="?state="+encodeURIComponent(btoa(JSON.stringify(t)))+"&keepState=true"),history.replaceState(null,null,a)}clearMap(){const e=this._data.days[this.dayNumber()];for(const t in e.values){const e=document.getElementById(t.toUpperCase());e&&e.style.removeProperty("fill")}}updateMap(){if(this.selectedIndicator()&&this.selectedFactor())if("country"!=this.viewMode()){const a=this._data.days[this.dayNumber()],i=new e.LinearGradient("#fff",this.selectedIndicator().colorDark);for(const s in a.values){const a=document.getElementById(s.toUpperCase());if(a){const r=this._geo.areas[s];if(r.type!=t.ViewModes[this.viewMode()].areaType)continue;let o=this.getFactorValue(this.dayNumber(),r);if(o==Number.POSITIVE_INFINITY&&(o=NaN),o=Math.min(1,o/this.maxFactor()),isNaN(o))a.classList.contains("valid")&&a.classList.remove("valid"),a.style.removeProperty("fill");else{a.classList.contains("valid")||a.classList.add("valid");e.MathUtils.discretize(e.MathUtils.exponential(o),20);a.style.fill=i.valueAt(.15+.85*o).toString()}}}}else e.linq(document.querySelectorAll("g.region")).foreach(e=>{this._execludedArea.has(e.id)?e.style.fill="#444":e.style.fill="#FFF"})}}}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),function(e){!function(t){function a(e){if(null!=e&&null!=e)return e.toString()}class i{constructor(e){this.min=ko.observable(),this.max=ko.observable(),this.step=ko.observable(),this.isSelected=ko.observable(!0),this.value=e.value,this.name=e.name}}class s{constructor(){this.vars={}}setExpressions(t){const a=this.calculator.getState();for(let i of t){const t=e.linq(a.expressions.list).first(e=>e.id==i.id);if(t)for(let e of Object.getOwnPropertyNames(i))t[e]=i[e];else a.expressions.list.push(i)}const i=e.linq(a.expressions.list).where(e=>"folder"!=e.type).groupBy(e=>e.folderId?e.folderId:"").toDictionary(e=>e.key,e=>e.values.toArray()),s=[];for(let t of e.linq(a.expressions.list).where(e=>"folder"==e.type)){s.push(t);const e=i[t.id];if(e)for(let t of e)s.push(t)}const r=i[""];if(r)for(let e of r)s.push(e);a.expressions.list=s,this.calculator.setState(a)}setColor(e,t){this.calculator.controller.dispatch({type:"set-item-color",id:e,color:t})}updateTable(t,a){const i=e.linq(this.calculator.getExpressions()).where(e=>e.id==t).first();i&&(i.columns[0].values=e.linq(a).select(e=>e.x.toString()).toArray(),i.columns[1].values=e.linq(a).select(e=>e.y.toString()).toArray(),this.calculator.setExpression(i))}updateExpression(t){e.linq(this.calculator.getExpressions()).where(e=>e.id==t.id).first();this.calculator.setExpression(t)}updateVariable(e,t,a){t&&this.updateExpression({id:e,latex:t+"="+a.toString()})}expressionZoomFit(e){this.calculator.controller.dispatch({type:"expression-zoom-fit",id:e})}setItemVisibile(e,t){this.updateExpression({id:e,hidden:!t})}generateVars(e){for(let t in e)e[t]||(e[t]=this.generateVar(t))}generateVar(e="a"){return this.vars[e[0]]||(this.vars[e[0]]=0),this.vars[e[0]]++,e[0]+"_{"+this.vars[e[0]]+"}"}}class r{constructor(){this.canDrag=!1,this.name=ko.observable(),this.time=ko.observable(0),this.color=ko.observable(),this.parameters=ko.observableArray()}createActions(a){a.push(e.apply(new t.ActionViewModel,e=>{e.text=$string("$(delete)"),e.icon="delete",e.execute=()=>this.remove()}))}canAccept(e){return!1}canReadData(e){return!1}readData(e){}writeData(e){return!1}setState(e){e.name&&this.name(e.name),null!=e.visible&&this.node.isVisible(e.visible),e.color&&this.color(e.color),null!=e.opened&&this.node.isExpanded(e.opened),e.folderId&&(this.folderId=e.folderId),this.setStateWork(e),this.updateGraph(),this.setChildrenStateWork(e)}getState(){return{name:this.name(),visible:this.node.isVisible(),folderId:this.folderId,color:this.color(),opened:this.node.isExpanded()}}getVar(e){return this._varsMap[e]}remove(e=!0){this._graphCtx&&(this._graphCtx.calculator.removeExpression({id:this.getGraphId("private")}),this._graphCtx.calculator.removeExpression({id:this.getGraphId("public")})),this.node.remove(),e&&this.children.foreach(e=>e.remove())}attachNode(e){this.node=e,this.node.isVisible.subscribe(e=>this.updateGraphVisibility()),this.node.isSelected.subscribe(e=>{e&&this.onSelected()});const t=[];this.createActions(t),this.node.actions(t)}attachGraph(e){this._graphCtx=e,this._graphCtx.calculator.observe("expressionAnalysis",()=>this.onGraphChanged()),this.color.subscribe(e=>this.updateColor())}isFullVisible(){let e=this.node;for(;e;){if(!e.isVisible())return!1;e=e.parentNode}return!0}updateGraphVisibility(e=!0){const t=this.isFullVisible();return this._graphCtx.setItemVisibile(this.getGraphId("public"),t),this._graphCtx.setItemVisibile(this.getGraphId("private"),t),e&&this.children.foreach(e=>e.updateGraphVisibility()),t}updateGraph(t=!0){if(!this._graphCtx)return;this.folderId||(this.folderId=e.StringUtils.uuidv4());const a=this.getExpressions();this._graphCtx.setExpressions(a),this.updateGraphWork(),this.updateGraphVisibility(),this.updateParameters(),t&&this.children.foreach(e=>e.updateGraph(t))}onParentChanged(){this.updateGraphVisibility()}get parent(){return this.node.parentNode.value()}get children(){return e.linq(this.node.nodes()).select(e=>e.value())}replaceVars(e){for(let t in this._varsMap){const a=new RegExp("\\$"+t,"g");e=e.replace(a,this._varsMap[t])}return e}getGraphId(e){return this.folderId+"/"+e}addChildrenWork(e,a=!0){const i=new t.TreeNodeViewModel(e);return this.node.addNode(i),e.attachNode(i),e.attachGraph(this._graphCtx),a&&e.updateGraph(),e.onParentChanged(),e}createParameters(e){return!1}updateParameters(){const e=[];this.createParameters(e)&&(this.parameters.removeAll(),e.forEach(e=>this.parameters.push(e)))}updateGraphWork(){}setChildrenStateWork(e){}onSelected(){}onGraphChanged(){}updateColor(){}}class o{constructor(){this.vars=ko.observable()}select(){}}class n{constructor(){this.curValue=ko.observable(),this.autoCompute=ko.observable(),this.min=ko.observable(),this.max=ko.observable(),this.step=ko.observable()}}class l extends r{constructor(e){super(),this._varsMap={},this.selectedFunction=ko.observable(),this.showIntegration=ko.observable(!0),this.maxDay=ko.observable(),this.endDay=ko.observable(),this._varsMap={fun:null,sum:null,n1:null,n2:null,value:null,time:null,tend:null,xp:null},this.itemType="regression",this.icon="show_chart",this.optionsTemplateName="RegressionOptionsTemplate",this.functions=[],this.addFunction({name:$string("$(log-normal)"),type:"log-normal",value:"$y\\sim $c\\cdot\\frac{ e^ {-\\frac{ \\left(\\ln\\ \\left($x - $a\\right) \\ -$u\\right)^ { 2}} { 2$o^ { 2} }}}{ \\left($x - $a\\right) \\sqrt{ 2\\pi } $o }",vars:[{name:"a",label:$string("$(offset)"),autoCompute:!0,precision:0},{name:"c",label:$string("$(total)"),autoCompute:!0,precision:0},{name:"o",label:$string("$(variance)"),autoCompute:!0,precision:5},{name:"u",label:$string("$(average)"),autoCompute:!0,precision:5}]}),this.addFunction({name:$string("$(normal)"),type:"normal",value:"$y\\sim $c\\cdot\\ \\left(\\frac{1}{\\sqrt{2\\cdot\\pi}\\cdot $o}\\right)\\cdot e^{-\\frac{1}{2}\\cdot\\left(\\frac{\\left($x-$u\\right)}{$o}\\right)^{2}}",vars:[{name:"c",label:$string("$(total)"),autoCompute:!0,precision:0},{name:"o",label:$string("$(variance)"),autoCompute:!0,precision:5},{name:"u",label:$string("$(avg-peak)"),autoCompute:!0,precision:0}]}),this.addFunction({name:$string("$(exponential)"),type:"exponential",value:"$y\\sim $a^{\\left($x-$b\\right)}",vars:[{name:"a",label:$string("$(base)"),autoCompute:!0,precision:5},{name:"b",label:$string("$(offset)"),autoCompute:!0,precision:5}]}),this.addFunction({name:$string("$(linear)"),type:"linear",value:"$y\\sim $a+$m$x",vars:[{name:"a",label:$string("$(offset)"),autoCompute:!0,precision:5},{name:"m",label:$string("$(slope)"),autoCompute:!0,precision:5}]}),this.showIntegration.subscribe(()=>{this._graphCtx.setItemVisibile(this.getGraphId("sum-serie"),this.isFullVisible()&&this.showIntegration()),this._graphCtx.setItemVisibile(this.getGraphId("sum-point"),this.isFullVisible()&&this.showIntegration())}),this.selectedFunction.subscribe(e=>{if(!this.name()&&e)return this.name(e.value.name)}),this.endDay.subscribe(e=>this.updateEndDay()),this.maxDay.subscribe(e=>this.updateEndDay()),this.selectedFunction(this.functions[0]),e&&this.setState(e)}addFunction(e){const t=new o;t.value=e,t.select=()=>{this.selectedFunction(t),this.name(t.value.name),this.updateGraph()};const a=[];for(let t of e.vars){const e=new n;e.value=t,e.curValue(t.value),e.autoCompute(t.autoCompute),e.min(t.minValue),e.max(t.maxValue),e.step(t.step),e.min.subscribe(e=>t.minValue=e),e.max.subscribe(e=>t.maxValue=e),e.step.subscribe(e=>t.step=e),e.curValue.subscribe(e=>t.value=e),e.autoCompute.subscribe(e=>{t.autoCompute=e,this.updateGraph()}),e.curValue.subscribe(a=>{e.autoCompute()||this._graphCtx.updateVariable(this.getGraphId(t.name+"-value"),this.getVar(t.name),a)}),a.push(e)}return t.vars(a),this.functions.push(t),t}onGraphChanged(){this.updateRegressionVars()}updateRegressionVars(){let t=this._graphCtx.calculator.controller.getItemModel(this.getGraphId("main"));if(t&&t.regressionParameters)for(let a of this.selectedFunction().vars()){const i=this.getVar(a.value.name).replace("{","").replace("}","");let s=t.regressionParameters[i];null!=s&&(null!=a.value.precision&&(s=e.MathUtils.round(s,a.value.precision)),a.curValue(s))}}createParameters(t){return t.push(e.apply(new i({value:this.endDay,name:$string("$(reg-days)")}),e=>{e.max=this.maxDay,e.min(0),e.step(1)})),!0}setStateWork(t){if(t.function){const a=e.linq(this.functions).first(e=>e.value.type==t.function.type);if(a){for(let i of t.function.vars){const t=e.linq(a.vars()).first(e=>e.value.name==i.name);t&&(t.autoCompute(i.autoCompute),t.max(i.maxValue),t.min(i.minValue),t.step(i.step),t.curValue(i.value))}this.selectedFunction(a)}}null!=t.showIntegration&&this.showIntegration(t.showIntegration)}getState(){const e=super.getState();e.function=this.selectedFunction().value,e.showIntegration=this.showIntegration();for(let e of this.selectedFunction().vars())e.value.value=e.curValue(),e.value.maxValue=e.max(),e.value.minValue=e.min(),e.value.step=e.step(),e.value.autoCompute=e.autoCompute();return e}onParentChanged(){super.onParentChanged(),this.color(this.parent.color()),this.maxDay(e.linq(this.parent.values).max(e=>e.x)),null==this.endDay()&&this.endDay(this.maxDay())}updateEndDay(){this._varsMap.tend&&this._graphCtx.updateExpression({type:"expression",id:this.getGraphId("end-day"),latex:this._varsMap.tend+"="+this.endDay(),slider:{min:"0",step:"1",max:this.maxDay().toString()}})}updateColor(){this._graphCtx.setColor(this.getGraphId("main-func"),this.color()),this._graphCtx.setColor(this.getGraphId("sum-serie"),this.color()),this._graphCtx.setColor(this.getGraphId("sum-point"),this.color()),this._graphCtx.setColor(this.getGraphId("end-day-line"),this.color())}updateGraphWork(){this.updateRegressionVars()}getExpressions(){const e=[];e.push({type:"folder",id:this.getGraphId("public"),title:this.parent.name()+" - "+this.name(),collapsed:!0}),e.push({type:"folder",id:this.getGraphId("private"),secret:!0,title:this.parent.name()+" - "+this.name(),collapsed:!0});const t=this.selectedFunction().value;this._varsMap.x="",this._varsMap.y=this.parent.getVar("y"),this._varsMap.time=this.parent.parent.getVar("time");for(let e of t.vars)this._varsMap[e.name]||(this._varsMap[e.name]=null);this._graphCtx.generateVars(this._varsMap),this._varsMap.x=this.getVar("xp"),e.push({type:"expression",id:this.getGraphId("main"),folderId:this.getGraphId("private"),latex:this.replaceVars(t.value),hidden:!0}),e.push({type:"expression",id:this.getGraphId("main-func"),folderId:this.getGraphId("private"),latex:this.replaceVars(t.value.replace("$y\\sim ","$fun\\left(x\\right)=").replace(/\$x/g,"x")),color:this.parent.color(),lineStyle:Desmos.Styles.DASHED}),e.push({type:"expression",id:this.getGraphId("sum-func"),folderId:this.getGraphId("private"),latex:this.replaceVars("$sum\\left(x\\right)=\\sum_{$n1=1}^{x}\\operatorname{round}\\left($fun\\left($n1\\right)\\right)"),hidden:!0}),e.push({type:"expression",id:this.getGraphId("sum-x-time"),folderId:this.getGraphId("private"),latex:this.replaceVars("$n2=\\left[1,...,$time\\right]")}),e.push({type:"expression",id:this.getGraphId("sum-serie"),folderId:this.getGraphId("private"),latex:this.replaceVars("\\left($n2,\\ $sum\\left($n2\\right)\\right)"),color:this.parent.color(),lines:!0,hidden:!this.showIntegration(),lineStyle:Desmos.Styles.SOLID,pointStyle:"NONE",points:!1}),e.push({type:"expression",id:this.getGraphId("sum-value"),folderId:this.getGraphId("public"),latex:this.replaceVars("$value=$sum\\left($time\\right)")}),e.push({type:"expression",id:this.getGraphId("sum-point"),folderId:this.getGraphId("private"),hidden:!this.showIntegration(),latex:this.replaceVars("\\left($time,$value\\right)"),color:this.parent.color(),label:this.parent.name(),dragMode:"XY",showLabel:!0}),e.push({type:"expression",id:this.getGraphId("end-day"),latex:this._varsMap.tend+"="+this.endDay(),folderId:this.getGraphId("public"),label:"Giorni Previsione",slider:{min:(0).toString(),max:this.maxDay().toString(),hardMax:!0,hardMin:!0,step:"1"}}),e.push({type:"expression",id:this.getGraphId("end-day-line"),color:this.color(),latex:"x="+this._varsMap.tend,folderId:this.getGraphId("private"),lines:!0}),e.push({type:"expression",id:this.getGraphId("end-day-serie"),latex:this.replaceVars("$xp=[0,...,$tend]+"+this.parent.getVar("ofs")),folderId:this.getGraphId("private"),hidden:!0});for(let t of this.selectedFunction().vars())t.autoCompute()?this._graphCtx.calculator.removeExpression({id:this.getGraphId(t.value.name+"-value")}):e.push({type:"expression",id:this.getGraphId(t.value.name+"-value"),latex:this.getVar(t.value.name)+"="+(t.curValue()?t.curValue().toString():"0"),folderId:this.getGraphId("public"),label:t.value.name,slider:{min:a(t.value.minValue),max:a(t.value.maxValue),hardMax:!0,hardMin:!0,step:a(t.value.step)}});return e}}class h extends r{constructor(e){super(),this.color=ko.observable(),this.offsetX=ko.observable(0),this.canDrag=!0,this.itemType="serie",this.icon="insert_chart",this.optionsTemplateName="StudioOptionsTemplate",this._varsMap={x:null,y:null,ofs:null,xofs:null},e&&this.setState(e)}importValues(t){if(t&&t.length>0){if(t[0].x instanceof Date){const a=t[0].x;return e.linq(t).select(t=>({x:Math.round(e.DateUtils.diff(t.x,a).totalDays),xLabel:t.x,y:t.y})).toArray()}if(isNaN(t[0].x))return e.linq(t).select((e,t)=>({x:t,xLabel:e.x,y:e.y})).toArray()}return t}writeData(e){var t={version:1,type:"serieState",state:this.getState()};return e.setData("application/json+studio",JSON.stringify(t)),e.setData("text/html+id",this.node.element.id),!0}createActions(a){super.createActions(a),a.push(e.apply(new t.ActionViewModel,e=>{e.text=$string("$(update)"),e.icon="autorenew",e.execute=()=>this.updateSerie()})),a.push(e.apply(new t.ActionViewModel,e=>{e.text=$string("$(new-regression)"),e.icon="add_box",e.execute=()=>{const e=this.addRegression(null,!1);e.updateGraph(),this.node.isExpanded(!0),e.node.isSelected(!0)}})),a.push(e.apply(new t.ActionViewModel,e=>{e.text=$string("$(zoom)"),e.icon="zoom_in",e.execute=()=>{this.zoom()}}))}static fromText(e){try{const t=JSON.parse(e);if(t){if("serie"==t.type)return new h({name:t.title,values:t.values,source:t.serie,color:t.color});if("serieState"==t.type)return new h(t.state)}}catch(e){}}getExpressions(){return this.color()||this.color("#0000ff"),this._graphCtx.generateVars(this._varsMap),[{type:"folder",id:this.getGraphId("public"),title:this.parent.name()+" - "+this.name(),collapsed:!0},{type:"folder",id:this.getGraphId("private"),title:this.parent.name()+" - "+this.name(),secret:!0,collapsed:!0},{type:"expression",id:this.getGraphId("offset"),latex:this._varsMap.ofs+"="+this.offsetX(),folderId:this.getGraphId("public"),label:"Scostamento",slider:{min:(-this.values.length).toString(),max:this.values.length.toString(),hardMax:!0,hardMin:!0,step:"1"}},{type:"expression",id:this.getGraphId("offset-x"),latex:this._varsMap.xofs+"="+this._varsMap.x+"+"+this._varsMap.ofs,folderId:this.getGraphId("private")},{type:"expression",id:this.getGraphId("offset-x-serie"),latex:"("+this._varsMap.xofs+","+this._varsMap.y+")",folderId:this.getGraphId("private"),points:!0,lines:!0,color:this.color()},{type:"table",id:this.getGraphId("table"),folderId:this.getGraphId("private"),columns:[{id:this.getGraphId("table/x"),latex:this._varsMap.x},{id:this.getGraphId("table/y"),latex:this._varsMap.y,hidden:!0}]}]}createParameters(t){return t.push(e.apply(new i({value:this.offsetX,name:$string("$(shift)")}),e=>{e.max(this.values.length),e.min(-this.values.length),e.step(1)})),!0}updateGraphWork(){this._graphCtx.updateTable(this.getGraphId("table"),this.values)}onGraphChanged(){}onSelected(){this._graphCtx.expressionZoomFit(this.getGraphId("table"))}updateColor(){this._graphCtx.setColor(this.getGraphId("offset-x-serie"),this.color()),this.children.foreach(e=>e.onParentChanged())}attachGraph(e){super.attachGraph(e),this.offsetX.subscribe(e=>this._graphCtx.updateVariable(this.getGraphId("offset"),this._varsMap.ofs,e))}setChildrenStateWork(e){null!=e.children&&(this.children.foreach(e=>e.remove()),e.children.forEach(e=>{this.addRegression(null,!1).setState(e)}))}setStateWork(e){null!=e.offsetX&&this.offsetX(e.offsetX),e.source&&(this.source=e.source),null!=e.values&&(this.values=this.importValues(e.values))}getState(){const e=super.getState();return e.offsetX=this.offsetX(),e.source=this.source,e.values=this.values,e.children=this.children.select(e=>e.getState()).toArray(),e}addRegression(e,t=!0){return this.addChildrenWork(e instanceof l?e:new l(e),t)}updateSerie(){return __awaiter(this,void 0,void 0,(function*(){if("geoplot"==this.source.type){if(!this._graphCtx.serieCalculator){M.toast({html:$string("$(msg-downloading-data)")});const e=yield t.Api.loadStudioData();this._graphCtx.serieCalculator=new t.IndicatorCalculator(e.data,t.InfectionDataSet,e.geo)}this.values=this.importValues(this._graphCtx.serieCalculator.getSerie(this.source)),this._graphCtx.updateTable(this.getGraphId("table"),this.values),this.children.foreach(e=>e.onParentChanged()),M.toast({html:$string("$(msg-update-complete)")})}else M.toast({html:$string("$(msg-update-not-supported)")})}))}zoom(){const t=e.linq(this.values).min(e=>e.x),a=e.linq(this.values).min(e=>e.y),i=e.linq(this.values).max(e=>e.x),s=e.linq(this.values).max(e=>e.y);this._graphCtx.calculator.setMathBounds({top:s+.1*(s-a),right:i+.1*(i-t),bottom:a-.1*(s-a),left:t-.1*(i-t)})}}class c extends r{constructor(e){super(),this.time=ko.observable(0),this.itemType="project",this.icon="folder",this.optionsTemplateName="ProjectOptionsTemplate",this._varsMap={time:null},e&&this.setState(e)}canAccept(e){return e instanceof h}canReadData(e){return-1!=e.types.indexOf("application/json+studio")}readData(e){const t=e.getData("application/json+studio");let a=h.fromText(t);a&&(this.addSerie(a),this.node.isExpanded(!0))}getExpressions(){return this._graphCtx.generateVars(this._varsMap),[{type:"folder",id:this.getGraphId("public"),title:this.name(),collapsed:!0},{type:"expression",folderId:this.getGraphId("public"),id:this.getGraphId("time"),latex:this._varsMap.time+"="+this.time(),slider:{hardMin:!0,hardMax:!0,min:"0",max:"100",step:"1"}}]}createParameters(t){return t.push(e.apply(new i({value:this.time,name:$string("$(day)")}),e=>{e.max(100),e.min(0),e.step(1)})),!0}setStateWork(e){null!=e.time&&this.time(e.time)}setChildrenStateWork(e){null!=e.children&&(this.children.foreach(e=>e.remove()),e.children.forEach(e=>{this.addSerie(null,!1).setState(e)}))}getState(){const e=super.getState();return e.time=this.time(),e.children=this.children.select(e=>e.getState()).toArray(),e}onGraphChanged(){}attachGraph(e){super.attachGraph(e),this.time.subscribe(e=>this._graphCtx.updateVariable(this.getGraphId("time"),this._varsMap.time,this.time()))}addSerie(e,t=!0){return this.addChildrenWork(e instanceof h?e:new h(e),t)}}t.StudioPage=class{constructor(a){this.items=new t.TreeViewModel,this.maxX=ko.observable(),this.maxY=ko.observable(),this.dataImport=new t.DataImportControl,this._projectId=a,this._graphCtx=new s,this._graphCtx.calculator=Desmos.GraphingCalculator(document.getElementById("calculator"),{pasteGraphLink:!1,pasteTableData:!1,expressionsCollapsed:!0,restrictedFunctions:!0,administerSecretFolders:!0,authorIDE:!0,advancedStyling:!0});const i=[];i.push(e.apply(new t.ActionViewModel,e=>{e.text=$string("$(new-project)"),e.icon="create_new_folder",e.execute=()=>this.newProject()})),i.push(e.apply(new t.ActionViewModel,e=>{e.text=$string("$(save)"),e.icon="save",e.execute=()=>this.saveState()})),i.push(e.apply(new t.ActionViewModel,e=>{e.text=$string("$(options)"),e.icon="settings",e.execute=()=>this.showOptions()})),i.push(e.apply(new t.ActionViewModel,e=>{e.text=$string("$(share) Studio"),e.icon="share",e.execute=()=>this.share()}));const r=new t.TreeNodeViewModel;r.actions(i),this.items.setRoot(r),document.body.addEventListener("paste",e=>__awaiter(this,void 0,void 0,(function*(){(yield this.onPaste(e.clipboardData))&&e.preventDefault()}))),M.Modal.init(document.getElementById("options"),{onCloseEnd:()=>this.updateOptions()}),setTimeout(()=>this.init())}updateOptions(){const e=parseInt(this.maxX()),t=parseInt(this.maxY());this._graphCtx.calculator.setMathBounds({bottom:-t/10,left:-e/10,right:e,top:t})}share(){return __awaiter(this,void 0,void 0,(function*(){const a=e.StringUtils.uuidv4();yield t.Api.saveState(a,this.getState());const i=e.Uri.absolute("~/"+$language.split("-")[0]+"/Studio/"+a);yield e.DomUtils.copyText(i),M.toast({html:$string("$(msg-shared)")})}))}showOptions(){const e=this._graphCtx.calculator.graphpaperBounds;this.maxX(Math.round(e.mathCoordinates.width)),this.maxY(Math.round(e.mathCoordinates.height)),M.Modal.getInstance(document.getElementById("options")).open()}getSelectedProject(){if(!this.items.selectedNode())return;const e=this.items.selectedNode().value();return"project"==e.itemType?e:"serie"==e.itemType?e.parent:"regression"==e.itemType?e.parent.parent:void 0}newProject(){const e=this.addProject({name:"Project "+(this.projects.count()+1)});return e.node.isSelected(!0),e}addProject(e,a=!0){const i=new c(e),s=new t.TreeNodeViewModel(i);return this.items.root().addNode(s),i.attachNode(s),i.attachGraph(this._graphCtx),a&&i.updateGraph(),i}getState(){const e={version:2};return e.graphState=this._graphCtx.calculator.getState(),e.vars=this._graphCtx.vars,e.projects=this.projects.select(e=>e.getState()).toArray(),e}setState(e){e&&(e.graphState&&(e.graphState.expressions.list=[],this._graphCtx.calculator.setState(e.graphState)),null!=e.projects&&(this.projects.toArray().forEach(e=>e.remove()),e.projects.forEach(e=>{this.addProject(null,!1).setState(e)})))}loadState(){return __awaiter(this,void 0,void 0,(function*(){if(this._projectId){let e=yield t.Api.loadState(this._projectId);this.setState(e)}else{const e=localStorage.getItem("studio");e&&this.setState(JSON.parse(e))}}))}saveState(){return __awaiter(this,void 0,void 0,(function*(){this._projectId?(yield t.Api.saveState(this._projectId,this.getState()),M.toast({html:$string("$(msg-saved)")})):(localStorage.setItem("studio",JSON.stringify(this.getState())),M.toast({html:$string("$(msg-saved-device)")}))}))}demo(){const e=this.addProject({name:"Project 1"});this.addProject({name:"Project 2"}),this.addProject({name:"Project 3"}),e.addSerie({name:"Serie 1"})}onPaste(e){return __awaiter(this,void 0,void 0,(function*(){let t=this.getSelectedProject();if(t||this.projects.any()||(t=this.newProject()),!t)return M.toast({html:$string("$(msg-select-project)")}),!1;const a=e.getData("text/plain").toString();if(a){const e=h.fromText(a);if(e){t.addSerie(e),t.node.isExpanded(!0),e.node.isExpanded(!0),e.zoom();const a=e.addRegression(null,!1);return a.updateGraph(),a.node.isSelected(!0),!0}try{if(this.dataImport.import(a)){const e=yield this.dataImport.show();if(1==e.length&&this.items.selectedNode()&&this.items.selectedNode().value()instanceof h&&confirm("Sostituire la serie selezionata con i nuovi dati?")){const t=this.items.selectedNode().value();return t.source=e[0],t.importValues(e[0].serie.values),t.updateGraph(!0),!0}t.node.isExpanded(!0);for(let a of e){const e=new h({name:a.serie.name,values:a.serie.values,source:a});t.addSerie(e),e.node.isExpanded(!0);const i=e.addRegression(null,!1);i.updateGraph(),i.node.isSelected(!0)}return!0}}catch(e){console.error(e)}}return M.toast({html:$string("$(msg-format-not-reconized)")}),!1}))}get projects(){return e.linq(function*(){for(let e of this.items.root().nodes())yield e.value()}.apply(this))}init(){return __awaiter(this,void 0,void 0,(function*(){this.loadState()}))}test(){return __awaiter(this,void 0,void 0,(function*(){var t=yield e.Http.getStringAsync("https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-regioni/dpc-covid19-ita-regioni.csv");this.dataImport.import(t),this.dataImport.show()}))}}}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={}));