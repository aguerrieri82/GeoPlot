var WebApp,__awaiter=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))((function(a,r){function o(e){try{l(s.next(e))}catch(e){r(e)}}function n(e){try{l(s.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}l((s=s.apply(e,t||[])).next())}))};function capitalizeFirst(e){return e.substr(0,1).toUpperCase()+e.substr(1)}function expandCollapse(e){let t=e.parentElement,i=t.querySelector(".section-content");t.classList.contains("closed")?(i.style.removeProperty("display"),t.classList.remove("closed")):(t.classList.add("closed"),setTimeout(()=>i.style.display="none",300))}!function(e){!function(t){let i;!function(t){t.saveState=function(t,i){return __awaiter(this,void 0,void 0,(function*(){let s=yield e.Http.postJsonAsync("~/SaveState/"+t,i);if(!s.isSuccess)throw s.error;return s.data}))},t.loadState=function(t){return __awaiter(this,void 0,void 0,(function*(){let i=yield e.Http.getJsonAsync("~/LoadState/"+t);if(!i.isSuccess)throw i.error;return i.data}))},t.loadStudioData=function(){return __awaiter(this,void 0,void 0,(function*(){return yield e.Http.getJsonAsync("~/StudioData")}))}}(i=t.Api||(t.Api={}))}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),function(e){let t;!function(t){t.GeoPlotApplication=class{constructor(){}initServices(){e.Services.httpClient=new e.XHRHttpClient}}}(t=e.GeoPlot||(e.GeoPlot={})),e.app=new t.GeoPlotApplication}(WebApp||(WebApp={})),HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(e,t,i){let s=this;setTimeout(()=>{const a=atob(s.toDataURL(t,i).split(",")[1]),r=a.length,o=new Uint8Array(r);for(let e=0;e<r;e++)o[e]=a.charCodeAt(e);e(new Blob([o],{type:t||"image/png"}))})}}),window.Chart&&Chart.plugins.register({beforeDraw:function(e){var t=e.ctx;t.fillStyle="white",t.fillRect(0,0,e.width,e.height)}}),function(e){!function(t){t.ConstIndicatorFunction=class{constructor(e){this._value=e}value(e,t,i,s,a){let r=this._value(e,a);if(i)for(var o in i)r-=this.value(i[o],s[o],null,null,a);return r}};t.SimpleIndicatorFunction=class{constructor(e){this._value=e}value(e,t,i,s,a){var r=this._value(e,a);if(t&&(r-=this._value(t,a)),i)for(var o in i)r-=this.value(i[o],s[o],null,null,a);return r}};t.CombineIndicatorFunction=class{constructor(e,t){this._value=t,this._indicators=e}value(e,t,i,s,a){const r={};for(var o in this._indicators)r[o]=this._indicators[o].value(e,t,i,s,a);return this._value(r)}};t.SimpleFactorFunction=class{constructor(e){this._value=e}value(e,t,i,s,a,r){let o=0;for(var n in e)o+=r.value(e[n],t[n],i[n],s[n],a);return this._value(o,e[0],a)}};t.DoubleFactorFunction=class{constructor(e,t){this._value=e,this._factor=t}value(e,t,i,s,a,r){let o=0,n=0;for(var l in e)o+=r.value(e[l],t[l],i[l],s[l],a),n+=this._factor.value(e[l],t[l],i[l],s[l],a);return this._value(o,n)}};t.IndicatorCalculator=class{constructor(e,t,i){this._data=e,this._dataSet=t,this._geo=i}getFactorValue(t){const i=("string"==typeof t.areaOrId?t.areaOrId:t.areaOrId.id).toLowerCase(),s=(e,t)=>e<0?void 0:this._data.days[e].values[t];let a;a=Array.isArray(t.dayNumberOrGroup)?t.dayNumberOrGroup:[t.dayNumberOrGroup];let r=[],o=[],n=[],l=[];for(var h of a)if(r.push(s(h,i)),t.isDayDelta&&o.push(s(h-1,i)),t.execludedAreas){var d=[],c=[];for(var u of t.execludedAreas)d.push(s(h,u.toLowerCase())),t.isDayDelta&&c.push(s(h-1,u.toLowerCase()));n.push(d),l.push(c)}const p=e.linq(this._dataSet.factors).first(e=>e.id==t.factorId),g=e.linq(this._dataSet.indicators).first(e=>e.id==t.indicatorId);return p.compute.value(r,o,n,l,this._geo.areas[i],g.compute)}getIndicatorValue(t){const i=("string"==typeof t.areaOrId?t.areaOrId:t.areaOrId.id).toLowerCase(),s=e.linq(this._dataSet.indicators).first(e=>e.id==t.indicatorId),a=(e,t)=>e<0?void 0:this._data.days[e].values[t];let r,o,n,l=a(t.dayNumber,i);if(t.isDayDelta&&(r=a(t.dayNumber-1,i)),t.execludedAreas)for(var h of(o=[],n=[],t.execludedAreas))o.push(a(t.dayNumber,h.toLowerCase())),t.isDayDelta&&n.push(a(t.dayNumber-1,h.toLowerCase()));return s.compute.value(l,r,o,n,this._geo.areas[i])}getSerie(e){const t=[];if(e.groupSize>1){let i=e.groupSize,s=[];for(let a=0+e.startDay;a<this._data.days.length;a++)if(s.push(a),i--,0==i){const r={x:"date"==e.xAxis?new Date(this._data.days[a].date):a,y:this.getFactorValue({dayNumberOrGroup:e.isDelta?s:a,areaOrId:e.areaId,factorId:e.factorId,indicatorId:e.indicatorId,execludedAreas:e.exeludedAreaIds,isDayDelta:e.isDelta})};t.push(r),i=e.groupSize,s=[]}}else for(let i=0+e.startDay;i<this._data.days.length;i++){const s={x:"date"==e.xAxis?new Date(this._data.days[i].date):i,y:this.getFactorValue({dayNumberOrGroup:i,areaOrId:e.areaId,factorId:e.factorId,indicatorId:e.indicatorId,execludedAreas:e.exeludedAreaIds,isDayDelta:e.isDelta})};t.push(s)}return t}}}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),function(e){!function(e){let t,i;!function(e){e[e.SUm=0]="SUm",e[e.Avg=1]="Avg"}(t=e.AggregationFunc||(e.AggregationFunc={})),function(e){e[e.Country=0]="Country",e[e.State=1]="State",e[e.Region=2]="Region",e[e.District=3]="District"}(i=e.GeoAreaType||(e.GeoAreaType={})),e.MATERIAL_COLORS={red:{600:"#f44336"},pink:{600:"#e91e63"},purple:{600:"#9c27b0"},deep_purple:{600:"#673ab7"},indigo:{600:"#3f51b5"},blue:{600:"#2196f3"},light_blue:{600:"#03a9f4"},cyan:{600:"#00bcd4"},teal:{600:"#009688"},green:{600:"#4caf50"},light_green:{600:"#8bc34a"},lime:{600:"#cddc39"},yellow:{600:"#ffeb3b"},amber:{600:"#ffc107"},orange:{600:"#ff9800"},depp_orange:{600:"#ff5722"},brown:{600:"#795548"},grey:{600:"#9e9e9e"},blue_gray:{600:"#607d8b"}}}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),function(e){!function(t){t.BaseTreeItem=class{constructor(){this.name=ko.observable(),this.color=ko.observable(),this.canDrag=!1}canReadData(e){return!1}readData(e){}writeData(e){return!1}attachNode(e){this.node=e}remove(){}onParentChanged(){}canAccept(e){return!1}};t.ActionViewModel=class{execute(){}};t.TreeNodeViewModel=class{constructor(e){this._dargEnterCount=0,this._childLoaded=!1,this.nodes=ko.observableArray(),this.value=ko.observable(),this.isSelected=ko.observable(!1),this.isVisible=ko.observable(!0),this.isExpanded=ko.observable(!1),this.actions=ko.observable(),this.value(e),this.isExpanded.subscribe(e=>__awaiter(this,void 0,void 0,(function*(){e&&!this._childLoaded&&(yield this.loadChildNodes(),this._childLoaded=!0)}))),this.isSelected.subscribe(e=>{e&&this._treeView.select(this)})}loadChildNodes(){return __awaiter(this,void 0,void 0,(function*(){}))}clear(){this._childLoaded=!1,this.nodes.removeAll()}get element(){return this._element}attachNode(t){this._element=t,this._element.id=e.DomUtils.generateId(),this._element.$model=this,this._element.addEventListener("keydown",e=>this.onKeyDown(e));let i=this._element.querySelector("header");i.ondragstart=e=>this.onDrag(e),i.ondragover=e=>this.onDragOver(e),i.ondragenter=e=>this.onDragEnter(e),i.ondragleave=e=>this.onDragLeave(e),i.ondrop=e=>this.onDrop(e)}onKeyDown(e){46==e.keyCode&&"INPUT"!=e.target.tagName&&(e.preventDefault(),this.isSelected()&&this.value().remove())}onDrag(e){if(!this.value().writeData(e.dataTransfer)||!this.value().canDrag)return e.preventDefault(),!1}onDragEnter(e){this._dargEnterCount++}onDragLeave(t){this._dargEnterCount--,0==this._dargEnterCount&&e.DomUtils.removeClass(this._element,"drop")}onDragOver(t){if(t.preventDefault(),1==this._dargEnterCount){let i=!0;this.value().canReadData(t.dataTransfer)||(i=!1),i?(t.ctrlKey?t.dataTransfer.dropEffect="copy":t.dataTransfer.dropEffect="move",e.DomUtils.addClass(this._element,"drop")):t.dataTransfer.dropEffect="move"}}onDrop(t){t.preventDefault(),this._dargEnterCount=0,e.DomUtils.removeClass(this._element,"drop");const i=t.dataTransfer.getData("text/html+id");if(i){const e=document.getElementById(i).$model;if(!this.value().canAccept(e.value()))return;if(!t.ctrlKey){if(e._parentNode==this)return;return e._parentNode.nodes.remove(e),e._parentNode=this,this.nodes.push(e),this.isExpanded(!0),void e.value().onParentChanged()}}else this.value().readData(t.dataTransfer)}remove(){this._parentNode&&this._parentNode.nodes.remove(this),this._treeView.selectedNode()==this&&this._treeView.select(null)}addNode(e){e.attach(this._treeView,this),this.nodes.push(e)}attach(e,t){this._treeView=e,this._parentNode=t;for(let t of this.nodes())t.attach(e)}get parentNode(){return this._parentNode}toggleVisible(){this.isVisible(!this.isVisible())}select(e=!1){if(this.isSelected(!0),this._element.focus(),e){let e=this;for(;e;)e.isExpanded(!0),e=e.parentNode}}expandCollapse(){this.isExpanded(!this.isExpanded())}};t.TreeViewModel=class{constructor(){this.root=ko.observable(),this.selectedNode=ko.observable()}select(e){this.selectedNode()!=e&&(this.selectedNode()&&this.selectedNode().isSelected(!1),this.selectedNode(e),this.selectedNode()&&this.selectedNode().isSelected(!0))}setRoot(e){e.attach(this),this.root(e)}}}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),function(e){!function(t){class i{constructor(){this._dargEnterCount=0}attachNode(e){this._element=e,e.ondragover=e=>this.onDragOver(e),e.ondrop=e=>this.onDrop(e),e.ondragenter=e=>this.onDragEnter(e),e.ondragleave=e=>this.onDragLeave(e)}onFileDropped(e){}onDragEnter(e){this._dargEnterCount++}onDragLeave(t){this._dargEnterCount--,0==this._dargEnterCount&&e.DomUtils.removeClass(this._element,"drop")}onDragOver(t){t.preventDefault(),1==this._dargEnterCount&&e.DomUtils.addClass(this._element,"drop")}onDrop(t){return __awaiter(this,void 0,void 0,(function*(){if(t.preventDefault(),this._dargEnterCount=0,e.DomUtils.removeClass(this._element,"drop"),1==t.dataTransfer.files.length){if(t.dataTransfer.files[0].name.toLowerCase().endsWith(".csv")){const e=yield t.dataTransfer.files[0].text();return void this.onFileDropped(e)}}M.toast({html:$string("$(msg-not-supported-only-csv)")})}))}}t.FileDragDrop=i;class s{constructor(){this._showCount=0,this.message=ko.observable(),this.percentage=ko.observable(),this.status=ko.observable(),this.status("hidden"),e.Operation.onBegin.add((e,t)=>this.show(t)),e.Operation.onEnd.add((e,t)=>this.hide(t)),e.Operation.onProgress.add((e,t)=>this.update(t.operation,t.progress))}show(e){0==this._showCount&&(this.status("indefinite"),this.percentage(100)),this.message(e.message),this._showCount++}update(e,t){this.message(e.getProgressDescription(t)),null!=t.totCount&&null!=t.current?(this.percentage(Math.min(100,t.current/t.totCount*100)),this.status("show")):(this.status("show"),this.percentage(100))}hide(e){this._showCount--,0==this._showCount&&this.status("hidden")}}t.ProgressViewModel=s;class a{constructor(t){this.alias=ko.observable(),this.type=ko.observable(),this.types=[{text:$string("$(exclude)"),value:e.DaColumnType.Exclude},{text:$string("$(x-axis)"),value:e.DaColumnType.XAxis},{text:$string("$(serie)"),value:e.DaColumnType.Serie},{text:$string("$(group)"),value:e.DaColumnType.Group}],this.value=t,this.type(t.type),this.alias(t.name)}}class r extends t.BaseTreeItem{constructor(e){super(),this.value=e,this.icon="folder",this.itemType="group",this.color("#ffc107"),this.name(e.name)}attachNode(e){super.attachNode(e),e.isVisible.subscribe(e=>{for(var t of this.node.nodes())t.isVisible(e)})}}class o extends t.BaseTreeItem{constructor(e){super(),this.value=e,this.icon="insert_chart",this.itemType="serie",this.color("#4caf50"),this.name(e.name)}}t.DataImportControl=class{constructor(){this.hasHeader=ko.observable(),this.columnSeparator=ko.observable(),this.columns=ko.observable(),this.table=ko.observable(),this.treeView=new t.TreeViewModel,this.progress=new s,this.hasData=ko.observable(!1),this.sourceUrl=ko.observable(),this.fileDrop=new i,this.columnSeparators=[{text:$string("$(tab-key)"),value:"\t"},{text:",",value:","},{text:";",value:";"},{text:$string("$(sapce-key)"),value:" "}],this.treeView.setRoot(new t.TreeNodeViewModel),this.treeView.selectedNode.subscribe(e=>this.onNodeSelected(e)),this.fileDrop.onFileDropped=e=>this.importText(e)}importText(t,i){return __awaiter(this,void 0,void 0,(function*(){if(M.toast({html:$string("$(msg-start-analysis)")}),this.hasData(!0),yield e.PromiseUtils.delay(0),this._text=t,this._adapter=new e.TextTableDataAdapter,this._options=yield this._adapter.analyzeAsync(this._text,i,5e3),!this._options.columnSeparator||!this._options.rowSeparator||!this._options.columns||this._options.columns.length<2)return!1;this.hasHeader(this._options.hasHeader),this.columnSeparator(this._options.columnSeparator);const s=[];for(let e of this._options.columns){var r=new a(e);s.push(r)}return this.columns(s),yield this.updatePreview(),!0}))}getSelectedData(){return __awaiter(this,void 0,void 0,(function*(){const e=[];return yield this.getSelectedDataWork(this.treeView.root(),[],e),e}))}getSelectedDataWork(e,t,i){return __awaiter(this,void 0,void 0,(function*(){if(e.isVisible())if(e.value()instanceof o){const s=e.value().value,a={type:"data-import",options:this._options,serie:s,groups:t};i.push(a)}else{if(e.isExpanded()||(yield e.loadChildNodes()),e.value()instanceof r){const i=e.value().value;let s=t.slice(0,t.length);s.push({id:i.colId,value:i.name}),t=s}for(let s of e.nodes())yield this.getSelectedDataWork(s,t,i)}}))}executeImport(){return __awaiter(this,void 0,void 0,(function*(){const e=yield this.getSelectedData();this._onGetData&&(this._onGetData(e),this._onGetData=null),this._model.close()}))}applyChanges(){return __awaiter(this,void 0,void 0,(function*(){this._options.hasHeader=this.hasHeader(),this._options.columnSeparator=this.columnSeparator(),this._options.columns.forEach((e,t)=>{e.name=this.columns()[t].alias(),e.type=this.columns()[t].type()}),yield this.updatePreview(!0)}))}updateGroups(){return __awaiter(this,void 0,void 0,(function*(){const e=yield this._adapter.loadGroupAsync(this._text,this._options);let i=new t.TreeNodeViewModel(new r(e));this.treeView.root().clear(),this.treeView.root().addNode(i),i.value().attachNode(i),this.updateNode(i,e),i.isExpanded(!0)}))}updateNode(i,s){if(i.clear(),s.groups)for(let a of e.linq(s.groups)){let e=new t.TreeNodeViewModel(new r(a.value));e.loadChildNodes=()=>__awaiter(this,void 0,void 0,(function*(){return this.updateNode(e,a.value)})),i.addNode(e),e.value().attachNode(e)}if(s.series)for(let a of e.linq(s.series)){let e=new t.TreeNodeViewModel(new o(a.value));i.addNode(e),e.value().attachNode(e)}}updateTable(){return __awaiter(this,void 0,void 0,(function*(){const t=yield this._adapter.loadTableAsync(this._text,this._options,50),i={header:e.linq(this._options.columns).where(t=>t.type!=e.DaColumnType.Exclude).select(e=>e.name).toArray(),rows:e.linq(t).select(t=>e.linq(t).select(e=>this.format(e.value)).toArray()).toArray()};this.table(i)}))}format(t){return"number"==typeof t?formatNumber(t):"boolean"==typeof t?$string(t?"$(yes)":"$(no)"):t instanceof Date?e.DateUtils.format(t,$string("$(date-format)")):t}updatePreview(e=!1){return __awaiter(this,void 0,void 0,(function*(){e||this._options.rowsCount<4999?yield this.updateGroups():this.treeView.root().clear(),yield this.updateTable()}))}onNodeSelected(t){if(t&&t.value()instanceof o){const i=t.value().value,s={header:[e.linq(this._options.columns).where(t=>t.type==e.DaColumnType.XAxis).select(e=>e.name).first(),i.name],rows:e.linq(i.values).take(50).select(e=>[this.format(e.x),this.format(e.y)]).toArray()};this.table(s)}else this.table(null)}show(){return this._model||(this._model=M.Modal.init(document.getElementById("dataImport"),{onCloseEnd:e=>{this._onGetData&&this._onGetData([]),this.reset()}})),this._model.open(),new Promise(e=>this._onGetData=e)}reset(){this._text=null,this._options=null,this._onGetData=null,this.hasData(!1),this.treeView.root().clear(),this.table(null)}importUrl(){return __awaiter(this,void 0,void 0,(function*(){const t=e.Operation.begin($string("$(msg-download-progress)"));try{let e=yield fetch(this.sourceUrl());if(e.ok){const t=yield e.text();if(t)return void this.importText(t)}M.toast({html:$string("$(msg-download-error): "+e.statusText)})}finally{t.end()}}))}}}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),function(e){!function(t){t.InfectionDataSet={name:"COVID-19",indicators:[{id:"totalPositive",name:$string("$(total-positive)"),colorLight:"#f44336",colorDark:"#b71c1c",compute:new t.SimpleIndicatorFunction(e=>e.totalPositive)},{id:"currentPositive",name:$string("$(current-positive)"),validFor:["region","country"],colorLight:"#e91e63",colorDark:"#880e4f",compute:new t.SimpleIndicatorFunction(e=>e.currentPositive)},{id:"totalDeath",name:$string("$(death)"),validFor:["region","country"],colorLight:"#9c27b0",colorDark:"#4a148c",compute:new t.SimpleIndicatorFunction(e=>e.totalDeath)},{id:"totalSevere",name:$string("$(severe)"),validFor:["region","country"],colorLight:"#ff9800",colorDark:"#e65100",compute:new t.SimpleIndicatorFunction(e=>e.totalSevere)},{id:"totalHospedalized",name:$string("$(hospedalized)"),validFor:["region","country"],colorLight:"#fdd835",colorDark:"#fbc02d",compute:new t.SimpleIndicatorFunction(e=>e.totalHospedalized)},{id:"totalHealed",name:$string("$(healed)"),validFor:["region","country"],colorLight:"#4caf50",colorDark:"#1b5e20",compute:new t.SimpleIndicatorFunction(e=>e.totalHealed)},{id:"toatlTests",name:$string("$(tested)"),validFor:["region","country"],colorLight:"#03a9f4",colorDark:"#01579b",compute:new t.SimpleIndicatorFunction(e=>e.toatlTests)},{id:"surface",name:$string("$(surface) ($(geo))"),validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new t.ConstIndicatorFunction((t,i)=>e.MathUtils.round(i.surface,0))},{id:"density",name:$string("$(density) ($(geo))"),validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new t.ConstIndicatorFunction((t,i)=>e.MathUtils.round(i.demography.total/i.surface,0))},{id:"population",name:$string("$(population) ($(geo))"),validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new t.ConstIndicatorFunction((e,t)=>t.demography.total)},{id:"populationOld",name:$string("$(population) +65 ($(geo))"),validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new t.ConstIndicatorFunction((e,t)=>t.demography.over65)}],factors:[{id:"none",name:$string("$(none)"),compute:new t.SimpleFactorFunction((e,t,i)=>e),format:e=>formatNumber(e),reference:(e,t)=>"N/A",description:$string("[indicator]")},{id:"population",name:$string("$(population)"),compute:new t.SimpleFactorFunction((e,t,i)=>e/i.demography.total*1e5),format:e=>formatNumber(e),reference:(e,t)=>formatNumber(t.demography.total),description:$string("[indicator] $(every-100k)")},{id:"population",name:$string("$(population) +65"),compute:new t.SimpleFactorFunction((e,t,i)=>e/i.demography.over65*1e5),format:t=>formatNumber(e.MathUtils.round(t,1)),reference:(e,t)=>formatNumber(t.demography.over65),description:$string("[indicator] $(every-100k) +65")},{id:"density",name:$string("$(density)"),compute:new t.SimpleFactorFunction((e,t,i)=>e/(i.demography.total/i.surface)*1e5),format:t=>formatNumber(e.MathUtils.round(t,1)),reference:(t,i)=>formatNumber(e.MathUtils.round(i.demography.total/i.surface,1)),description:$string("[indicator] $(over-density)")},{id:"totalPositive",name:$string("$(total-positive)"),validFor:["region","country"],compute:new t.DoubleFactorFunction((e,t)=>e?e/t*100:0,new t.SimpleIndicatorFunction(e=>e.totalPositive)),format:t=>e.MathUtils.round(t,1)+"%",reference:(e,t)=>e.totalPositive?formatNumber(e.totalPositive):"N/A",description:$string("% [indicator] $(over-total-positive)")},{id:"severe",name:$string("$(severe)"),validFor:["region","country"],compute:new t.DoubleFactorFunction((e,t)=>e?e/t*100:0,new t.SimpleIndicatorFunction(e=>e.totalSevere)),format:t=>e.MathUtils.round(t,1)+"%",reference:(e,t)=>e.totalSevere?formatNumber(e.totalSevere):"N/A",description:$string("% [indicator] $(over-severe)")},{id:"test",name:$string("$(tested)"),validFor:["region","country"],compute:new t.DoubleFactorFunction((e,t)=>e?e/t*100:0,new t.SimpleIndicatorFunction(e=>e.toatlTests)),format:t=>e.MathUtils.round(t,1)+"%",reference:(e,t)=>e.toatlTests?formatNumber(e.toatlTests):"N/A",description:$string("% [indicator] $(over-tested)")}]}}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),function(e){!function(e){e.ViewModes={district:{label:{singular:$string("$(district)"),plural:$string("$(districts)")},mapGroup:"group_district",tab:"districtTab",areaType:e.GeoAreaType.District,validateId:e=>"d"==e[0].toLowerCase()},region:{label:{singular:$string("$(region)"),plural:$string("$(regions)")},mapGroup:"group_region",tab:"regionTab",areaType:e.GeoAreaType.Region,validateId:e=>"r"==e[0].toLowerCase()},country:{label:{singular:$string("$(italian)"),plural:$string("$(italians)")},mapGroup:"group_country",tab:"italyTab",areaType:e.GeoAreaType.Country,validateId:e=>"it"==e.toLowerCase()}}}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),window.ko&&(ko.bindingHandlers.attach={init:(e,t,i,s)=>{let a=ko.unwrap(t());if(!0!==a&&null!=a||(a=s.attachNode),"function"!=typeof a)throw"Supplied argument is not a function";setTimeout(()=>a.call(s,e))}}),function(e){let t;!function(e){e[e.Exclude=0]="Exclude",e[e.XAxis=1]="XAxis",e[e.Serie=2]="Serie",e[e.Group=3]="Group"}(t=e.DaColumnType||(e.DaColumnType={}));class i{constructor(){}}e.TextTableDataAdapter=class extends i{constructor(){super()}createIdentifier(e){let t=0,i="";for(let s=0;s<e.length;s++){const a=e[s];switch(t){case 0:i+=a.toLowerCase(),t=1;break;case 1:" "==a||"-"==a||"_"==a?t=2:i+=a;break;case 2:i+=a.toUpperCase(),t=1}}return i}extractHeader(i,s){const a=e.linq(new e.SplitEnumerator(i,s.rowSeparator)).first(),r=e.linq(new e.CsvSplitEnumerator(a,s.columnSeparator)).toArray();let o;if(!1!==s.hasHeader){const t=[];this.analyzeRow(r,t);const i=e.linq(t).sum(e=>e.stringCount),a=e.linq(t).sum(e=>e.emptyCount);i>0&&i+a==r.length&&(s.hasHeader=!0,o=e.linq(r).select((e,t)=>""==e?"col"+t:e).toArray())}o||(s.hasHeader=!1,o=e.linq(r).select((e,t)=>"col"+t).toArray()),s.columns||(s.columns=e.linq(o).select(e=>({id:this.createIdentifier(e),name:e,type:t.Exclude})).toArray())}extractRowSeparator(e,t){if(t.rowSeparator)return;const i=["\r\n","\n"];for(var s of i)if(-1!=e.indexOf(s))return void(t.rowSeparator=s)}extractColumnSeparator(t,i){if(i.columnSeparator)return;const s=["\t",";",","," "],a={},r=e.linq(new e.SplitEnumerator(t,i.rowSeparator)).take(10);for(let t of r)for(let i of s){if(!1===a[i])continue;const s=e.linq(new e.CsvSplitEnumerator(t,i)).count();s>1&&!(i in a)?a[i]=s:a[i]!=s&&(a[i]=!1)}for(var o in a)if(!1!==a[o])return void(i.columnSeparator=o)}analyzeRow(e,t){if(0==t.length)for(let i=0;i<e.length;i++)t.push({values:{},booleanCount:0,dateCount:0,emptyCount:0,numberCount:0,stringCount:0});for(let i=0;i<e.length;i++)this.analyzeColumn(e[i],t[i])}analyzeColumn(e,t){(!t.values||Object.keys(t.values).length<150)&&(e in t.values?t.values[e]++:t.values[e]=1),null==e||0==e.length||0==e.trim().length?t.emptyCount++:isNaN(e)?Date.parse(e)?t.dateCount++:"true"==e||"false"==e?t.booleanCount++:t.stringCount++:t.numberCount++}createParser(e){return e.numberCount>0&&0==e.stringCount?e=>isNaN(e)?null:parseFloat(e):e.booleanCount>0&&0==e.stringCount?e=>"true"==e:e.dateCount>0&&0==e.stringCount?e=>e?new Date(e):null:e.stringCount>0?e=>e?e.startsWith('"')&&e.endsWith('"')?e.substr(1,e.length-2):e:"":e=>null}analyzeAsync(i,s,a){return __awaiter(this,void 0,void 0,(function*(){s||(s={}),this.extractRowSeparator(i,s),this.extractColumnSeparator(i,s),this.extractHeader(i,s);let r=e.linq(new e.SplitEnumerator(i,s.rowSeparator));a&&(r=r.take(a)),s.hasHeader&&(r=r.skip(1));let o=e.Operation.begin("Analazing rows...");const n=[];let l=0;yield r.foreachAsync(t=>__awaiter(this,void 0,void 0,(function*(){l++,this.analyzeRow(e.linq(new e.CsvSplitEnumerator(t,s.columnSeparator)).toArray(),n),l%200==0&&(o.progress={current:l},yield e.PromiseUtils.delay(0))}))),s.rowsCount=l,o.end();const h=e.linq(s.columns);return n.forEach((e,t)=>{s.columns[t].parser||(s.columns[t].parser=this.createParser(e))}),h.any(e=>e.type==t.XAxis)||(h.first(e=>e.type==t.Exclude).type=t.XAxis),h.any(e=>e.type==t.Serie)||n.forEach((e,i)=>{e.numberCount>0&&0==e.stringCount&&(s.columns[i].type=t.Serie)}),h.any(e=>e.type==t.Group)||n.forEach((i,a)=>{if(i.stringCount>0&&0==i.emptyCount){var r=e.linq(i.values);r.count()>1&&r.any(e=>e.value>1)&&(s.columns[a].type=t.Group)}}),s}))}loadTableAsync(i,s,a){return __awaiter(this,void 0,void 0,(function*(){var r=[],o=e.linq(new e.SplitEnumerator(i,s.rowSeparator));for(var n of(s.hasHeader&&(o=o.skip(1)),o)){const i=e.linq(new e.CsvSplitEnumerator(n,s.columnSeparator)).toArray(),o={};for(let e=0;e<i.length;e++){const a=s.columns[e];a.type!=t.Exclude&&(o[a.id]=a.parser(i[e]))}if(r.push(o),a&&r.length>=a)break}return r}))}loadGroupAsync(i,s){return __awaiter(this,void 0,void 0,(function*(){var a={name:$string("$(da-main-group)")},r=e.linq(new e.SplitEnumerator(i,s.rowSeparator));s.hasHeader&&(r=r.skip(1));const o=e.linq(s.columns).where(e=>e.type==t.XAxis).select((e,t)=>t).first();let n=e.Operation.begin("Loading groups..."),l=0;return yield r.foreachAsync(i=>__awaiter(this,void 0,void 0,(function*(){const r=e.linq(new e.CsvSplitEnumerator(i,s.columnSeparator)).toArray(),h=s.columns[o].parser(r[o]);let d=a;for(let e=0;e<r.length;e++){const i=s.columns[e];if(i.type==t.Exclude||i.type==t.XAxis)continue;let a=i.parser(r[e]);i.type==t.Group?(d.groups||(d.groups={}),""===a&&(a=$string("<$(empty)>")),a in d.groups||(d.groups[a]={name:a,colId:i.id}),d=d.groups[a]):i.type==t.Serie&&(d.series||(d.series={}),i.id in d.series||(d.series[i.id]={name:i.name,colId:i.id,values:[]}),d.series[i.id].values.push({x:h,y:a}))}l++,l%200==0&&(n.progress={current:l,totCount:s.rowsCount},yield e.PromiseUtils.delay(0))}))),s.rowsCount=l,n.end(),a}))}};e.JsonDataAdapter=class extends i{constructor(){super()}loadGroupAsync(e,t){return __awaiter(this,void 0,void 0,(function*(){return null}))}loadTableAsync(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return null}))}analyzeAsync(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return null}))}}}(WebApp||(WebApp={})),function(e){!function(e){class t{static project(e){var i={x:0,y:0};return i.x=e.lng*t.OriginShift/180,i.y=Math.log(Math.tan((90+e.lat)*Math.PI/360))/(Math.PI/180),i.y=-i.y*t.OriginShift/180,i.x-=t.OFFSET_X,i.y-=t.OFFSET_Y,i}}t.EarthRadius=6378137,t.OriginShift=2*Math.PI*t.EarthRadius/2,t.OFFSET_X=1263355,t.OFFSET_Y=5543162,e.Geo=t}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),function(e){e.LinearGradient=class{constructor(...i){i.length>0?"string"==typeof i[0]?this.colors=e.linq(i).select(e=>new t(e)).toArray():this.colors=i:this.colors=[]}valueAt(e){if(e<0)return this.colors[0];e>1&&this.colors[this.colors.length-1];const i=1/(this.colors.length-1),s=Math.floor(e/i),a=Math.ceil(e/i),r=(e-s*i)/i,o=this.colors[s],n=this.colors[a],l=new t;return l.r=o.r+(n.r-o.r)*r,l.g=o.g+(n.g-o.g)*r,l.b=o.b+(n.b-o.b)*r,l}};class t{constructor(e){this.r=0,this.g=0,this.b=0,e&&this.fromHex(e)}fromHex(e){4==e.length?(this.r=parseInt("0x"+e[1]+e[1])/255,this.g=parseInt("0x"+e[2]+e[2])/255,this.b=parseInt("0x"+e[3]+e[3])/255):(this.r=parseInt("0x"+e[1]+e[2])/255,this.g=parseInt("0x"+e[3]+e[4])/255,this.b=parseInt("0x"+e[5]+e[6])/255)}toString(){function e(e){let t=Math.round(255*e).toString(16);return 1==t.length?"0"+t:t}return"#"+e(this.r)+e(this.g)+e(this.b)}}e.RgbColor=t;e.Graphics=class{constructor(e){this._svg=e}setViewPort(e,t,i,s){this._svg.viewBox.baseVal.x=e,this._svg.viewBox.baseVal.y=t,this._svg.viewBox.baseVal.width=i-e,this._svg.viewBox.baseVal.height=s-t}drawPoly(e){var t=document.createElementNS("http://www.w3.org/2000/svg","polygon");t.style.fill=e.fillColor,t.style.stroke=e.strokeColor,t.style.strokeWidth=e.strokeSize+"%",t.id=e.id;for(let i=0;i<e.geometry.points.length;i++){let s=this._svg.createSVGPoint();s.x=e.geometry.points[i].x,s.y=e.geometry.points[i].y,t.points.appendItem(s)}this._svg.appendChild(t)}}}(WebApp||(WebApp={})),function(e){!function(t){class i{constructor(t){this.message=null,this.parentOperation=null,t.type?this._type=t.type:this._type=e.OperationType.Global,this.parentOperation=t.parentOperation}end(){e.Operation.end(this)}get type(){return this._type}get progress(){return this._progress}set progress(t){this._progress=t,this._progress?(console.log(this.getProgressDescription(this._progress)),this._progress.message&&(this.message=this._progress.message),e.Operation.onProgress.raise(this,{operation:this,progress:t})):this.message=void 0}addSubOperation(e){}removeSubOperation(e){}getProgressDescription(e){let t="Progress ("+this.message+"): ";return e.message&&(t+="'"+e.message+"'"),null!=e.current&&null!=e.totCount?t+=" - "+e.current+"/"+e.totCount+" ("+Math.round(100/e.totCount*e.current)+"%)":null!=e.current&&(t+=e.current),t}}t.BaseOperationManager=class{constructor(){this._oprations=[],this.onBegin=e.event(),this.onEnd=e.event(),this.onProgress=e.event()}progress(t){e.ObjectUtils.isString(t)&&(t={message:t}),this.current&&(this.current.progress=t)}begin(t){var s;e.ObjectUtils.isString(t)&&(t={message:t});let a=new i(t);return console.group("Begin operation: ",$string(null!==(s=a.message)&&void 0!==s?s:"")),a.progress=t,void 0===a.parentOperation&&(a.parentOperation=this.current),this._oprations.push(a),a.parentOperation?a.parentOperation.addSubOperation(a):(a.type,e.OperationType.Global),this.onBegin.raise(this,a),a}end(t){var i;console.groupEnd(),console.log("End operation: ",$string(null!==(i=t.message)&&void 0!==i?i:""));const s=this._oprations.indexOf(t);this._oprations.splice(s,1),t.parentOperation?t.parentOperation.removeSubOperation(t):(t.type,e.OperationType.Global),this.onEnd.raise(this,t)}get current(){return this._oprations.length>0?this._oprations[this._oprations.length-1]:null}get operations(){return this._oprations}}}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),function(e){e.Operation=new e.GeoPlot.BaseOperationManager}(WebApp||(WebApp={})),function(e){e.SplitEnumerator=class{constructor(e,t,i=0){this._value=e,this._separator=t,this._startIndex=i}get current(){return this._current||(this._current=this._value.substring(this._currentStartIndex,this._curIndex-this._separator.length)),this._current}moveNext(){if(this._curIndex>this._value.length)return!1;this._currentStartIndex=this._curIndex;var e=this._value.indexOf(this._separator,this._curIndex);return this._curIndex=-1==e?this._value.length+1:e+this._separator.length,this._current=null,!0}reset(){this._curIndex=this._startIndex,this._currentStartIndex=this._curIndex,this._current=null}};e.CsvSplitEnumerator=class{constructor(e,t,i=0){this._state=0,this._wordLength=0,this._value=e,this._separator=t,this._startIndex=i}get current(){return this._current||(this._current=this._value.substr(this._wordStartIndex,this._wordLength),this._hasEscape&&(this._current=this._current.replace('""','"'))),this._current}moveNext(){let e=!1;for(;;){const t=this._curIndex>=this._value.length?"":this._value[this._curIndex];switch(this._state){case 0:'"'==t?(this._state=1,this._hasEscape=!1,this._wordLength=0,this._wordStartIndex=this._curIndex+1):t!=this._separator&&t?(this._state=2,this._wordLength=1,this._wordStartIndex=this._curIndex):(this._wordStartIndex=this._curIndex,this._wordLength=0,e=this._curIndex<=this._value.length);break;case 1:'"'==t?this._state=3:this._wordLength++;break;case 2:t!=this._separator&&t?this._wordLength++:(this._state=0,e=!0);break;case 3:'"'==t?(this._hasEscape=!0,this._wordLength+=2,this._state=1):t!=this._separator&&t?this._state=4:(e=!0,this._state=0);break;case 4:t!=this._separator&&t||(e=!0,this._state=0)}if(this._curIndex++,!t||e)break}return this._current=null,e}reset(){this._hasEscape=!1,this._curIndex=this._startIndex,this._wordStartIndex=this._curIndex,this._wordLength=0,this._current=null,this._state=0}}}(WebApp||(WebApp={})),function(e){class t{constructor(e,t){this.isVisible=ko.observable(!1),this.isTransparent=ko.observable(!1),this.value=e,this._closeAfter=t}dontShowAgain(){}onActionExecuted(){}executeAction(){this.value.showAction&&this.value.showAction(),setTimeout(()=>this.startPulse()),this.onActionExecuted()}startPulse(){if(this._element=document.querySelector(this.value.elementSelector),!this._element)return;let t=e.DomUtils.centerElement(this._element);e.DomUtils.addClass(this._element,"pulse");let i=document.querySelector(".tip-container");t<i.clientTop+i.clientHeight&&this.isTransparent(!0)}stopPulse(){this._element&&(e.DomUtils.removeClass(this._element,"pulse"),this.isTransparent(!1))}next(){}understood(){}onClose(){}close(){clearTimeout(this._closeTimeoutId),this.stopPulse(),this.isVisible(!1),this.onClose()}show(){this._closeTimeoutId&&clearTimeout(this._closeTimeoutId),this.isVisible(!0),this._closeAfter&&(this._closeTimeoutId=setTimeout(()=>this.close(),this._closeAfter))}}e.TipViewModel=t;e.TipManager=class{constructor(e,t,i){this.tip=ko.observable(),this._getPreferences=t,this._tips=e,this.savePreferences=i}get preferences(){return this._getPreferences()}savePreferences(){}markAction(t,i){this.preferences.actions[t]++,this.savePreferences(),window.gtag&&e.safeCall(()=>gtag("event",t,{event_category:"GeoPlot",event_label:i,value:this.preferences.actions[t]}))}markTip(t,i){window.gtag&&e.safeCall(()=>gtag("event",i,{event_category:"GeoPlot/Tip",event_label:t}))}engageUser(){if(null!=this.preferences.showTips&&!this.preferences.showTips)return;const t=e.linq(this._tips).where(e=>e.value.showAfter>0&&0==this.preferences.actions[e.key]).first();this.showTip(t.key,{onClose:()=>this.engageUser(),timeout:t.value.showAfter})||this.engageUser()}showTip(i,s){if(null!=this.preferences.showTips&&!this.preferences.showTips)return!1;if((!s||!s.override)&&this.tip()&&this.tip().isVisible())return!1;if((!s||!s.force)&&this.preferences.actions[i])return!1;const a=this._tips[i],r=new t(a);r.onActionExecuted=()=>{this.markTip(i,"how")},r.dontShowAgain=()=>{this.preferences.showTips=!1,this.savePreferences(),r.close(),this.markTip(i,"dontShowAgain")},r.understood=()=>{this.preferences.actions[i]++,this.savePreferences(),r.close(),this.markTip(i,"understood")},r.onClose=()=>{s&&s.onClose&&s.onClose()};let o=e.linq(this._tips).where(e=>e.value.order>a.order&&0==this.preferences.actions[e.key]).first();return r.next=o?()=>{r.close(),this.preferences.actions[i]++,this.showTip(o.key),this.markTip(i,"next")}:null,this.tip(r),setTimeout(()=>r.show(),s&&s.timeout?1e3*s.timeout:0),!0}}}(WebApp||(WebApp={})),function(e){!function(t){class i{constructor(){this.value=ko.observable()}select(){}}class s{constructor(){this.data=ko.observable(),this.factor=ko.observable(),this.indicator=ko.observable(),this.reference=ko.observable(),this.indicators=ko.observable()}select(){}}t.GeoPlotPage=class{constructor(i){this._topAreasVisible=!1,this._execludedArea=new Map,this._dataSet=t.InfectionDataSet,this._keepState=!1,this._debugMode=!1,this._tips={areaSelected:{order:0,featureName:"Zone",html:"Puoi vedere i dati relativi ad una particolare area selezionadoli sulla mappa.",elementSelector:".card-map .center-align",showAfter:3,showAction:()=>{this.viewMode("region"),this.selectedArea=this._geo.areas.r10}},indicatorSelected:{order:1,featureName:"Indicatori",html:"Puoi vedere il grafico associato all'indicatore, facendo click sull'indicatore.",elementSelector:".indicators .summary-field",showAfter:15,showAction:()=>{this.currentArea()||this._tips.areaSelected.showAction(),this.selectedIndicator(e.linq(this._dataSet.indicators).first(e=>"totalDeath"==e.id))}},dayChanged:{order:2,featureName:"Cronologia",html:"Puoi vedere gli indicatori dei giorni precedenti muovendo la slide.",elementSelector:".day input[type=range]",showAfter:20,showAction:()=>{this.dayNumber(5)}},indicatorChanged:{order:3,featureName:"Indicatori",html:"Puoi cambiare l'indicatore scegliendolo dal filtro nell'elenco.",elementSelector:".filter-indicator",showAfter:0},viewChanged:{order:4,featureName:"Zone",html:"Puoi vedere gli indicatori a livello regionale, nazionale o provinciale.",elementSelector:"#areaTabs",showAfter:0,showAction:()=>{this.viewMode("district")}},topAreasOpened:{order:5,featureName:"Zone",html:"Puo vedere le zone più colpite di un qualsiasi indicatore scelto.",elementSelector:"#topCases .card-title",showAfter:20,showAction:()=>{"country"==this.viewMode()&&this.viewMode("region"),M.Collapsible.getInstance(document.getElementById("topCases")).open(0)}},deltaSelected:{order:5.5,featureName:"Indicatori",html:"Puoi vedere l'incremento giornaliero dell'indicatore anzichè il valore totale.",elementSelector:".day-delta",showAfter:20,showAction:()=>{this.currentArea()||this._tips.areaSelected.showAction(),this.isDayDelta(!0)}},factorChanged:{order:6,featureName:"Indicatori",html:"Puoi mettere in relazione qualsiasi indicatore a numerosi parametri (es. % Positivi su Tamponi).",elementSelector:".filter-factor",showAfter:30,showAction:()=>{this.currentArea()||this._tips.areaSelected.showAction(),this.selectedIndicator(e.linq(this._dataSet.indicators).first(e=>"totalPositive"==e.id)),this.selectedFactor(e.linq(this._dataSet.factors).first(e=>"population"==e.id))}},groupChanged:{order:7,featureName:"Grafico",html:"Puo raggruppare i dati del grafico in gruppi da 1 a 7 giorni. Puoi anche scegliere la data d'inizio.",elementSelector:".row-chart-group .select-wrapper",showAfter:30,showAction:()=>{this.currentArea()||this._tips.areaSelected.showAction();var e=document.querySelector(".chart-options");e.classList.contains("closed")&&e.classList.remove("closed"),this.groupSize(2),M.FormSelect.init(document.querySelectorAll(".row-chart-group select"))}},chartActionExecuted:{order:8,featureName:"Grafico",html:"Puoi portare il grafico a schermo interno, copiarlo, o copiare la serie numerico e incollarla in excel.",elementSelector:".chart .actions",showAfter:30},scaleChanged:{order:9,featureName:"Grafico",html:"Puoi cambiare da scala logaritmica a scala lineare.",elementSelector:".log-scale",showAfter:210,showAction:()=>{this.isLogScale(!0)}},maxFactorChanged:{order:10,featureName:"Mappa",html:"Puoi cambiare il riferimento rispetto al quale la mappa viene colorata. Normalmente è in base al valore massimo che si ha avuto globalmente.",elementSelector:".max-factor",showAfter:60,showAction:()=>{this.currentArea()||this._tips.areaSelected.showAction(),this.selectedIndicator(e.linq(this._dataSet.indicators).first(e=>"totalPositive"==e.id)),this.autoMaxFactor(!1),this.maxFactor(1e3)}},regionExcluded:{order:11,featureName:"Mappa",html:"Nella vista nazionale puoi escludere dagli indicatori il valore di una o più regioni cliccando sulla mappa.",elementSelector:".card-map .center-align",showAfter:0,showAction:()=>{"country"!=this.viewMode()&&this.viewMode("country"),this._execludedArea.set("R8",this._geo.areas.r8),this.updateIndicator()}}},this._specialDates={current:{date:void 0,color:"#000",width:.5,label:"Giorno corrente"},dpcm8:{date:new Date(2020,2,7),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 8 Marzo (italia zona rossa)"},dpcm9:{date:new Date(2020,2,9),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 9 Marzo (italia zona rossa)"},dpcm11:{date:new Date(2020,2,11),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 11 Marzo (chiusura attività)"},mds20:{date:new Date(2020,2,20),color:"#070",dash:[5,5],width:1,visible:!1,label:"MDS 20 Marzo (chiura parchi, motoria nelle vicinane)"},dpcm22:{date:new Date(2020,2,21),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 22 Marzo (chiusura ulteriore attività)"},dpcm25:{date:new Date(2020,2,24),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 25 Marzo (maggiori sanzioni)"}},this.dayNumber=ko.observable(0),this.totalDays=ko.observable(0),this.currentData=ko.observable(),this.currentArea=ko.observable(),this.topAreas=ko.observable(),this.viewMode=ko.observable("district"),this.selectedIndicator=ko.observable(),this.selectedFactor=ko.observable(),this.autoMaxFactor=ko.observable(!0),this.maxFactor=ko.observable(),this.isPlaying=ko.observable(!1),this.isLogScale=ko.observable(!1),this.isDayDelta=ko.observable(!1),this.isZoomChart=ko.observable(!1),this.isShowEnvData=ko.observable(!1),this.groupSize=ko.observable(1),this.startDay=ko.observable(0),this.isNoFactorSelected=ko.computed(()=>this.selectedFactor()&&"none"==this.selectedFactor().id),this.groupDays=[1,2,3,4,5,6,7],this.factorDescription=ko.observable(),this._data=i.data,this._geo=i.geo,this._debugMode=i.debugMode,this._calculator=new t.IndicatorCalculator(this._data,this._dataSet,this._geo),this.totalDays(this._data.days.length-1),this.dayNumber.subscribe(e=>{e!=this._data.days.length-1&&this.tipManager.markAction("dayChanged"),this.updateDayData(),this._specialDates.current.date=new Date(this._data.days[e].date),this.updateChart()}),this._mapSvg=document.getElementsByTagName("svg").item(0),this._mapSvg.addEventListener("click",e=>this.onMapClick(e)),this.days=[];for(var s=0;s<this._data.days.length;s++)this.days.push({number:s,value:new Date(this._data.days[s].date),text:e.DateUtils.format(this._data.days[s].date,$string("$(date-format-short)"))});M.Tabs.init(document.getElementById("areaTabs")).options.onShow=e=>{this.setViewMode(e.dataset.viewMode)};const a=M.Collapsible.init(document.getElementById("topCases"));a.options.onOpenStart=()=>{this._daysData||this.updateTopAreas(),this._topAreasVisible=!0,this.tipManager.markAction("topAreasOpened")},a.options.onCloseEnd=()=>{this._topAreasVisible=!1},this.indicators=ko.computed(()=>e.linq(this._dataSet.indicators).where(e=>!e.validFor||-1!=e.validFor.indexOf(this.viewMode())).toArray()),this.factors=ko.computed(()=>e.linq(this._dataSet.factors).where(e=>!e.validFor||-1!=e.validFor.indexOf(this.viewMode())).toArray()),this.selectedIndicator.subscribe(e=>{e&&(this.updateIndicator(),"totalPositive"!=e.id&&this.tipManager.markAction("indicatorChanged",e.id))}),this.selectedFactor.subscribe(e=>{e&&(this.updateIndicator(),"none"!=e.id&&this.tipManager.markAction("factorChanged",e.id),setTimeout(()=>M.FormSelect.init(document.querySelectorAll(".row-chart-group select"))))}),this.autoMaxFactor.subscribe(e=>{e&&(this.updateMaxFactor(),this.updateMap()),this.updateUrl()}),this.maxFactor.subscribe(e=>{this.autoMaxFactor()||(this.updateMap(),this.tipManager.markAction("maxFactorChanged",e.toString())),this.updateUrl()}),this.isDayDelta.subscribe(e=>{this.computeStartDayForGroup(),this.updateIndicator(),e&&this.tipManager.markAction("deltaSelected")}),this.isLogScale.subscribe(e=>{this.updateChart(),this.updateUrl(),e&&this.tipManager.markAction("scaleChanged")}),this.isZoomChart.subscribe(e=>{this.updateChart()}),this.groupSize.subscribe(e=>{this.computeStartDayForGroup(),this.updateChart(),this.updateUrl(),e>1&&this.tipManager.markAction("groupChanged",e.toString())}),this.startDay.subscribe(e=>{this.updateChart(),this.updateUrl()});const r=new URLSearchParams(window.location.search),o=r.get("state");let n;this._keepState="true"==r.get("keepState"),this.loadPreferences(),this.tipManager=new e.TipManager(this._tips,()=>this._preferences,()=>this.savePreferences()),this.tipManager.engageUser(),n=o&&this._keepState?JSON.parse(atob(o)):{},setTimeout(()=>this.loadState(n),0),this._debugMode||window.addEventListener("beforeunload",()=>this.savePreferences())}isDefaultState(e){return!(e.day&&e.day!=this._data.days.length-1||e.view&&"region"!=e.view||e.area||e.indicator&&"totalPositive"!=e.indicator||e.factor&&"none"!=e.factor||e.maxFactor||e.dayDelta||e.logScale||e.showEnvData||e.groupSize&&1!=e.groupSize||null!=e.startDay&&0!=e.startDay||e.excludedArea)}loadState(i){if(i.view||(i.view="region"),M.Tabs.getInstance(document.getElementById("areaTabs")).select(t.ViewModes[i.view].tab),document.body.scrollTop=0,null!=i.logScale&&this.isLogScale(i.logScale),i.groupSize&&this.groupSize(i.groupSize),null!=i.startDay&&this.startDay(i.startDay),null!=i.dayDelta&&this.isDayDelta(i.dayDelta),null!=i.showEnvData&&this.isShowEnvData(i.showEnvData),i.maxFactor&&(this.autoMaxFactor(!1),this.maxFactor(i.maxFactor)),this.dayNumber(null!=i.day?i.day:this._data.days.length-1),i.excludedArea){this._execludedArea.clear();for(let e of i.excludedArea)this._execludedArea.set(e,this._geo.areas[e.toLowerCase()])}i.indicator&&this.selectedIndicator(e.linq(this._dataSet.indicators).first(e=>e.id==i.indicator)),i.factor&&this.selectedFactor(e.linq(this._dataSet.factors).first(e=>e.id==i.factor)),i.area&&(this.selectedArea=this._geo.areas[i.area.toLowerCase()])}saveStata(){return{view:"region"==this.viewMode()?void 0:this.viewMode(),indicator:this.selectedIndicator()?this.selectedIndicator().id:void 0,factor:this.selectedFactor()?this.selectedFactor().id:void 0,dayDelta:!!this.isDayDelta()||void 0,maxFactor:this.autoMaxFactor()?void 0:this.maxFactor(),day:this.dayNumber()==this._data.days.length-1?void 0:this.dayNumber(),area:this.selectedArea?this.selectedArea.id:void 0,groupSize:1==this.groupSize()?void 0:this.groupSize(),startDay:0==this.startDay()?void 0:this.startDay(),logScale:!!this.isLogScale()||void 0,excludedArea:this._execludedArea.size>0?e.linq(this._execludedArea.keys()).toArray():void 0,showEnvData:!!this.isShowEnvData()||void 0}}loadPreferences(){let e=localStorage.getItem("preferences");if(e){try{this._preferences=JSON.parse(e)}catch(e){}this._preferences&&1==this._preferences.version||(this._preferences=this.getDefaultPreferences(),this._preferences.isFirstView=!1,this._preferences.showTips=!1,this.savePreferences())}else this._preferences=this.getDefaultPreferences()}getDefaultPreferences(){return{isFirstView:!0,showTips:!0,version:1,actions:{areaSelected:0,indicatorSelected:0,indicatorChanged:0,dayChanged:0,viewChanged:0,chartActionExecuted:0,factorChanged:0,groupChanged:0,maxFactorChanged:0,scaleChanged:0,topAreasOpened:0,deltaSelected:0,regionExcluded:0}}}savePreferences(){this._preferences.isFirstView=!1,localStorage.setItem("preferences",JSON.stringify(this._preferences))}toggleChartZoom(){this._preferences.actions.chartActionExecuted++,this.isZoomChart(!this.isZoomChart())}copyMap(){return __awaiter(this,void 0,void 0,(function*(){const e=document.querySelector("svg.map"),t=e.outerHTML,i=new Blob([t],{type:"image/svg+xml"});if(navigator.clipboard&&navigator.clipboard.write){const t=document.createElement("img");t.style.width=e.clientWidth+"px",t.style.height=e.clientHeight+"px",t.onload=function(){const i=document.createElement("canvas");i.width=e.clientWidth,i.height=e.clientHeight;const s=i.getContext("2d");s.fillStyle="white",s.fillRect(0,0,i.width,i.height),s.drawImage(t,0,0),i.toBlob(e=>__awaiter(this,void 0,void 0,(function*(){let t=new ClipboardItem({[e.type]:e});yield navigator.clipboard.write([t]),M.toast({html:$string("$(msg-map-copied)")})})))},t.src=window.URL.createObjectURL(i)}else{const e=document.createElement("a");e.href=window.URL.createObjectURL(i),e.target="_blan",e.download="map.svg",e.click(),M.toast({html:$string("$(msg-no-copy)")})}}))}copyChart(){this._chart.canvas.toBlob(e=>__awaiter(this,void 0,void 0,(function*(){if(navigator.clipboard&&navigator.clipboard.write){let t=new ClipboardItem({[e.type]:e});yield navigator.clipboard.write([t]),M.toast({html:$string("$(msg-chart-copied)")})}else{const t=window.URL.createObjectURL(e),i=document.createElement("a");i.href=t,i.target="_blan",i.download=this._chart.options.title.text+".png",i.click(),M.toast({html:$string("$(msg-no-copy)")})}}))),this.tipManager.markAction("chartActionExecuted","copy")}copySerie(){return __awaiter(this,void 0,void 0,(function*(){const t=this._chart.data.datasets[0].data;let i="";for(let s=0;s<t.length;s++)i+=e.DateUtils.format(t[s].x,$string("$(date-format)"))+"\t"+s+"\t"+e.MathUtils.round(t[s].y,1)+"\n";e.DomUtils.copyText(i),M.toast({html:$string("$(msg-serie-copied)")}),this.tipManager.markAction("chartActionExecuted","copySerie")}))}copySerieForStudio(){return __awaiter(this,void 0,void 0,(function*(){let t={type:"serie",version:1,color:this.selectedIndicator().colorLight,serie:{type:"geoplot",areaId:this.selectedArea.id,indicatorId:this.selectedIndicator().id,xAxis:"dayNumber",startDay:this.startDay(),exeludedAreaIds:e.linq(this._execludedArea.keys()).toArray(),factorId:this.selectedFactor().id,groupSize:this.groupSize(),isDelta:this.isDayDelta()},title:this.factorDescription()};t.values=this._calculator.getSerie(t.serie),e.DomUtils.copyText(JSON.stringify(t)),M.toast({html:$string("$(msg-serie-copied-studio)")}),this.tipManager.markAction("chartActionExecuted","copySerieForStudio")}))}play(){this.dayNumber()==this._data.days.length-1&&this.dayNumber(0),this.isPlaying(!0),this.nextFrame()}pause(){this.isPlaying(!1)}setViewMode(e){"region"!=e&&this.tipManager.markAction("viewChanged",e),this.viewMode(e);const t=document.getElementById("group_district");"district"==e?t.style.removeProperty("display"):t.style.display="none",this.selectedArea=null,this._chart=null,this._execludedArea.clear(),this.clearMap(),this.updateMaxFactor(),this.updateDayData(),"country"==this.viewMode()?(this.selectedArea=this._geo.areas.it,this.tipManager.showTip("regionExcluded",{timeout:5})):this._topAreasVisible?this.updateTopAreas():this._daysData=void 0,setTimeout(()=>M.FormSelect.init(document.querySelectorAll(".row-indicator select")))}get selectedArea(){return this._selectedArea}set selectedArea(e){if(e!=this._selectedArea){if(this._selectedArea){const e=document.getElementById(this._selectedArea.id.toUpperCase());e&&e.classList.remove("selected")}if(this._selectedArea=e,this._selectedArea){const e=document.getElementById(this._selectedArea.id.toUpperCase());if(e){e.classList.add("selected");const t=e.parentElement;e.remove(),t.appendChild(e)}}this.changeArea()}}getFactorValue(t,i){return this._calculator.getFactorValue({dayNumberOrGroup:t,areaOrId:i,factorId:this.selectedFactor().id,indicatorId:this.selectedIndicator().id,isDayDelta:this.isDayDelta(),execludedAreas:e.linq(this._execludedArea.keys()).toArray()})}getIndicatorValue(t,i,s){return this._calculator.getIndicatorValue({dayNumber:t,areaOrId:i,indicatorId:s,isDayDelta:this.isDayDelta(),execludedAreas:e.linq(this._execludedArea.keys()).toArray()})}computeStartDayForGroup(){const e=(this.days.length-this.startDay())%this.groupSize();if(0!=e){const t=this.groupSize()-e;this.startDay()-t>=0?this.startDay(this.startDay()-t):this.startDay()+e<this.days.length-1&&this.startDay(this.startDay()+e),M.FormSelect.init(document.querySelectorAll(".row-chart-group select"))}}onMapClick(e){const t=e.target,i=t.parentElement.id,s=this._geo.areas[i.toLowerCase()];s&&("country"==this.viewMode()?(this._execludedArea.has(i)?this._execludedArea.delete(i):(this._execludedArea.set(i,s),M.toast({html:$string("$(msg-region-ex)").replace("[region]",s.name)})),this.updateIndicator()):t.parentElement.classList.contains(this.viewMode())&&(this.selectedArea=s),this.tipManager.markAction("areaSelected",s.name))}nextFrame(){this.isPlaying()&&(this.dayNumber()>=this._data.days.length-1?this.pause():this.dayNumber(parseInt(this.dayNumber().toString())+1),setTimeout(()=>this.nextFrame(),1e3))}changeArea(){if(null==this._selectedArea)this.currentArea(null);else{var e=!this.currentArea();const t=new s;t.value=this._selectedArea,this.updateArea(t),this.currentArea(t),this.updateFactorDescription(),this.updateAreaIndicators(),this.updateChart(),e&&(M.FormSelect.init(document.querySelectorAll(".row-chart-group select")),M.Tooltip.init(document.querySelectorAll(".row-chart-group .tooltipped")))}this.updateUrl()}updateAreaIndicators(){if(!this.currentArea())return;if(!this.currentArea().indicators()){const e=[];for(let t of this.indicators()){let s=new i;s.indicator=t,s.select=()=>{this.tipManager.markAction("indicatorSelected",s.indicator.id),this.selectedIndicator(t),setTimeout(()=>M.FormSelect.init(document.querySelectorAll(".row-indicator select")))},e.push(s)}this.currentArea().indicators(e)}const e=this.currentArea().value.id.toLowerCase();for(let t of this.currentArea().indicators())t.value(this.getIndicatorValue(this.dayNumber(),e,t.indicator.id))}updateFactorDescription(){let e="";if(this.isDayDelta()&&(e="$(new) "),e+=this.selectedFactor().description.replace("[indicator]",this.selectedIndicator().name),this.currentArea()&&(e+=" - "+this.currentArea().value.name),this._execludedArea.size>0){e+=" - $(except) (";let t=0;for(let i of this._execludedArea.keys())t>0&&(e+=", "),e+=this._execludedArea.get(i).name,t++;e+=")"}this.factorDescription($string(e))}updateIndicator(){this.selectedIndicator()&&this.selectedFactor()&&(this.updateFactorDescription(),this.updateMaxFactor(),this.updateDayData(),this.updateChart(),this.updateUrl(),this._topAreasVisible&&this.updateTopAreas())}updateMaxFactor(){if(!this.selectedFactor()||!this.selectedIndicator()||!this.autoMaxFactor())return;let e=Number.NEGATIVE_INFINITY,i=t.ViewModes[this.viewMode()];for(let t=0;t<this._data.days.length;t++){const s=this._data.days[t];for(let a in s.values){if(!i.validateId(a))continue;const s=this.getFactorValue(t,a);s>e&&s!=Number.POSITIVE_INFINITY&&(e=s)}}this.maxFactor(parseFloat(e.toFixed(1)))}initChart(){const t=document.querySelector("#areaGraph"),i={afterDraw:e=>{const t=e.data.datasets[0].data;if(!t||0==t.length)return;const i=e.scales["x-axis-0"],s=e.ctx;for(let t in this._specialDates){let a=this._specialDates[t];if(!a.date||!1===a.visible)continue;let r=i.getPixelForValue({x:a.date});s.lineWidth=a.width||1,s.beginPath(),s.moveTo(r,e.chartArea.top),s.lineTo(r,e.chartArea.bottom),s.strokeStyle=a.color||"#000",a.dash?s.setLineDash(a.dash):s.setLineDash([]),a.dashOffset&&(s.lineDashOffset=a.dashOffset),s.stroke()}}};this._chart=new Chart(t,{plugins:[i],type:"line",data:{datasets:[{lineTension:0,data:[],borderWidth:1}]},options:{maintainAspectRatio:!1,legend:{display:!0,position:"bottom"},title:{display:!1},tooltips:{callbacks:{label:(t,i)=>t.xLabel+": "+e.MathUtils.round(parseFloat(t.value),1)}},scales:{xAxes:[{type:"time",distribution:"linear",time:{unit:"day",tooltipFormat:"DD/MMM"}}]}}})}updateChart(){if(!this.selectedIndicator()||!this.currentArea()||!this.selectedFactor())return;null==this._chart&&this.initChart();const t=this.currentArea().value;t.id.toLowerCase(),this.selectedIndicator().id;this._chart.data.datasets[0].label=this.factorDescription(),this._chart.options.title.text=this._chart.data.datasets[0].label,this.isLogScale()?this._chart.options.scales.yAxes[0].type="logarithmic":this._chart.options.scales.yAxes[0].type="linear",this._chart.data.datasets[0].borderColor=this.selectedIndicator().colorDark,this._chart.data.datasets[0].backgroundColor=this.selectedIndicator().colorLight,this._chart.data.datasets[0].data=this._calculator.getSerie({type:"geoplot",areaId:t.id,indicatorId:this.selectedIndicator().id,xAxis:"date",startDay:this.startDay(),exeludedAreaIds:e.linq(this._execludedArea.keys()).toArray(),factorId:this.selectedFactor().id,groupSize:this.groupSize(),isDelta:this.isDayDelta()}),this._chart.update()}updateArea(t,i){if(!t||!this.selectedIndicator()||!this.selectedFactor())return;null==i&&(i=this.dayNumber());const s=t.value.id.toLowerCase(),a=t.value,r=this._data.days[i];r&&r.values[s]?(t.data(r.values[s]),t.indicator(this.getIndicatorValue(i,s,this.selectedIndicator().id)),t.factor(e.MathUtils.round(this.getFactorValue(i,a),1)),t.reference(this.selectedFactor().reference(r.values[s],a))):M.toast({html:$string("$msg-no-data)")})}updateTopAreas(){this._daysData=[];for(let i=0;i<this._data.days.length;i++){const a=this._data.days[i],r={},o=t.ViewModes[this.viewMode()].validateId;r.topAreas=e.linq(a.values).select(e=>({factor:this.getFactorValue(i,e.key),value:e})).orderByDesc(e=>e.factor).where(e=>o(e.value.key)).select(e=>{const t=new s;return t.value=this._geo.areas[e.value.key.toLowerCase()],t.select=()=>this.selectedArea=t.value,this.updateArea(t,i),t}).take(25).toArray(),this._daysData.push(r)}this.topAreas(this._daysData[this.dayNumber()].topAreas)}updateDayData(){const t=this._data.days[this.dayNumber()];this.currentData(e.DateUtils.format(t.date,$string("$(date-format)"))),this.updateMap(),this.updateArea(this.currentArea()),this.updateAreaIndicators(),this._daysData&&this._topAreasVisible&&this.topAreas(this._daysData[this.dayNumber()].topAreas),this.updateUrl()}updateUrl(){if(!this._keepState)return;const t=this.saveStata();let i=e.app.baseUrl+"Overview";this.isDefaultState(t)||(i+="?state="+encodeURIComponent(btoa(JSON.stringify(t)))+"&keepState=true"),history.replaceState(null,null,i)}clearMap(){const e=this._data.days[this.dayNumber()];for(const t in e.values){const e=document.getElementById(t.toUpperCase());e&&e.style.removeProperty("fill")}}updateMap(){if(this.selectedIndicator()&&this.selectedFactor())if("country"!=this.viewMode()){const i=this._data.days[this.dayNumber()],s=new e.LinearGradient("#fff",this.selectedIndicator().colorDark);for(const a in i.values){const i=document.getElementById(a.toUpperCase());if(i){const r=this._geo.areas[a];if(r.type!=t.ViewModes[this.viewMode()].areaType)continue;let o=this.getFactorValue(this.dayNumber(),r);if(o==Number.POSITIVE_INFINITY&&(o=NaN),o=Math.min(1,o/this.maxFactor()),isNaN(o))i.classList.contains("valid")&&i.classList.remove("valid"),i.style.removeProperty("fill");else{i.classList.contains("valid")||i.classList.add("valid");e.MathUtils.discretize(e.MathUtils.exponential(o),20);i.style.fill=s.valueAt(.15+.85*o).toString()}}}}else e.linq(document.querySelectorAll("g.region")).foreach(e=>{this._execludedArea.has(e.id)?e.style.fill="#444":e.style.fill="#FFF"})}}}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={})),function(e){!function(t){function i(e){if(null!=e&&null!=e)return e.toString()}class s{constructor(){for(var e in this.isOpened=ko.observable(!1),this.colors=[],t.MATERIAL_COLORS)this.addColor(t.MATERIAL_COLORS[e][600]);this._mouseDown=e=>this.onMouseDown(e)}attachNode(e){this._element=e,document.body.appendChild(this._element)}pick(){return __awaiter(this,void 0,void 0,(function*(){return yield this.open(),new Promise(e=>this._onSelected=e)}))}addColor(e){this.colors.push({value:e,select:()=>{this._onSelected&&this._onSelected(e),this._onSelected=null,this.close()}})}open(){return __awaiter(this,void 0,void 0,(function*(){if(!this.isOpened()){if(this.isOpened(!0),window.event){const e=window.event,t={x:e.pageX,y:e.pageY};this._element.style.left=t.x+"px",this._element.style.top=t.y-this._element.clientHeight+"px"}document.body.addEventListener("mousedown",this._mouseDown)}}))}close(){this.isOpened()&&(this.isOpened(!1),document.body.removeEventListener("mousedown",this._mouseDown))}onMouseDown(e){e.target.parentElement!=this._element&&(this._onSelected&&this._onSelected(void 0),this._onSelected=null,this.close())}}s.instance=new s;class a{constructor(e){this.min=ko.observable(),this.max=ko.observable(),this.step=ko.observable(),this.isSelected=ko.observable(!0),this.value=e.value,this.name=e.name}}class r{constructor(){this.vars={},this.treeItems={}}setExpressions(t){const i=this.calculator.getState();for(let s of t){const t=e.linq(i.expressions.list).first(e=>e.id==s.id);if(t)for(let e of Object.getOwnPropertyNames(s))t[e]=s[e];else i.expressions.list.push(s)}const s=e.linq(i.expressions.list).where(e=>"folder"!=e.type).groupBy(e=>e.folderId?e.folderId:"").toDictionary(e=>e.key,e=>e.values.toArray()),a=[];for(let t of e.linq(i.expressions.list).where(e=>"folder"==e.type)){a.push(t);const e=s[t.id];if(e)for(let t of e)a.push(t)}const r=s[""];if(r)for(let e of r)a.push(e);i.expressions.list=a,this.calculator.setState(i)}setSelectedId(e){this.calculator.controller.listModel.selectedItem&&this.calculator.controller.listModel.selectedItem.id==e||this.calculator.controller.dispatch({type:"set-selected-id",id:e})}setColor(e,t){this.calculator.controller.dispatch({type:"set-item-color",id:e,color:t})}updateTable(t,i){const s=e.linq(this.calculator.getExpressions()).where(e=>e.id==t).first();s&&(s.columns[0].values=e.linq(i).select(e=>e.x.toString()).toArray(),s.columns[1].values=e.linq(i).select(e=>e.y.toString()).toArray(),this.calculator.setExpression(s))}updateExpression(t){e.linq(this.calculator.getExpressions()).where(e=>e.id==t.id).first();this.calculator.setExpression(t)}updateVariable(e,t,i){t&&this.updateExpression({id:e,latex:t+"="+i.toString()})}expressionZoomFit(e){this.calculator.controller.dispatch({type:"expression-zoom-fit",id:e})}setItemVisibile(e,t){this.updateExpression({id:e,hidden:!t})}generateVars(e){for(let t in e)e[t]||(e[t]=this.generateVar(t))}generateVar(e="a"){return this.vars[e[0]]||(this.vars[e[0]]=0),this.vars[e[0]]++,e[0]+"_{"+this.vars[e[0]]+"}"}}class o{constructor(){this.canDrag=!1,this.name=ko.observable(),this.time=ko.observable(0),this.color=ko.observable(),this.parameters=ko.observableArray()}createActions(i){i.push(e.apply(new t.ActionViewModel,e=>{e.text=$string("$(delete)"),e.icon="delete",e.execute=()=>this.remove()}))}canAccept(e){return!1}canReadData(e){return!1}readData(e){}writeData(e){return!1}setState(e){e.name&&this.name(e.name),null!=e.visible&&this.node.isVisible(e.visible),e.color&&this.color(e.color),null!=e.opened&&this.node.isExpanded(e.opened),e.folderId&&(this.folderId=e.folderId),this.setStateWork(e),this.updateGraph(),this.setChildrenStateWork(e)}getState(){return{name:this.name(),visible:this.node.isVisible(),folderId:this.folderId,color:this.color(),opened:this.node.isExpanded()}}getVar(e){return this._varsMap[e]}remove(e=!0){this._graphCtx&&(this._graphCtx.calculator.removeExpression({id:this.getGraphId("private")}),this._graphCtx.calculator.removeExpression({id:this.getGraphId("public")})),this.node.remove(),e&&this.children.foreach(e=>e.remove())}attachNode(e){this.node=e,this.node.isVisible.subscribe(e=>this.updateGraphVisibility()),this.node.isSelected.subscribe(e=>{e&&this.onSelected()});const t=[];this.createActions(t),this.node.actions(t)}attachGraph(e){this._graphCtx=e,this._graphCtx.calculator.observe("expressionAnalysis",()=>this.onGraphChanged()),this.color.subscribe(e=>this.updateColor())}isFullVisible(){let e=this.node;for(;e;){if(!e.isVisible())return!1;e=e.parentNode}return!0}updateGraphVisibility(e=!0){const t=this.isFullVisible();return this._graphCtx.setItemVisibile(this.getGraphId("public"),t),this._graphCtx.setItemVisibile(this.getGraphId("private"),t),e&&this.children.foreach(e=>e.updateGraphVisibility()),t}updateGraph(t=!0){if(!this._graphCtx)return;this.folderId||(this.folderId=e.StringUtils.uuidv4()),this._graphCtx.treeItems[this.folderId]=this;const i=this.getExpressions();this._graphCtx.setExpressions(i),this.updateGraphWork(),this.updateGraphVisibility(),this.updateParameters(),t&&this.children.foreach(e=>e.updateGraph(t))}onParentChanged(){this.updateGraphVisibility()}get parent(){return this.node.parentNode.value()}get children(){return e.linq(this.node.nodes()).select(e=>e.value())}replaceVars(e){for(let t in this._varsMap){const i=new RegExp("\\$"+t,"g");e=e.replace(i,this._varsMap[t])}return e}getGraphId(e){return this.folderId+"/"+e}addChildrenWork(e,i=!0){const s=new t.TreeNodeViewModel(e);return this.node.addNode(s),e.attachNode(s),e.attachGraph(this._graphCtx),i&&e.updateGraph(),e.onParentChanged(),e}createParameters(e){return!1}updateParameters(){const e=[];this.createParameters(e)&&(this.parameters.removeAll(),e.forEach(e=>this.parameters.push(e)))}updateGraphWork(){}setChildrenStateWork(e){}onSelected(){this.mainExpression&&this._graphCtx&&this._graphCtx.setSelectedId(this.mainExpression)}onGraphChanged(){}updateColor(){}}class n{constructor(){this.vars=ko.observable()}select(){}}class l{constructor(){this.curValue=ko.observable(),this.autoCompute=ko.observable(),this.min=ko.observable(),this.max=ko.observable(),this.step=ko.observable()}}class h extends o{constructor(e){super(),this._varsMap={},this.selectedFunction=ko.observable(),this.showIntegration=ko.observable(!0),this.maxDay=ko.observable(),this.endDay=ko.observable(),this._varsMap={fun:null,sum:null,n1:null,n2:null,value:null,time:null,tend:null,xp:null},this.itemType="regression",this.icon="show_chart",this.optionsTemplateName="RegressionOptionsTemplate",this.functions=[],this.addFunction({name:$string("$(log-normal)"),type:"log-normal",value:"$y\\sim $c\\cdot\\frac{ e^ {-\\frac{ \\left(\\ln\\ \\left($x - $a\\right) \\ -$u\\right)^ { 2}} { 2$o^ { 2} }}}{ \\left($x - $a\\right) \\sqrt{ 2\\pi } $o }",vars:[{name:"a",label:$string("$(offset)"),autoCompute:!0,precision:0},{name:"c",label:$string("$(total)"),autoCompute:!0,precision:0},{name:"o",label:$string("$(variance)"),autoCompute:!0,precision:5},{name:"u",label:$string("$(average)"),autoCompute:!0,precision:5}]}),this.addFunction({name:$string("$(normal)"),type:"normal",value:"$y\\sim $c\\cdot\\ \\left(\\frac{1}{\\sqrt{2\\cdot\\pi}\\cdot $o}\\right)\\cdot e^{-\\frac{1}{2}\\cdot\\left(\\frac{\\left($x-$u\\right)}{$o}\\right)^{2}}",vars:[{name:"c",label:$string("$(total)"),autoCompute:!0,precision:0},{name:"o",label:$string("$(variance)"),autoCompute:!0,precision:5},{name:"u",label:$string("$(avg-peak)"),autoCompute:!0,precision:0}]}),this.addFunction({name:$string("$(exponential)"),type:"exponential",value:"$y\\sim $a^{\\left($x-$b\\right)}",vars:[{name:"a",label:$string("$(base)"),autoCompute:!0,precision:5},{name:"b",label:$string("$(offset)"),autoCompute:!0,precision:5}]}),this.addFunction({name:$string("$(linear)"),type:"linear",value:"$y\\sim $a+$m$x",vars:[{name:"a",label:$string("$(offset)"),autoCompute:!0,precision:5},{name:"m",label:$string("$(slope)"),autoCompute:!0,precision:5}]}),this.showIntegration.subscribe(()=>{this._graphCtx.setItemVisibile(this.getGraphId("sum-serie"),this.isFullVisible()&&this.showIntegration()),this._graphCtx.setItemVisibile(this.getGraphId("sum-point"),this.isFullVisible()&&this.showIntegration())}),this.selectedFunction.subscribe(e=>{if(!this.name()&&e)return this.name(e.value.name)}),this.endDay.subscribe(e=>this.updateEndDay()),this.maxDay.subscribe(e=>this.updateEndDay()),this.selectedFunction(this.functions[0]),e&&this.setState(e)}get mainExpression(){return this.getGraphId("main-func")}addFunction(e){const t=new n;t.value=e,t.select=()=>{this.selectedFunction(t),this.name(t.value.name),this.updateGraph()};const i=[];for(let t of e.vars){const e=new l;e.value=t,e.curValue(t.value),e.autoCompute(t.autoCompute),e.min(t.minValue),e.max(t.maxValue),e.step(t.step),e.min.subscribe(e=>t.minValue=e),e.max.subscribe(e=>t.maxValue=e),e.step.subscribe(e=>t.step=e),e.curValue.subscribe(e=>t.value=e),e.autoCompute.subscribe(e=>{t.autoCompute=e,this.updateGraph()}),e.curValue.subscribe(i=>{e.autoCompute()||this._graphCtx.updateVariable(this.getGraphId(t.name+"-value"),this.getVar(t.name),i)}),i.push(e)}return t.vars(i),this.functions.push(t),t}onGraphChanged(){this.updateRegressionVars()}updateRegressionVars(){let t=this._graphCtx.calculator.controller.getItemModel(this.getGraphId("main"));if(t&&t.regressionParameters)for(let i of this.selectedFunction().vars()){const s=this.getVar(i.value.name).replace("{","").replace("}","");let a=t.regressionParameters[s];null!=a&&(null!=i.value.precision&&(a=e.MathUtils.round(a,i.value.precision)),i.curValue(a))}}createParameters(t){return t.push(e.apply(new a({value:this.endDay,name:$string("$(reg-days)")}),e=>{e.max=this.maxDay,e.min(0),e.step(1)})),!0}setStateWork(t){if(t.function){const i=e.linq(this.functions).first(e=>e.value.type==t.function.type);if(i){for(let s of t.function.vars){const t=e.linq(i.vars()).first(e=>e.value.name==s.name);t&&(t.autoCompute(s.autoCompute),t.max(s.maxValue),t.min(s.minValue),t.step(s.step),t.curValue(s.value))}this.selectedFunction(i)}}null!=t.showIntegration&&this.showIntegration(t.showIntegration)}getState(){const e=super.getState();e.function=this.selectedFunction().value,e.showIntegration=this.showIntegration();for(let e of this.selectedFunction().vars())e.value.value=e.curValue(),e.value.maxValue=e.max(),e.value.minValue=e.min(),e.value.step=e.step(),e.value.autoCompute=e.autoCompute();return e}onParentChanged(){super.onParentChanged(),this.color(this.parent.color()),this.maxDay(e.linq(this.parent.values).max(e=>e.x)),null==this.endDay()&&this.endDay(this.maxDay())}updateEndDay(){this._varsMap.tend&&this._graphCtx.updateExpression({type:"expression",id:this.getGraphId("end-day"),latex:this._varsMap.tend+"="+this.endDay(),slider:{min:"0",step:"1",max:this.maxDay().toString()}})}updateColor(){this._graphCtx.setColor(this.getGraphId("main-func"),this.color()),this._graphCtx.setColor(this.getGraphId("sum-serie"),this.color()),this._graphCtx.setColor(this.getGraphId("sum-point"),this.color()),this._graphCtx.setColor(this.getGraphId("end-day-line"),this.color())}updateGraphWork(){this.updateRegressionVars()}getExpressions(){const e=[];e.push({type:"folder",id:this.getGraphId("public"),title:this.parent.name()+" - "+this.name(),collapsed:!0}),e.push({type:"folder",id:this.getGraphId("private"),secret:!0,title:this.parent.name()+" - "+this.name(),collapsed:!0});const t=this.selectedFunction().value;this._varsMap.x="",this._varsMap.y=this.parent.getVar("y"),this._varsMap.time=this.parent.parent.getVar("time");for(let e of t.vars)this._varsMap[e.name]||(this._varsMap[e.name]=null);this._graphCtx.generateVars(this._varsMap),this._varsMap.x=this.getVar("xp"),e.push({type:"expression",id:this.getGraphId("main"),folderId:this.getGraphId("private"),latex:this.replaceVars(t.value),hidden:!0}),e.push({type:"expression",id:this.getGraphId("main-func"),folderId:this.getGraphId("private"),latex:this.replaceVars(t.value.replace("$y\\sim ","$fun\\left(x\\right)=").replace(/\$x/g,"x")),color:this.parent.color(),lineStyle:Desmos.Styles.DASHED}),e.push({type:"expression",id:this.getGraphId("sum-func"),folderId:this.getGraphId("private"),latex:this.replaceVars("$sum\\left(x\\right)=\\sum_{$n1=1}^{x}\\operatorname{round}\\left($fun\\left($n1\\right)\\right)"),hidden:!0}),e.push({type:"expression",id:this.getGraphId("sum-x-time"),folderId:this.getGraphId("private"),latex:this.replaceVars("$n2=\\left[1,...,$time\\right]")}),e.push({type:"expression",id:this.getGraphId("sum-serie"),folderId:this.getGraphId("private"),latex:this.replaceVars("\\left($n2,\\ $sum\\left($n2\\right)\\right)"),color:this.parent.color(),lines:!0,hidden:!this.showIntegration(),lineStyle:Desmos.Styles.SOLID,pointStyle:"NONE",points:!1}),e.push({type:"expression",id:this.getGraphId("sum-value"),folderId:this.getGraphId("public"),latex:this.replaceVars("$value=$sum\\left($time\\right)")}),e.push({type:"expression",id:this.getGraphId("sum-point"),folderId:this.getGraphId("private"),hidden:!this.showIntegration(),latex:this.replaceVars("\\left($time,$value\\right)"),color:this.parent.color(),label:this.parent.name(),dragMode:"XY",showLabel:!0}),e.push({type:"expression",id:this.getGraphId("end-day"),latex:this._varsMap.tend+"="+this.endDay(),folderId:this.getGraphId("public"),label:"Giorni Previsione",slider:{min:(0).toString(),max:this.maxDay().toString(),hardMax:!0,hardMin:!0,step:"1"}}),e.push({type:"expression",id:this.getGraphId("end-day-line"),color:this.color(),latex:"x="+this._varsMap.tend,folderId:this.getGraphId("private"),lines:!0}),e.push({type:"expression",id:this.getGraphId("end-day-serie"),latex:this.replaceVars("$xp=[0,...,$tend]+"+this.parent.getVar("ofs")),folderId:this.getGraphId("private"),hidden:!0});for(let t of this.selectedFunction().vars())t.autoCompute()?this._graphCtx.calculator.removeExpression({id:this.getGraphId(t.value.name+"-value")}):e.push({type:"expression",id:this.getGraphId(t.value.name+"-value"),latex:this.getVar(t.value.name)+"="+(t.curValue()?t.curValue().toString():"0"),folderId:this.getGraphId("public"),label:t.value.name,slider:{min:i(t.value.minValue),max:i(t.value.maxValue),hardMax:!0,hardMin:!0,step:i(t.value.step)}});return e}}class d extends o{constructor(e){super(),this.color=ko.observable(),this.offsetX=ko.observable(0),this.colorPicker=s.instance,this.canDrag=!0,this.itemType="serie",this.icon="insert_chart",this.optionsTemplateName="StudioOptionsTemplate",this._varsMap={x:null,y:null,ofs:null,xofs:null},e&&this.setState(e)}importValues(t){if(t&&t.length>0){if(t[0].x instanceof Date){const i=t[0].x;return e.linq(t).select(t=>({x:Math.round(e.DateUtils.diff(t.x,i).totalDays),xLabel:t.x,y:t.y})).toArray()}if(isNaN(t[0].x))return e.linq(t).select((e,t)=>({x:t,xLabel:e.x,y:e.y})).toArray()}return t}writeData(e){var t={version:1,type:"serieState",state:this.getState()};return e.setData("application/json+studio",JSON.stringify(t)),e.setData("text/html+id",this.node.element.id),!0}createActions(i){super.createActions(i),i.push(e.apply(new t.ActionViewModel,e=>{e.text=$string("$(update)"),e.icon="autorenew",e.execute=()=>this.updateSerie()})),i.push(e.apply(new t.ActionViewModel,e=>{e.text=$string("$(new-regression)"),e.icon="add_box",e.execute=()=>{const e=this.addRegression(null,!1);e.updateGraph(),this.node.isExpanded(!0),e.node.isSelected(!0)}})),i.push(e.apply(new t.ActionViewModel,e=>{e.text=$string("$(zoom)"),e.icon="zoom_in",e.execute=()=>{this.zoom()}}))}static fromText(e){try{const t=JSON.parse(e);if(t){if("serie"==t.type)return new d({name:t.title,values:t.values,source:t.serie,color:t.color});if("serieState"==t.type)return new d(t.state)}}catch(e){}}getExpressions(){return this.color()||this.color("#0000ff"),this._graphCtx.generateVars(this._varsMap),[{type:"folder",id:this.getGraphId("public"),title:this.parent.name()+" - "+this.name(),collapsed:!0},{type:"folder",id:this.getGraphId("private"),title:this.parent.name()+" - "+this.name(),secret:!0,collapsed:!0},{type:"expression",id:this.getGraphId("offset"),latex:this._varsMap.ofs+"="+this.offsetX(),folderId:this.getGraphId("public"),label:"Scostamento",slider:{min:(-this.values.length).toString(),max:this.values.length.toString(),hardMax:!0,hardMin:!0,step:"1"}},{type:"expression",id:this.getGraphId("offset-x"),latex:this._varsMap.xofs+"="+this._varsMap.x+"+"+this._varsMap.ofs,folderId:this.getGraphId("private")},{type:"expression",id:this.getGraphId("offset-x-serie"),latex:"("+this._varsMap.xofs+","+this._varsMap.y+")",folderId:this.getGraphId("private"),points:!0,lines:!0,color:this.color()},{type:"table",id:this.getGraphId("table"),folderId:this.getGraphId("private"),columns:[{id:this.getGraphId("table/x"),latex:this._varsMap.x},{id:this.getGraphId("table/y"),latex:this._varsMap.y,hidden:!0}]}]}get mainExpression(){return this.getGraphId("offset-x-serie")}createParameters(t){return t.push(e.apply(new a({value:this.offsetX,name:$string("$(shift)")}),e=>{e.max(this.values.length),e.min(-this.values.length),e.step(1)})),!0}updateGraphWork(){this._graphCtx.updateTable(this.getGraphId("table"),this.values)}onGraphChanged(){}onSelected(){super.onSelected()}updateColor(){this._graphCtx.setColor(this.getGraphId("offset-x-serie"),this.color()),this.children.foreach(e=>e.onParentChanged())}attachGraph(e){super.attachGraph(e),this.offsetX.subscribe(e=>this._graphCtx.updateVariable(this.getGraphId("offset"),this._varsMap.ofs,e))}setChildrenStateWork(e){null!=e.children&&(this.children.foreach(e=>e.remove()),e.children.forEach(e=>{this.addRegression(null,!1).setState(e)}))}setStateWork(e){null!=e.offsetX&&this.offsetX(e.offsetX),e.source&&(this.source=e.source),null!=e.values&&(this.values=this.importValues(e.values))}getState(){const e=super.getState();return e.offsetX=this.offsetX(),e.source=this.source,e.values=this.values,e.children=this.children.select(e=>e.getState()).toArray(),e}addRegression(e,t=!0){return this.addChildrenWork(e instanceof h?e:new h(e),t)}changeColor(){return __awaiter(this,void 0,void 0,(function*(){const e=yield this.colorPicker.pick();e&&this.color(e)}))}updateSerie(){return __awaiter(this,void 0,void 0,(function*(){if("geoplot"!=this.source.type&&this.source.type)M.toast({html:$string("$(msg-update-not-supported)")});else{if(!this._graphCtx.serieCalculator){M.toast({html:$string("$(msg-downloading-data)")});const e=yield t.Api.loadStudioData();this._graphCtx.serieCalculator=new t.IndicatorCalculator(e.data,t.InfectionDataSet,e.geo)}this.values=this.importValues(this._graphCtx.serieCalculator.getSerie(this.source)),this._graphCtx.updateTable(this.getGraphId("table"),this.values),this.children.foreach(e=>e.onParentChanged()),M.toast({html:$string("$(msg-update-complete)")})}}))}zoom(){const t=e.linq(this.values).min(e=>e.x),i=e.linq(this.values).min(e=>e.y),s=e.linq(this.values).max(e=>e.x),a=e.linq(this.values).max(e=>e.y);this._graphCtx.calculator.setMathBounds({top:a+.1*(a-i),right:s+.1*(s-t),bottom:i-.1*(a-i),left:t-.1*(s-t)})}}class c extends o{constructor(e){super(),this.time=ko.observable(0),this.itemType="project",this.icon="folder",this.optionsTemplateName="ProjectOptionsTemplate",this._varsMap={time:null},e&&this.setState(e)}canAccept(e){return e instanceof d}canReadData(e){return-1!=e.types.indexOf("application/json+studio")}readData(e){const t=e.getData("application/json+studio");let i=d.fromText(t);i&&(this.addSerie(i),this.node.isExpanded(!0))}getExpressions(){return this._graphCtx.generateVars(this._varsMap),[{type:"folder",id:this.getGraphId("public"),title:this.name(),collapsed:!0},{type:"expression",folderId:this.getGraphId("public"),id:this.getGraphId("time"),latex:this._varsMap.time+"="+this.time(),slider:{hardMin:!0,hardMax:!0,min:"0",max:"100",step:"1"}}]}createParameters(t){return t.push(e.apply(new a({value:this.time,name:$string("$(day)")}),e=>{e.max(100),e.min(0),e.step(1)})),!0}setStateWork(e){null!=e.time&&this.time(e.time)}setChildrenStateWork(e){null!=e.children&&(this.children.foreach(e=>e.remove()),e.children.forEach(e=>{this.addSerie(null,!1).setState(e)}))}getState(){const e=super.getState();return e.time=this.time(),e.children=this.children.select(e=>e.getState()).toArray(),e}onGraphChanged(){}attachGraph(e){super.attachGraph(e),this.time.subscribe(e=>this._graphCtx.updateVariable(this.getGraphId("time"),this._varsMap.time,this.time()))}addSerie(e,t=!0){return this.addChildrenWork(e instanceof d?e:new d(e),t)}}t.StudioPage=class{constructor(i){this.items=new t.TreeViewModel,this.maxX=ko.observable(),this.maxY=ko.observable(),this.dataImport=new t.DataImportControl,this._projectId=i,this._graphCtx=new r,this._graphCtx.calculator=Desmos.GraphingCalculator(document.getElementById("calculator"),{pasteGraphLink:!1,pasteTableData:!1,expressionsCollapsed:!0,restrictedFunctions:!0,administerSecretFolders:!0,authorIDE:!0,advancedStyling:!0}),this._graphCtx.calculator.controller.listModel.onSelectionChanged=e=>this.onGraphSelectionChanged(e);const s=[];s.push(e.apply(new t.ActionViewModel,e=>{e.text=$string("$(new-project)"),e.icon="create_new_folder",e.execute=()=>this.newProject()})),s.push(e.apply(new t.ActionViewModel,e=>{e.text=$string("$(save)"),e.icon="save",e.execute=()=>this.saveState()})),s.push(e.apply(new t.ActionViewModel,e=>{e.text=$string("$(import)"),e.icon="import_export",e.execute=()=>this.import()})),s.push(e.apply(new t.ActionViewModel,e=>{e.text=$string("$(share) Studio"),e.icon="share",e.execute=()=>this.share()})),s.push(e.apply(new t.ActionViewModel,e=>{e.text=$string("$(options)"),e.icon="settings",e.execute=()=>this.showOptions()}));const a=new t.TreeNodeViewModel;a.actions(s),this.items.setRoot(a),document.body.addEventListener("paste",e=>__awaiter(this,void 0,void 0,(function*(){"INPUT"!=e.target.tagName&&(yield this.onPaste(e.clipboardData))&&e.preventDefault()}))),M.Modal.init(document.getElementById("options"),{onCloseEnd:()=>this.updateOptions()}),setTimeout(()=>this.init())}onGraphSelectionChanged(e){if(!e||!e.folderId)return;const t=e.folderId.split("/")[0],i=this._graphCtx.treeItems[t];i&&i.node.select(!0)}updateOptions(){const e=parseInt(this.maxX()),t=parseInt(this.maxY());this._graphCtx.calculator.setMathBounds({bottom:-t/10,left:-e/10,right:e,top:t})}share(){return __awaiter(this,void 0,void 0,(function*(){const i=e.StringUtils.uuidv4();yield t.Api.saveState(i,this.getState());const s=e.Uri.absolute("~/"+$language.split("-")[0]+"/Studio/"+i);yield e.DomUtils.copyText(s),M.toast({html:$string("$(msg-shared)")})}))}showOptions(){const e=this._graphCtx.calculator.graphpaperBounds;this.maxX(Math.round(e.mathCoordinates.width)),this.maxY(Math.round(e.mathCoordinates.height)),M.Modal.getInstance(document.getElementById("options")).open()}getSelectedProject(){if(!this.items.selectedNode())return;const e=this.items.selectedNode().value();return"project"==e.itemType?e:"serie"==e.itemType?e.parent:"regression"==e.itemType?e.parent.parent:void 0}newProject(){const e=this.addProject({name:"Project "+(this.projects.count()+1)});return e.node.isSelected(!0),e}addProject(e,i=!0){const s=new c(e),a=new t.TreeNodeViewModel(s);return this.items.root().addNode(a),s.attachNode(a),s.attachGraph(this._graphCtx),i&&s.updateGraph(),s}getState(){const e={version:2};return e.graphState=this._graphCtx.calculator.getState(),e.vars=this._graphCtx.vars,e.projects=this.projects.select(e=>e.getState()).toArray(),e}setState(e){e&&(e.graphState&&(e.graphState.expressions.list=[],this._graphCtx.calculator.setState(e.graphState)),null!=e.projects&&(this.projects.toArray().forEach(e=>e.remove()),e.projects.forEach(e=>{this.addProject(null,!1).setState(e)})))}loadState(){return __awaiter(this,void 0,void 0,(function*(){if(this._projectId){let e=yield t.Api.loadState(this._projectId);this.setState(e)}else{const e=localStorage.getItem("studio");e&&this.setState(JSON.parse(e))}}))}saveState(){return __awaiter(this,void 0,void 0,(function*(){this._projectId?(yield t.Api.saveState(this._projectId,this.getState()),M.toast({html:$string("$(msg-saved)")})):(localStorage.setItem("studio",JSON.stringify(this.getState())),M.toast({html:$string("$(msg-saved-device)")}))}))}demo(){const e=this.addProject({name:"Project 1"});this.addProject({name:"Project 2"}),this.addProject({name:"Project 3"}),e.addSerie({name:"Serie 1"})}onPaste(e){return __awaiter(this,void 0,void 0,(function*(){const t=e.getData("text/plain").toString();return!!t&&(yield this.importText(t))}))}import(){return __awaiter(this,void 0,void 0,(function*(){let e=this.getSelectedProject();const t=yield this.dataImport.show();return this.addImportedData(t,e),!0}))}importText(e){return __awaiter(this,void 0,void 0,(function*(){let t=this.getSelectedProject();if(t||this.projects.any()||(t=this.newProject()),!t)return M.toast({html:$string("$(msg-select-project)")}),!1;const i=d.fromText(e);if(i){t.addSerie(i),t.node.isExpanded(!0),i.node.isExpanded(!0),i.zoom();const e=i.addRegression(null,!1);return e.updateGraph(),e.node.isSelected(!0),!0}try{(yield this.dataImport.importText(e))&&(yield this.import())}catch(e){console.error(e)}return M.toast({html:$string("$(msg-format-not-reconized)")}),!1}))}addImportedData(e,t){if(1==e.length&&this.items.selectedNode()&&this.items.selectedNode().value()instanceof d&&confirm("Sostituire la serie selezionata con i nuovi dati?")){const t=this.items.selectedNode().value();return t.source=e[0],t.importValues(e[0].serie.values),t.updateGraph(!0),!0}t.node.isExpanded(!0);for(let i of e){const e=new d({name:i.serie.name,values:i.serie.values,source:i});t.addSerie(e),e.node.isExpanded(!0);const s=e.addRegression(null,!1);s.updateGraph(),s.node.isSelected(!0)}}get projects(){return e.linq(function*(){for(let e of this.items.root().nodes())yield e.value()}.apply(this))}init(){return __awaiter(this,void 0,void 0,(function*(){this.loadState()}))}}}(e.GeoPlot||(e.GeoPlot={}))}(WebApp||(WebApp={}));