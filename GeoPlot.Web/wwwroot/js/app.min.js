function formatNumber(n){return n?itNumberFormat.format(n):""}function capitalizeFirst(n){return n.substr(0,1).toUpperCase()+n.substr(1)}function expandCollapse(n){var t=n.parentElement,i=t.querySelector(".section-content");t.classList.contains("closed")?(i.style.removeProperty("display"),t.classList.remove("closed")):(t.classList.add("closed"),setTimeout(function(){return i.style.display="none"},300))}var __values=this&&this.__values||function(n){var t=typeof Symbol=="function"&&Symbol.iterator,i=t&&n[t],r=0;if(i)return i.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&r>=n.length&&(n=void 0),{value:n&&n[r++],done:!n}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.");},__awaiter=this&&this.__awaiter||function(n,t,i,r){function u(n){return n instanceof i?n:new i(function(t){t(n)})}return new(i||(i=Promise))(function(i,f){function o(n){try{e(r.next(n))}catch(t){f(t)}}function s(n){try{e(r["throw"](n))}catch(t){f(t)}}function e(n){n.done?i(n.value):u(n.value).then(o,s)}e((r=r.apply(n,t||[])).next())})},__generator=this&&this.__generator||function(n,t){function o(n){return function(t){return s([n,t])}}function s(e){if(f)throw new TypeError("Generator is already executing.");while(r)try{if(f=1,u&&(i=e[0]&2?u["return"]:e[0]?u["throw"]||((i=u["return"])&&i.call(u),0):u.next)&&!(i=i.call(u,e[1])).done)return i;(u=0,i)&&(e=[e[0]&2,i.value]);switch(e[0]){case 0:case 1:i=e;break;case 4:return r.label++,{value:e[1],done:!1};case 5:r.label++;u=e[1];e=[0];continue;case 7:e=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(e[0]===6||e[0]===2)){r=0;continue}if(e[0]===3&&(!i||e[1]>i[0]&&e[1]<i[3])){r.label=e[1];break}if(e[0]===6&&r.label<i[1]){r.label=i[1];i=e;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(e);break}i[2]&&r.ops.pop();r.trys.pop();continue}e=t.call(n,r)}catch(o){e=[6,o];u=0}finally{f=i=0}if(e[0]&5)throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},f,u,i,e;return e={next:o(0),"throw":o(1),"return":o(2)},typeof Symbol=="function"&&(e[Symbol.iterator]=function(){return this}),e},itNumberFormat,WebApp;(function(n){var t=function(){function t(){}return t.prototype.initServices=function(){n.Services.httpClient=new n.XHRHttpClient},t}();n.app=new t})(WebApp||(WebApp={})),function(n){var t=function(){function n(){}return n.project=function(t){var i={x:0,y:0};return i.x=t.lng*n.OriginShift/180,i.y=Math.log(Math.tan((90+t.lat)*Math.PI/360))/(Math.PI/180),i.y=-(i.y*n.OriginShift/180),i.x-=n.OFFSET_X,i.y-=n.OFFSET_Y,i},n.EarthRadius=6378137,n.OriginShift=2*Math.PI*n.EarthRadius/2,n.OFFSET_X=1263355,n.OFFSET_Y=5543162,n}();n.Geo=t}(WebApp||(WebApp={}));itNumberFormat=new Intl.NumberFormat("it-IT",{});HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(n,t,i){var r=this;setTimeout(function(){for(var f=atob(r.toDataURL(t,i).split(",")[1]),e=f.length,o=new Uint8Array(e),u=0;u<e;u++)o[u]=f.charCodeAt(u);n(new Blob([o],{type:t||"image/png"}))})}});window.Chart&&Chart.plugins.register({beforeDraw:function(n){var t=n.ctx;t.fillStyle="white";t.fillRect(0,0,n.width,n.height)}}),function(n){var r=function(){function i(){for(var i=[],r=0;r<arguments.length;r++)i[r]=arguments[r];this.colors=i.length>0?typeof i[0]=="string"?n.linq(i).select(function(n){return new t(n)}).toArray():i:[]}return i.prototype.valueAt=function(n){if(n<0)return this.colors[0];n>1&&this.colors[this.colors.length-1];var r=1/(this.colors.length-1),o=Math.floor(n/r),s=Math.ceil(n/r),f=(n-o*r)/r,i=this.colors[o],e=this.colors[s],u=new t;return u.r=i.r+(e.r-i.r)*f,u.g=i.g+(e.g-i.g)*f,u.b=i.b+(e.b-i.b)*f,u},i}(),t,i;n.LinearGradient=r;t=function(){function n(n){this.r=0;this.g=0;this.b=0;n&&this.fromHex(n)}return n.prototype.fromHex=function(n){n.length==4?(this.r=parseInt("0x"+n[1]+n[1])/255,this.g=parseInt("0x"+n[2]+n[2])/255,this.b=parseInt("0x"+n[3]+n[3])/255):(this.r=parseInt("0x"+n[1]+n[2])/255,this.g=parseInt("0x"+n[3]+n[4])/255,this.b=parseInt("0x"+n[5]+n[6])/255)},n.prototype.toString=function(){function n(n){var t=Math.round(n*255).toString(16);return t.length==1?"0"+t:t}return"#"+n(this.r)+n(this.g)+n(this.b)},n}();n.RgbColor=t;i=function(){function n(n){this._svg=n}return n.prototype.setViewPort=function(n,t,i,r){this._svg.viewBox.baseVal.x=n;this._svg.viewBox.baseVal.y=t;this._svg.viewBox.baseVal.width=i-n;this._svg.viewBox.baseVal.height=r-t},n.prototype.drawPoly=function(n){var t=document.createElementNS("http://www.w3.org/2000/svg","polygon"),i,r;for(t.style.fill=n.fillColor,t.style.stroke=n.strokeColor,t.style.strokeWidth=n.strokeSize+"%",t.id=n.id,i=0;i<n.geometry.points.length;i++)r=this._svg.createSVGPoint(),r.x=n.geometry.points[i].x,r.y=n.geometry.points[i].y,t.points.appendItem(r);this._svg.appendChild(t)},n}();n.Graphics=i}(WebApp||(WebApp={})),function(n){var f=function(){function n(n){this._value=n}return n.prototype.value=function(n,t,i,r,u){var e=this._value(n,u),f;if(i)for(f in i)e-=this.value(i[f],r[f],null,null,u);return e},n}(),t,i,r,u;n.ConstIndicatorFunction=f;t=function(){function n(n){this._value=n}return n.prototype.value=function(n,t,i,r,u){var f=this._value(n,u),e;if(t&&(f-=this._value(t,u)),i)for(e in i)f-=this.value(i[e],r[e],null,null,u);return f},n}();n.SimpleIndicatorFunction=t;i=function(){function n(n){this._value=n}return n.prototype.value=function(n,t,i,r,u,f){var o=0;for(var e in n)o+=f.value(n[e],t[e],i[e],r[e],u);return this._value(o,n[0],u)},n}();n.SimpleFactorFunction=i;r=function(){function n(n,t){this._value=n;this._factor=t}return n.prototype.value=function(n,t,i,r,u,f){var o=0,s=0;for(var e in n)o+=f.value(n[e],t[e],i[e],r[e],u),s+=this._factor.value(n[e],t[e],i[e],r[e],u);return this._value(o,s)},n}();n.DoubleFactorFunction=r;u=function(){function t(n,t,i){this._data=n;this._dataSet=t;this._geo=i}return t.prototype.getFactorValue=function(t){var e,l,d=this,o=(typeof t.areaOrId=="string"?t.areaOrId:t.areaOrId.id).toLowerCase(),f=function(n,t){return n<0?undefined:d._data.days[n].values[t]},a,r,i,u,s,h,c,b,k;a=Array.isArray(t.dayNumberOrGroup)?t.dayNumberOrGroup:[t.dayNumberOrGroup];var v=[],y=[],p=[],w=[];try{for(r=__values(a),i=r.next();!i.done;i=r.next())if(u=i.value,v.push(f(u,o)),t.isDayDelta&&y.push(f(u-1,o)),t.execludedAreas){s=[];h=[];for(c in t.execludedAreas)s.push(f(u,c.toLowerCase())),t.isDayDelta&&h.push(f(u-1,c.toLowerCase()));p.push(s);w.push(h)}}catch(g){e={error:g}}finally{try{i&&!i.done&&(l=r.return)&&l.call(r)}finally{if(e)throw e.error;}}return b=n.linq(this._dataSet.factors).first(function(n){return n.id==t.factorId}),k=n.linq(this._dataSet.indicators).first(function(n){return n.id==t.indicatorId}),b.compute.value(v,y,p,w,this._geo.areas[o],k.compute)},t.prototype.getIndicatorValue=function(t){var s=this,r=(typeof t.areaOrId=="string"?t.areaOrId:t.areaOrId.id).toLowerCase(),h=n.linq(this._dataSet.indicators).first(function(n){return n.id==t.indicatorId}),i=function(n,t){return n<0?undefined:s._data.days[n].values[t]},c=i(t.dayNumber,r),o,u,f,e;if(t.isDayDelta&&(o=i(t.dayNumber-1,r)),t.execludedAreas){u=[];f=[];for(e in t.execludedAreas)u.push(i(t.dayNumber,e.toLowerCase())),t.isDayDelta&&f.push(i(t.dayNumber-1,e.toLowerCase()))}return h.compute.value(c,o,u,f,this._geo.areas[r])},t.prototype.getSerie=function(n){var f=[],i,r,t,u;if(n.groupSize>1)for(i=n.groupSize,r=[],t=0+n.startDay;t<this._data.days.length;t++)r.push(t),i--,i==0&&(u={x:n.xAxis=="date"?new Date(this._data.days[t].date):t,y:this.getFactorValue({dayNumberOrGroup:r,areaOrId:n.areaId,factorId:n.factorId,indicatorId:n.indicatorId,execludedAreas:n.exeludedAreaIds,isDayDelta:n.isDelta})},f.push(u),i=n.groupSize,r=[]);else for(t=0+n.startDay;t<this._data.days.length;t++)u={x:n.xAxis=="date"?new Date(this._data.days[t].date):t,y:this.getFactorValue({dayNumberOrGroup:t,areaOrId:n.areaId,factorId:n.factorId,indicatorId:n.indicatorId,execludedAreas:n.exeludedAreaIds,isDayDelta:n.isDelta})},f.push(u);return f},t}();n.IndicatorCalculator=u}(WebApp||(WebApp={})),function(n){var t,i;(function(n){n[n.SUm=0]="SUm";n[n.Avg=1]="Avg"})(t=n.AggregationFunc||(n.AggregationFunc={})),function(n){n[n.Country=0]="Country";n[n.State=1]="State";n[n.Region=2]="Region";n[n.District=3]="District"}(i=n.GeoAreaType||(n.GeoAreaType={}))}(WebApp||(WebApp={})),function(n){n.InfectionDataSet={name:"COVID-19",indicators:[{id:"totalPositive",name:"Positivi Totali",colorLight:"#f44336",colorDark:"#b71c1c",compute:new n.SimpleIndicatorFunction(function(n){return n.totalPositive})},{id:"currentPositive",name:"Attuali Positivi",validFor:["region","country"],colorLight:"#e91e63",colorDark:"#880e4f",compute:new n.SimpleIndicatorFunction(function(n){return n.currentPositive})},{id:"totalDeath",name:"Deceduti",validFor:["region","country"],colorLight:"#9c27b0",colorDark:"#4a148c",compute:new n.SimpleIndicatorFunction(function(n){return n.totalDeath})},{id:"totalSevere",name:"Gravi",validFor:["region","country"],colorLight:"#ff9800",colorDark:"#e65100",compute:new n.SimpleIndicatorFunction(function(n){return n.totalSevere})},{id:"totalHospedalized",name:"Ricoverati",validFor:["region","country"],colorLight:"#fdd835",colorDark:"#fbc02d",compute:new n.SimpleIndicatorFunction(function(n){return n.totalHospedalized})},{id:"totalHealed",name:"Guariti",validFor:["region","country"],colorLight:"#4caf50",colorDark:"#1b5e20",compute:new n.SimpleIndicatorFunction(function(n){return n.totalHealed})},{id:"toatlTests",name:"Tamponi",validFor:["region","country"],colorLight:"#03a9f4",colorDark:"#01579b",compute:new n.SimpleIndicatorFunction(function(n){return n.toatlTests})},{id:"surface",name:"Superfice (Geo)",validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new n.ConstIndicatorFunction(function(t,i){return n.MathUtils.round(i.surface,0)})},{id:"density",name:"Densita (Geo)",validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new n.ConstIndicatorFunction(function(t,i){return n.MathUtils.round(i.demography.total/i.surface,0)})},{id:"population",name:"Popolazione (Geo)",validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new n.ConstIndicatorFunction(function(n,t){return t.demography.total})},{id:"populationOld",name:"Popolazione +65 (Geo)",validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new n.ConstIndicatorFunction(function(n,t){return t.demography.over65})},],factors:[{id:"none",name:"Nessuno",compute:new n.SimpleFactorFunction(function(n){return n}),format:function(n){return formatNumber(n)},reference:function(){return"N/A"},description:"[indicator]"},{id:"population",name:"Popolazione",compute:new n.SimpleFactorFunction(function(n,t,i){return n/i.demography.total*1e5}),format:function(n){return formatNumber(n)},reference:function(n,t){return formatNumber(t.demography.total)},description:"[indicator] ogni 100.000 abitanti"},{id:"population",name:"Popolazione +65",compute:new n.SimpleFactorFunction(function(n,t,i){return n/i.demography.over65*1e5}),format:function(t){return formatNumber(n.MathUtils.round(t,1))},reference:function(n,t){return formatNumber(t.demography.over65)},description:"[indicator] ogni 100.000 abitanti +65"},{id:"density",name:"Densità",compute:new n.SimpleFactorFunction(function(n,t,i){return n/(i.demography.total/i.surface)*1e5}),format:function(t){return formatNumber(n.MathUtils.round(t,1))},reference:function(t,i){return formatNumber(n.MathUtils.round(i.demography.total/i.surface,1))},description:"[indicator] rispetto densità territorio"},{id:"totalPositive",name:"Positivi Totali",validFor:["region","country"],compute:new n.DoubleFactorFunction(function(n,t){return n?n/t*100:0},new n.SimpleIndicatorFunction(function(n){return n.totalPositive})),format:function(t){return n.MathUtils.round(t,1)+"%"},reference:function(n){return n.totalPositive?formatNumber(n.totalPositive):"N/A"},description:"% [indicator] su positivi totali"},{id:"severe",name:"Gravi",validFor:["region","country"],compute:new n.DoubleFactorFunction(function(n,t){return n?n/t*100:0},new n.SimpleIndicatorFunction(function(n){return n.totalSevere})),format:function(t){return n.MathUtils.round(t,1)+"%"},reference:function(n){return n.totalSevere?formatNumber(n.totalSevere):"N/A"},description:"% [indicator] sui gravi totali"},{id:"test",name:"Tamponi",validFor:["region","country"],compute:new n.DoubleFactorFunction(function(n,t){return n?n/t*100:0},new n.SimpleIndicatorFunction(function(n){return n.toatlTests})),format:function(t){return n.MathUtils.round(t,1)+"%"},reference:function(n){return n.toatlTests?formatNumber(n.toatlTests):"N/A"},description:"% [indicator] sui tamponi eseguiti"}]}}(WebApp||(WebApp={})),function(n){n.ViewModes={district:{label:{singular:"provincia",plural:"province"},mapGroup:"group_district",tab:"districtTab",areaType:n.GeoAreaType.District,validateId:function(n){return n[0].toLowerCase()=="d"}},region:{label:{singular:"regione",plural:"regioni"},mapGroup:"group_region",tab:"regionTab",areaType:n.GeoAreaType.Region,validateId:function(n){return n[0].toLowerCase()=="r"}},country:{label:{singular:"italiana",plural:"italiane"},mapGroup:"group_country",tab:"italyTab",areaType:n.GeoAreaType.Country,validateId:function(n){return n.toLowerCase()=="it"}}}}(WebApp||(WebApp={})),function(n){var i=function(){function n(){this.value=ko.observable()}return n.prototype.select=function(){},n}(),t=function(){function n(){this.data=ko.observable();this.factor=ko.observable();this.indicator=ko.observable();this.reference=ko.observable();this.indicators=ko.observable()}return n.prototype.select=function(){},n}(),r=function(){function t(n,t){this.isVisible=ko.observable(!1);this.isTransparent=ko.observable(!1);this.value=n;this._closeAfter=t}return t.prototype.dontShowAgain=function(){},t.prototype.executeAction=function(){var n=this;this.value.showAction&&this.value.showAction();setTimeout(function(){return n.startPulse()})},t.prototype.startPulse=function(){var i,t;(this._element=document.querySelector(this.value.elementSelector),this._element)&&(i=n.DomUtils.centerElement(this._element),n.DomUtils.addClass(this._element,"pulse"),t=document.querySelector(".tip-container"),i<t.clientTop+t.clientHeight&&this.isTransparent(!0))},t.prototype.stopPulse=function(){this._element&&(n.DomUtils.removeClass(this._element,"pulse"),this.isTransparent(!1))},t.prototype.next=function(){},t.prototype.understood=function(){},t.prototype.onClose=function(){},t.prototype.close=function(){clearTimeout(this._closeTimeoutId);this.stopPulse();this.isVisible(!1);this.onClose()},t.prototype.show=function(){var n=this;this._closeTimeoutId&&clearTimeout(this._closeTimeoutId);this.isVisible(!0);this._closeAfter&&(this._closeTimeoutId=setTimeout(function(){return n.close()},this._closeAfter))},t}(),u=function(){function u(t){var i=this,r,o,u,f,e,s;for(this._topAreasVisible=!1,this._execludedArea=new Map,this._dataSet=n.InfectionDataSet,this._keepState=!1,this._debugMode=!1,this._tips={areaSelected:{order:0,featureName:"Zone",html:"Puoi vedere i dati relativi ad una particolare area selezionadoli sulla mappa.",elementSelector:".card-map .center-align",showAfter:3,showAction:function(){i.viewMode("region");i.selectedArea=i._geo.areas.r10}},indicatorSelected:{order:1,featureName:"Indicatori",html:"Puoi vedere il grafico associato all'indicatore, facendo click sull'indicatore.",elementSelector:".indicators .summary-field",showAfter:15,showAction:function(){i.currentArea()||i._tips.areaSelected.showAction();i.selectedIndicator(n.linq(i._dataSet.indicators).first(function(n){return n.id=="totalDeath"}))}},dayChanged:{order:2,featureName:"Cronologia",html:"Puoi vedere gli indicatori dei giorni precedenti muovendo la slide.",elementSelector:".day input[type=range]",showAfter:20,showAction:function(){i.dayNumber(5)}},indicatorChanged:{order:3,featureName:"Indicatori",html:"Puoi cambiare l'indicatore scegliendolo dal filtro nell'elenco.",elementSelector:".filter-indicator",showAfter:0},viewChanged:{order:4,featureName:"Zone",html:"Puoi vedere gli indicatori a livello regionale, nazionale o provinciale.",elementSelector:"#areaTabs",showAfter:0,showAction:function(){i.viewMode("district")}},topAreasOpened:{order:5,featureName:"Zone",html:"Puo vedere le zone più colpite di un qualsiasi indicatore scelto.",elementSelector:"#topCases .card-title",showAfter:20,showAction:function(){i.viewMode()=="country"&&i.viewMode("region");M.Collapsible.getInstance(document.getElementById("topCases")).open(0)}},deltaSelected:{order:5.5,featureName:"Indicatori",html:"Puoi vedere l'incremento giornaliero dell'indicatore anzichè il valore totale.",elementSelector:".day-delta",showAfter:20,showAction:function(){i.currentArea()||i._tips.areaSelected.showAction();i.isDayDelta(!0)}},factorChanged:{order:6,featureName:"Indicatori",html:"Puoi mettere in relazione qualsiasi indicatore a numerosi parametri (es. % Positivi su Tamponi).",elementSelector:".filter-factor",showAfter:30,showAction:function(){i.currentArea()||i._tips.areaSelected.showAction();i.selectedIndicator(n.linq(i._dataSet.indicators).first(function(n){return n.id=="totalPositive"}));i.selectedFactor(n.linq(i._dataSet.factors).first(function(n){return n.id=="population"}))}},groupChanged:{order:7,featureName:"Grafico",html:"Puo raggruppare i dati del grafico in gruppi da 1 a 7 giorni. Puoi anche scegliere la data d'inizio.",elementSelector:".row-chart-group .select-wrapper",showAfter:30,showAction:function(){i.currentArea()||i._tips.areaSelected.showAction();var n=document.querySelector(".chart-options");n.classList.contains("closed")&&n.classList.remove("closed");i.groupSize(2);M.FormSelect.init(document.querySelectorAll(".row-chart-group select"))}},chartActionExecuted:{order:8,featureName:"Grafico",html:"Puoi portare il grafico a schermo interno, copiarlo, o copiare la serie numerico e incollarla in excel.",elementSelector:".chart .actions",showAfter:30},scaleChanged:{order:9,featureName:"Grafico",html:"Puo cambiare da scala logaritmica a scala lineare.",elementSelector:".log-scale",showAfter:210,showAction:function(){i.isLogScale(!0)}},maxFactorChanged:{order:10,featureName:"Mappa",html:"Puoi cambiare il riferimento rispetto al quale la mappa viene colorata. Normalmente è in base al valore massimo che si ha avuto globalmente.",elementSelector:".max-factor",showAfter:60,showAction:function(){i.currentArea()||i._tips.areaSelected.showAction();i.selectedIndicator(n.linq(i._dataSet.indicators).first(function(n){return n.id=="totalPositive"}));i.autoMaxFactor(!1);i.maxFactor(1e3)}},regionExcluded:{order:11,featureName:"Mappa",html:"Nella vista nazionale puoi escludere dagli indicatori il valore di una o più regioni cliccando sulla mappa.",elementSelector:".card-map .center-align",showAfter:0,showAction:function(){i.viewMode()!="country"&&i.viewMode("country");i._execludedArea.set("R8",i._geo.areas.r8);i.updateIndicator()}}},this._specialDates={current:{date:undefined,color:"#000",width:.5,label:"Giorno corrente"},dpcm8:{date:new Date(2020,2,7),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 8 Marzo (italia zona rossa)"},dpcm9:{date:new Date(2020,2,9),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 9 Marzo (italia zona rossa)"},dpcm11:{date:new Date(2020,2,11),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 11 Marzo (chiusura attività)"},mds20:{date:new Date(2020,2,20),color:"#070",dash:[5,5],width:1,visible:!1,label:"MDS 20 Marzo (chiura parchi, motoria nelle vicinane)"},dpcm22:{date:new Date(2020,2,21),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 22 Marzo (chiusura ulteriore attività)"}},this.dayNumber=ko.observable(0),this.totalDays=ko.observable(0),this.currentData=ko.observable(),this.currentArea=ko.observable(),this.topAreas=ko.observable(),this.viewMode=ko.observable("district"),this.selectedIndicator=ko.observable(),this.selectedFactor=ko.observable(),this.autoMaxFactor=ko.observable(!0),this.maxFactor=ko.observable(),this.isPlaying=ko.observable(!1),this.isLogScale=ko.observable(!1),this.isDayDelta=ko.observable(!1),this.isZoomChart=ko.observable(!1),this.isShowEnvData=ko.observable(!1),this.groupSize=ko.observable(1),this.startDay=ko.observable(0),this.isNoFactorSelected=ko.computed(function(){return i.selectedFactor()&&i.selectedFactor().id=="none"}),this.groupDays=[1,2,3,4,5,6,7],this.tip=ko.observable(),this.factorDescription=ko.observable(),this._data=t.data,this._geo=t.geo,this._debugMode=t.debugMode,this._calculator=new n.IndicatorCalculator(this._data,this._dataSet,this._geo),this.totalDays(this._data.days.length-1),this.dayNumber.subscribe(function(n){n!=i._data.days.length-1&&i._preferences.actions.dayChanged++;i.updateDayData();i._specialDates.current.date=new Date(i._data.days[n].date);i.updateChart()}),this._mapSvg=document.getElementsByTagName("svg").item(0),this._mapSvg.addEventListener("click",function(n){return i.onMapClick(n)}),this.days=[],r=0;r<this._data.days.length;r++)this.days.push({number:r,value:new Date(this._data.days[r].date),text:n.DateUtils.format(this._data.days[r].date,"{DD}/{MM}")});M.Tooltip.init(document.querySelectorAll(".tooltipped"));M.Sidenav.init(document.getElementById("mobile-menu"));o=M.Tabs.init(document.getElementById("areaTabs"));o.options.onShow=function(n){i.setViewMode(n.dataset.viewMode)};u=M.Collapsible.init(document.getElementById("topCases"));u.options.onOpenStart=function(){i._daysData||i.updateTopAreas();i._topAreasVisible=!0;i._preferences.actions.topAreasOpened++};u.options.onCloseEnd=function(){i._topAreasVisible=!1};this.indicators=ko.computed(function(){return n.linq(i._dataSet.indicators).where(function(n){return!n.validFor||n.validFor.indexOf(i.viewMode())!=-1}).toArray()});this.factors=ko.computed(function(){return n.linq(i._dataSet.factors).where(function(n){return!n.validFor||n.validFor.indexOf(i.viewMode())!=-1}).toArray()});this.selectedIndicator.subscribe(function(n){n&&(i.updateIndicator(),n.id!="totalPositive"&&i._preferences.actions.indicatorChanged++)});this.selectedFactor.subscribe(function(n){n&&(i.updateIndicator(),n.id!="none"&&i._preferences.actions.factorChanged++,setTimeout(function(){return M.FormSelect.init(document.querySelectorAll(".row-chart-group select"))}))});this.autoMaxFactor.subscribe(function(n){n&&(i.updateMaxFactor(),i.updateMap());i.updateUrl()});this.maxFactor.subscribe(function(){i.autoMaxFactor()||(i.updateMap(),i._preferences.actions.maxFactorChanged++);i.updateUrl()});this.isDayDelta.subscribe(function(n){i.computeStartDayForGroup();i.updateIndicator();n&&i._preferences.actions.deltaSelected++});this.isLogScale.subscribe(function(n){i.updateChart();i.updateUrl();n&&i._preferences.actions.scaleChanged++});this.isZoomChart.subscribe(function(){i.updateChart()});this.groupSize.subscribe(function(n){i.computeStartDayForGroup();i.updateChart();i.updateUrl();n>1&&i._preferences.actions.groupChanged++});this.startDay.subscribe(function(){i.updateChart();i.updateUrl()});f=new URLSearchParams(window.location.search);e=f.get("state");this._keepState=f.get("keepState")=="true";this.loadPreferences();this.engageUser();s=e&&this._keepState?JSON.parse(atob(e)):{};setTimeout(function(){return i.loadState(s)},0);this._debugMode||window.addEventListener("beforeunload",function(){return i.savePreferences()})}return u.prototype.engageUser=function(){var i=this,t;(this._preferences.showTips==undefined||this._preferences.showTips)&&(t=n.linq(this._tips).where(function(n){return n.value.showAfter>0&&i._preferences.actions[n.key]==0}).first(),this.showTip(t.key,{onClose:function(){return i.engageUser()},timeout:t.value.showAfter})||this.engageUser())},u.prototype.showTip=function(t,i){var f=this,e,u,o;return this._preferences.showTips!=undefined&&!this._preferences.showTips?!1:(!i||!i.override)&&this.tip()&&this.tip().isVisible()?!1:(!i||!i.force)&&this._preferences.actions[t]?!1:(e=this._tips[t],u=new r(e),u.dontShowAgain=function(){f._preferences.showTips=!1;f.savePreferences();u.close()},u.understood=function(){f._preferences.actions[t]++;f.savePreferences();u.close()},u.onClose=function(){i&&i.onClose&&i.onClose()},o=n.linq(this._tips).where(function(n){return n.value.order>e.order&&f._preferences.actions[n.key]==0}).first(),u.next=o?function(){u.close();f._preferences.actions[t]++;f.showTip(o.key)}:null,this.tip(u),setTimeout(function(){return u.show()},i&&i.timeout?i.timeout*1e3:0),!0)},u.prototype.isDefaultState=function(n){return(!n.day||n.day==this._data.days.length-1)&&(!n.view||n.view=="region")&&!n.area&&(!n.indicator||n.indicator=="totalPositive")&&(!n.factor||n.factor=="none")&&!n.maxFactor&&!n.dayDelta&&!n.logScale&&!n.showEnvData&&(!n.groupSize||n.groupSize==1)&&(n.startDay==undefined||n.startDay==0)&&!n.excludedArea},u.prototype.loadState=function(t){var u,e,o,r,i,f;if(t.view||(t.view="region"),o=M.Tabs.getInstance(document.getElementById("areaTabs")),o.select(n.ViewModes[t.view].tab),document.body.scrollTop=0,t.logScale!=undefined&&this.isLogScale(t.logScale),t.groupSize&&this.groupSize(t.groupSize),t.startDay!=undefined&&this.startDay(t.startDay),t.dayDelta!=undefined&&this.isDayDelta(t.dayDelta),t.showEnvData!=undefined&&this.isShowEnvData(t.showEnvData),t.maxFactor&&(this.autoMaxFactor(!1),this.maxFactor(t.maxFactor)),this.dayNumber(t.day!=undefined?t.day:this._data.days.length-1),t.excludedArea){this._execludedArea.clear();try{for(r=__values(t.excludedArea),i=r.next();!i.done;i=r.next())f=i.value,this._execludedArea.set(f,this._geo.areas[f.toLowerCase()])}catch(s){u={error:s}}finally{try{i&&!i.done&&(e=r.return)&&e.call(r)}finally{if(u)throw u.error;}}}t.indicator&&this.selectedIndicator(n.linq(this._dataSet.indicators).first(function(n){return n.id==t.indicator}));t.factor&&this.selectedFactor(n.linq(this._dataSet.factors).first(function(n){return n.id==t.factor}));t.area&&(this.selectedArea=this._geo.areas[t.area.toLowerCase()])},u.prototype.saveStata=function(){return{view:this.viewMode()=="region"?undefined:this.viewMode(),indicator:this.selectedIndicator()?this.selectedIndicator().id:undefined,factor:this.selectedFactor()?this.selectedFactor().id:undefined,dayDelta:this.isDayDelta()?!0:undefined,maxFactor:this.autoMaxFactor()?undefined:this.maxFactor(),day:this.dayNumber()==this._data.days.length-1?undefined:this.dayNumber(),area:this.selectedArea?this.selectedArea.id:undefined,groupSize:this.groupSize()==1?undefined:this.groupSize(),startDay:this.startDay()==0?undefined:this.startDay(),logScale:this.isLogScale()?!0:undefined,excludedArea:this._execludedArea.size>0?n.linq(this._execludedArea.keys()).toArray():undefined,showEnvData:this.isShowEnvData()?!0:undefined}},u.prototype.loadPreferences=function(){var n=localStorage.getItem("preferences");if(n){try{this._preferences=JSON.parse(n)}catch(t){}this._preferences&&this._preferences.version==1||(this._preferences=this.getDefaultPreferences(),this._preferences.isFirstView=!1,this._preferences.showTips=!1,this.savePreferences())}else this._preferences=this.getDefaultPreferences()},u.prototype.getDefaultPreferences=function(){return{isFirstView:!0,showTips:!0,version:1,actions:{areaSelected:0,indicatorSelected:0,indicatorChanged:0,dayChanged:0,viewChanged:0,chartActionExecuted:0,factorChanged:0,groupChanged:0,maxFactorChanged:0,scaleChanged:0,topAreasOpened:0,deltaSelected:0,regionExcluded:0}}},u.prototype.savePreferences=function(){this._preferences.isFirstView=!1;localStorage.setItem("preferences",JSON.stringify(this._preferences))},u.prototype.toggleChartZoom=function(){this._preferences.actions.chartActionExecuted++;this.isZoomChart(!this.isZoomChart())},u.prototype.copyMap=function(){return __awaiter(this,void 0,void 0,function(){var n,u,r,t,i;return __generator(this,function(){return n=document.querySelector("svg.map"),u=n.outerHTML,r=new Blob([u],{type:"image/svg+xml"}),navigator.clipboard&&navigator.clipboard.write?(t=document.createElement("img"),t.style.width=n.clientWidth+"px",t.style.height=n.clientHeight+"px",t.onload=function(){var u=this,i=document.createElement("canvas"),r;i.width=n.clientWidth;i.height=n.clientHeight;r=i.getContext("2d");r.fillStyle="white";r.fillRect(0,0,i.width,i.height);r.drawImage(t,0,0);i.toBlob(function(n){return __awaiter(u,void 0,void 0,function(){var i,t;return __generator(this,function(r){switch(r.label){case 0:return i=new ClipboardItem((t={},t[n.type]=n,t)),[4,navigator.clipboard.write([i])];case 1:return r.sent(),M.toast({html:"Mappa copiata negli appunti."}),[2]}})})})},t.src=window.URL.createObjectURL(r)):(i=document.createElement("a"),i.href=window.URL.createObjectURL(r),i.target="_blan",i.download="map.svg",i.click(),M.toast({html:"Funzionalità non supportata, download in corso."})),[2]})})},u.prototype.copyChart=function(){var n=this;this._chart.canvas.toBlob(function(t){return __awaiter(n,void 0,void 0,function(){var r,u,n,i;return __generator(this,function(f){switch(f.label){case 0:return(navigator.clipboard&&navigator.clipboard.write)?(r=new ClipboardItem((i={},i[t.type]=t,i)),[4,navigator.clipboard.write([r])]):[3,2];case 1:return f.sent(),M.toast({html:"Grafico copiato negli appunti."}),[3,3];case 2:u=window.URL.createObjectURL(t);n=document.createElement("a");n.href=u;n.target="_blan";n.download=this._chart.options.title.text+".png";n.click();M.toast({html:"Funzionalità non supportata, download in corso."});f.label=3;case 3:return[2]}})})});this._preferences.actions.chartActionExecuted++},u.prototype.copySerie=function(){return __awaiter(this,void 0,void 0,function(){var i,r,t;return __generator(this,function(){for(i=this._chart.data.datasets[0].data,r="",t=0;t<i.length;t++)r+=n.DateUtils.format(i[t].x,"{YYYY}-{MM}-{DD}")+"\t"+t+"\t"+n.MathUtils.round(i[t].y,1)+"\n";return n.DomUtils.copyText(r),M.toast({html:"Serie copiata sugli appunti."}),this._preferences.actions.chartActionExecuted++,[2]})})},u.prototype.copySerieForStudio=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(){return t={type:"serie",version:1,color:this.selectedIndicator().colorLight,serie:{areaId:this.selectedArea.id,indicatorId:this.selectedIndicator().id,xAxis:"dayNumber",startDay:this.startDay(),exeludedAreaIds:n.linq(this._execludedArea.keys()).toArray(),factorId:this.selectedFactor().id,groupSize:this.groupSize(),isDelta:this.isDayDelta()},title:this.factorDescription()},t.values=this._calculator.getSerie(t.serie),n.DomUtils.copyText(JSON.stringify(t)),M.toast({html:"Serie copiata sugli appunti."}),[2]})})},u.prototype.play=function(){this.dayNumber()==this._data.days.length-1&&this.dayNumber(0);this.isPlaying(!0);this.nextFrame()},u.prototype.pause=function(){this.isPlaying(!1)},u.prototype.setViewMode=function(n){n!="region"&&this._preferences.actions.viewChanged++;this.viewMode(n);var t=document.getElementById("group_district");n=="district"?t.style.removeProperty("display"):t.style.display="none";this.selectedArea=null;this._chart=null;this._execludedArea.clear();this.clearMap();this.updateMaxFactor();this.updateDayData();this.viewMode()=="country"?(this.selectedArea=this._geo.areas.it,this.showTip("regionExcluded",{timeout:5})):this._topAreasVisible?this.updateTopAreas():this._daysData=undefined;setTimeout(function(){return M.FormSelect.init(document.querySelectorAll(".row-indicator select"))})},Object.defineProperty(u.prototype,"selectedArea",{get:function(){return this._selectedArea},set:function(n){var t,i;n!=this._selectedArea&&(this._selectedArea&&(t=document.getElementById(this._selectedArea.id.toUpperCase()),t&&t.classList.remove("selected")),this._selectedArea=n,this._selectedArea&&(t=document.getElementById(this._selectedArea.id.toUpperCase()),t&&(t.classList.add("selected"),i=t.parentElement,t.remove(),i.appendChild(t))),this.changeArea())},enumerable:!0,configurable:!0}),u.prototype.getFactorValue=function(t,i){return this._calculator.getFactorValue({dayNumberOrGroup:t,areaOrId:i,factorId:this.selectedFactor().id,indicatorId:this.selectedIndicator().id,isDayDelta:this.isDayDelta(),execludedAreas:n.linq(this._execludedArea.keys()).toArray()})},u.prototype.getIndicatorValue=function(t,i,r){return this._calculator.getIndicatorValue({dayNumber:t,areaOrId:i,indicatorId:r,isDayDelta:this.isDayDelta(),execludedAreas:n.linq(this._execludedArea.keys()).toArray()})},u.prototype.computeStartDayForGroup=function(){var i=this.days.length-this.startDay(),n=i%this.groupSize(),t;n!=0&&(t=this.groupSize()-n,this.startDay()-t>=0?this.startDay(this.startDay()-t):this.startDay()+n<this.days.length-1&&this.startDay(this.startDay()+n),M.FormSelect.init(document.querySelectorAll(".row-chart-group select")))},u.prototype.onMapClick=function(n){var r=n.target,t=r.parentElement.id,i=this._geo.areas[t.toLowerCase()];i&&(this.viewMode()=="country"?(this._execludedArea.has(t)?this._execludedArea.delete(t):(this._execludedArea.set(t,i),M.toast({html:"Regione "+i.name+" esclusa dai conteggi."})),this.updateIndicator()):r.parentElement.classList.contains(this.viewMode())&&(this.selectedArea=i),this._preferences.actions.areaSelected++)},u.prototype.nextFrame=function(){var n=this;this.isPlaying()&&(this.dayNumber()>=this._data.days.length-1?this.pause():this.dayNumber(parseInt(this.dayNumber().toString())+1),setTimeout(function(){return n.nextFrame()},1e3))},u.prototype.changeArea=function(){if(this._selectedArea==null)this.currentArea(null);else{var i=!this.currentArea(),n=new t;n.value=this._selectedArea;this.updateArea(n);this.currentArea(n);this.updateFactorDescription();this.updateAreaIndicators();this.updateChart();i&&(M.FormSelect.init(document.querySelectorAll(".row-chart-group select")),M.Tooltip.init(document.querySelectorAll(".row-chart-group .tooltipped")))}this.updateUrl()},u.prototype.updateAreaIndicators=function(){var f,h,e,c,l=this,o,a,r,n,v,y,u,t,s;if(this.currentArea()){if(!this.currentArea().indicators()){o=[];a=function(n){var t=new i;t.indicator=n;t.select=function(){l._preferences.actions.indicatorSelected++;l.selectedIndicator(n);setTimeout(function(){return M.FormSelect.init(document.querySelectorAll(".row-indicator select"))})};o.push(t)};try{for(r=__values(this.indicators()),n=r.next();!n.done;n=r.next())v=n.value,a(v)}catch(p){f={error:p}}finally{try{n&&!n.done&&(h=r.return)&&h.call(r)}finally{if(f)throw f.error;}}this.currentArea().indicators(o)}y=this.currentArea().value.id.toLowerCase();try{for(u=__values(this.currentArea().indicators()),t=u.next();!t.done;t=u.next())s=t.value,s.value(this.getIndicatorValue(this.dayNumber(),y,s.indicator.id))}catch(w){e={error:w}}finally{try{t&&!t.done&&(c=u.return)&&c.call(u)}finally{if(e)throw e.error;}}}},u.prototype.updateFactorDescription=function(){var r,f,n="",u,i,t,e;if(this.isDayDelta()&&(n="Nuovi "),n+=this.selectedFactor().description.replace("[indicator]",this.selectedIndicator().name),this.currentArea()&&(n+=" - "+this.currentArea().value.name),this._execludedArea.size>0){n+=" - Escluso (";u=0;try{for(i=__values(this._execludedArea.keys()),t=i.next();!t.done;t=i.next())e=t.value,u>0&&(n+=", "),n+=this._execludedArea.get(e).name,u++}catch(o){r={error:o}}finally{try{t&&!t.done&&(f=i.return)&&f.call(i)}finally{if(r)throw r.error;}}n+=")"}this.factorDescription(n)},u.prototype.updateIndicator=function(){this.selectedIndicator()&&this.selectedFactor()&&(this.updateFactorDescription(),this.updateMaxFactor(),this.updateDayData(),this.updateChart(),this.updateUrl(),this._topAreasVisible&&this.updateTopAreas())},u.prototype.updateMaxFactor=function(){var i,f,t,e,u,r;if(this.selectedFactor()&&this.selectedIndicator()&&this.autoMaxFactor()){for(i=Number.NEGATIVE_INFINITY,f=n.ViewModes[this.viewMode()],t=0;t<this._data.days.length;t++){e=this._data.days[t];for(u in e.values)f.validateId(u)&&(r=this.getFactorValue(t,u),r>i&&r!=Number.POSITIVE_INFINITY&&(i=r))}this.maxFactor(parseFloat(i.toFixed(1)))}},u.prototype.initChart=function(){var t=this,i=document.querySelector("#areaGraph"),r={afterDraw:function(n){var f=n.data.datasets[0].data,e,i,o,r,u;if(f&&f.length!=0){e=n.scales["x-axis-0"];i=n.ctx;for(o in t._specialDates)(r=t._specialDates[o],r.date&&r.visible!==!1)&&(u=e.getPixelForValue({x:r.date}),i.lineWidth=r.width||1,i.beginPath(),i.moveTo(u,n.chartArea.top),i.lineTo(u,n.chartArea.bottom),i.strokeStyle=r.color||"#000",r.dash?i.setLineDash(r.dash):i.setLineDash([]),r.dashOffset&&(i.lineDashOffset=r.dashOffset),i.stroke())}}};this._chart=new Chart(i,{plugins:[r],type:"line",data:{datasets:[{lineTension:0,data:[],borderWidth:1}]},options:{maintainAspectRatio:!1,legend:{display:!0,position:"bottom"},title:{display:!1},tooltips:{callbacks:{label:function(t){return t.xLabel+": "+n.MathUtils.round(parseFloat(t.value),1)}}},scales:{xAxes:[{type:"time",distribution:"linear",time:{unit:"day",tooltipFormat:"DD/MMM"}}]}}})},u.prototype.updateChart=function(){if(this.selectedIndicator()&&this.currentArea()&&this.selectedFactor()){this._chart==null&&this.initChart();var t=this.currentArea().value,i=t.id.toLowerCase(),r=this.selectedIndicator().id;this._chart.data.datasets[0].label=this.factorDescription();this._chart.options.title.text=this._chart.data.datasets[0].label;this._chart.options.scales.yAxes[0].type=this.isLogScale()?"logarithmic":"linear";this._chart.data.datasets[0].borderColor=this.selectedIndicator().colorDark;this._chart.data.datasets[0].backgroundColor=this.selectedIndicator().colorLight;this._chart.data.datasets[0].data=this._calculator.getSerie({areaId:t.id,indicatorId:this.selectedIndicator().id,xAxis:"date",startDay:this.startDay(),exeludedAreaIds:n.linq(this._execludedArea.keys()).toArray(),factorId:this.selectedFactor().id,groupSize:this.groupSize(),isDelta:this.isDayDelta()});this._chart.update()}},u.prototype.updateArea=function(t,i){if(t&&this.selectedIndicator()&&this.selectedFactor()){i==undefined&&(i=this.dayNumber());var r=t.value.id.toLowerCase(),f=t.value,u=this._data.days[i];if(!u||!u.values[r]){M.toast({html:"Dati non disponibili"});return}t.data(u.values[r]);t.indicator(this.getIndicatorValue(i,r,this.selectedIndicator().id));t.factor(n.MathUtils.round(this.getFactorValue(i,f),1));t.reference(this.selectedFactor().reference(u.values[r],f))}},u.prototype.updateTopAreas=function(){var i=this,f,r,u;for(this._daysData=[],f=function(u){var e=r._data.days[u],f={},o=n.ViewModes[r.viewMode()].validateId;f.topAreas=n.linq(e.values).select(function(n){return{factor:i.getFactorValue(u,n.key),value:n}}).orderByDesc(function(n){return n.factor}).where(function(n){return o(n.value.key)}).select(function(n){var r=new t;return r.value=i._geo.areas[n.value.key.toLowerCase()],r.select=function(){return i.selectedArea=r.value},i.updateArea(r,u),r}).take(25).toArray();r._daysData.push(f)},r=this,u=0;u<this._data.days.length;u++)f(u);this.topAreas(this._daysData[this.dayNumber()].topAreas)},u.prototype.updateDayData=function(){var t=this._data.days[this.dayNumber()];this.currentData(n.DateUtils.format(t.date,"{DD}/{MM}/{YYYY}"));this.updateMap();this.updateArea(this.currentArea());this.updateAreaIndicators();this._daysData&&this._topAreasVisible&&this.topAreas(this._daysData[this.dayNumber()].topAreas);this.updateUrl()},u.prototype.updateUrl=function(){if(this._keepState){var t=this.saveStata(),i=n.app.baseUrl+"Overview";this.isDefaultState(t)||(i+="?state="+encodeURIComponent(btoa(JSON.stringify(t)))+"&keepState=true");history.replaceState(null,null,i)}},u.prototype.clearMap=function(){var i=this._data.days[this.dayNumber()],t,n;for(t in i.values)n=document.getElementById(t.toUpperCase()),n&&(n.style.fillOpacity="1",n.style.removeProperty("fill"))},u.prototype.updateMap=function(){var o=this,f,e,r,t,u,i,s;if(this.selectedIndicator()&&this.selectedFactor())if(this.viewMode()!="country"){f=this._data.days[this.dayNumber()];e=new n.LinearGradient("#fff",this.selectedIndicator().colorDark);for(r in f.values)if(t=document.getElementById(r.toUpperCase()),t){if(u=this._geo.areas[r],u.type!=n.ViewModes[this.viewMode()].areaType)continue;i=this.getFactorValue(this.dayNumber(),u);i==Number.POSITIVE_INFINITY&&(i=NaN);i=Math.min(1,i/this.maxFactor());isNaN(i)?(t.classList.contains("valid")&&t.classList.remove("valid"),t.style.fillOpacity="1",t.style.removeProperty("fill")):(t.classList.contains("valid")||t.classList.add("valid"),s=n.MathUtils.discretize(n.MathUtils.exponential(i),20),t.style.fill=e.valueAt(i).toString())}}else n.linq(document.querySelectorAll("g.region")).foreach(function(n){n.style.fill=o._execludedArea.has(n.id)?"#444":"#FFF"})},u}();n.GeoPlotPage=u}(WebApp||(WebApp={})),function(n){var o=function(){function t(){this.vars={}}return t.prototype.setExpressions=function(t){var k,et,p,ot,d,st,w,ht,g,ct,i=this.calculator.getState(),s,r,h,nt,c,u,tt,it,l,a,f,rt,ut,v,e,ft,y,o,b;try{for(s=__values(t),r=s.next();!r.done;r=s.next())if(h=r.value,nt=n.linq(i.expressions.list).first(function(n){return n.id==h.id}),nt)try{for(c=(p=void 0,__values(Object.getOwnPropertyNames(h))),u=c.next();!u.done;u=c.next())tt=u.value,nt[tt]=h[tt]}catch(lt){p={error:lt}}finally{try{u&&!u.done&&(ot=c.return)&&ot.call(c)}finally{if(p)throw p.error;}}else i.expressions.list.push(h)}catch(at){k={error:at}}finally{try{r&&!r.done&&(et=s.return)&&et.call(s)}finally{if(k)throw k.error;}}it=n.linq(i.expressions.list).where(function(n){return n.type!="folder"}).groupBy(function(n){return n.folderId?n.folderId:""}).toDictionary(function(n){return n.key},function(n){return n.values.toArray()});l=[];try{for(a=__values(n.linq(i.expressions.list).where(function(n){return n.type=="folder"})),f=a.next();!f.done;f=a.next())if(rt=f.value,l.push(rt),ut=it[rt.id],ut)try{for(v=(w=void 0,__values(ut)),e=v.next();!e.done;e=v.next())b=e.value,l.push(b)}catch(vt){w={error:vt}}finally{try{e&&!e.done&&(ht=v.return)&&ht.call(v)}finally{if(w)throw w.error;}}}catch(yt){d={error:yt}}finally{try{f&&!f.done&&(st=a.return)&&st.call(a)}finally{if(d)throw d.error;}}if(ft=it[""],ft)try{for(y=__values(ft),o=y.next();!o.done;o=y.next())b=o.value,l.push(b)}catch(pt){g={error:pt}}finally{try{o&&!o.done&&(ct=y.return)&&ct.call(y)}finally{if(g)throw g.error;}}i.expressions.list=l;this.calculator.setState(i)},t.prototype.setColor=function(n,t){this.calculator.controller.dispatch({type:"set-item-color",id:n,color:t})},t.prototype.updateTable=function(t,i){var r=n.linq(this.calculator.getExpressions()).where(function(n){return n.id==t}).first();r&&(r.columns[0].values=n.linq(i).select(function(n){return n.x.toString()}).toArray(),r.columns[1].values=n.linq(i).select(function(n){return n.y.toString()}).toArray(),this.calculator.setExpression(r))},t.prototype.updateExpression=function(t){var u,o,f=n.linq(this.calculator.getExpressions()).where(function(n){return n.id==t.id}).first(),r,i,e;if(f){try{for(r=__values(Object.getOwnPropertyNames(t)),i=r.next();!i.done;i=r.next())e=i.value,f[e]=t[e]}catch(s){u={error:s}}finally{try{i&&!i.done&&(o=r.return)&&o.call(r)}finally{if(u)throw u.error;}}this.calculator.setExpression(f)}},t.prototype.updateVariable=function(n,t,i){this.updateExpression({id:n,latex:t+"="+i.toString()})},t.prototype.expressionZoomFit=function(n){this.calculator.controller.dispatch({type:"expression-zoom-fit",id:n})},t.prototype.setItemVisibile=function(n,t){this.calculator.controller._setItemHidden(n,!t)},t.prototype.generateVars=function(n){for(var t in n)n[t]||(n[t]=this.generateVar(t))},t.prototype.generateVar=function(n){return n===void 0&&(n="a"),this.vars[n]||(this.vars[n]=0),this.vars[n]++,n[0]+"_{"+this.vars[n]+"}"},t}(),u=function(){function n(n){this._varsMap={x:null,y:null,ofs:null,xofs:null};this.name=ko.observable();this.itemType="regression";this.icon="show_chart";this.optionsTemplateName="RegressionOptionsTemplate";this.actions=[];n&&this.setState(n)}return n.prototype.setState=function(n){n.name&&this.name(n.name);n.visible!=undefined&&this.node.isVisible(n.visible)},n.prototype.getState=function(){return{name:this.name(),visible:this.node.isVisible()}},n.prototype.remove=function(){},n.prototype.attachNode=function(n){this.node=n},n.prototype.attachGraph=function(n){this._graphCtx=n},n.prototype.updateGraph=function(){!this._graphCtx},Object.defineProperty(n.prototype,"serie",{get:function(){return this.node.parentNode.value()},enumerable:!0,configurable:!0}),n}(),r=function(){function r(i){var r=this;this._varsMap={x:null,y:null,ofs:null,xofs:null};this.name=ko.observable();this.color=ko.observable();this.offsetX=ko.observable(0);this.itemType="serie";this.icon="insert_chart";this.optionsTemplateName="StudioOptionsTemplate";this.actions=[];i&&this.setState(i);this.actions.push(n.apply(new t,function(n){n.text="Elimina";n.icon="delete";n.execute=function(){return r.remove()}}));this.actions.push(n.apply(new t,function(n){n.text="Aggiorna";n.icon="autorenew";n.execute=function(){return r.updateSerie()}}));this.actions.push(n.apply(new t,function(n){n.text="Regressione";n.icon="add_box";n.execute=function(){var n=r.addRegression();r.node.isExpanded(!0);n.node.isSelected(!0)}}))}return r.fromText=function(n){try{var t=JSON.parse(n);if(t&&t.type=="serie")return new r({name:t.title,values:t.values,source:t.serie,color:t.color})}catch(i){}},r.prototype.addRegression=function(n,t){t===void 0&&(t=!0);var r=n instanceof u?n:new u(n),f=new i(r);return this.node.addNode(f),r.attachNode(f),r.attachGraph(this._graphCtx),t&&r.updateGraph(),r},r.prototype.setState=function(n){var t=this;n.name&&this.name(n.name);n.color&&this.color(n.color);n.offsetX!=undefined&&this.offsetX(n.offsetX);n.source&&(this.source=n.source);n.values!=undefined&&(this.values=n.values);n.folderId!=undefined&&(this.folderId=n.folderId);n.visible!=undefined&&this.node.isVisible(n.visible);n.regressions!=undefined&&(this.regressions.foreach(function(n){return n.remove()}),n.regressions.forEach(function(n){var i=t.addRegression(null,!1);i.setState(n)}));this.updateGraph()},r.prototype.getState=function(){return{color:this.color(),name:this.name(),offsetX:this.offsetX(),source:this.source,values:this.values,folderId:this.folderId,varsMap:this._varsMap,visible:this.node.isVisible(),regressions:this.regressions.select(function(n){return n.getState()}).toArray()}},r.prototype.updateSerie=function(){this.values=this._graphCtx.serieCalculator.getSerie(this.source);this._graphCtx.updateTable(this.getGraphId("table"),this.values)},r.prototype.remove=function(){this._graphCtx&&(this._graphCtx.calculator.removeExpression({id:this.getGraphId("private")}),this._graphCtx.calculator.removeExpression({id:this.getGraphId("public")}));this.node.remove()},r.prototype.attachNode=function(n){var t=this;this.node=n;this.node.isVisible.subscribe(function(){return t.updateGraphVisibility()});this.node.isSelected.subscribe(function(n){n&&t.onSelected()})},r.prototype.attachGraph=function(n){var t=this;this._graphCtx=n;this._graphCtx.calculator.observe("expressionAnalysis",function(){var n=t._graphCtx.calculator.expressionAnalysis[t.getGraphId("offset")];t.offsetX(n.evaluation.value)});this.color.subscribe(function(n){t._graphCtx.setColor(t.getGraphId("offset-x-serie"),n)})},r.prototype.onSelected=function(){this._graphCtx.expressionZoomFit(this.getGraphId("table"))},r.prototype.getGraphId=function(n){return this.folderId+"/"+n},r.prototype.updateGraphVisibility=function(){var n=this.node.isVisible()&&this.project.node.isVisible();this._graphCtx.setItemVisibile(this.getGraphId("public"),n);this._graphCtx.setItemVisibile(this.getGraphId("private"),n)},r.prototype.updateGraph=function(t){(t===void 0&&(t=!1),this._graphCtx)&&(this.folderId||(this.folderId=n.StringUtils.uuidv4()),this.color()||this.color("#0000ff"),this._graphCtx.generateVars(this._varsMap),this._graphCtx.setExpressions([{type:"folder",id:this.getGraphId("public"),title:this.project.name()+" - "+this.name()},{type:"folder",id:this.getGraphId("private"),title:this.project.name()+" - "+this.name(),secret:!0,hidden:!this.node.isVisible()||!this.project.node.isVisible()},{type:"expression",id:this.getGraphId("offset"),latex:this._varsMap.ofs+"="+this.offsetX(),folderId:this.getGraphId("public"),label:"Scostamento",slider:{min:(-this.values.length).toString(),max:this.values.length.toString(),hardMax:!0,hardMin:!0,step:"1"}},{type:"expression",id:this.getGraphId("offset-x"),latex:this._varsMap.xofs+"="+this._varsMap.x+"+"+this._varsMap.ofs,folderId:this.getGraphId("private")},{type:"expression",id:this.getGraphId("offset-x-serie"),latex:"("+this._varsMap.xofs+","+this._varsMap.y+")",folderId:this.getGraphId("private"),points:!0,lines:!0,color:this.color()},{type:"table",id:this.getGraphId("table"),folderId:this.getGraphId("private"),columns:[{id:this.getGraphId("table/x"),latex:this._varsMap.x},{id:this.getGraphId("table/y"),latex:this._varsMap.y,hidden:!0}]}]),this._graphCtx.updateTable(this.getGraphId("table"),this.values),this.updateGraphVisibility())},Object.defineProperty(r.prototype,"regressions",{get:function(){function t(){var t,n,r,u,i,f;return __generator(this,function(e){switch(e.label){case 0:e.trys.push([0,5,6,7]);t=__values(this.node.nodes());n=t.next();e.label=1;case 1:return!n.done?(r=n.value,[4,r.value()]):[3,4];case 2:e.sent();e.label=3;case 3:return n=t.next(),[3,1];case 4:return[3,7];case 5:return u=e.sent(),i={error:u},[3,7];case 6:try{n&&!n.done&&(f=t.return)&&f.call(t)}finally{if(i)throw i.error;}return[7];case 7:return[2]}})}return n.linq(t.apply(this))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"project",{get:function(){return this.node.parentNode.value()},enumerable:!0,configurable:!0}),r}(),s=function(){function u(i){var r=this;this.name=ko.observable();this.itemType="project";this.icon="folder";this.optionsTemplateName="ProjectOptionsTemplate";this.actions=[];i&&this.setState(i);this.actions.push(n.apply(new t,function(n){n.text="Elimina";n.icon="delete";n.execute=function(){return r.remove()}}))}return u.prototype.setState=function(n){var t=this;n.name&&this.name(n.name);n.visible!=undefined&&this.node.isVisible(n.visible);n.opened!=undefined&&this.node.isExpanded(n.opened);n.series!=undefined&&(this.series.foreach(function(n){return n.remove()}),n.series.forEach(function(n){var i=t.addSerie(null,!1);i.setState(n)}))},u.prototype.getState=function(){return{name:this.name(),series:this.series.select(function(n){return n.getState()}).toArray(),visible:this.node.isVisible(),opened:this.node.isExpanded()}},u.prototype.remove=function(){this.series.foreach(function(n){return n.remove()});this.node.remove()},u.prototype.attachNode=function(n){var t=this;this.node=n;this.node.isVisible.subscribe(function(){return t.series.foreach(function(n){return n.updateGraphVisibility()})})},u.prototype.attachGraph=function(n){this._graphCtx=n},u.prototype.updateGraph=function(n){(n===void 0&&(n=!1),this._graphCtx)&&n&&this.series.foreach(function(t){return t.updateGraph(n)})},u.prototype.addSerie=function(n,t){t===void 0&&(t=!0);var u=n instanceof r?n:new r(n),f=new i(u);return this.node.addNode(f),u.attachNode(f),u.attachGraph(this._graphCtx),t&&u.updateGraph(),u},Object.defineProperty(u.prototype,"series",{get:function(){function t(){var t,n,r,u,i,f;return __generator(this,function(e){switch(e.label){case 0:e.trys.push([0,5,6,7]);t=__values(this.node.nodes());n=t.next();e.label=1;case 1:return!n.done?(r=n.value,[4,r.value()]):[3,4];case 2:e.sent();e.label=3;case 3:return n=t.next(),[3,1];case 4:return[3,7];case 5:return u=e.sent(),i={error:u},[3,7];case 6:try{n&&!n.done&&(f=t.return)&&f.call(t)}finally{if(i)throw i.error;}return[7];case 7:return[2]}})}return n.linq(t.apply(this))},enumerable:!0,configurable:!0}),u}(),t=function(){function n(){}return n.prototype.execute=function(){},n}(),i=function(){function n(n){var t=this;this.nodes=ko.observableArray();this.value=ko.observable();this.isSelected=ko.observable(!1);this.isVisible=ko.observable(!0);this.isExpanded=ko.observable(!1);this.actions=ko.observableArray();this.value(n);this.isSelected.subscribe(function(n){n&&t._treeView.select(t)})}return n.prototype.remove=function(){this._parentNode&&this._parentNode.nodes.remove(this);this._treeView.selectedNode()==this&&this._treeView.select(null)},n.prototype.addNode=function(n){n.attach(this._treeView,this);this.nodes.push(n)},n.prototype.attach=function(n,t){var u,f,r,i,e;this._treeView=n;this._parentNode=t;try{for(r=__values(this.nodes()),i=r.next();!i.done;i=r.next())e=i.value,e.attach(n)}catch(o){u={error:o}}finally{try{i&&!i.done&&(f=r.return)&&f.call(r)}finally{if(u)throw u.error;}}},Object.defineProperty(n.prototype,"parentNode",{get:function(){return this._parentNode},enumerable:!0,configurable:!0}),n.prototype.toggleVisible=function(){this.isVisible(!this.isVisible())},n.prototype.toggleSelection=function(){this.isSelected(!this.isSelected())},n.prototype.expandCollapse=function(){this.isExpanded(!this.isExpanded())},n}(),f=function(){function n(){this.root=ko.observable();this.selectedNode=ko.observable()}return n.prototype.select=function(n){this.selectedNode()!=n&&(this.selectedNode()&&this.selectedNode().isSelected(!1),this.selectedNode(n),this.selectedNode()&&this.selectedNode().isSelected(!0))},n.prototype.setRoot=function(n){n.attach(this);this.root(n)},n}(),e;n.TreeViewModel=f;e=function(){function t(t){var r=this;this._dataSet=n.InfectionDataSet;this.items=new f;this._data=t.data;this._geo=t.geo;this._graphCtx=new o;this._graphCtx.serieCalculator=new n.IndicatorCalculator(this._data,this._dataSet,this._geo);this._graphCtx.calculator=Desmos.GraphingCalculator(document.getElementById("calculator"),{pasteGraphLink:!1,pasteTableData:!1,restrictedFunctions:!0,administerSecretFolders:!0,authorIDE:!0,advancedStyling:!0});this.items.setRoot(new i);document.body.addEventListener("paste",function(n){n.preventDefault();r.onPaste(n.clipboardData)});document.body.addEventListener("keydown",function(n){r.onKeyDown(n)});setTimeout(function(){return r.init()})}return t.prototype.removeSelected=function(){if(this.items.selectedNode()){var n=this.items.selectedNode().value();n.remove()}},t.prototype.getSelectedProject=function(){if(this.items.selectedNode()){var n=this.items.selectedNode().value();return n.itemType=="project"?n:n.itemType=="serie"?n.project:void 0}},t.prototype.newProject=function(){var n=this.addProject({name:"Project "+(this.projects.count()+1)});return n.node.isSelected(!0),n},t.prototype.addProject=function(n,t){t===void 0&&(t=!0);var r=new s(n),u=new i(r);return this.items.root().addNode(u),r.attachNode(u),r.attachGraph(this._graphCtx),t&&r.updateGraph(),r},t.prototype.getState=function(){var n={version:2};return n.graphState=this._graphCtx.calculator.getState(),n.vars=this._graphCtx.vars,n.projects=this.projects.select(function(n){return n.getState()}).toArray(),n},t.prototype.setState=function(n){var t=this;n&&(n.graphState&&(n.graphState.expressions.list=[],this._graphCtx.calculator.setState(n.graphState)),n.projects!=undefined&&(this.projects.toArray().forEach(function(n){return n.remove()}),n.projects.forEach(function(n){var i=t.addProject();i.setState(n)})))},t.prototype.loadState=function(){var n=localStorage.getItem("studio");n&&this.setState(JSON.parse(n))},t.prototype.saveState=function(){localStorage.setItem("studio",JSON.stringify(this.getState()));M.toast({html:"Studio salvato"})},t.prototype.demo=function(){var n=this.addProject({name:"Project 1"});this.addProject({name:"Project 2"});this.addProject({name:"Project 3"});n.addSerie({name:"Serie 1"})},t.prototype.onKeyDown=function(n){n.keyCode==46&&n.target.tagName!="INPUT"&&(n.preventDefault(),this.removeSelected())},t.prototype.onPaste=function(n){var t=this.getSelectedProject(),u,i;t||this.projects.any()||(t=this.newProject());t&&(u=n.getData("text/plain").toString(),u&&(i=r.fromText(u),i&&(t.addSerie(i),t.node.isExpanded(!0),i.node.isSelected(!0))))},Object.defineProperty(t.prototype,"projects",{get:function(){function t(){var t,n,r,u,i,f;return __generator(this,function(e){switch(e.label){case 0:e.trys.push([0,5,6,7]);t=__values(this.items.root().nodes());n=t.next();e.label=1;case 1:return!n.done?(r=n.value,[4,r.value()]):[3,4];case 2:e.sent();e.label=3;case 3:return n=t.next(),[3,1];case 4:return[3,7];case 5:return u=e.sent(),i={error:u},[3,7];case 6:try{n&&!n.done&&(f=t.return)&&f.call(t)}finally{if(i)throw i.error;}return[7];case 7:return[2]}})}return n.linq(t.apply(this))},enumerable:!0,configurable:!0}),t.prototype.init=function(){this.loadState()},t}();n.StudioPage=e}(WebApp||(WebApp={}));