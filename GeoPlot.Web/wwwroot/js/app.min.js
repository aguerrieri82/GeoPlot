function formatNumber(n){return n?$numberFormat.format(n):""}function capitalizeFirst(n){return n.substr(0,1).toUpperCase()+n.substr(1)}function expandCollapse(n){var t=n.parentElement,i=t.querySelector(".section-content");t.classList.contains("closed")?(i.style.removeProperty("display"),t.classList.remove("closed")):(t.classList.add("closed"),setTimeout(function(){return i.style.display="none"},300))}function $string(n){return n.replace(/\$\((?<id>[^)]+)\)/g,function(n,t){return $stringTable[t]})}var __values=this&&this.__values||function(n){var t=typeof Symbol=="function"&&Symbol.iterator,i=t&&n[t],r=0;if(i)return i.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&r>=n.length&&(n=void 0),{value:n&&n[r++],done:!n}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.");},__awaiter=this&&this.__awaiter||function(n,t,i,r){function u(n){return n instanceof i?n:new i(function(t){t(n)})}return new(i||(i=Promise))(function(i,f){function o(n){try{e(r.next(n))}catch(t){f(t)}}function s(n){try{e(r["throw"](n))}catch(t){f(t)}}function e(n){n.done?i(n.value):u(n.value).then(o,s)}e((r=r.apply(n,t||[])).next())})},__generator=this&&this.__generator||function(n,t){function o(n){return function(t){return s([n,t])}}function s(e){if(f)throw new TypeError("Generator is already executing.");while(r)try{if(f=1,u&&(i=e[0]&2?u["return"]:e[0]?u["throw"]||((i=u["return"])&&i.call(u),0):u.next)&&!(i=i.call(u,e[1])).done)return i;(u=0,i)&&(e=[e[0]&2,i.value]);switch(e[0]){case 0:case 1:i=e;break;case 4:return r.label++,{value:e[1],done:!1};case 5:r.label++;u=e[1];e=[0];continue;case 7:e=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(e[0]===6||e[0]===2)){r=0;continue}if(e[0]===3&&(!i||e[1]>i[0]&&e[1]<i[3])){r.label=e[1];break}if(e[0]===6&&r.label<i[1]){r.label=i[1];i=e;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(e);break}i[2]&&r.ops.pop();r.trys.pop();continue}e=t.call(n,r)}catch(o){e=[6,o];u=0}finally{f=i=0}if(e[0]&5)throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},f,u,i,e;return e={next:o(0),"throw":o(1),"return":o(2)},typeof Symbol=="function"&&(e[Symbol.iterator]=function(){return this}),e},__extends=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),$numberFormat,WebApp;(function(n){var t;(function(t){var i=function(){function t(){}return t.prototype.initServices=function(){n.Services.httpClient=new n.XHRHttpClient},t}();t.GeoPlotApplication=i})(t=n.GeoPlot||(n.GeoPlot={}));n.app=new t.GeoPlotApplication})(WebApp||(WebApp={}));window.ko&&(ko.bindingHandlers.attach={init:function(n,t,i,r){var u=ko.unwrap(t());if((u===!0||u==undefined)&&(u=r.attachNode),typeof u!="function")throw"Supplied argument is not a function";setTimeout(function(){return u.call(r,n)})}}),function(n){var t;(function(n){var t=function(){function n(){}return n.project=function(t){var i={x:0,y:0};return i.x=t.lng*n.OriginShift/180,i.y=Math.log(Math.tan((90+t.lat)*Math.PI/360))/(Math.PI/180),i.y=-(i.y*n.OriginShift/180),i.x-=n.OFFSET_X,i.y-=n.OFFSET_Y,i},n.EarthRadius=6378137,n.OriginShift=2*Math.PI*n.EarthRadius/2,n.OFFSET_X=1263355,n.OFFSET_Y=5543162,n}();n.Geo=t})(t=n.GeoPlot||(n.GeoPlot={}))}(WebApp||(WebApp={}));$numberFormat=new Intl.NumberFormat($language,{});HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(n,t,i){var r=this;setTimeout(function(){for(var f=atob(r.toDataURL(t,i).split(",")[1]),e=f.length,o=new Uint8Array(e),u=0;u<e;u++)o[u]=f.charCodeAt(u);n(new Blob([o],{type:t||"image/png"}))})}});window.Chart&&Chart.plugins.register({beforeDraw:function(n){var t=n.ctx;t.fillStyle="white";t.fillRect(0,0,n.width,n.height)}}),function(n){var t;(function(t){var u=function(){function t(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];this.colors=t.length>0?typeof t[0]=="string"?n.linq(t).select(function(n){return new i(n)}).toArray():t:[]}return t.prototype.valueAt=function(n){if(n<0)return this.colors[0];n>1&&this.colors[this.colors.length-1];var r=1/(this.colors.length-1),o=Math.floor(n/r),s=Math.ceil(n/r),f=(n-o*r)/r,t=this.colors[o],e=this.colors[s],u=new i;return u.r=t.r+(e.r-t.r)*f,u.g=t.g+(e.g-t.g)*f,u.b=t.b+(e.b-t.b)*f,u},t}(),i,r;t.LinearGradient=u;i=function(){function n(n){this.r=0;this.g=0;this.b=0;n&&this.fromHex(n)}return n.prototype.fromHex=function(n){n.length==4?(this.r=parseInt("0x"+n[1]+n[1])/255,this.g=parseInt("0x"+n[2]+n[2])/255,this.b=parseInt("0x"+n[3]+n[3])/255):(this.r=parseInt("0x"+n[1]+n[2])/255,this.g=parseInt("0x"+n[3]+n[4])/255,this.b=parseInt("0x"+n[5]+n[6])/255)},n.prototype.toString=function(){function n(n){var t=Math.round(n*255).toString(16);return t.length==1?"0"+t:t}return"#"+n(this.r)+n(this.g)+n(this.b)},n}();t.RgbColor=i;r=function(){function n(n){this._svg=n}return n.prototype.setViewPort=function(n,t,i,r){this._svg.viewBox.baseVal.x=n;this._svg.viewBox.baseVal.y=t;this._svg.viewBox.baseVal.width=i-n;this._svg.viewBox.baseVal.height=r-t},n.prototype.drawPoly=function(n){var t=document.createElementNS("http://www.w3.org/2000/svg","polygon"),i,r;for(t.style.fill=n.fillColor,t.style.stroke=n.strokeColor,t.style.strokeWidth=n.strokeSize+"%",t.id=n.id,i=0;i<n.geometry.points.length;i++)r=this._svg.createSVGPoint(),r.x=n.geometry.points[i].x,r.y=n.geometry.points[i].y,t.points.appendItem(r);this._svg.appendChild(t)},n}();t.Graphics=r})(t=n.GeoPlot||(n.GeoPlot={}))}(WebApp||(WebApp={})),function(n){var t;(function(t){var e=function(){function n(n){this._value=n}return n.prototype.value=function(n,t,i,r,u){var e=this._value(n,u),f;if(i)for(f in i)e-=this.value(i[f],r[f],null,null,u);return e},n}(),i,r,u,f;t.ConstIndicatorFunction=e;i=function(){function n(n){this._value=n}return n.prototype.value=function(n,t,i,r,u){var f=this._value(n,u),e;if(t&&(f-=this._value(t,u)),i)for(e in i)f-=this.value(i[e],r[e],null,null,u);return f},n}();t.SimpleIndicatorFunction=i;r=function(){function n(n){this._value=n}return n.prototype.value=function(n,t,i,r,u,f){var o=0;for(var e in n)o+=f.value(n[e],t[e],i[e],r[e],u);return this._value(o,n[0],u)},n}();t.SimpleFactorFunction=r;u=function(){function n(n,t){this._value=n;this._factor=t}return n.prototype.value=function(n,t,i,r,u,f){var o=0,s=0;for(var e in n)o+=f.value(n[e],t[e],i[e],r[e],u),s+=this._factor.value(n[e],t[e],i[e],r[e],u);return this._value(o,s)},n}();t.DoubleFactorFunction=u;f=function(){function t(n,t,i){this._data=n;this._dataSet=t;this._geo=i}return t.prototype.getFactorValue=function(t){var h,y,o,p,it=this,c=(typeof t.areaOrId=="string"?t.areaOrId:t.areaOrId.id).toLowerCase(),s=function(n,t){return n<0?undefined:it._data.days[n].values[t]},w,u,i,f,l,a,e,r,v,nt,tt;w=Array.isArray(t.dayNumberOrGroup)?t.dayNumberOrGroup:[t.dayNumberOrGroup];var b=[],k=[],d=[],g=[];try{for(u=__values(w),i=u.next();!i.done;i=u.next())if(f=i.value,b.push(s(f,c)),t.isDayDelta&&k.push(s(f-1,c)),t.execludedAreas){l=[];a=[];try{for(e=(o=void 0,__values(t.execludedAreas)),r=e.next();!r.done;r=e.next())v=r.value,l.push(s(f,v.toLowerCase())),t.isDayDelta&&a.push(s(f-1,v.toLowerCase()))}catch(rt){o={error:rt}}finally{try{r&&!r.done&&(p=e.return)&&p.call(e)}finally{if(o)throw o.error;}}d.push(l);g.push(a)}}catch(ut){h={error:ut}}finally{try{i&&!i.done&&(y=u.return)&&y.call(u)}finally{if(h)throw h.error;}}return nt=n.linq(this._dataSet.factors).first(function(n){return n.id==t.factorId}),tt=n.linq(this._dataSet.indicators).first(function(n){return n.id==t.indicatorId}),nt.compute.value(b,k,d,g,this._geo.areas[c],tt.compute)},t.prototype.getIndicatorValue=function(t){var f,c,a=this,e=(typeof t.areaOrId=="string"?t.areaOrId:t.areaOrId.id).toLowerCase(),v=n.linq(this._dataSet.indicators).first(function(n){return n.id==t.indicatorId}),u=function(n,t){return n<0?undefined:a._data.days[n].values[t]},y=u(t.dayNumber,e),l,o,s,r,i,h;if(t.isDayDelta&&(l=u(t.dayNumber-1,e)),t.execludedAreas){o=[];s=[];try{for(r=__values(t.execludedAreas),i=r.next();!i.done;i=r.next())h=i.value,o.push(u(t.dayNumber,h.toLowerCase())),t.isDayDelta&&s.push(u(t.dayNumber-1,h.toLowerCase()))}catch(p){f={error:p}}finally{try{i&&!i.done&&(c=r.return)&&c.call(r)}finally{if(f)throw f.error;}}}return v.compute.value(y,l,o,s,this._geo.areas[e])},t.prototype.getSerie=function(n){var f=[],i,r,t,u;if(n.groupSize>1)for(i=n.groupSize,r=[],t=0+n.startDay;t<this._data.days.length;t++)r.push(t),i--,i==0&&(u={x:n.xAxis=="date"?new Date(this._data.days[t].date):t,y:this.getFactorValue({dayNumberOrGroup:n.isDelta?r:t,areaOrId:n.areaId,factorId:n.factorId,indicatorId:n.indicatorId,execludedAreas:n.exeludedAreaIds,isDayDelta:n.isDelta})},f.push(u),i=n.groupSize,r=[]);else for(t=0+n.startDay;t<this._data.days.length;t++)u={x:n.xAxis=="date"?new Date(this._data.days[t].date):t,y:this.getFactorValue({dayNumberOrGroup:t,areaOrId:n.areaId,factorId:n.factorId,indicatorId:n.indicatorId,execludedAreas:n.exeludedAreaIds,isDayDelta:n.isDelta})},f.push(u);return f},t}();t.IndicatorCalculator=f})(t=n.GeoPlot||(n.GeoPlot={}))}(WebApp||(WebApp={})),function(n){var t;(function(n){var t,i;(function(n){n[n.SUm=0]="SUm";n[n.Avg=1]="Avg"})(t=n.AggregationFunc||(n.AggregationFunc={})),function(n){n[n.Country=0]="Country";n[n.State=1]="State";n[n.Region=2]="Region";n[n.District=3]="District"}(i=n.GeoAreaType||(n.GeoAreaType={}))})(t=n.GeoPlot||(n.GeoPlot={}))}(WebApp||(WebApp={})),function(n){var t;(function(t){t.InfectionDataSet={name:"COVID-19",indicators:[{id:"totalPositive",name:$string("$(total-positive)"),colorLight:"#f44336",colorDark:"#b71c1c",compute:new t.SimpleIndicatorFunction(function(n){return n.totalPositive})},{id:"currentPositive",name:$string("$(current-positive)"),validFor:["region","country"],colorLight:"#e91e63",colorDark:"#880e4f",compute:new t.SimpleIndicatorFunction(function(n){return n.currentPositive})},{id:"totalDeath",name:$string("$(death)"),validFor:["region","country"],colorLight:"#9c27b0",colorDark:"#4a148c",compute:new t.SimpleIndicatorFunction(function(n){return n.totalDeath})},{id:"totalSevere",name:$string("$(severe)"),validFor:["region","country"],colorLight:"#ff9800",colorDark:"#e65100",compute:new t.SimpleIndicatorFunction(function(n){return n.totalSevere})},{id:"totalHospedalized",name:$string("$(hospedalized)"),validFor:["region","country"],colorLight:"#fdd835",colorDark:"#fbc02d",compute:new t.SimpleIndicatorFunction(function(n){return n.totalHospedalized})},{id:"totalHealed",name:$string("$(healed)"),validFor:["region","country"],colorLight:"#4caf50",colorDark:"#1b5e20",compute:new t.SimpleIndicatorFunction(function(n){return n.totalHealed})},{id:"toatlTests",name:$string("$(tested)"),validFor:["region","country"],colorLight:"#03a9f4",colorDark:"#01579b",compute:new t.SimpleIndicatorFunction(function(n){return n.toatlTests})},{id:"surface",name:$string("$(surface) ($(geo))"),validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new t.ConstIndicatorFunction(function(t,i){return n.MathUtils.round(i.surface,0)})},{id:"density",name:$string("$(density) ($(geo))"),validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new t.ConstIndicatorFunction(function(t,i){return n.MathUtils.round(i.demography.total/i.surface,0)})},{id:"population",name:$string("$(population) ($(geo))"),validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new t.ConstIndicatorFunction(function(n,t){return t.demography.total})},{id:"populationOld",name:$string("$(population) +65 ($(geo))"),validFor:["region","district"],colorLight:"#777",colorDark:"#222",compute:new t.ConstIndicatorFunction(function(n,t){return t.demography.over65})},],factors:[{id:"none",name:$string("$(none)"),compute:new t.SimpleFactorFunction(function(n){return n}),format:function(n){return formatNumber(n)},reference:function(){return"N/A"},description:$string("[indicator]")},{id:"population",name:$string("$(population)"),compute:new t.SimpleFactorFunction(function(n,t,i){return n/i.demography.total*1e5}),format:function(n){return formatNumber(n)},reference:function(n,t){return formatNumber(t.demography.total)},description:$string("[indicator] $(every-100k)")},{id:"population",name:$string("$(population) +65"),compute:new t.SimpleFactorFunction(function(n,t,i){return n/i.demography.over65*1e5}),format:function(t){return formatNumber(n.MathUtils.round(t,1))},reference:function(n,t){return formatNumber(t.demography.over65)},description:$string("[indicator] $(every-100k) +65")},{id:"density",name:$string("$(density)"),compute:new t.SimpleFactorFunction(function(n,t,i){return n/(i.demography.total/i.surface)*1e5}),format:function(t){return formatNumber(n.MathUtils.round(t,1))},reference:function(t,i){return formatNumber(n.MathUtils.round(i.demography.total/i.surface,1))},description:$string("[indicator] $(over-density)")},{id:"totalPositive",name:$string("$(total-positive)"),validFor:["region","country"],compute:new t.DoubleFactorFunction(function(n,t){return n?n/t*100:0},new t.SimpleIndicatorFunction(function(n){return n.totalPositive})),format:function(t){return n.MathUtils.round(t,1)+"%"},reference:function(n){return n.totalPositive?formatNumber(n.totalPositive):"N/A"},description:$string("% [indicator] $(over-total-positive)")},{id:"severe",name:$string("$(severe)"),validFor:["region","country"],compute:new t.DoubleFactorFunction(function(n,t){return n?n/t*100:0},new t.SimpleIndicatorFunction(function(n){return n.totalSevere})),format:function(t){return n.MathUtils.round(t,1)+"%"},reference:function(n){return n.totalSevere?formatNumber(n.totalSevere):"N/A"},description:$string("% [indicator] $(over-severe)")},{id:"test",name:$string("$(tested)"),validFor:["region","country"],compute:new t.DoubleFactorFunction(function(n,t){return n?n/t*100:0},new t.SimpleIndicatorFunction(function(n){return n.toatlTests})),format:function(t){return n.MathUtils.round(t,1)+"%"},reference:function(n){return n.toatlTests?formatNumber(n.toatlTests):"N/A"},description:$string("% [indicator] $(over-tested)")}]}})(t=n.GeoPlot||(n.GeoPlot={}))}(WebApp||(WebApp={})),function(n){var t;(function(n){n.ViewModes={district:{label:{singular:$string("$(district)"),plural:$string("$(districts)")},mapGroup:"group_district",tab:"districtTab",areaType:n.GeoAreaType.District,validateId:function(n){return n[0].toLowerCase()=="d"}},region:{label:{singular:$string("$(region)"),plural:$string("$(regions)")},mapGroup:"group_region",tab:"regionTab",areaType:n.GeoAreaType.Region,validateId:function(n){return n[0].toLowerCase()=="r"}},country:{label:{singular:$string("$(italian)"),plural:$string("$(italians)")},mapGroup:"group_country",tab:"italyTab",areaType:n.GeoAreaType.Country,validateId:function(n){return n.toLowerCase()=="it"}}}})(t=n.GeoPlot||(n.GeoPlot={}))}(WebApp||(WebApp={})),function(n){var t;(function(t){var r=function(){function n(){this.value=ko.observable()}return n.prototype.select=function(){},n}(),i=function(){function n(){this.data=ko.observable();this.factor=ko.observable();this.indicator=ko.observable();this.reference=ko.observable();this.indicators=ko.observable()}return n.prototype.select=function(){},n}(),u=function(){function t(n,t){this.isVisible=ko.observable(!1);this.isTransparent=ko.observable(!1);this.value=n;this._closeAfter=t}return t.prototype.dontShowAgain=function(){},t.prototype.onActionExecuted=function(){},t.prototype.executeAction=function(){var n=this;this.value.showAction&&this.value.showAction();setTimeout(function(){return n.startPulse()});this.onActionExecuted()},t.prototype.startPulse=function(){var i,t;(this._element=document.querySelector(this.value.elementSelector),this._element)&&(i=n.DomUtils.centerElement(this._element),n.DomUtils.addClass(this._element,"pulse"),t=document.querySelector(".tip-container"),i<t.clientTop+t.clientHeight&&this.isTransparent(!0))},t.prototype.stopPulse=function(){this._element&&(n.DomUtils.removeClass(this._element,"pulse"),this.isTransparent(!1))},t.prototype.next=function(){},t.prototype.understood=function(){},t.prototype.onClose=function(){},t.prototype.close=function(){clearTimeout(this._closeTimeoutId);this.stopPulse();this.isVisible(!1);this.onClose()},t.prototype.show=function(){var n=this;this._closeTimeoutId&&clearTimeout(this._closeTimeoutId);this.isVisible(!0);this._closeAfter&&(this._closeTimeoutId=setTimeout(function(){return n.close()},this._closeAfter))},t}(),f=function(){function f(i){var r=this,u,s,f,e,o,h;for(this._topAreasVisible=!1,this._execludedArea=new Map,this._dataSet=t.InfectionDataSet,this._keepState=!1,this._debugMode=!1,this._tips={areaSelected:{order:0,featureName:"Zone",html:"Puoi vedere i dati relativi ad una particolare area selezionadoli sulla mappa.",elementSelector:".card-map .center-align",showAfter:3,showAction:function(){r.viewMode("region");r.selectedArea=r._geo.areas.r10}},indicatorSelected:{order:1,featureName:"Indicatori",html:"Puoi vedere il grafico associato all'indicatore, facendo click sull'indicatore.",elementSelector:".indicators .summary-field",showAfter:15,showAction:function(){r.currentArea()||r._tips.areaSelected.showAction();r.selectedIndicator(n.linq(r._dataSet.indicators).first(function(n){return n.id=="totalDeath"}))}},dayChanged:{order:2,featureName:"Cronologia",html:"Puoi vedere gli indicatori dei giorni precedenti muovendo la slide.",elementSelector:".day input[type=range]",showAfter:20,showAction:function(){r.dayNumber(5)}},indicatorChanged:{order:3,featureName:"Indicatori",html:"Puoi cambiare l'indicatore scegliendolo dal filtro nell'elenco.",elementSelector:".filter-indicator",showAfter:0},viewChanged:{order:4,featureName:"Zone",html:"Puoi vedere gli indicatori a livello regionale, nazionale o provinciale.",elementSelector:"#areaTabs",showAfter:0,showAction:function(){r.viewMode("district")}},topAreasOpened:{order:5,featureName:"Zone",html:"Puo vedere le zone più colpite di un qualsiasi indicatore scelto.",elementSelector:"#topCases .card-title",showAfter:20,showAction:function(){r.viewMode()=="country"&&r.viewMode("region");M.Collapsible.getInstance(document.getElementById("topCases")).open(0)}},deltaSelected:{order:5.5,featureName:"Indicatori",html:"Puoi vedere l'incremento giornaliero dell'indicatore anzichè il valore totale.",elementSelector:".day-delta",showAfter:20,showAction:function(){r.currentArea()||r._tips.areaSelected.showAction();r.isDayDelta(!0)}},factorChanged:{order:6,featureName:"Indicatori",html:"Puoi mettere in relazione qualsiasi indicatore a numerosi parametri (es. % Positivi su Tamponi).",elementSelector:".filter-factor",showAfter:30,showAction:function(){r.currentArea()||r._tips.areaSelected.showAction();r.selectedIndicator(n.linq(r._dataSet.indicators).first(function(n){return n.id=="totalPositive"}));r.selectedFactor(n.linq(r._dataSet.factors).first(function(n){return n.id=="population"}))}},groupChanged:{order:7,featureName:"Grafico",html:"Puo raggruppare i dati del grafico in gruppi da 1 a 7 giorni. Puoi anche scegliere la data d'inizio.",elementSelector:".row-chart-group .select-wrapper",showAfter:30,showAction:function(){r.currentArea()||r._tips.areaSelected.showAction();var n=document.querySelector(".chart-options");n.classList.contains("closed")&&n.classList.remove("closed");r.groupSize(2);M.FormSelect.init(document.querySelectorAll(".row-chart-group select"))}},chartActionExecuted:{order:8,featureName:"Grafico",html:"Puoi portare il grafico a schermo interno, copiarlo, o copiare la serie numerico e incollarla in excel.",elementSelector:".chart .actions",showAfter:30},scaleChanged:{order:9,featureName:"Grafico",html:"Puoi cambiare da scala logaritmica a scala lineare.",elementSelector:".log-scale",showAfter:210,showAction:function(){r.isLogScale(!0)}},maxFactorChanged:{order:10,featureName:"Mappa",html:"Puoi cambiare il riferimento rispetto al quale la mappa viene colorata. Normalmente è in base al valore massimo che si ha avuto globalmente.",elementSelector:".max-factor",showAfter:60,showAction:function(){r.currentArea()||r._tips.areaSelected.showAction();r.selectedIndicator(n.linq(r._dataSet.indicators).first(function(n){return n.id=="totalPositive"}));r.autoMaxFactor(!1);r.maxFactor(1e3)}},regionExcluded:{order:11,featureName:"Mappa",html:"Nella vista nazionale puoi escludere dagli indicatori il valore di una o più regioni cliccando sulla mappa.",elementSelector:".card-map .center-align",showAfter:0,showAction:function(){r.viewMode()!="country"&&r.viewMode("country");r._execludedArea.set("R8",r._geo.areas.r8);r.updateIndicator()}}},this._specialDates={current:{date:undefined,color:"#000",width:.5,label:"Giorno corrente"},dpcm8:{date:new Date(2020,2,7),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 8 Marzo (italia zona rossa)"},dpcm9:{date:new Date(2020,2,9),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 9 Marzo (italia zona rossa)"},dpcm11:{date:new Date(2020,2,11),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 11 Marzo (chiusura attività)"},mds20:{date:new Date(2020,2,20),color:"#070",dash:[5,5],width:1,visible:!1,label:"MDS 20 Marzo (chiura parchi, motoria nelle vicinane)"},dpcm22:{date:new Date(2020,2,21),color:"#000",dash:[5,5],width:1,visible:!0,label:"DPCM 22 Marzo (chiusura ulteriore attività)"}},this.dayNumber=ko.observable(0),this.totalDays=ko.observable(0),this.currentData=ko.observable(),this.currentArea=ko.observable(),this.topAreas=ko.observable(),this.viewMode=ko.observable("district"),this.selectedIndicator=ko.observable(),this.selectedFactor=ko.observable(),this.autoMaxFactor=ko.observable(!0),this.maxFactor=ko.observable(),this.isPlaying=ko.observable(!1),this.isLogScale=ko.observable(!1),this.isDayDelta=ko.observable(!1),this.isZoomChart=ko.observable(!1),this.isShowEnvData=ko.observable(!1),this.groupSize=ko.observable(1),this.startDay=ko.observable(0),this.isNoFactorSelected=ko.computed(function(){return r.selectedFactor()&&r.selectedFactor().id=="none"}),this.groupDays=[1,2,3,4,5,6,7],this.tip=ko.observable(),this.factorDescription=ko.observable(),this._data=i.data,this._geo=i.geo,this._debugMode=i.debugMode,this._calculator=new t.IndicatorCalculator(this._data,this._dataSet,this._geo),this.totalDays(this._data.days.length-1),this.dayNumber.subscribe(function(n){n!=r._data.days.length-1&&r.markAction("dayChanged");r.updateDayData();r._specialDates.current.date=new Date(r._data.days[n].date);r.updateChart()}),this._mapSvg=document.getElementsByTagName("svg").item(0),this._mapSvg.addEventListener("click",function(n){return r.onMapClick(n)}),this.days=[],u=0;u<this._data.days.length;u++)this.days.push({number:u,value:new Date(this._data.days[u].date),text:n.DateUtils.format(this._data.days[u].date,$string("$(date-format-short)"))});s=M.Tabs.init(document.getElementById("areaTabs"));s.options.onShow=function(n){r.setViewMode(n.dataset.viewMode)};f=M.Collapsible.init(document.getElementById("topCases"));f.options.onOpenStart=function(){r._daysData||r.updateTopAreas();r._topAreasVisible=!0;r.markAction("topAreasOpened")};f.options.onCloseEnd=function(){r._topAreasVisible=!1};this.indicators=ko.computed(function(){return n.linq(r._dataSet.indicators).where(function(n){return!n.validFor||n.validFor.indexOf(r.viewMode())!=-1}).toArray()});this.factors=ko.computed(function(){return n.linq(r._dataSet.factors).where(function(n){return!n.validFor||n.validFor.indexOf(r.viewMode())!=-1}).toArray()});this.selectedIndicator.subscribe(function(n){n&&(r.updateIndicator(),n.id!="totalPositive"&&r.markAction("indicatorChanged"))});this.selectedFactor.subscribe(function(n){n&&(r.updateIndicator(),n.id!="none"&&r.markAction("factorChanged"),setTimeout(function(){return M.FormSelect.init(document.querySelectorAll(".row-chart-group select"))}))});this.autoMaxFactor.subscribe(function(n){n&&(r.updateMaxFactor(),r.updateMap());r.updateUrl()});this.maxFactor.subscribe(function(){r.autoMaxFactor()||(r.updateMap(),r.markAction("maxFactorChanged"));r.updateUrl()});this.isDayDelta.subscribe(function(n){r.computeStartDayForGroup();r.updateIndicator();n&&r.markAction("deltaSelected")});this.isLogScale.subscribe(function(n){r.updateChart();r.updateUrl();n&&r.markAction("scaleChanged")});this.isZoomChart.subscribe(function(){r.updateChart()});this.groupSize.subscribe(function(n){r.computeStartDayForGroup();r.updateChart();r.updateUrl();n>1&&r.markAction("groupChanged")});this.startDay.subscribe(function(){r.updateChart();r.updateUrl()});e=new URLSearchParams(window.location.search);o=e.get("state");this._keepState=e.get("keepState")=="true";this.loadPreferences();this.engageUser();h=o&&this._keepState?JSON.parse(atob(o)):{};setTimeout(function(){return r.loadState(h)},0);this._debugMode||window.addEventListener("beforeunload",function(){return r.savePreferences()})}return f.prototype.markAction=function(n,t){(this._preferences.actions[n]++,this.savePreferences(),window.ga)&&ga("send","event",{eventCategory:"GeoPlot",eventAction:n,eventValue:this._preferences.actions[n],eventLabel:t})},f.prototype.markTip=function(n,t){window.ga&&ga("send","event",{eventCategory:"GeoPlot/Tip",eventAction:t,eventLabel:n})},f.prototype.engageUser=function(){var i=this,t;(this._preferences.showTips==undefined||this._preferences.showTips)&&(t=n.linq(this._tips).where(function(n){return n.value.showAfter>0&&i._preferences.actions[n.key]==0}).first(),this.showTip(t.key,{onClose:function(){return i.engageUser()},timeout:t.value.showAfter})||this.engageUser())},f.prototype.showTip=function(t,i){var r=this,e,f,o;return this._preferences.showTips!=undefined&&!this._preferences.showTips?!1:(!i||!i.override)&&this.tip()&&this.tip().isVisible()?!1:(!i||!i.force)&&this._preferences.actions[t]?!1:(e=this._tips[t],f=new u(e),f.onActionExecuted=function(){r.markTip(t,"how")},f.dontShowAgain=function(){r._preferences.showTips=!1;r.savePreferences();f.close();r.markTip(t,"dontShowAgain")},f.understood=function(){r._preferences.actions[t]++;r.savePreferences();f.close();r.markTip(t,"understood")},f.onClose=function(){i&&i.onClose&&i.onClose()},o=n.linq(this._tips).where(function(n){return n.value.order>e.order&&r._preferences.actions[n.key]==0}).first(),f.next=o?function(){f.close();r._preferences.actions[t]++;r.showTip(o.key);r.markTip(t,"next")}:null,this.tip(f),setTimeout(function(){return f.show()},i&&i.timeout?i.timeout*1e3:0),!0)},f.prototype.isDefaultState=function(n){return(!n.day||n.day==this._data.days.length-1)&&(!n.view||n.view=="region")&&!n.area&&(!n.indicator||n.indicator=="totalPositive")&&(!n.factor||n.factor=="none")&&!n.maxFactor&&!n.dayDelta&&!n.logScale&&!n.showEnvData&&(!n.groupSize||n.groupSize==1)&&(n.startDay==undefined||n.startDay==0)&&!n.excludedArea},f.prototype.loadState=function(i){var f,o,s,u,r,e;if(i.view||(i.view="region"),s=M.Tabs.getInstance(document.getElementById("areaTabs")),s.select(t.ViewModes[i.view].tab),document.body.scrollTop=0,i.logScale!=undefined&&this.isLogScale(i.logScale),i.groupSize&&this.groupSize(i.groupSize),i.startDay!=undefined&&this.startDay(i.startDay),i.dayDelta!=undefined&&this.isDayDelta(i.dayDelta),i.showEnvData!=undefined&&this.isShowEnvData(i.showEnvData),i.maxFactor&&(this.autoMaxFactor(!1),this.maxFactor(i.maxFactor)),this.dayNumber(i.day!=undefined?i.day:this._data.days.length-1),i.excludedArea){this._execludedArea.clear();try{for(u=__values(i.excludedArea),r=u.next();!r.done;r=u.next())e=r.value,this._execludedArea.set(e,this._geo.areas[e.toLowerCase()])}catch(h){f={error:h}}finally{try{r&&!r.done&&(o=u.return)&&o.call(u)}finally{if(f)throw f.error;}}}i.indicator&&this.selectedIndicator(n.linq(this._dataSet.indicators).first(function(n){return n.id==i.indicator}));i.factor&&this.selectedFactor(n.linq(this._dataSet.factors).first(function(n){return n.id==i.factor}));i.area&&(this.selectedArea=this._geo.areas[i.area.toLowerCase()])},f.prototype.saveStata=function(){return{view:this.viewMode()=="region"?undefined:this.viewMode(),indicator:this.selectedIndicator()?this.selectedIndicator().id:undefined,factor:this.selectedFactor()?this.selectedFactor().id:undefined,dayDelta:this.isDayDelta()?!0:undefined,maxFactor:this.autoMaxFactor()?undefined:this.maxFactor(),day:this.dayNumber()==this._data.days.length-1?undefined:this.dayNumber(),area:this.selectedArea?this.selectedArea.id:undefined,groupSize:this.groupSize()==1?undefined:this.groupSize(),startDay:this.startDay()==0?undefined:this.startDay(),logScale:this.isLogScale()?!0:undefined,excludedArea:this._execludedArea.size>0?n.linq(this._execludedArea.keys()).toArray():undefined,showEnvData:this.isShowEnvData()?!0:undefined}},f.prototype.loadPreferences=function(){var n=localStorage.getItem("preferences");if(n){try{this._preferences=JSON.parse(n)}catch(t){}this._preferences&&this._preferences.version==1||(this._preferences=this.getDefaultPreferences(),this._preferences.isFirstView=!1,this._preferences.showTips=!1,this.savePreferences())}else this._preferences=this.getDefaultPreferences()},f.prototype.getDefaultPreferences=function(){return{isFirstView:!0,showTips:!0,version:1,actions:{areaSelected:0,indicatorSelected:0,indicatorChanged:0,dayChanged:0,viewChanged:0,chartActionExecuted:0,factorChanged:0,groupChanged:0,maxFactorChanged:0,scaleChanged:0,topAreasOpened:0,deltaSelected:0,regionExcluded:0}}},f.prototype.savePreferences=function(){this._preferences.isFirstView=!1;localStorage.setItem("preferences",JSON.stringify(this._preferences))},f.prototype.toggleChartZoom=function(){this._preferences.actions.chartActionExecuted++;this.isZoomChart(!this.isZoomChart())},f.prototype.copyMap=function(){return __awaiter(this,void 0,void 0,function(){var n,u,r,t,i;return __generator(this,function(){return n=document.querySelector("svg.map"),u=n.outerHTML,r=new Blob([u],{type:"image/svg+xml"}),navigator.clipboard&&navigator.clipboard.write?(t=document.createElement("img"),t.style.width=n.clientWidth+"px",t.style.height=n.clientHeight+"px",t.onload=function(){var u=this,i=document.createElement("canvas"),r;i.width=n.clientWidth;i.height=n.clientHeight;r=i.getContext("2d");r.fillStyle="white";r.fillRect(0,0,i.width,i.height);r.drawImage(t,0,0);i.toBlob(function(n){return __awaiter(u,void 0,void 0,function(){var i,t;return __generator(this,function(r){switch(r.label){case 0:return i=new ClipboardItem((t={},t[n.type]=n,t)),[4,navigator.clipboard.write([i])];case 1:return r.sent(),M.toast({html:$string("$(msg-map-copied)")}),[2]}})})})},t.src=window.URL.createObjectURL(r)):(i=document.createElement("a"),i.href=window.URL.createObjectURL(r),i.target="_blan",i.download="map.svg",i.click(),M.toast({html:$string("$(msg-no-copy)")})),[2]})})},f.prototype.copyChart=function(){var n=this;this._chart.canvas.toBlob(function(t){return __awaiter(n,void 0,void 0,function(){var r,u,n,i;return __generator(this,function(f){switch(f.label){case 0:return(navigator.clipboard&&navigator.clipboard.write)?(r=new ClipboardItem((i={},i[t.type]=t,i)),[4,navigator.clipboard.write([r])]):[3,2];case 1:return f.sent(),M.toast({html:$string("$(msg-chart-copied)")}),[3,3];case 2:u=window.URL.createObjectURL(t);n=document.createElement("a");n.href=u;n.target="_blan";n.download=this._chart.options.title.text+".png";n.click();M.toast({html:$string("$(msg-no-copy)")});f.label=3;case 3:return[2]}})})});this.markAction("chartActionExecuted","copy")},f.prototype.copySerie=function(){return __awaiter(this,void 0,void 0,function(){var i,r,t;return __generator(this,function(){for(i=this._chart.data.datasets[0].data,r="",t=0;t<i.length;t++)r+=n.DateUtils.format(i[t].x,$string("$(date-format)"))+"\t"+t+"\t"+n.MathUtils.round(i[t].y,1)+"\n";return n.DomUtils.copyText(r),M.toast({html:$string("$(msg-serie-copied)")}),this.markAction("chartActionExecuted","copySerie"),[2]})})},f.prototype.copySerieForStudio=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(){return t={type:"serie",version:1,color:this.selectedIndicator().colorLight,serie:{areaId:this.selectedArea.id,indicatorId:this.selectedIndicator().id,xAxis:"dayNumber",startDay:this.startDay(),exeludedAreaIds:n.linq(this._execludedArea.keys()).toArray(),factorId:this.selectedFactor().id,groupSize:this.groupSize(),isDelta:this.isDayDelta()},title:this.factorDescription()},t.values=this._calculator.getSerie(t.serie),n.DomUtils.copyText(JSON.stringify(t)),M.toast({html:$string("$(msg-serie-copied)")}),this.markAction("chartActionExecuted","copySerieForStudio"),[2]})})},f.prototype.play=function(){this.dayNumber()==this._data.days.length-1&&this.dayNumber(0);this.isPlaying(!0);this.nextFrame()},f.prototype.pause=function(){this.isPlaying(!1)},f.prototype.setViewMode=function(n){n!="region"&&this.markAction("viewChanged");this.viewMode(n);var t=document.getElementById("group_district");n=="district"?t.style.removeProperty("display"):t.style.display="none";this.selectedArea=null;this._chart=null;this._execludedArea.clear();this.clearMap();this.updateMaxFactor();this.updateDayData();this.viewMode()=="country"?(this.selectedArea=this._geo.areas.it,this.showTip("regionExcluded",{timeout:5})):this._topAreasVisible?this.updateTopAreas():this._daysData=undefined;setTimeout(function(){return M.FormSelect.init(document.querySelectorAll(".row-indicator select"))})},Object.defineProperty(f.prototype,"selectedArea",{get:function(){return this._selectedArea},set:function(n){var t,i;n!=this._selectedArea&&(this._selectedArea&&(t=document.getElementById(this._selectedArea.id.toUpperCase()),t&&t.classList.remove("selected")),this._selectedArea=n,this._selectedArea&&(t=document.getElementById(this._selectedArea.id.toUpperCase()),t&&(t.classList.add("selected"),i=t.parentElement,t.remove(),i.appendChild(t))),this.changeArea())},enumerable:!0,configurable:!0}),f.prototype.getFactorValue=function(t,i){return this._calculator.getFactorValue({dayNumberOrGroup:t,areaOrId:i,factorId:this.selectedFactor().id,indicatorId:this.selectedIndicator().id,isDayDelta:this.isDayDelta(),execludedAreas:n.linq(this._execludedArea.keys()).toArray()})},f.prototype.getIndicatorValue=function(t,i,r){return this._calculator.getIndicatorValue({dayNumber:t,areaOrId:i,indicatorId:r,isDayDelta:this.isDayDelta(),execludedAreas:n.linq(this._execludedArea.keys()).toArray()})},f.prototype.computeStartDayForGroup=function(){var i=this.days.length-this.startDay(),n=i%this.groupSize(),t;n!=0&&(t=this.groupSize()-n,this.startDay()-t>=0?this.startDay(this.startDay()-t):this.startDay()+n<this.days.length-1&&this.startDay(this.startDay()+n),M.FormSelect.init(document.querySelectorAll(".row-chart-group select")))},f.prototype.onMapClick=function(n){var r=n.target,t=r.parentElement.id,i=this._geo.areas[t.toLowerCase()];i&&(this.viewMode()=="country"?(this._execludedArea.has(t)?this._execludedArea.delete(t):(this._execludedArea.set(t,i),M.toast({html:$string("$(msg-region-ex)").replace("[region]",i.name)})),this.updateIndicator()):r.parentElement.classList.contains(this.viewMode())&&(this.selectedArea=i),this.markAction("areaSelected"))},f.prototype.nextFrame=function(){var n=this;this.isPlaying()&&(this.dayNumber()>=this._data.days.length-1?this.pause():this.dayNumber(parseInt(this.dayNumber().toString())+1),setTimeout(function(){return n.nextFrame()},1e3))},f.prototype.changeArea=function(){if(this._selectedArea==null)this.currentArea(null);else{var t=!this.currentArea(),n=new i;n.value=this._selectedArea;this.updateArea(n);this.currentArea(n);this.updateFactorDescription();this.updateAreaIndicators();this.updateChart();t&&(M.FormSelect.init(document.querySelectorAll(".row-chart-group select")),M.Tooltip.init(document.querySelectorAll(".row-chart-group .tooltipped")))}this.updateUrl()},f.prototype.updateAreaIndicators=function(){var f,h,e,c,l=this,o,a,i,n,v,y,u,t,s;if(this.currentArea()){if(!this.currentArea().indicators()){o=[];a=function(n){var t=new r;t.indicator=n;t.select=function(){l.markAction("indicatorSelected");l.selectedIndicator(n);setTimeout(function(){return M.FormSelect.init(document.querySelectorAll(".row-indicator select"))})};o.push(t)};try{for(i=__values(this.indicators()),n=i.next();!n.done;n=i.next())v=n.value,a(v)}catch(p){f={error:p}}finally{try{n&&!n.done&&(h=i.return)&&h.call(i)}finally{if(f)throw f.error;}}this.currentArea().indicators(o)}y=this.currentArea().value.id.toLowerCase();try{for(u=__values(this.currentArea().indicators()),t=u.next();!t.done;t=u.next())s=t.value,s.value(this.getIndicatorValue(this.dayNumber(),y,s.indicator.id))}catch(w){e={error:w}}finally{try{t&&!t.done&&(c=u.return)&&c.call(u)}finally{if(e)throw e.error;}}}},f.prototype.updateFactorDescription=function(){var r,f,n="",u,i,t,e;if(this.isDayDelta()&&(n="Nuovi "),n+=this.selectedFactor().description.replace("[indicator]",this.selectedIndicator().name),this.currentArea()&&(n+=" - "+this.currentArea().value.name),this._execludedArea.size>0){n+=" - Escluso (";u=0;try{for(i=__values(this._execludedArea.keys()),t=i.next();!t.done;t=i.next())e=t.value,u>0&&(n+=", "),n+=this._execludedArea.get(e).name,u++}catch(o){r={error:o}}finally{try{t&&!t.done&&(f=i.return)&&f.call(i)}finally{if(r)throw r.error;}}n+=")"}this.factorDescription(n)},f.prototype.updateIndicator=function(){this.selectedIndicator()&&this.selectedFactor()&&(this.updateFactorDescription(),this.updateMaxFactor(),this.updateDayData(),this.updateChart(),this.updateUrl(),this._topAreasVisible&&this.updateTopAreas())},f.prototype.updateMaxFactor=function(){var i,f,n,e,u,r;if(this.selectedFactor()&&this.selectedIndicator()&&this.autoMaxFactor()){for(i=Number.NEGATIVE_INFINITY,f=t.ViewModes[this.viewMode()],n=0;n<this._data.days.length;n++){e=this._data.days[n];for(u in e.values)f.validateId(u)&&(r=this.getFactorValue(n,u),r>i&&r!=Number.POSITIVE_INFINITY&&(i=r))}this.maxFactor(parseFloat(i.toFixed(1)))}},f.prototype.initChart=function(){var t=this,i=document.querySelector("#areaGraph"),r={afterDraw:function(n){var f=n.data.datasets[0].data,e,i,o,r,u;if(f&&f.length!=0){e=n.scales["x-axis-0"];i=n.ctx;for(o in t._specialDates)(r=t._specialDates[o],r.date&&r.visible!==!1)&&(u=e.getPixelForValue({x:r.date}),i.lineWidth=r.width||1,i.beginPath(),i.moveTo(u,n.chartArea.top),i.lineTo(u,n.chartArea.bottom),i.strokeStyle=r.color||"#000",r.dash?i.setLineDash(r.dash):i.setLineDash([]),r.dashOffset&&(i.lineDashOffset=r.dashOffset),i.stroke())}}};this._chart=new Chart(i,{plugins:[r],type:"line",data:{datasets:[{lineTension:0,data:[],borderWidth:1}]},options:{maintainAspectRatio:!1,legend:{display:!0,position:"bottom"},title:{display:!1},tooltips:{callbacks:{label:function(t){return t.xLabel+": "+n.MathUtils.round(parseFloat(t.value),1)}}},scales:{xAxes:[{type:"time",distribution:"linear",time:{unit:"day",tooltipFormat:"DD/MMM"}}]}}})},f.prototype.updateChart=function(){if(this.selectedIndicator()&&this.currentArea()&&this.selectedFactor()){this._chart==null&&this.initChart();var t=this.currentArea().value,i=t.id.toLowerCase(),r=this.selectedIndicator().id;this._chart.data.datasets[0].label=this.factorDescription();this._chart.options.title.text=this._chart.data.datasets[0].label;this._chart.options.scales.yAxes[0].type=this.isLogScale()?"logarithmic":"linear";this._chart.data.datasets[0].borderColor=this.selectedIndicator().colorDark;this._chart.data.datasets[0].backgroundColor=this.selectedIndicator().colorLight;this._chart.data.datasets[0].data=this._calculator.getSerie({areaId:t.id,indicatorId:this.selectedIndicator().id,xAxis:"date",startDay:this.startDay(),exeludedAreaIds:n.linq(this._execludedArea.keys()).toArray(),factorId:this.selectedFactor().id,groupSize:this.groupSize(),isDelta:this.isDayDelta()});this._chart.update()}},f.prototype.updateArea=function(t,i){if(t&&this.selectedIndicator()&&this.selectedFactor()){i==undefined&&(i=this.dayNumber());var r=t.value.id.toLowerCase(),f=t.value,u=this._data.days[i];if(!u||!u.values[r]){M.toast({html:$string("$msg-no-data)")});return}t.data(u.values[r]);t.indicator(this.getIndicatorValue(i,r,this.selectedIndicator().id));t.factor(n.MathUtils.round(this.getFactorValue(i,f),1));t.reference(this.selectedFactor().reference(u.values[r],f))}},f.prototype.updateTopAreas=function(){var r=this,e,u,f;for(this._daysData=[],e=function(f){var o=u._data.days[f],e={},s=t.ViewModes[u.viewMode()].validateId;e.topAreas=n.linq(o.values).select(function(n){return{factor:r.getFactorValue(f,n.key),value:n}}).orderByDesc(function(n){return n.factor}).where(function(n){return s(n.value.key)}).select(function(n){var t=new i;return t.value=r._geo.areas[n.value.key.toLowerCase()],t.select=function(){return r.selectedArea=t.value},r.updateArea(t,f),t}).take(25).toArray();u._daysData.push(e)},u=this,f=0;f<this._data.days.length;f++)e(f);this.topAreas(this._daysData[this.dayNumber()].topAreas)},f.prototype.updateDayData=function(){var t=this._data.days[this.dayNumber()];this.currentData(n.DateUtils.format(t.date,$string("$(date-format)")));this.updateMap();this.updateArea(this.currentArea());this.updateAreaIndicators();this._daysData&&this._topAreasVisible&&this.topAreas(this._daysData[this.dayNumber()].topAreas);this.updateUrl()},f.prototype.updateUrl=function(){if(this._keepState){var t=this.saveStata(),i=n.app.baseUrl+"Overview";this.isDefaultState(t)||(i+="?state="+encodeURIComponent(btoa(JSON.stringify(t)))+"&keepState=true");history.replaceState(null,null,i)}},f.prototype.clearMap=function(){var i=this._data.days[this.dayNumber()],t,n;for(t in i.values)n=document.getElementById(t.toUpperCase()),n&&(n.style.fillOpacity="1",n.style.removeProperty("fill"))},f.prototype.updateMap=function(){var s=this,e,o,u,i,f,r,h;if(this.selectedIndicator()&&this.selectedFactor())if(this.viewMode()!="country"){e=this._data.days[this.dayNumber()];o=new t.LinearGradient("#fff",this.selectedIndicator().colorDark);for(u in e.values)if(i=document.getElementById(u.toUpperCase()),i){if(f=this._geo.areas[u],f.type!=t.ViewModes[this.viewMode()].areaType)continue;r=this.getFactorValue(this.dayNumber(),f);r==Number.POSITIVE_INFINITY&&(r=NaN);r=Math.min(1,r/this.maxFactor());isNaN(r)?(i.classList.contains("valid")&&i.classList.remove("valid"),i.style.fillOpacity="1",i.style.removeProperty("fill")):(i.classList.contains("valid")||i.classList.add("valid"),h=n.MathUtils.discretize(n.MathUtils.exponential(r),20),i.style.fill=o.valueAt(r).toString())}}else n.linq(document.querySelectorAll("g.region")).foreach(function(n){n.style.fill=s._execludedArea.has(n.id)?"#444":"#FFF"})},f}();t.GeoPlotPage=f})(t=n.GeoPlot||(n.GeoPlot={}))}(WebApp||(WebApp={})),function(n){var t;(function(t){function u(n){return n==null||n==undefined?undefined:n.toString()}var f=function(){function n(n){this.min=ko.observable();this.max=ko.observable();this.step=ko.observable();this.isSelected=ko.observable(!0);this.value=n.value;this.name=n.name}return n}(),l=function(){function t(){this.vars={}}return t.prototype.setExpressions=function(t){var y,nt,p,tt,a,it,w,rt,i=this.calculator.getState(),ft=function(t){var f,o,s=n.linq(i.expressions.list).first(function(n){return n.id==t.id}),u,r,e;if(s)try{for(u=(f=void 0,__values(Object.getOwnPropertyNames(t))),r=u.next();!r.done;r=u.next())e=r.value,s[e]=t[e]}catch(h){f={error:h}}finally{try{r&&!r.done&&(o=u.return)&&o.call(u)}finally{if(f)throw f.error;}}else i.expressions.list.push(t)},o,r,ut,b,s,h,u,k,d,c,f,g,l,e,v;try{for(o=__values(t),r=o.next();!r.done;r=o.next())ut=r.value,ft(ut)}catch(et){y={error:et}}finally{try{r&&!r.done&&(nt=o.return)&&nt.call(o)}finally{if(y)throw y.error;}}b=n.linq(i.expressions.list).where(function(n){return n.type!="folder"}).groupBy(function(n){return n.folderId?n.folderId:""}).toDictionary(function(n){return n.key},function(n){return n.values.toArray()});s=[];try{for(h=__values(n.linq(i.expressions.list).where(function(n){return n.type=="folder"})),u=h.next();!u.done;u=h.next())if(k=u.value,s.push(k),d=b[k.id],d)try{for(c=(a=void 0,__values(d)),f=c.next();!f.done;f=c.next())v=f.value,s.push(v)}catch(ot){a={error:ot}}finally{try{f&&!f.done&&(it=c.return)&&it.call(c)}finally{if(a)throw a.error;}}}catch(st){p={error:st}}finally{try{u&&!u.done&&(tt=h.return)&&tt.call(h)}finally{if(p)throw p.error;}}if(g=b[""],g)try{for(l=__values(g),e=l.next();!e.done;e=l.next())v=e.value,s.push(v)}catch(ht){w={error:ht}}finally{try{e&&!e.done&&(rt=l.return)&&rt.call(l)}finally{if(w)throw w.error;}}i.expressions.list=s;this.calculator.setState(i)},t.prototype.setColor=function(n,t){this.calculator.controller.dispatch({type:"set-item-color",id:n,color:t})},t.prototype.updateTable=function(t,i){var r=n.linq(this.calculator.getExpressions()).where(function(n){return n.id==t}).first();r&&(r.columns[0].values=n.linq(i).select(function(n){return n.x.toString()}).toArray(),r.columns[1].values=n.linq(i).select(function(n){return n.y.toString()}).toArray(),this.calculator.setExpression(r))},t.prototype.updateExpression=function(t){var i=n.linq(this.calculator.getExpressions()).where(function(n){return n.id==t.id}).first();this.calculator.setExpression(t)},t.prototype.updateVariable=function(n,t,i){t&&this.updateExpression({id:n,latex:t+"="+i.toString()})},t.prototype.expressionZoomFit=function(n){this.calculator.controller.dispatch({type:"expression-zoom-fit",id:n})},t.prototype.setItemVisibile=function(n,t){this.updateExpression({id:n,hidden:!t})},t.prototype.generateVars=function(n){for(var t in n)n[t]||(n[t]=this.generateVar(t))},t.prototype.generateVar=function(n){return n===void 0&&(n="a"),this.vars[n[0]]||(this.vars[n[0]]=0),this.vars[n[0]]++,n[0]+"_{"+this.vars[n[0]]+"}"},t}(),e=function(){function t(){this.canDrag=!1;this.name=ko.observable();this.time=ko.observable(0);this.color=ko.observable();this.parameters=ko.observableArray()}return t.prototype.createActions=function(t){var r=this;t.push(n.apply(new i,function(n){n.text=$string("$(delete)");n.icon="delete";n.execute=function(){return r.remove()}}))},t.prototype.canAccept=function(){return!1},t.prototype.canReadData=function(){return!1},t.prototype.readData=function(){},t.prototype.writeData=function(){return!1},t.prototype.setState=function(n){n.name&&this.name(n.name);n.visible!=undefined&&this.node.isVisible(n.visible);n.color&&this.color(n.color);n.opened!=undefined&&this.node.isExpanded(n.opened);n.folderId&&(this.folderId=n.folderId);this.setStateWork(n);this.updateGraph();this.setChildrenStateWork(n)},t.prototype.getState=function(){return{name:this.name(),visible:this.node.isVisible(),folderId:this.folderId,color:this.color(),opened:this.node.isExpanded()}},t.prototype.getVar=function(n){return this._varsMap[n]},t.prototype.remove=function(n){n===void 0&&(n=!0);this._graphCtx&&(this._graphCtx.calculator.removeExpression({id:this.getGraphId("private")}),this._graphCtx.calculator.removeExpression({id:this.getGraphId("public")}));this.node.remove();n&&this.children.foreach(function(n){return n.remove()})},t.prototype.attachNode=function(n){var i=this,t;this.node=n;this.node.isVisible.subscribe(function(){return i.updateGraphVisibility()});this.node.isSelected.subscribe(function(n){n&&i.onSelected()});t=[];this.createActions(t);this.node.actions(t)},t.prototype.attachGraph=function(n){var t=this;this._graphCtx=n;this._graphCtx.calculator.observe("expressionAnalysis",function(){return t.onGraphChanged()});this.color.subscribe(function(){return t.updateColor()})},t.prototype.isFullVisible=function(){for(var n=this.node;n;){if(!n.isVisible())return!1;n=n.parentNode}return!0},t.prototype.updateGraphVisibility=function(n){n===void 0&&(n=!0);var t=this.isFullVisible();return this._graphCtx.setItemVisibile(this.getGraphId("public"),t),this._graphCtx.setItemVisibile(this.getGraphId("private"),t),n&&this.children.foreach(function(n){return n.updateGraphVisibility()}),t},t.prototype.updateGraph=function(t){if(t===void 0&&(t=!0),this._graphCtx){this.folderId||(this.folderId=n.StringUtils.uuidv4());var i=this.getExpressions();this._graphCtx.setExpressions(i);this.updateGraphWork();this.updateGraphVisibility();this.updateParameters();t&&this.children.foreach(function(n){return n.updateGraph(t)})}},t.prototype.onParentChanged=function(){this.updateGraphVisibility()},Object.defineProperty(t.prototype,"parent",{get:function(){return this.node.parentNode.value()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"children",{get:function(){return n.linq(this.node.nodes()).select(function(n){return n.value()})},enumerable:!0,configurable:!0}),t.prototype.replaceVars=function(n){var t,i;for(t in this._varsMap)i=new RegExp("\\$"+t,"g"),n=n.replace(i,this._varsMap[t]);return n},t.prototype.getGraphId=function(n){return this.folderId+"/"+n},t.prototype.addChildrenWork=function(n,t){t===void 0&&(t=!0);var i=new o(n);return this.node.addNode(i),n.attachNode(i),n.attachGraph(this._graphCtx),t&&n.updateGraph(),n.onParentChanged(),n},t.prototype.createParameters=function(){return!1},t.prototype.updateParameters=function(){var t=this,n=[];this.createParameters(n)&&(this.parameters.removeAll(),n.forEach(function(n){return t.parameters.push(n)}))},t.prototype.updateGraphWork=function(){},t.prototype.setChildrenStateWork=function(){},t.prototype.onSelected=function(){},t.prototype.onGraphChanged=function(){},t.prototype.updateColor=function(){},t}(),a=function(){function n(){this.vars=ko.observable()}return n.prototype.select=function(){},n}(),v=function(){function n(){this.curValue=ko.observable();this.autoCompute=ko.observable();this.min=ko.observable();this.max=ko.observable();this.step=ko.observable()}return n}(),s=function(t){function i(n){var i=t.call(this)||this;return i._varsMap={},i.selectedFunction=ko.observable(),i.showIntegration=ko.observable(!0),i.maxDay=ko.observable(),i.endDay=ko.observable(),i._varsMap={fun:null,sum:null,n1:null,n2:null,value:null,time:null,tend:null,xp:null},i.itemType="regression",i.icon="show_chart",i.optionsTemplateName="RegressionOptionsTemplate",i.functions=[],i.addFunction({name:$string("$(log-normal)"),type:"log-normal",value:"$y\\sim $c\\cdot\\frac{ e^ {-\\frac{ \\left(\\ln\\ \\left($x - $a\\right) \\ -$u\\right)^ { 2}} { 2$o^ { 2} }}}{ \\left($x - $a\\right) \\sqrt{ 2\\pi } $o }",vars:[{name:"a",label:$string("$(offset)"),autoCompute:!0,precision:0},{name:"c",label:$string("$(total)"),autoCompute:!0,precision:0},{name:"o",label:$string("$(variance)"),autoCompute:!0,precision:5},{name:"u",label:$string("$(average)"),autoCompute:!0,precision:5}]}),i.addFunction({name:$string("$(normal)"),type:"normal",value:"$y\\sim $c\\cdot\\ \\left(\\frac{1}{\\sqrt{2\\cdot\\pi}\\cdot $o}\\right)\\cdot e^{-\\frac{1}{2}\\cdot\\left(\\frac{\\left($x-$u\\right)}{$o}\\right)^{2}}",vars:[{name:"c",label:$string("$(total)"),autoCompute:!0,precision:0},{name:"o",label:$string("$(variance)"),autoCompute:!0,precision:5},{name:"u",label:$string("$(avg-peak)"),autoCompute:!0,precision:0}]}),i.addFunction({name:$string("$(exponential)"),type:"exponential",value:"$y\\sim $a^{\\left($x-$b\\right)}",vars:[{name:"a",label:$string("$(base)"),autoCompute:!0,precision:5},{name:"b",label:$string("$(offset)"),autoCompute:!0,precision:5}]}),i.addFunction({name:$string("$(linear)"),type:"linear",value:"$y\\sim $a+$m$x",vars:[{name:"a",label:$string("$(offset)"),autoCompute:!0,precision:5},{name:"m",label:$string("$(slope)"),autoCompute:!0,precision:5}]}),i.showIntegration.subscribe(function(){i._graphCtx.setItemVisibile(i.getGraphId("sum-serie"),i.isFullVisible()&&i.showIntegration());i._graphCtx.setItemVisibile(i.getGraphId("sum-point"),i.isFullVisible()&&i.showIntegration())}),i.selectedFunction.subscribe(function(n){if(!i.name()&&n)return i.name(n.value.name)}),i.endDay.subscribe(function(){return i.updateEndDay()}),i.maxDay.subscribe(function(){return i.updateEndDay()}),i.selectedFunction(i.functions[0]),n&&i.setState(n),i}return __extends(i,t),i.prototype.addFunction=function(n){var f,o,t=this,i=new a,e,s,u,r,h;i.value=n;i.select=function(){t.selectedFunction(i);t.name(i.value.name);t.updateGraph()};e=[];s=function(n){var i=new v;i.value=n;i.curValue(n.value);i.autoCompute(n.autoCompute);i.min(n.minValue);i.max(n.maxValue);i.step(n.step);i.min.subscribe(function(t){return n.minValue=t});i.max.subscribe(function(t){return n.maxValue=t});i.step.subscribe(function(t){return n.step=t});i.curValue.subscribe(function(t){return n.value=t});i.autoCompute.subscribe(function(i){n.autoCompute=i;t.updateGraph()});i.curValue.subscribe(function(r){i.autoCompute()||t._graphCtx.updateVariable(t.getGraphId(n.name+"-value"),t.getVar(n.name),r)});e.push(i)};try{for(u=__values(n.vars),r=u.next();!r.done;r=u.next())h=r.value,s(h)}catch(c){f={error:c}}finally{try{r&&!r.done&&(o=u.return)&&o.call(u)}finally{if(f)throw f.error;}}return i.vars(e),this.functions.push(i),i},i.prototype.onGraphChanged=function(){this.updateRegressionVars()},i.prototype.updateRegressionVars=function(){var f,o,e=this._graphCtx.calculator.controller.getItemModel(this.getGraphId("main")),i,t;if(e&&e.regressionParameters)try{for(i=__values(this.selectedFunction().vars()),t=i.next();!t.done;t=i.next()){var r=t.value,s=this.getVar(r.value.name).replace("{","").replace("}",""),u=e.regressionParameters[s];u!=undefined&&(r.value.precision!=undefined&&(u=n.MathUtils.round(u,r.value.precision)),r.curValue(u))}}catch(h){f={error:h}}finally{try{t&&!t.done&&(o=i.return)&&o.call(i)}finally{if(f)throw f.error;}}},i.prototype.createParameters=function(t){var i=this;return t.push(n.apply(new f({value:this.endDay,name:$string("$(reg-days)")}),function(n){n.max=i.maxDay;n.min(0);n.step(1)})),!0},i.prototype.setStateWork=function(t){var f,e,u,o,r,i,s;if(t.function&&(u=n.linq(this.functions).first(function(n){return n.value.type==t.function.type}),u)){o=function(t){var i=n.linq(u.vars()).first(function(n){return n.value.name==t.name});i&&(i.autoCompute(t.autoCompute),i.max(t.maxValue),i.min(t.minValue),i.step(t.step),i.curValue(t.value))};try{for(r=__values(t.function.vars),i=r.next();!i.done;i=r.next())s=i.value,o(s)}catch(h){f={error:h}}finally{try{i&&!i.done&&(e=r.return)&&e.call(r)}finally{if(f)throw f.error;}}this.selectedFunction(u)}t.showIntegration!=undefined&&this.showIntegration(t.showIntegration)},i.prototype.getState=function(){var u,e,f=t.prototype.getState.call(this),r,i,n;f.function=this.selectedFunction().value;f.showIntegration=this.showIntegration();try{for(r=__values(this.selectedFunction().vars()),i=r.next();!i.done;i=r.next())n=i.value,n.value.value=n.curValue(),n.value.maxValue=n.max(),n.value.minValue=n.min(),n.value.step=n.step(),n.value.autoCompute=n.autoCompute()}catch(o){u={error:o}}finally{try{i&&!i.done&&(e=r.return)&&e.call(r)}finally{if(u)throw u.error;}}return f},i.prototype.onParentChanged=function(){t.prototype.onParentChanged.call(this);this.color(this.parent.color());this.maxDay(n.linq(this.parent.values).max(function(n){return n.x}));this.endDay()==undefined&&this.endDay(this.maxDay())},i.prototype.updateEndDay=function(){this._varsMap.tend&&this._graphCtx.updateExpression({type:"expression",id:this.getGraphId("end-day"),latex:this._varsMap.tend+"="+this.endDay(),slider:{min:"0",step:"1",max:this.maxDay().toString()}})},i.prototype.updateColor=function(){this._graphCtx.setColor(this.getGraphId("main-func"),this.color());this._graphCtx.setColor(this.getGraphId("sum-serie"),this.color());this._graphCtx.setColor(this.getGraphId("sum-point"),this.color());this._graphCtx.setColor(this.getGraphId("end-day-line"),this.color())},i.prototype.updateGraphWork=function(){this.updateRegressionVars()},i.prototype.getExpressions=function(){var s,c,h,l,n=[],o,f,i,e,r,t;n.push({type:"folder",id:this.getGraphId("public"),title:this.parent.name()+" - "+this.name(),collapsed:!0});n.push({type:"folder",id:this.getGraphId("private"),secret:!0,title:this.parent.name()+" - "+this.name(),collapsed:!0});o=this.selectedFunction().value;this._varsMap.x="";this._varsMap.y=this.parent.getVar("y");this._varsMap.time=this.parent.parent.getVar("time");try{for(f=__values(o.vars),i=f.next();!i.done;i=f.next())t=i.value,this._varsMap[t.name]||(this._varsMap[t.name]=null)}catch(a){s={error:a}}finally{try{i&&!i.done&&(c=f.return)&&c.call(f)}finally{if(s)throw s.error;}}this._graphCtx.generateVars(this._varsMap);this._varsMap.x=this.getVar("xp");n.push({type:"expression",id:this.getGraphId("main"),folderId:this.getGraphId("private"),latex:this.replaceVars(o.value),hidden:!0});n.push({type:"expression",id:this.getGraphId("main-func"),folderId:this.getGraphId("private"),latex:this.replaceVars(o.value.replace("$y\\sim ","$fun\\left(x\\right)=").replace(/\$x/g,"x")),color:this.parent.color(),lineStyle:Desmos.Styles.DASHED});n.push({type:"expression",id:this.getGraphId("sum-func"),folderId:this.getGraphId("private"),latex:this.replaceVars("$sum\\left(x\\right)=\\sum_{$n1=1}^{x}\\operatorname{round}\\left($fun\\left($n1\\right)\\right)"),hidden:!0});n.push({type:"expression",id:this.getGraphId("sum-x-time"),folderId:this.getGraphId("private"),latex:this.replaceVars("$n2=\\left[1,...,$time\\right]")});n.push({type:"expression",id:this.getGraphId("sum-serie"),folderId:this.getGraphId("private"),latex:this.replaceVars("\\left($n2,\\ $sum\\left($n2\\right)\\right)"),color:this.parent.color(),lines:!0,hidden:!this.showIntegration(),lineStyle:Desmos.Styles.SOLID,pointStyle:"NONE",points:!1});n.push({type:"expression",id:this.getGraphId("sum-value"),folderId:this.getGraphId("public"),latex:this.replaceVars("$value=$sum\\left($time\\right)")});n.push({type:"expression",id:this.getGraphId("sum-point"),folderId:this.getGraphId("private"),hidden:!this.showIntegration(),latex:this.replaceVars("\\left($time,$value\\right)"),color:this.parent.color(),label:this.parent.name(),dragMode:"XY",showLabel:!0});n.push({type:"expression",id:this.getGraphId("end-day"),latex:this._varsMap.tend+"="+this.endDay(),folderId:this.getGraphId("public"),label:"Giorni Previsione",slider:{min:0..toString(),max:this.maxDay().toString(),hardMax:!0,hardMin:!0,step:"1"}});n.push({type:"expression",id:this.getGraphId("end-day-line"),color:this.color(),latex:"x="+this._varsMap.tend,folderId:this.getGraphId("private"),lines:!0});n.push({type:"expression",id:this.getGraphId("end-day-serie"),latex:this.replaceVars("$xp=[0,...,$tend]+"+this.parent.getVar("ofs")),folderId:this.getGraphId("private"),hidden:!0});try{for(e=__values(this.selectedFunction().vars()),r=e.next();!r.done;r=e.next())t=r.value,t.autoCompute()?this._graphCtx.calculator.removeExpression({id:this.getGraphId(t.value.name+"-value")}):n.push({type:"expression",id:this.getGraphId(t.value.name+"-value"),latex:this.getVar(t.value.name)+"="+(t.curValue()?t.curValue().toString():"0"),folderId:this.getGraphId("public"),label:t.value.name,slider:{min:u(t.value.minValue),max:u(t.value.maxValue),hardMax:!0,hardMin:!0,step:u(t.value.step)}})}catch(v){h={error:v}}finally{try{r&&!r.done&&(l=e.return)&&l.call(e)}finally{if(h)throw h.error;}}return n},i}(e),r=function(r){function u(n){var t=r.call(this)||this;return t.color=ko.observable(),t.offsetX=ko.observable(0),t.canDrag=!0,t.itemType="serie",t.icon="insert_chart",t.optionsTemplateName="StudioOptionsTemplate",t._varsMap={x:null,y:null,ofs:null,xofs:null},n&&t.setState(n),t}return __extends(u,r),u.prototype.writeData=function(n){var t={version:1,type:"serieState",state:this.getState()};return n.setData("application/json+studio",JSON.stringify(t)),n.setData("text/html+id",this.node.element.id),!0},u.prototype.createActions=function(t){var u=this;r.prototype.createActions.call(this,t);t.push(n.apply(new i,function(n){n.text=$string("$(update)");n.icon="autorenew";n.execute=function(){return u.updateSerie()}}));t.push(n.apply(new i,function(n){n.text=$string("$(new-regression)");n.icon="add_box";n.execute=function(){var n=u.addRegression();u.node.isExpanded(!0);n.node.isSelected(!0)}}));t.push(n.apply(new i,function(n){n.text=$string("$(zoom)");n.icon="zoom_in";n.execute=function(){u.zoom()}}))},u.fromText=function(n){try{var t=JSON.parse(n);if(t){if(t.type=="serie")return new u({name:t.title,values:t.values,source:t.serie,color:t.color});if(t.type=="serieState")return new u(t.state)}}catch(i){}},u.prototype.getExpressions=function(){this.color()||this.color("#0000ff");this._graphCtx.generateVars(this._varsMap);return[{type:"folder",id:this.getGraphId("public"),title:this.parent.name()+" - "+this.name(),collapsed:!0},{type:"folder",id:this.getGraphId("private"),title:this.parent.name()+" - "+this.name(),secret:!0,collapsed:!0},{type:"expression",id:this.getGraphId("offset"),latex:this._varsMap.ofs+"="+this.offsetX(),folderId:this.getGraphId("public"),label:"Scostamento",slider:{min:(-this.values.length).toString(),max:this.values.length.toString(),hardMax:!0,hardMin:!0,step:"1"}},{type:"expression",id:this.getGraphId("offset-x"),latex:this._varsMap.xofs+"="+this._varsMap.x+"+"+this._varsMap.ofs,folderId:this.getGraphId("private")},{type:"expression",id:this.getGraphId("offset-x-serie"),latex:"("+this._varsMap.xofs+","+this._varsMap.y+")",folderId:this.getGraphId("private"),points:!0,lines:!0,color:this.color()},{type:"table",id:this.getGraphId("table"),folderId:this.getGraphId("private"),columns:[{id:this.getGraphId("table/x"),latex:this._varsMap.x},{id:this.getGraphId("table/y"),latex:this._varsMap.y,hidden:!0}]}]},u.prototype.createParameters=function(t){var i=this;return t.push(n.apply(new f({value:this.offsetX,name:$string("$(shift)")}),function(n){n.max(i.values.length);n.min(-i.values.length);n.step(1)})),!0},u.prototype.updateGraphWork=function(){this._graphCtx.updateTable(this.getGraphId("table"),this.values)},u.prototype.onGraphChanged=function(){},u.prototype.onSelected=function(){this._graphCtx.expressionZoomFit(this.getGraphId("table"))},u.prototype.updateColor=function(){this._graphCtx.setColor(this.getGraphId("offset-x-serie"),this.color());this.children.foreach(function(n){return n.onParentChanged()})},u.prototype.attachGraph=function(n){var t=this;r.prototype.attachGraph.call(this,n);this.offsetX.subscribe(function(n){return t._graphCtx.updateVariable(t.getGraphId("offset"),t._varsMap.ofs,n)})},u.prototype.setChildrenStateWork=function(n){var t=this;n.children!=undefined&&(this.children.foreach(function(n){return n.remove()}),n.children.forEach(function(n){var i=t.addRegression(null,!1);i.setState(n)}))},u.prototype.setStateWork=function(n){n.offsetX!=undefined&&this.offsetX(n.offsetX);n.source&&(this.source=n.source);n.values!=undefined&&(this.values=n.values)},u.prototype.getState=function(){var n=r.prototype.getState.call(this);return n.offsetX=this.offsetX(),n.source=this.source,n.values=this.values,n.children=this.children.select(function(n){return n.getState()}).toArray(),n},u.prototype.addRegression=function(n,t){return t===void 0&&(t=!0),this.addChildrenWork(n instanceof s?n:new s(n),t)},u.prototype.updateSerie=function(){return __awaiter(this,void 0,void 0,function(){var i;return __generator(this,function(r){switch(r.label){case 0:return!this._graphCtx.serieCalculator?(M.toast({html:$string("$(msg-downloading-data)")}),[4,n.Http.getJsonAsync("~/StudioData")]):[3,2];case 1:i=r.sent();this._graphCtx.serieCalculator=new t.IndicatorCalculator(i.data,t.InfectionDataSet,i.geo);r.label=2;case 2:return this.values=this._graphCtx.serieCalculator.getSerie(this.source),this._graphCtx.updateTable(this.getGraphId("table"),this.values),M.toast({html:$string("$(msg-update-complete)")}),[2]}})})},u.prototype.zoom=function(){var t=n.linq(this.values).min(function(n){return n.x}),i=n.linq(this.values).min(function(n){return n.y}),r=n.linq(this.values).max(function(n){return n.x}),u=n.linq(this.values).max(function(n){return n.y});this._graphCtx.calculator.setMathBounds({top:u+(u-i)*.1,right:r+(r-t)*.1,bottom:i-(u-i)*.1,left:t-(r-t)*.1})},u}(e),y=function(t){function i(n){var i=t.call(this)||this;return i.time=ko.observable(0),i.itemType="project",i.icon="folder",i.optionsTemplateName="ProjectOptionsTemplate",i._varsMap={time:null},n&&i.setState(n),i}return __extends(i,t),i.prototype.canAccept=function(n){return n instanceof r},i.prototype.canReadData=function(n){return n.types.indexOf("application/json+studio")!=-1},i.prototype.readData=function(n){var i=n.getData("application/json+studio"),t=r.fromText(i);t&&(this.addSerie(t),this.node.isExpanded(!0))},i.prototype.getExpressions=function(){this._graphCtx.generateVars(this._varsMap);return[{type:"folder",id:this.getGraphId("public"),title:this.name(),collapsed:!0},{type:"expression",folderId:this.getGraphId("public"),id:this.getGraphId("time"),latex:this._varsMap.time+"="+this.time(),slider:{hardMin:!0,hardMax:!0,min:"0",max:"100",step:"1"}}]},i.prototype.createParameters=function(t){return t.push(n.apply(new f({value:this.time,name:$string("$(day)")}),function(n){n.max(100);n.min(0);n.step(1)})),!0},i.prototype.setStateWork=function(n){n.time!=undefined&&this.time(n.time)},i.prototype.setChildrenStateWork=function(n){var t=this;n.children!=undefined&&(this.children.foreach(function(n){return n.remove()}),n.children.forEach(function(n){var i=t.addSerie(null,!1);i.setState(n)}))},i.prototype.getState=function(){var n=t.prototype.getState.call(this);return n.time=this.time(),n.children=this.children.select(function(n){return n.getState()}).toArray(),n},i.prototype.onGraphChanged=function(){},i.prototype.attachGraph=function(n){var i=this;t.prototype.attachGraph.call(this,n);this.time.subscribe(function(){return i._graphCtx.updateVariable(i.getGraphId("time"),i._varsMap.time,i.time())})},i.prototype.addSerie=function(n,t){return t===void 0&&(t=!0),this.addChildrenWork(n instanceof r?n:new r(n),t)},i}(e),i=function(){function n(){}return n.prototype.execute=function(){},n}(),o=function(){function t(n){var t=this;this._dargEnterCount=0;this.nodes=ko.observableArray();this.value=ko.observable();this.isSelected=ko.observable(!1);this.isVisible=ko.observable(!0);this.isExpanded=ko.observable(!1);this.actions=ko.observable();this.value(n);this.isSelected.subscribe(function(n){n&&t._treeView.select(t)})}return Object.defineProperty(t.prototype,"element",{get:function(){return this._element},enumerable:!0,configurable:!0}),t.prototype.attachNode=function(t){var r=this,i;this._element=t;this._element.id=n.DomUtils.generateId();this._element.$model=this;i=this._element.querySelector("header");i.ondragstart=function(n){return r.onDrag(n)};i.ondragover=function(n){return r.onDragOver(n)};i.ondragenter=function(n){return r.onDragEnter(n)};i.ondragleave=function(n){return r.onDragLeave(n)};i.ondrop=function(n){return r.onDrop(n)}},t.prototype.onDrag=function(n){if(!this.value().writeData(n.dataTransfer)||!this.value().canDrag)return n.preventDefault(),!1},t.prototype.onDragEnter=function(){this._dargEnterCount++},t.prototype.onDragLeave=function(){this._dargEnterCount--;this._dargEnterCount==0&&n.DomUtils.removeClass(this._element,"drop")},t.prototype.onDragOver=function(t){if(t.preventDefault(),this._dargEnterCount==1){var i=!0;this.value().canReadData(t.dataTransfer)||(i=!1);i?(t.dataTransfer.dropEffect=t.ctrlKey?"copy":"move",n.DomUtils.addClass(this._element,"drop")):t.dataTransfer.dropEffect="move"}},t.prototype.onDrop=function(t){var r,u,i;if(t.preventDefault(),this._dargEnterCount=0,n.DomUtils.removeClass(this._element,"drop"),r=t.dataTransfer.getData("text/html+id"),r){if(u=document.getElementById(r),i=u.$model,!this.value().canAccept(i.value()))return;if(!t.ctrlKey){if(i._parentNode==this)return;i._parentNode.nodes.remove(i);i._parentNode=this;this.nodes.push(i);this.isExpanded(!0);i.value().onParentChanged();return}}else this.value().readData(t.dataTransfer)},t.prototype.remove=function(){this._parentNode&&this._parentNode.nodes.remove(this);this._treeView.selectedNode()==this&&this._treeView.select(null)},t.prototype.addNode=function(n){n.attach(this._treeView,this);this.nodes.push(n)},t.prototype.attach=function(n,t){var u,f,r,i,e;this._treeView=n;this._parentNode=t;try{for(r=__values(this.nodes()),i=r.next();!i.done;i=r.next())e=i.value,e.attach(n)}catch(o){u={error:o}}finally{try{i&&!i.done&&(f=r.return)&&f.call(r)}finally{if(u)throw u.error;}}},Object.defineProperty(t.prototype,"parentNode",{get:function(){return this._parentNode},enumerable:!0,configurable:!0}),t.prototype.toggleVisible=function(){this.isVisible(!this.isVisible())},t.prototype.toggleSelection=function(){this.isSelected(!this.isSelected())},t.prototype.expandCollapse=function(){this.isExpanded(!this.isExpanded())},t}(),h=function(){function n(){this.root=ko.observable();this.selectedNode=ko.observable()}return n.prototype.select=function(n){this.selectedNode()!=n&&(this.selectedNode()&&this.selectedNode().isSelected(!1),this.selectedNode(n),this.selectedNode()&&this.selectedNode().isSelected(!0))},n.prototype.setRoot=function(n){n.attach(this);this.root(n)},n}(),c;t.TreeViewModel=h;c=function(){function t(){var t=this,r,u;this.items=new h;this.maxX=ko.observable();this.maxY=ko.observable();this._graphCtx=new l;this._graphCtx.calculator=Desmos.GraphingCalculator(document.getElementById("calculator"),{pasteGraphLink:!1,pasteTableData:!1,expressionsCollapsed:!0,restrictedFunctions:!0,authorIDE:!0,advancedStyling:!0});r=[];r.push(n.apply(new i,function(n){n.text=$string("$(new-project)");n.icon="create_new_folder";n.execute=function(){return t.newProject()}}));r.push(n.apply(new i,function(n){n.text=$string("$(save)");n.icon="save";n.execute=function(){return t.saveState()}}));r.push(n.apply(new i,function(n){n.text=$string("$(options)");n.icon="settings";n.execute=function(){return t.showOptions()}}));u=new o;u.actions(r);this.items.setRoot(u);document.body.addEventListener("paste",function(n){n.preventDefault();t.onPaste(n.clipboardData)});document.body.addEventListener("keydown",function(n){t.onKeyDown(n)});M.Modal.init(document.getElementById("options"),{onCloseEnd:function(){return t.updateOptions()}});setTimeout(function(){return t.init()})}return t.prototype.updateOptions=function(){var n=parseInt(this.maxX()),t=parseInt(this.maxY());this._graphCtx.calculator.setMathBounds({bottom:-t/10,left:-n/10,right:n,top:t})},t.prototype.showOptions=function(){var n=this._graphCtx.calculator.graphpaperBounds,t;this.maxX(Math.round(n.mathCoordinates.width));this.maxY(Math.round(n.mathCoordinates.height));t=M.Modal.getInstance(document.getElementById("options"));t.open()},t.prototype.removeSelected=function(){if(this.items.selectedNode()){var n=this.items.selectedNode().value();n.remove()}},t.prototype.getSelectedProject=function(){if(this.items.selectedNode()){var n=this.items.selectedNode().value();return n.itemType=="project"?n:n.itemType=="serie"?n.parent:n.itemType=="regression"?n.parent.parent:void 0}},t.prototype.newProject=function(){var n=this.addProject({name:"Project "+(this.projects.count()+1)});return n.node.isSelected(!0),n},t.prototype.addProject=function(n,t){t===void 0&&(t=!0);var i=new y(n),r=new o(i);return this.items.root().addNode(r),i.attachNode(r),i.attachGraph(this._graphCtx),t&&i.updateGraph(),i},t.prototype.getState=function(){var n={version:2};return n.graphState=this._graphCtx.calculator.getState(),n.vars=this._graphCtx.vars,n.projects=this.projects.select(function(n){return n.getState()}).toArray(),n},t.prototype.setState=function(n){var t=this;n&&(n.graphState&&(n.graphState.expressions.list=[],this._graphCtx.calculator.setState(n.graphState)),n.projects!=undefined&&(this.projects.toArray().forEach(function(n){return n.remove()}),n.projects.forEach(function(n){var i=t.addProject(null,!1);i.setState(n)})))},t.prototype.loadState=function(){var n=localStorage.getItem("studio");n&&this.setState(JSON.parse(n))},t.prototype.saveState=function(){localStorage.setItem("studio",JSON.stringify(this.getState()));M.toast({html:$string("$(msg-saved)")})},t.prototype.demo=function(){var n=this.addProject({name:"Project 1"});this.addProject({name:"Project 2"});this.addProject({name:"Project 3"});n.addSerie({name:"Serie 1"})},t.prototype.onKeyDown=function(n){n.keyCode==46&&n.target.tagName!="INPUT"&&(n.preventDefault(),this.removeSelected())},t.prototype.onPaste=function(n){var i=this.getSelectedProject(),u,t,f;i||this.projects.any()||(i=this.newProject());i&&(u=n.getData("text/plain").toString(),u&&(t=r.fromText(u),t&&(i.addSerie(t),i.node.isExpanded(!0),t.node.isExpanded(!0),t.zoom(),f=t.addRegression(),f.node.isSelected(!0))))},Object.defineProperty(t.prototype,"projects",{get:function(){function t(){var t,n,r,u,i,f;return __generator(this,function(e){switch(e.label){case 0:e.trys.push([0,5,6,7]);t=__values(this.items.root().nodes());n=t.next();e.label=1;case 1:return!n.done?(r=n.value,[4,r.value()]):[3,4];case 2:e.sent();e.label=3;case 3:return n=t.next(),[3,1];case 4:return[3,7];case 5:return u=e.sent(),i={error:u},[3,7];case 6:try{n&&!n.done&&(f=t.return)&&f.call(t)}finally{if(i)throw i.error;}return[7];case 7:return[2]}})}return n.linq(t.apply(this))},enumerable:!0,configurable:!0}),t.prototype.init=function(){this.loadState()},t}();t.StudioPage=c})(t=n.GeoPlot||(n.GeoPlot={}))}(WebApp||(WebApp={}));